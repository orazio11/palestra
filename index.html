<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Schede Palestra - Versione Migliorata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0c0a09;
            --bg-secondary: #1c1917;
            --bg-gradient-from: #1f2937;
            --bg-gradient-to: #0c0a09;
            --text-primary: #e2e8f0;
            --text-secondary: #a8a29e;
            --text-accent: #dc2626; /* Red-600 */
            --text-accent-hover: #b91c1c; /* Red-700 */
            --text-accent-dark: #fef2f2; /* Red-50 */
            --border-color: #44403c;
            --btn-secondary-bg: #262626;
            --btn-secondary-hover: #404040;
        }
        html.light {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-gradient-from: #f3f4f6;
            --bg-gradient-to: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --text-accent: #dc2626;
            --text-accent-hover: #b91c1c;
            --text-accent-dark: #ffffff;
            --border-color: #d1d5db;
            --btn-secondary-bg: #e5e7eb;
            --btn-secondary-hover: #d1d5db;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .bg-gradient-main { background-image: linear-gradient(to bottom right, var(--bg-gradient-from), var(--bg-gradient-to)); }
        .input-field { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 10px 12px; width: 100%; transition: all 0.2s; color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--text-accent); box-shadow: 0 0 0 2px var(--text-accent-dark); }
        html.dark .input-field:focus { box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3); }
        .textarea-field { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 10px 12px; width: 100%; transition: all 0.2s; color: var(--text-primary); resize: vertical; min-height: 80px; }
        .textarea-field:focus { outline: none; border-color: var(--text-accent); box-shadow: 0 0 0 2px var(--text-accent-dark); }
        html.dark .textarea-field:focus { box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.3); }
        .btn { display: inline-flex; align-items: center; justify-content: center; text-align: center; background-color: var(--text-accent); color: var(--text-accent-dark); font-weight: 700; padding: 10px 16px; border-radius: 0.5rem; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:hover { background-color: var(--text-accent-hover); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .btn:disabled { cursor: not-allowed; filter: grayscale(50%); opacity: 0.7; }
        .btn-secondary { background-color: var(--btn-secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover); }
        .btn-danger { background-color: #be123c; color: #fff1f2; }
        .btn-danger:hover { background-color: #9f1239; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--text-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .week-btn { flex-shrink: 0; background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .week-btn.active { background-color: var(--text-accent); color: var(--text-accent-dark); font-weight: 700; border-color: var(--text-accent); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.open { max-height: 2000px; }
        .notification { position: fixed; bottom: 20px; right: 20px; background-color: var(--text-accent); color: var(--text-accent-dark); padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; animation: slideIn 0.3s ease-out; }
        .notification.warning { background-color: #be123c; color: #fff1f2; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .reward-badge { display: inline-block; background-color: #f59e0b; color: #431407; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .progress-bar { height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--text-accent); }
        .timer-display { font-family: monospace; font-size: 1.5rem; font-weight: bold; }
        .user-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 8px 16px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .exercise-image { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; border: 2px solid var(--border-color); border-radius: 0.5rem; display: block; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .pdf-preview { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; background-color: var(--bg-secondary); }
        .macrocycle-card { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); border: 1px solid #3b82f6; }
        .accordion-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .accordion-header:hover { background-color: rgba(59, 130, 246, 0.2); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-icon.open { transform: rotate(180deg); }
        .intensity-active { border-color: var(--text-accent); background-color: rgba(220, 38, 38, 0.1); }
        .intensity-glow { border-color: var(--text-accent); box-shadow: 0 0 15px 4px rgba(220, 38, 38, 0.4), inset 0 0 8px 1px rgba(220, 38, 38, 0.3); }
        .recap-card { background: linear-gradient(135deg, #4a044e, #1e1b4b); border: 1px solid #7e22ce; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .circuit-card { border-color: #f59e0b; background: linear-gradient(135deg, rgba(120, 53, 15, 0.2), rgba(28, 25, 23, 0.2)); }
        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem; }
        .image-grid .exercise-image { width: 100%; height: auto; aspect-ratio: 1 / 1; }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="container mx-auto p-4 max-w-3xl">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <i class="fas fa-dumbbell text-red-500 text-2xl"></i>
                <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Gym App</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle-btn" class="btn btn-secondary !p-2" title="Cambia tema">
                    <i id="theme-icon-light" class="fas fa-sun hidden"></i>
                    <i id="theme-icon-dark" class="fas fa-moon"></i>
                </button>
                <div id="user-controls"></div>
            </div>
        </header>

        <div id="user-indicator" class="user-indicator hidden">
            <div class="flex items-center gap-2">
                <i class="fas fa-user text-red-500"></i>
                <span id="selected-user-name" class="text-sm font-medium"></span>
                <button id="back-to-admin-btn" class="btn btn-secondary !p-1 text-xs">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div id="main-view"></div>
    </div>

    <!-- Modals -->
    <div id="auth-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 id="auth-title" class="text-xl font-bold text-white mb-4 text-center">Area Personale</h3>
            <p id="auth-error" class="text-red-400 mb-4 text-center text-sm"></p>
            <form id="auth-form" class="space-y-4">
                <input type="email" name="email" class="input-field" placeholder="Email" required>
                <input type="password" name="password" class="input-field" placeholder="Password (min. 6 caratteri)" required>
                <button type="submit" id="auth-submit-btn" class="btn w-full">Accedi</button>
                <button type="button" id="toggle-auth-mode-btn" class="text-center w-full mt-4 text-sm text-red-500 hover:text-red-400">Non hai un account? Registrati</button>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 id="confirm-title" class="text-xl font-bold text-white mb-4">Conferma Azione</h3>
            <p id="confirm-message" class="text-stone-300 mb-6">Sei sicuro?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Annulla</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Conferma</button>
            </div>
        </div>
    </div>

    <div id="edit-exercise-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
             <h3 class="text-xl font-bold text-white mb-4">Modifica Esercizio</h3>
             <div id="edit-exercise-container"></div>
        </div>
    </div>

    <div id="favorites-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-3xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Esercizi Preferiti</h3>
                <button id="close-favorites-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="favorites-container"></div>
        </div>
    </div>

    <div id="user-management-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-users-cog mr-2 text-red-500"></i> Gestione Utenti</h3>
                <div class="flex gap-2">
                    <button id="refresh-users-btn" class="btn btn-secondary !p-2" title="Aggiorna lista"><i class="fas fa-sync-alt"></i></button>
                    <button id="close-user-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="user-management-container"></div>
        </div>
    </div>

    <div id="edit-user-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4">Modifica Utente</h3>
            <div id="edit-user-container"></div>
        </div>
    </div>

    <div id="user-details-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Dettagli Utente</h3>
                <button id="close-user-details-btn" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="user-details-container"></div>
        </div>
    </div>

    <!-- Modified Timer Modal Structure -->
    <div id="timer-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800" id="timer-modal-content-wrapper">
            <div id="timer-modal-content">
                <!-- Simple or Interval Timer Content is injected here -->
            </div>
        </div>
    </div>
    <!-- End Modified Timer Modal Structure -->

    <div id="pdf-preview-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Anteprima PDF</h3>
                <div class="flex gap-2">
                    <button id="download-pdf-btn" class="btn btn-secondary"><i class="fas fa-download mr-2"></i> Scarica PDF</button>
                    <button id="close-pdf-preview-btn" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="pdf-preview-container" class="pdf-preview"></div>
        </div>
    </div>

    <div id="procrastination-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-red-500 text-center">
            <h3 class="text-3xl font-bold text-red-500 mb-4 animate-pulse">Ci stai mettendo troppo!</h3>
            <p class="text-stone-300 mb-6">Mantieni alta l'intensità. È ora della prossima serie!</p>
            <button id="procrastination-ok-btn" class="btn">Ho capito!</button>
        </div>
    </div>

    <div id="exercise-history-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-3xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 id="history-modal-title" class="text-xl font-bold text-white">Storico Esercizio</h3>
                <button id="close-history-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="exercise-history-container"></div>
        </div>
    </div>

    <div id="volume-analysis-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-gradient-main p-8 rounded-lg shadow-xl w-full max-w-5xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-calculator mr-2 text-red-500"></i> Analisi Volume Mesociclo</h3>
                <button id="close-volume-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="volume-analysis-container" class="space-y-6"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, query, orderBy, writeBatch, setDoc, where, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- CONFIGURAZIONE FIREBASE ---
        // Le tue chiavi e config dovrebbero essere dinamiche o fornite dall'ambiente in un'app reale.
        // Manteniamo questa configurazione per l'ambiente canvas:
        const firebaseConfig = {
            apiKey: "AIzaSyBpzZN8VmrRKW60rW1WprEzgXyhhATzaPs",
            authDomain: "apppalestrasuper.firebaseapp.com",
            projectId: "apppalestrasuper",
            storageBucket: "apppalestrasuper.appspot.com",
            messagingSenderId: "883984670947",
            appId: "1:883984670947:web:adb9a75775e78ae7a965d6",
            measurementId: "G-CL6QVT906P"
        };

        // --- INIZIALIZZAZIONE SERVIZI FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // --- COSTANTI E VARIABILI GLOBALI ---
        const CATEGORIES = ["ABDUCTORS", "ABS", "ADDUCTORS", "BICEPS", "CALVES", "CHEST ISO", "DECLINE PUSH", "FRONT DELTS", "GLUTEI ISO", "HAMSTRINGS", "HIP HINGE", "HORIZONTAL HIP EXTENSION", "HORIZONTAL PULL", "HORIZONTAL PUSH", "INCLINE PULL", "INCLINE PUSH", "LEG PRESS VARIATION", "LOWER BACK", "LUNGE", "PULLOVER", "QUADS ISO", "REAR DELTS", "SIDE DELTS", "SQUAT PATTERN", "STRETCHING", "TRAPS", "TRICIPITI", "TRICEPS PUSH", "UPPER BACK", "VERTICAL PULL", "VERTICAL PUSH"];
        const MACROCYCLE_RULES = {
            "ADDOMINALI": { main: "ABS", additional: [] },
            "ADDUTTORI": { main: "ADDUCTORS", additional: [] },
            "BICIPITI": { main: "BICEPS", additional: [ { category: "HORIZONTAL PULL", percentage: 25 }, { category: "UPPER BACK", percentage: 25 }, { category: "INCLINE PULL", percentage: 25 } ] },
            "DELTOIDI FRONTALI": { main: "FRONT DELTS", additional: [ { category: "INCLINE PUSH", percentage: 25 }, { category: "VERTICAL PUSH", percentage: 25 } ] },
            "DELTOIDI LATERALI": { main: "SIDE DELTS", additional: [] },
            "DELTOIDI POSTERIORI": { main: "REAR DELTS", additional: [ { category: "HORIZONTAL PULL", percentage: 25 }, { category: "UPPER BACK", percentage: 25 } ] },
            "DORSALI": { main: "UPPER BACK", additional: [ { category: "HORIZONTAL PULL", percentage: 100 }, { category: "PULLOVER", percentage: 100 }, { category: "INCLINE PULL", percentage: 100 } ] },
            "GLUTEI": { main: "HORIZONTAL HIP EXTENSION", additional: [ { category: "HIP HINGE", percentage: 100 }, { category: "LEG PRESS VARIATION", percentage: 100 }, { category: "LUNGE", percentage: 100 }, { category: "ABDUCTORS", percentage: 100 }, { category: "SQUAT PATTERN", percentage: 100 }, { category: "GLUTEI ISO", percentage: 100 } ] },
            "LOMBARI": { main: "HIP HINGE", additional: [ { category: "LOWER BACK", percentage: 100 } ] },
            "PETTORALI": { main: "HORIZONTAL PUSH", additional: [ { category: "INCLINE PUSH", percentage: 100 }, { category: "CHEST ISO", percentage: 100 }, { category: "DECLINE PUSH", percentage: 100 } ] },
            "POLPACCI": { main: "CALVES", additional: [] },
            "QUADRICIPITI": { main: "SQUAT PATTERN", additional: [ { category: "QUADS ISO", percentage: 100 }, { category: "LUNGE", percentage: 100 }, { category: "LEG PRESS VARIATION", percentage: 100 } ] },
            "STRETCHING": { main: "STRETCHING", additional: [] },
            "TRAPEZI": { main: "HIP HINGE", additional: [ { category: "TRAPS", percentage: 100 }, { category: "HORIZONTAL PULL", percentage: 100 } ] },
            "TRICIPITI": { main: "TRICIPITI", additional: [ { category: "FRONT DELTS", percentage: 100 }, { category: "HORIZONTAL PUSH", percentage: 100 }, { category: "INCLINE PUSH", percentage: 100 }, { category: "DECLINE PUSH", percentage: 100 } ] },
            "UPPER BACK": { main: "VERTICAL PULL", additional: [ { category: "UPPER BACK", percentage: 100 }, { category: "HORIZONTAL PULL", percentage: 100 } ] }
        };
        const WEIGHT_INCREMENT = 2.5;

        // Riferimenti DOM
        const userControls = document.getElementById('user-controls');
        const mainView = document.getElementById('main-view');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const authModal = document.getElementById('auth-modal');
        const editExerciseModal = document.getElementById('edit-exercise-modal');
        const favoritesModal = document.getElementById('favorites-modal');
        const userManagementModal = document.getElementById('user-management-modal');
        const editUserModal = document.getElementById('edit-user-modal');
        const userDetailsModal = document.getElementById('user-details-modal');
        const timerModal = document.getElementById('timer-modal');
        const userIndicator = document.getElementById('user-indicator');
        const selectedUserName = document.getElementById('selected-user-name');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const pdfPreviewModal = document.getElementById('pdf-preview-modal');
        const procrastinationModal = document.getElementById('procrastination-modal');
        const exerciseHistoryModal = document.getElementById('exercise-history-modal');
        const volumeAnalysisModal = document.getElementById('volume-analysis-modal');

        let currentUser = null, currentUserRole = 'user', currentMesoId = null, currentSheetId = null, currentSheetData = null, currentWeek = 1, exercisesCache = [], saveTimeouts = {}, isLoginMode = true, selectedUserId = null, favoritesCache = [];
        let activeTimerInterval = null, timerSeconds = 0, timerPaused = false;
        let procrastinationTimers = {};
        let modifiedExercisesThisWeek = new Set();
        
        // Stato per il nuovo Interval Timer
        let intervalTimer = {
            interval: null,
            totalSeconds: 0,
            currentPhase: 'WORK',
            workTime: 0,
            restTime: 0,
            currentRound: 0,
            totalRounds: 0,
            exerciseName: ''
        };


        // --- GESTIONE TEMA ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('light', theme === 'light');
            document.getElementById('theme-icon-light').classList.toggle('hidden', theme !== 'light');
            document.getElementById('theme-icon-dark').classList.toggle('hidden', theme === 'light');
            localStorage.setItem('theme', theme);
        }
        themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light'));
        applyTheme(localStorage.getItem('theme') || 'dark');

        // --- GESTIONE TIMER RECUPERO SEMPLICE ---
        function renderSimpleTimerModal() {
            document.getElementById('timer-modal-content').innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4 text-center">Timer Recupero</h3>
                <div class="timer-display text-red-500 text-center mb-6" id="simple-timer-display">00:00</div>
                <div class="flex justify-center gap-4">
                    <button id="simple-timer-pause-btn" class="btn btn-secondary"><i class="fas fa-pause"></i> Pausa</button>
                    <button id="simple-timer-stop-btn" class="btn btn-danger"><i class="fas fa-stop"></i> Ferma</button>
                </div>
            `;
            // Rebind listeners
            document.getElementById('simple-timer-pause-btn').addEventListener('click', toggleSimpleTimerPause);
            document.getElementById('simple-timer-stop-btn').addEventListener('click', stopSimpleTimer);
        }

        function startTimerModal(duration) {
            renderSimpleTimerModal(); // Initialize simple timer UI
            const display = document.getElementById('simple-timer-display');
            if (!display) return; 

            timerSeconds = duration;
            timerPaused = false;
            display.textContent = `${Math.floor(duration / 60).toString().padStart(2, '0')}:${(duration % 60).toString().padStart(2, '0')}`;
            
            timerModal.classList.remove('hidden');
            setTimeout(() => timerModal.classList.remove('opacity-0'), 10);
            
            if (activeTimerInterval) clearInterval(activeTimerInterval);
            activeTimerInterval = setInterval(() => {
                if (!timerPaused && timerSeconds > 0) {
                    timerSeconds--;
                    const minutes = Math.floor(timerSeconds / 60);
                    const seconds = timerSeconds % 60;
                    display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else if (timerSeconds <= 0) {
                    stopSimpleTimer();
                    showNotification("Timer completato!");
                }
            }, 1000);
        }

        function toggleSimpleTimerPause() {
            timerPaused = !timerPaused;
            document.getElementById('simple-timer-pause-btn').innerHTML = timerPaused ? '<i class="fas fa-play"></i> Riprendi' : '<i class="fas fa-pause"></i> Pausa';
        }

        function stopSimpleTimer() {
            clearInterval(activeTimerInterval);
            timerModal.classList.add('opacity-0');
            setTimeout(() => timerModal.classList.add('hidden'), 250);
        }


        // --- GESTIONE TIMER CIRCUITO A INTERVALLI ---
        function startIntervalCircuitTimer(ex) {
            if (!ex.circuitWorkTime || !ex.circuitRestTime || ex.serie === 0) {
                showNotification("Dati circuito non validi. Controlla Tempo Lavoro e Tempo Rec tra Round.", "error");
                return;
            }
            
            intervalTimer.workTime = ex.circuitWorkTime;
            intervalTimer.restTime = ex.circuitRestTime;
            intervalTimer.totalRounds = ex.serie;
            intervalTimer.currentRound = 1;
            intervalTimer.exerciseName = ex.nomeEsercizio;

            document.getElementById('timer-modal-content').innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4 text-center">Circuito: ${ex.nomeEsercizio}</h3>
                <p class="text-stone-300 text-center mb-2" id="timer-phase-display"></p>
                <div class="timer-display text-red-500 text-center mb-6" id="circuit-timer-display">00:00</div>
                <p class="text-sm text-center text-secondary mb-4" id="timer-round-display">Round 1 / ${ex.serie}</p>
                <div class="flex justify-center gap-4">
                    <button id="circuit-timer-pause-btn" class="btn btn-secondary"><i class="fas fa-pause"></i> Pausa</button>
                    <button id="circuit-timer-stop-btn" class="btn btn-danger"><i class="fas fa-stop"></i> Ferma</button>
                </div>
            `;

            document.getElementById('circuit-timer-stop-btn').onclick = stopIntervalTimer;
            document.getElementById('circuit-timer-pause-btn').onclick = toggleIntervalPause;

            timerModal.classList.remove('hidden');
            setTimeout(() => timerModal.classList.remove('opacity-0'), 10);

            if (intervalTimer.interval) clearInterval(intervalTimer.interval);
            startPhase('WORK');
        }

        function stopIntervalTimer() {
            clearInterval(intervalTimer.interval);
            intervalTimer.interval = null; // Reset state
            timerModal.classList.add('opacity-0');
            setTimeout(() => timerModal.classList.add('hidden'), 250);
        }

        function toggleIntervalPause() {
            const btn = document.getElementById('circuit-timer-pause-btn');
            if (intervalTimer.interval) {
                clearInterval(intervalTimer.interval);
                intervalTimer.interval = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Riprendi';
            } else {
                runIntervalTimer();
                btn.innerHTML = '<i class="fas fa-pause"></i> Pausa';
            }
        }

        function startPhase(phase) {
            intervalTimer.currentPhase = phase;
            const duration = phase === 'WORK' ? intervalTimer.workTime : intervalTimer.restTime;
            intervalTimer.totalSeconds = duration;
            
            const display = document.getElementById('circuit-timer-display');
            const phaseDisplay = document.getElementById('timer-phase-display');
            
            if (phase === 'WORK') {
                display.classList.remove('text-green-500');
                display.classList.add('text-red-500');
                phaseDisplay.textContent = 'FASE DI LAVORO';
            } else {
                display.classList.remove('text-red-500');
                display.classList.add('text-green-500');
                phaseDisplay.textContent = 'RECUPERO TRA ROUND';
            }
            
            if (intervalTimer.interval) clearInterval(intervalTimer.interval);
            runIntervalTimer();
        }

        function runIntervalTimer() {
            function updateDisplay() {
                const minutes = Math.floor(intervalTimer.totalSeconds / 60);
                const seconds = intervalTimer.totalSeconds % 60;
                document.getElementById('circuit-timer-display').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (intervalTimer.totalSeconds <= 0) {
                    handlePhaseEnd();
                } else {
                    intervalTimer.totalSeconds--;
                }
            }

            intervalTimer.interval = setInterval(updateDisplay, 1000);
        }

        function handlePhaseEnd() {
            clearInterval(intervalTimer.interval);
            showNotification(intervalTimer.currentPhase === 'WORK' ? 'Tempo di lavoro scaduto!' : 'Recupero finito!');
            
            if (intervalTimer.currentPhase === 'WORK') {
                if (intervalTimer.currentRound < intervalTimer.totalRounds) {
                    startPhase('REST');
                } else {
                    showNotification(`Circuito ${intervalTimer.exerciseName} completato!`);
                    stopIntervalTimer();
                }
            } else if (intervalTimer.currentPhase === 'REST') {
                intervalTimer.currentRound++;
                document.getElementById('timer-round-display').textContent = `Round ${intervalTimer.currentRound} / ${intervalTimer.totalRounds}`;
                showNotification(`Inizia Round ${intervalTimer.currentRound}!`);
                startPhase('WORK');
            }
        }
        // --- FINE GESTIONE TIMER CIRCUITO A INTERVALLI ---

        // --- VERIFICA E IMPOSTAZIONE ADMIN ---
        async function setupAdminAccount() {
            try {
                const adminQuery = query(collection(db, 'users'), where('role', '==', 'admin'));
                const adminSnapshot = await getDocs(adminQuery);
                if (adminSnapshot.empty) {
                    const email = 'naccio@live.it';
                    try {
                        await signInWithEmailAndPassword(auth, email, 'admin123');
                        const userCredential = auth.currentUser;
                        await setDoc(doc(db, 'users', userCredential.uid), { email, role: 'admin', createdAt: new Date().toISOString(), createdBy: 'system' }, { merge: true });
                        console.log('Account esistente promosso ad admin!');
                        await signOut(auth);
                    } catch (error) {
                        if (error.code === 'auth/user-not-found') {
                            try {
                                const userCredential = await createUserWithEmailAndPassword(auth, email, 'admin123');
                                await setDoc(doc(db, 'users', userCredential.user.uid), { email, role: 'admin', createdAt: new Date().toISOString(), createdBy: 'system' });
                                console.log('Admin creato con successo!');
                                await signOut(auth);
                            } catch (createError) { console.error('Errore creazione admin:', createError); }
                        } else {
                            console.error('Errore durante il setup dell\'admin:', error);
                        }
                    }
                } else {
                    console.log('Admin già presente nel sistema');
                }
            } catch (error) {
                console.error('Errore verifica admin:', error);
            }
        }

        // --- GESTIONE UTENTE SELEZIONATO (ADMIN) ---
        function selectUser(userId, userEmail) {
            selectedUserId = userId;
            selectedUserName.textContent = userEmail;
            userIndicator.classList.remove('hidden');
            resetState();
            renderAppView();
        }
        function deselectUser() {
            selectedUserId = null;
            userIndicator.classList.add('hidden');
            resetState();
            renderAppView();
        }
        backToAdminBtn.addEventListener('click', deselectUser);
        function resetState() {
            currentMesoId = null;
            currentSheetId = null;
            currentSheetData = null;
            currentWeek = 1;
            exercisesCache = [];
        }

        // --- GESTIONE AUTENTICAZIONE E UI PRINCIPALE ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (user.email === 'naccio@live.it') {
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        await setDoc(doc(db, 'users', user.uid), { email: user.email, role: 'admin' }, { merge: true });
                        currentUserRole = 'admin';
                    } else {
                        currentUserRole = userDoc.data().role || 'user';
                    }
                } else {
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role || 'user';
                    } else {
                        await setDoc(doc(db, 'users', user.uid), { email: user.email, role: 'user', createdAt: new Date().toISOString() });
                        currentUserRole = 'user';
                    }
                }
                renderAppView();
            } else {
                renderLoginView();
            }
        });

        function renderLoginView() {
            mainView.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-dumbbell text-red-500 text-5xl mb-6"></i>
                    <h2 class="text-2xl font-bold mb-4">Benvenuto in Gym App</h2>
                    <p class="text-secondary mb-8">Effettua il login per accedere alla tua area personale.</p>
                </div>`;
            userControls.innerHTML = `<button id="login-btn" class="btn">Accedi / Registrati</button>`;
            document.getElementById('login-btn').addEventListener('click', openAuthModal);
        }

        async function renderAppView() {
            userControls.innerHTML = `<div class="flex items-center gap-2"><span class="text-sm text-secondary hidden sm:block">Ciao, ${currentUser.email}</span><button id="logout-btn" class="btn btn-secondary">Logout</button></div>`;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            const isAdmin = currentUserRole === 'admin';
            mainView.innerHTML = `
                <div class="space-y-6">
                    <div id="last-workout-container" class="mb-6"></div>
                    ${isAdmin && !selectedUserId ? `
                    <div class="bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg">
                        <h3 class="text-lg font-bold text-white mb-3"><i class="fas fa-users mr-2 text-red-500"></i> Seleziona Utente</h3>
                        <div id="user-selector-container"></div>
                    </div>` : ''}
                    <div id="mesocycle-container" class="bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg"></div>
                    <div id="sheet-container" class="bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg hidden"></div>
                    <div id="sheet-content" class="hidden">
                        <div id="week-selector-container" class="mb-4"></div>
                        <div id="workout-controls-container" class="mb-4"></div>
                        <div id="sheet-volume-summary-container" class="mb-4"></div>
                        <div id="exercise-list-container" class="space-y-4"></div>
                        ${isAdmin ? `
                        <div class="mt-6 bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <button id="toggle-add-exercise-btn" class="btn w-full btn-secondary"><i class="fas fa-plus mr-2"></i> Aggiungi Esercizio</button>
                                <button id="add-from-favorites-btn" class="btn w-full btn-secondary"><i class="fas fa-star mr-2"></i> Aggiungi da Preferiti</button>
                            </div>
                            <div id="add-exercise-container" class="collapsible-content"></div>
                        </div>` : ''}
                        <div class="mt-6 text-center">
                            <button id="export-pdf-btn" class="btn btn-secondary"><i class="fas fa-file-pdf mr-2"></i> Esporta PDF</button>
                        </div>
                    </div>
                    <div id="initial-message" class="text-center p-8 text-secondary">
                        <i class="fas fa-clipboard-list text-4xl mb-4 text-stone-600"></i>
                        <p>Seleziona o crea un mesociclo per iniziare.</p>
                    </div>
                    ${isAdmin && !selectedUserId ? `
                    <div class="mt-6 bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg">
                        <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-user-shield mr-2 text-red-500"></i> Area Amministratore</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="manage-favorites-btn" class="btn btn-secondary"><i class="fas fa-star mr-2"></i> Gestisci Preferiti</button>
                            <button id="manage-users-btn" class="btn btn-secondary"><i class="fas fa-users-cog mr-2"></i> Gestisci Utenti</button>
                        </div>
                    </div>` : ''}
                </div>`;
            renderLastWorkoutRecap();
            if (isAdmin && !selectedUserId) {
                renderUserSelector();
            }
            renderMesocycleSelector();
        }

        // --- RIFERIMENTI DB DINAMICI ---
        const getMesocyclesRef = () => collection(db, 'users', selectedUserId || currentUser.uid, 'mesocycles');
        const getSheetsRef = (mesoId) => collection(db, 'users', selectedUserId || currentUser.uid, 'mesocycles', mesoId, 'trainingSheets');
        const getExercisesRef = (mesoId, sheetId) => collection(db, 'users', selectedUserId || currentUser.uid, 'mesocycles', mesoId, 'trainingSheets', sheetId, 'exercises');
        const getFavoriteExercisesRef = () => collection(db, 'favoriteExercises');
        const getUsersRef = () => collection(db, 'users');
        const getWorkoutHistoryRef = () => collection(db, 'users', selectedUserId || currentUser.uid, 'workoutHistory');

        // --- FUNZIONI MODAL E UTILITY ---
        function showNotification(message, type = "success") {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'warning' : ''}`;
            notification.innerHTML = `<div class="flex items-center"><i class="fas ${type === "error" ? "fa-exclamation-circle" : "fa-check-circle"} mr-2"></i><span>${message}</span></div>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showConfirmModal(message) {
            return new Promise(resolve => {
                confirmModal.classList.remove('hidden');
                document.getElementById('confirm-message').textContent = message;
                setTimeout(() => confirmModal.classList.remove('opacity-0'), 10);
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const cleanup = (result) => {
                    confirmModal.classList.add('opacity-0');
                    setTimeout(() => confirmModal.classList.add('hidden'), 250);
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };
                okBtn.onclick = () => cleanup(true);
                cancelBtn.onclick = () => cleanup(false);
            });
        }

        function openAuthModal() {
            authModal.classList.remove('hidden');
            setTimeout(() => authModal.classList.remove('opacity-0'), 10);
        }

        function closeAuthModal() {
            authModal.classList.add('opacity-0');
            setTimeout(() => authModal.classList.add('hidden'), 250);
        }
        authModal.addEventListener('click', (e) => { if (e.target === authModal) closeAuthModal(); });

        document.getElementById('toggle-auth-mode-btn').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-submit-btn').textContent = isLoginMode ? 'Accedi' : 'Registrati';
            document.getElementById('toggle-auth-mode-btn').textContent = isLoginMode ? 'Non hai un account? Registrati' : 'Hai già un account? Accedi';
            document.getElementById('auth-error').textContent = '';
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements.email.value;
            const password = e.target.elements.password.value;
            const authError = document.getElementById('auth-error');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            authError.textContent = '';
            authSubmitBtn.disabled = true;
            authSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Elaborazione...';
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, 'users', userCredential.user.uid), { email, role: 'user', createdAt: new Date().toISOString() });
                }
                closeAuthModal();
            } catch (error) {
                console.error("Authentication error:", error.code, error.message);
                authError.textContent = "Credenziali non valide o utente già esistente.";
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerHTML = isLoginMode ? 'Accedi' : 'Registrati';
            }
        });

        // --- FUNZIONI DI LOGICA PRINCIPALE ---
        async function renderUserSelector() {
            const container = document.getElementById('user-selector-container');
            if (!container) return;
            container.innerHTML = '<div class="loader"></div>';
            try {
                const usersSnapshot = await getDocs(getUsersRef());
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                let options = '<option value="">-- Seleziona un utente --</option>';
                users.forEach(user => {
                    options += `<option value="${user.id}">${user.email}</option>`;
                });
                container.innerHTML = `<select id="user-selector" class="input-field w-full">${options}</select>`;
                document.getElementById('user-selector').addEventListener('change', (e) => {
                    const userId = e.target.value;
                    if (userId) {
                        const selectedUser = users.find(u => u.id === userId);
                        if (selectedUser) selectUser(userId, selectedUser.email);
                    }
                });
            } catch (error) {
                console.error("Errore caricamento utenti:", error);
                container.innerHTML = '<p class="text-red-400 text-center">Errore durante il caricamento degli utenti.</p>';
            }
        }

        async function renderMesocycleSelector() {
            const mesocycleContainer = document.getElementById('mesocycle-container');
            if (!mesocycleContainer) return;
            const mesocyclesSnapshot = await getDocs(query(getMesocyclesRef(), orderBy("dataCreazione", "desc")));
            let options = '<option value="">-- Seleziona un mesociclo --</option>';
            mesocyclesSnapshot.forEach(doc => {
                options += `<option value="${doc.id}">${doc.data().nome}</option>`;
            });
            mesocycleContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-calendar-alt mr-2 text-red-500"></i> Mesociclo</h3>
                     <div class="flex items-center gap-2">
                         ${currentUserRole === 'admin' ? `<button id="analyze-volume-btn" class="btn btn-secondary !p-2 text-xs" title="Analisi Volume Mesociclo"><i class="fas fa-calculator"></i></button>` : ''}
                         ${currentUserRole === 'admin' ? `<button id="toggle-create-meso-btn" class="btn btn-secondary !p-2 text-xs" title="Crea Nuovo Mesociclo"><i class="fas fa-plus"></i></button>` : ''}
                    </div>
                </div>
                <select id="mesocycle-selector" class="input-field w-full">${options}</select>
                ${currentUserRole === 'admin' ? `
                <div id="create-meso-container" class="collapsible-content mt-3">
                    <form id="create-meso-form" class="space-y-3">
                        <input type="text" name="name" class="input-field" placeholder="Nome mesociclo..." required>
                        <button type="submit" class="btn w-full"><i class="fas fa-plus mr-2"></i> Crea</button>
                    </form>
                </div>` : ''}`;
            const mesoSelector = document.getElementById('mesocycle-selector');
            mesoSelector.addEventListener('change', (e) => selectMesocycle(e.target.value));
            if (currentUserRole === 'admin') {
                document.getElementById('create-meso-form').addEventListener('submit', handleCreateMeso);
                document.getElementById('toggle-create-meso-btn').addEventListener('click', () => document.getElementById('create-meso-container').classList.toggle('open'));
                document.getElementById('analyze-volume-btn').addEventListener('click', openVolumeAnalysisModal);
            }
            const effectiveUserId = selectedUserId || currentUser.uid;
            const lastMesoId = localStorage.getItem(`lastMesoId_${effectiveUserId}`);
            if (lastMesoId && mesoSelector.querySelector(`option[value="${lastMesoId}"]`)) {
                mesoSelector.value = lastMesoId;
                selectMesocycle(lastMesoId);
            }
        }

        async function selectMesocycle(mesoId) {
            currentMesoId = mesoId;
            const effectiveUserId = selectedUserId || currentUser.uid;
            localStorage.setItem(`lastMesoId_${effectiveUserId}`, mesoId || '');
            const sheetContent = document.getElementById('sheet-content');
            const initialMessage = document.getElementById('initial-message');
            const sheetContainer = document.getElementById('sheet-container');
            sheetContent.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            if (!mesoId) {
                sheetContainer.classList.add('hidden');
                return;
            }
            sheetContainer.classList.remove('hidden');
            await renderSheetSelector();
        }

        async function renderSheetSelector() {
            const sheetContainer = document.getElementById('sheet-container');
            const sheetsSnapshot = await getDocs(query(getSheetsRef(currentMesoId), orderBy("dataCreazione", "desc")));
            let options = '<option value="">-- Seleziona una scheda --</option>';
            sheetsSnapshot.forEach(doc => {
                const sheet = doc.data();
                options += `<option value="${doc.id}">${sheet.nomeScheda}${sheet.isCompleta ? ' (Completata)' : ''}</option>`;
            });
            sheetContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-clipboard-list mr-2 text-red-500"></i> Scheda di Allenamento</h3>
                    ${currentUserRole === 'admin' ? `<button id="toggle-create-sheet-btn" class="btn btn-secondary !p-2 text-xs"><i class="fas fa-plus"></i></button>` : ''}
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <select id="sheet-selector" class="input-field flex-grow">${options}</select>
                    <div class="flex items-center gap-3">
                        ${currentUserRole === 'admin' ? `
                        <button id="add-weeks-btn" class="btn btn-secondary" title="Aggiungi Settimane"><i class="fas fa-calendar-plus"></i></button> <button id="duplicate-sheet-btn" class="btn btn-secondary" title="Duplica Scheda"><i class="fas fa-copy"></i></button>
                        <button id="delete-sheet-btn" class="btn btn-danger" title="Elimina Scheda"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
                ${currentUserRole === 'admin' ? `
                <div id="create-sheet-container" class="collapsible-content mt-3">
                    <form id="create-sheet-form" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                        <input type="text" id="new-sheet-name" class="input-field flex-grow" placeholder="Nome nuova scheda..." required>
                        <input type="number" id="new-sheet-weeks" class="input-field sm:w-28" placeholder="Sett." min="1" required>
                        <button type="submit" class="btn !w-full sm:!w-auto"><i class="fas fa-plus mr-2"></i> Aggiungi</button>
                    </form>
                </div>` : ''}`;
            document.getElementById('sheet-selector').addEventListener('change', (e) => selectSheet(e.target.value));

            if (currentUserRole === 'admin') {
                document.getElementById('toggle-create-sheet-btn').addEventListener('click', () => document.getElementById('create-sheet-container').classList.toggle('open'));
                document.getElementById('create-sheet-form').addEventListener('submit', handleCreateSheet);
                document.getElementById('add-weeks-btn').addEventListener('click', handleAddWeeks);
                document.getElementById('duplicate-sheet-btn').addEventListener('click', handleDuplicateSheet);
                document.getElementById('delete-sheet-btn').addEventListener('click', handleDeleteSheet);
            }
        }

        async function selectSheet(sheetId) {
            Object.values(procrastinationTimers).forEach(clearTimeout);
            procrastinationTimers = {};

            const sheetContent = document.getElementById('sheet-content');
            const initialMessage = document.getElementById('initial-message');

            if (!sheetId) {
                sheetContent.classList.add('hidden');
                initialMessage.classList.remove('hidden');
                currentSheetId = null;
                return;
            }

            initialMessage.classList.add('hidden');
            sheetContent.classList.remove('hidden');
            currentSheetId = sheetId;
            currentWeek = 1;
            modifiedExercisesThisWeek = new Set();

            const sheetDocRef = doc(getSheetsRef(currentMesoId), sheetId);
            const sheetDocSnap = await getDoc(sheetDocRef);
            if (!sheetDocSnap.exists()) {
                showNotification("Scheda non trovata!", "error");
                return;
            }
            currentSheetData = sheetDocSnap.data();

            renderWeekSelector();
            renderWorkoutControls();
            renderSpecificRecap();
            if (currentUserRole === 'admin') {
                renderAddExerciseForm();
            }
            await loadAndRenderExercises();
        }
        async function loadAndRenderExercises() {
            const exerciseContainer = document.getElementById('exercise-list-container');
            exerciseContainer.innerHTML = '<div class="loader"></div>';
            const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
            const q = query(exercisesRef, orderBy("ordine"));
            const exercisesSnapshot = await getDocs(q);
            exercisesCache = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderExercises();
        }

        // --- RENDERING UI SPECIFICA ---
        function renderWeekSelector() {
            const weekSelectorContainer = document.getElementById('week-selector-container');
            const numWeeks = currentSheetData.numeroSettimane || 1;
            weekSelectorContainer.innerHTML = `<div class="flex items-center space-x-2 overflow-x-auto pb-1 no-scrollbar"></div>`;
            const container = weekSelectorContainer.firstElementChild;
            for (let i = 1; i <= numWeeks; i++) {
                const isCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === i);
                const btn = document.createElement('button');
                btn.innerHTML = `Sett. ${i} ${isCompleted ? '<i class="fas fa-check-circle ml-1 text-green-400"></i>' : ''}`;
                let classes = 'week-btn px-4 py-2 rounded-md font-semibold text-sm';
                if (i === currentWeek) classes += ' active';
                if (isCompleted) {
                    btn.classList.add('opacity-70', 'border-green-500/50');
                }
                btn.className = classes;
                btn.onclick = () => {
                     currentWeek = i;
                     modifiedExercisesThisWeek = new Set();
                    renderWeekSelector();
                     renderExercises();
                    renderWorkoutControls();
                };
                container.appendChild(btn);
            }
        }

        function calculateAndRenderSheetVolume() {
            const sheetVolumeSummaryContainer = document.getElementById('sheet-volume-summary-container');
            const volumeByMuscleGroup = {};

            for (const group in MACROCYCLE_RULES) {
                volumeByMuscleGroup[group] = 0;
            }

            exercisesCache.forEach(ex => {
                const { categoria, serie } = ex;
                if (!categoria || !serie) return;

                for (const group in MACROCYCLE_RULES) {
                    const rule = MACROCYCLE_RULES[group];
                    if (rule.main === categoria) {
                        volumeByMuscleGroup[group] += serie;
                    } else {
                        const additionalRule = rule.additional.find(r => r.category === categoria);
                        if (additionalRule) {
                            volumeByMuscleGroup[group] += serie * (additionalRule.percentage / 100);
                        }
                    }
                }
            });

            let summaryHTML = `<h3 class="text-lg font-bold mb-2 text-white"><i class="fas fa-chart-pie mr-2 text-red-500"></i> Volume Muscolare Totale</h3><div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">`;
            const sortedGroups = Object.keys(volumeByMuscleGroup).sort();
            let hasVolume = false;
            sortedGroups.forEach(group => {
                const volume = Math.round(volumeByMuscleGroup[group] * 10) / 10;
                if (volume > 0) {
                    hasVolume = true;
                    summaryHTML += `<div class="bg-stone-800/50 p-2 rounded"><span class="font-semibold text-secondary">${group}:</span> <span class="text-red-400 font-bold">${volume} serie</span></div>`;
                }
            });

            if (!hasVolume) {
                summaryHTML = '';
            } else {
                summaryHTML += `</div>`;
            }

            sheetVolumeSummaryContainer.innerHTML = summaryHTML;
        }

        function renderExercises() {
            const exerciseContainer = document.getElementById('exercise-list-container');
            exerciseContainer.innerHTML = '';
            if (exercisesCache.length === 0) {
                exerciseContainer.innerHTML = `<div class="text-center py-8"><i class="fas fa-dumbbell text-4xl text-stone-600 mb-4"></i><p class="text-secondary">Nessun esercizio. Aggiungine uno.</p></div>`;
            } else {
                exercisesCache.forEach(ex => exerciseContainer.appendChild(createExerciseCard(ex)));
            }
            calculateAndRenderSheetVolume();
        }

        function createExerciseCard(ex) {
            const card = document.createElement('div');
            card.id = `ex-card-${ex.id}`;
                         
            let cardClasses = 'bg-gradient-main p-3 rounded-lg border shadow-md transition-all duration-300';
            if (ex.isCircuit) {
                cardClasses += ' circuit-card';
            } else if (ex.tecnicheIntensita && ex.tecnicheIntensita.trim() !== '') {
                cardClasses += ' intensity-glow';
            } else {
                cardClasses += ' border-stone-800';
            }
            card.className = cardClasses;

            let seriesHTML = '<div class="space-y-2 mt-2">';
            
            // Check if it's the old format (just an array) or new format (object)
            let weeklyData = ex.datiSettimanali?.[currentWeek] || {};
            if (Array.isArray(weeklyData)) {
                // Migrate old array structure to new object structure (in memory for reading)
                weeklyData = { userNote: '', sets: weeklyData };
            }

            const setDataArray = weeklyData.sets || [];
            const userNoteContent = weeklyData.userNote || ''; // Get user note

            const prevWeeklyDataRaw = ex.datiSettimanali?.[currentWeek - 1] || {};
            const prevSetDataArray = (Array.isArray(prevWeeklyDataRaw) ? prevWeeklyDataRaw : prevWeeklyDataRaw.sets) || []; // Handle previous week format

            const targetReps = ex.ripetizioniPerSerie || [];
            
            for (let i = 0; i < ex.serie; i++) {
                let setData = setDataArray[i] || { carico: '', reps: '' };
                const prevSetData = prevSetDataArray[i] || null;
                const targetRep = targetReps[i] || ex.ripetizioni || '';
                
                // Logic for progressive overload suggestion (only for non-circuit)
                if (!ex.isCircuit && currentWeek > 1 && !setData.carico && prevSetData?.carico && prevSetData?.reps) {
                    const repRange = (targetRep.toString() || "").split('-').map(Number);
                    const maxReps = repRange.length > 1 ? repRange[1] : repRange[0];
                    if (parseInt(prevSetData.reps, 10) >= maxReps) {
                        setData.carico = (parseFloat(prevSetData.carico) + WEIGHT_INCREMENT).toString();
                    } else {
                        setData.carico = prevSetData.carico;
                    }
                }
                
                let prevWeekHint = prevSetData ? `<p class="text-xs text-stone-500 text-right col-span-5 mb-1"><i class="fas fa-history mr-1"></i> Sett. prec: ${prevSetData.carico || '-'}kg x ${prevSetData.reps || '-'}</p>` : '';
                
                // Determine timer button action
                let timerButton;
                if (ex.isCircuit) {
                    timerButton = `<button class="btn btn-secondary !p-2 text-xs" data-circuit-ex-id="${ex.id}" title="Avvia Timer Circuito"><i class="fas fa-stopwatch-20"></i></button>`;
                } else {
                    timerButton = `<button class="btn btn-secondary !p-2 text-xs" data-timer="${ex.recupero}" title="Avvia timer recupero"><i class="fas fa-stopwatch"></i></button>`;
                }

                seriesHTML += `
                        ${prevWeekHint}
                        <div class="grid grid-cols-5 items-center gap-2">
                            <span class="font-semibold text-secondary text-sm">S ${i + 1} (${targetRep})</span>
                            <input type="number" step="0.5" placeholder="kg" class="input-field !p-2 text-center" value="${setData.carico}" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="carico">
                            <input type="number" placeholder="reps" class="input-field !p-2 text-center" value="${setData.reps}" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="reps">
                            <span class="text-xs text-center text-red-400 font-mono" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="1rm">~% 1RM</span>
                            ${timerButton}
                        </div>`;
            }
            seriesHTML += '</div>';

            let imagesHTML = '';
            const imageUrls = [ex.imageUrl, ex.imageUrl2, ex.imageUrl3, ex.imageUrl4].filter(url => url);
            if (imageUrls.length > 0) {
                if (imageUrls.length > 2) { // Use grid for 3 or 4 images
                    imagesHTML += `<div class="image-grid">`;
                    imageUrls.forEach(url => {
                        imagesHTML += `<div><img src="${url}" alt="${ex.nomeEsercizio}" class="exercise-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/374151/E5E7EB?text=NO_IMG';"></div>`;
                    });
                    imagesHTML += `</div>`;
                } else { // Use flex for 1 or 2 images
                    imagesHTML += `<div class="flex gap-2 mt-2 justify-center">`;
                    imageUrls.forEach(url => {
                        imagesHTML += `<div class="${imageUrls.length === 1 ? 'w-1/2 max-w-[200px]' : 'w-1/2'}"><img src="${url}" alt="${ex.nomeEsercizio}" class="exercise-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/374151/E5E7EB?text=NO_IMG';"></div>`;
                    });
                    imagesHTML += '</div>';
                }
            }

            const repsDisplay = ex.ripetizioniPerSerie && ex.ripetizioniPerSerie.length > 0 ? ex.ripetizioniPerSerie.join(' / ') : (ex.ripetizioni || '');

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow pr-4">
                        <h4 class="text-lg font-bold text-white">${ex.nomeEsercizio} ${ex.isCircuit ? '<span class="reward-badge !bg-amber-500 !text-amber-900">CIRCUITO</span>' : ''}</h4>
                        <p class="text-sm text-red-500"><i class="fas fa-tag mr-1"></i> ${ex.categoria}</p>
                        <p class="text-xs text-secondary mt-1">
                            <i class="fas fa-list-ol mr-1"></i> S: ${ex.serie} | 
                            <i class="fas fa-redo mr-1 ml-2"></i> R: ${repsDisplay} |
                            ${ex.isCircuit ? `<i class="fas fa-clock mr-1 ml-2"></i> Lavoro: ${ex.circuitWorkTime || '-'}s | Rec Round: ${ex.circuitRestTime || '-'}s |` : ''}
                            <i class="fas fa-fire mr-1 ml-2"></i> RIR: ${ex.rir || '-'} | 
                            <i class="fas fa-hourglass-half mr-1 ml-2"></i> Rec: ${ex.recupero || '-'}s | 
                            <i class="fas fa-stopwatch-20 mr-1 ml-2"></i> TUT: ${ex.tut || '-'}
                        </p>
                        ${ex.tecnicheIntensita ? `<p class="text-sm text-red-400 mt-2 font-semibold"><i class="fas fa-bolt mr-2"></i> ${ex.tecnicheIntensita}</p>` : ''}
                        
                        <!-- Coach Note (Persistent) -->
                        ${ex.note ? `<p class="text-sm text-stone-300 mt-2 border-t border-stone-700/50 pt-2"><i class="fas fa-comment-dots mr-1 text-red-400"></i><span class="font-semibold text-red-400">Nota Coach (Persistente):</span> ${ex.note}</p>` : ''}
                    </div>
                    <div class="flex items-start gap-2">
                        <div class="flex flex-col gap-1">
                            <button class="btn btn-secondary !p-1 reorder-btn" data-reorder-ex-id="${ex.id}" data-direction="up" title="Sposta su"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn btn-secondary !p-1 reorder-btn" data-reorder-ex-id="${ex.id}" data-direction="down" title="Sposta giù"><i class="fas fa-arrow-down"></i></button>
                        </div>
                        <div class="flex flex-col gap-1">
                            <button class="btn btn-secondary !p-2" data-save-fav-ex-id="${ex.id}" title="Salva nei preferiti"><i class="fas fa-star"></i></button>
                            <button class="btn btn-secondary !p-2" data-edit-ex-id="${ex.id}" title="Modifica"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary !p-2" data-history-ex-id="${ex.id}" title="Storico"><i class="fas fa-chart-line"></i></button>
                            <button class="btn btn-danger !p-2" data-delete-ex-id="${ex.id}" title="Elimina"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
                ${imagesHTML}
                ${seriesHTML}
                <!-- User Note (Weekly) -->
                <div class="mt-4 pt-3 border-t border-stone-800">
                    <label for="user-note-${ex.id}" class="text-xs text-secondary mb-1 block font-semibold">La tua Nota (Settimana ${currentWeek}, privata):</label>
                    <textarea id="user-note-${ex.id}" class="textarea-field !p-2 text-sm" data-ex-id="${ex.id}" data-field="userNote" placeholder="Es. Sentito bene, aumento il carico prossima settimana">${userNoteContent}</textarea>
                </div>
                `;
                         
            const repsInputs = card.querySelectorAll('input[data-field="reps"]');
            repsInputs.forEach(input => {
                const reps = parseInt(input.value, 10);
                const serieIndex = input.dataset.serieIndex;
                const oneRmSpan = card.querySelector(`span[data-field="1rm"][data-serie-index="${serieIndex}"]`);
                if (oneRmSpan) {
                    oneRmSpan.textContent = calculate1RMEstimate(reps);
                }
            });
            return card;
        }

        function generateRepInputs(container, numSeries, values = []) {
            container.innerHTML = '';
            if (numSeries > 0) {
                const label = document.createElement('label');
                label.className = 'text-sm text-secondary col-span-full';
                label.textContent = 'Ripetizioni per Serie';
                container.appendChild(label);
            }
            for (let i = 0; i < numSeries; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'ripetizioniPerSerie';
                input.className = 'input-field !p-2 text-center';
                input.placeholder = `S ${i + 1}`;
                input.value = values[i] || '';
                container.appendChild(input);
            }
        }

        function renderAddExerciseForm() {
            const addExerciseContainer = document.getElementById('add-exercise-container');
            const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            addExerciseContainer.innerHTML = `
                <form id="add-exercise-form" class="space-y-4">
                    <input type="text" name="nomeEsercizio" class="input-field" placeholder="Nome Esercizio" required>
                    <select name="categoria" class="input-field" required>${categoryOptions}</select>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                        <input type="number" name="serie" class="input-field" placeholder="N° Serie" required>
                        <input type="text" name="ripetizioni" class="input-field" placeholder="Reps (es. 8-12)">
                        <input type="text" name="rir" class="input-field" placeholder="RIR (es. 1-2)">
                        <input type="text" name="tut" class="input-field" placeholder="TUT (es. 2-1-1)">
                        <input type="number" name="recupero" class="input-field" placeholder="Recupero (s)">
                    </div>
                    <div id="add-ripetizioni-per-serie-container" class="grid grid-cols-3 sm:grid-cols-6 gap-2 mt-2"></div>
                    <input type="text" name="tecnicheIntensita" class="input-field" placeholder="Tecnica di Intensità (es. Dropset)">
                    <textarea name="note" class="textarea-field" placeholder="Nota Coach (Opzionale - persistente ogni settimana)"></textarea>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-secondary">Immagine 1</label>
                            <input type="url" name="imageUrl" class="input-field mb-2" placeholder="URL Immagine 1">
                            <input type="file" name="imageFile1" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                        </div>
                        <div>
                            <label class="text-sm text-secondary">Immagine 2</label>
                            <input type="url" name="imageUrl2" class="input-field mb-2" placeholder="URL Immagine 2">
                            <input type="file" name="imageFile2" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="isCircuit" class="h-4 w-4 rounded bg-stone-700 border-stone-600 text-red-600 focus:ring-red-500">
                            <span class="text-secondary">È un circuito?</span>
                        </label>
                    </div>
                    <!-- Nuovi campi per Circuito -->
                    <div id="add-circuit-fields" class="hidden space-y-4 pt-4 border-t border-stone-700">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="number" name="circuitWorkTime" class="input-field" placeholder="Tempo Lavoro per round (secondi)">
                            <input type="number" name="circuitRestTime" class="input-field" placeholder="Recupero tra Round (secondi)">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-secondary">Immagine 3</label>
                                <input type="url" name="imageUrl3" class="input-field mb-2" placeholder="URL Immagine 3">
                                <input type="file" name="imageFile3" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                            </div>
                            <div>
                                <label class="text-sm text-secondary">Immagine 4</label>
                                <input type="url" name="imageUrl4" class="input-field mb-2" placeholder="URL Immagine 4">
                                <input type="file" name="imageFile4" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn w-full !mt-6">Aggiungi Esercizio</button>
                </form>`;
            
            const addForm = document.getElementById('add-exercise-form');
            addForm.elements.serie.addEventListener('input', (e) => {
                const numSeries = parseInt(e.target.value, 10) || 0;
                const container = addForm.querySelector('#add-ripetizioni-per-serie-container');
                generateRepInputs(container, numSeries);
            });
            addForm.elements.isCircuit.addEventListener('change', (e) => {
                document.getElementById('add-circuit-fields').classList.toggle('hidden', !e.target.checked);
            });
            addForm.addEventListener('submit', handleAddExercise);
        }

        // --- GESTIONE EVENTI E AZIONI ---
        async function handleCreateMeso(e) {
            e.preventDefault();
            const form = e.target;
            const mesoName = form.elements['name'].value.trim();
            if (!mesoName) return;
            await addDoc(getMesocyclesRef(), { nome: mesoName, dataCreazione: new Date().toISOString() });
            await renderMesocycleSelector();
            showNotification("Mesociclo creato con successo!");
        }

        async function handleCreateSheet(e) {
            e.preventDefault();
            const form = e.target;
            const sheetName = form.elements['new-sheet-name'].value.trim();
            const numWeeks = parseInt(form.elements['new-sheet-weeks'].value, 10);
            if (!sheetName || !numWeeks) return;
            await addDoc(getSheetsRef(currentMesoId), { nomeScheda: sheetName, numeroSettimane: numWeeks, dataCreazione: new Date().toISOString(), isCompleta: false, completedWeeks: [] });
            await renderSheetSelector();
            showNotification("Scheda creata con successo!");
        }

        async function handleDuplicateSheet() {
            if (!currentSheetId) { showNotification("Seleziona una scheda da duplicare.", "warning"); return; }
            const newName = prompt("Nuovo nome per la scheda:", `${currentSheetData.nomeScheda} (Copia)`);
            if (!newName) return;
            const newSheetRef = await addDoc(getSheetsRef(currentMesoId), { ...currentSheetData, nomeScheda: newName, dataCreazione: new Date().toISOString(), isCompleta: false });
            const exercisesSnapshot = await getDocs(getExercisesRef(currentMesoId, currentSheetId));
            const batch = writeBatch(db);
            exercisesSnapshot.forEach(exDoc => {
                const newExerciseRef = doc(getExercisesRef(currentMesoId, newSheetRef.id));
                batch.set(newExerciseRef, exDoc.data());
            });
            await batch.commit();
            showNotification(`Scheda "${newName}" creata!`);
            await renderSheetSelector();
        }

        async function handleDeleteSheet() {
            if (!currentSheetId) { showNotification("Seleziona una scheda da eliminare.", "warning"); return; }
            if (await showConfirmModal(`Sei sicuro di voler eliminare la scheda "${currentSheetData.nomeScheda}"?`)) {
                const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
                const exercisesSnapshot = await getDocs(exercisesRef);
                const batch = writeBatch(db);
                exercisesSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await deleteDoc(doc(getSheetsRef(currentMesoId), currentSheetId));
                showNotification("Scheda eliminata.");
                currentSheetId = null;
                document.getElementById('sheet-content').classList.add('hidden');
                document.getElementById('initial-message').classList.remove('hidden');
                await renderSheetSelector();
            }
        }

        async function handleAddWeeks() {
            if (!currentSheetId || !currentSheetData) {
                showNotification("Seleziona una scheda per aggiungere settimane.", "warning");
                return;
            }

            const weeksToAddStr = prompt("Quante settimane vuoi aggiungere?");
            if (!weeksToAddStr) return;
            const weeksToAdd = parseInt(weeksToAddStr, 10);
            if (isNaN(weeksToAdd) || weeksToAdd <= 0) {
                showNotification("Inserisci un numero di settimane valido e positivo.", "error");
                return;
            }

            const currentWeeks = currentSheetData.numeroSettimane || 0;
            const newTotalWeeks = currentWeeks + weeksToAdd;

            try {
                const sheetRef = doc(getSheetsRef(currentMesoId), currentSheetId);
                await updateDoc(sheetRef, { numeroSettimane: newTotalWeeks });
                currentSheetData.numeroSettimane = newTotalWeeks;
                renderWeekSelector();
                showNotification(`${weeksToAdd} settimana(e) aggiunta(e) con successo! Totale: ${newTotalWeeks}.`, "success");
            } catch (error) {
                console.error("Errore durante l'aggiunta di settimane:", error);
                showNotification("Si è verificato un errore durante l'aggiornamento.", "error");
            }
        }

        async function uploadImage(file) {
            if (!file) return null;
            const storageRef = ref(storage, `exercise_images/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (error) {
                console.error("Errore durante l'upload dell'immagine:", error);
                showNotification("Errore upload immagine.", "error");
                return null;
            }
        }

        async function handleAddExercise(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Aggiungo...';

            const imageFile1 = form.elements.imageFile1.files[0];
            const imageFile2 = form.elements.imageFile2.files[0];
            const imageUrl1 = await uploadImage(imageFile1);
            const imageUrl2 = await uploadImage(imageFile2);
                          
            const isCircuit = form.elements.isCircuit.checked;
            let imageUrl3 = null, imageUrl4 = null;
            let circuitWorkTime = null, circuitRestTime = null;

            if (isCircuit) {
                const imageFile3 = form.elements.imageFile3.files[0];
                const imageFile4 = form.elements.imageFile4.files[0];
                imageUrl3 = await uploadImage(imageFile3);
                imageUrl4 = await uploadImage(imageFile4);
                
                circuitWorkTime = parseInt(form.elements.circuitWorkTime.value, 10) || null;
                circuitRestTime = parseInt(form.elements.circuitRestTime.value, 10) || null;
            }

            const newExercise = {
                nomeEsercizio: form.elements.nomeEsercizio.value,
                categoria: form.elements.categoria.value,
                ordine: (exercisesCache.length || 0) + 1,
                serie: parseInt(form.elements.serie.value, 10),
                ripetizioni: form.elements.ripetizioni.value,
                rir: form.elements.rir.value || "",
                tut: form.elements.tut.value || "",
                recupero: parseInt(form.elements.recupero.value, 10) || null,
                tecnicheIntensita: form.elements.tecnicheIntensita.value || "",
                note: form.elements.note.value || "", // Coach/Persistent Note
                imageUrl: imageUrl1 || form.elements.imageUrl.value || "",
                imageUrl2: imageUrl2 || form.elements.imageUrl2.value || "",
                ripetizioniPerSerie: Array.from(form.querySelectorAll('input[name="ripetizioniPerSerie"]')).map(input => input.value),
                datiSettimanali: {},
                isCircuit: isCircuit,
                circuitWorkTime: circuitWorkTime, // New circuit field
                circuitRestTime: circuitRestTime, // New circuit field
                imageUrl3: isCircuit ? (imageUrl3 || form.elements.imageUrl3.value || "") : "",
                imageUrl4: isCircuit ? (imageUrl4 || form.elements.imageUrl4.value || "") : ""
            };

            await addDoc(getExercisesRef(currentMesoId, currentSheetId), newExercise);
            form.reset();
            document.getElementById('add-ripetizioni-per-serie-container').innerHTML = ''; // Clear reps per series
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Aggiungi Esercizio';
            document.getElementById('add-circuit-fields').classList.add('hidden');
            document.getElementById('add-exercise-container').classList.remove('open');
            await loadAndRenderExercises();
            showNotification("Esercizio aggiunto!");
        }

        async function handleReorderExercise(exId, direction) {
            const currentIndex = exercisesCache.findIndex(ex => ex.id === exId);
            if (currentIndex === -1) return;
            const otherIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (otherIndex < 0 || otherIndex >= exercisesCache.length) return;

            const [currentExercise, otherExercise] = [exercisesCache[currentIndex], exercisesCache[otherIndex]];
            const [currentOrder, otherOrder] = [currentExercise.ordine, otherExercise.ordine];

            const batch = writeBatch(db);
            batch.update(doc(getExercisesRef(currentMesoId, currentSheetId), currentExercise.id), { ordine: otherOrder });
            batch.update(doc(getExercisesRef(currentMesoId, currentSheetId), otherExercise.id), { ordine: currentOrder });

            await batch.commit();
            await loadAndRenderExercises();
        }
        async function handleSaveToFavorites(exercise) {
            const { datiSettimanali, id, ...favData } = exercise;
             await addDoc(getFavoriteExercisesRef(), favData);
            showNotification(`"${favData.nomeEsercizio}" salvato nei preferiti!`);
        }
        
        mainView.addEventListener('input', (e) => {
            if (e.target.matches('input[data-ex-id]')) {
                const { exId, serieIndex, field } = e.target.dataset;
                const value = e.target.value;
                const weekForSave = currentWeek;
                
                // Clear set-specific timeout
                const key = `${exId}-${weekForSave}-${serieIndex}-${field}`;
                clearTimeout(saveTimeouts[key]);
                saveTimeouts[key] = setTimeout(() => saveWeeklyData(exId, parseInt(serieIndex, 10), field, value, weekForSave), 800);

                if (field === 'reps') {
                    const card = e.target.closest('.bg-gradient-main');
                    if (card) {
                        const oneRmSpan = card.querySelector(`span[data-field="1rm"][data-serie-index="${serieIndex}"]`);
                        if (oneRmSpan) oneRmSpan.textContent = calculate1RMEstimate(parseInt(value, 10));
                    }
                    handleProcrastinationCheck(exId, parseInt(serieIndex, 10), e.target);
                } else if (field === 'carico') {
                    clearProcrastinationTimer(exId);
                }
            } else if (e.target.matches('textarea[data-ex-id][data-field="userNote"]')) {
                const { exId, field } = e.target.dataset;
                const value = e.target.value;
                const weekForSave = currentWeek;

                // Clear userNote timeout (no serieIndex here)
                const key = `${exId}-${weekForSave}-userNote`;
                clearTimeout(saveTimeouts[key]);
                saveTimeouts[key] = setTimeout(() => saveWeeklyData(exId, null, field, value, weekForSave), 800);
            }
        });

        mainView.addEventListener('click', async (e) => {
            const reorderBtn = e.target.closest('button[data-reorder-ex-id]');
            const editBtn = e.target.closest('button[data-edit-ex-id]');
            const deleteBtn = e.target.closest('button[data-delete-ex-id]');
            const timerBtn = e.target.closest('button[data-timer]');
            const circuitTimerBtn = e.target.closest('button[data-circuit-ex-id]');
            const saveFavBtn = e.target.closest('button[data-save-fav-ex-id]');
            const historyBtn = e.target.closest('button[data-history-ex-id]');

            if (reorderBtn) {
                await handleReorderExercise(reorderBtn.dataset.reorderExId, reorderBtn.dataset.direction);
            } else if (editBtn) {
                openEditExerciseModal(editBtn.dataset.editExId);
            } else if (historyBtn) {
                openExerciseHistoryModal(historyBtn.dataset.historyExId);
            } else if (deleteBtn) {
                if (await showConfirmModal('Eliminare questo esercizio?')) {
                    await deleteDoc(doc(getExercisesRef(currentMesoId, currentSheetId), deleteBtn.dataset.deleteExId));
                    await loadAndRenderExercises();
                    showNotification("Esercizio eliminato!");
                }
            } else if (timerBtn) {
                const time = parseInt(timerBtn.dataset.timer, 10);
                if (time) startTimerModal(time);
            } else if (circuitTimerBtn) {
                const exercise = exercisesCache.find(ex => ex.id === circuitTimerBtn.dataset.circuitExId);
                if (exercise) startIntervalCircuitTimer(exercise);
            } else if (saveFavBtn) {
                const exerciseToSave = exercisesCache.find(ex => ex.id === saveFavBtn.dataset.saveFavExId);
                if (exerciseToSave) await handleSaveToFavorites(exerciseToSave);
            } else if (e.target.id === 'toggle-add-exercise-btn') {
                document.getElementById('add-exercise-container').classList.toggle('open');
            } else if (e.target.id === 'add-from-favorites-btn') {
                openFavoritesModal();
            } else if (e.target.id === 'export-pdf-btn') {
                previewAndExportPDF();
            } else if (e.target.id === 'manage-favorites-btn') {
                openFavoritesModal();
            } else if (e.target.id === 'manage-users-btn') {
                openUserManagementModal();
            }
        });

        async function saveWeeklyData(exId, serieIndex, field, value, week) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise) return;

            const updatedDati = JSON.parse(JSON.stringify(exercise.datiSettimanali || {}));
            
            // Handle old array format by normalizing
            if (Array.isArray(updatedDati[week])) {
                updatedDati[week] = { userNote: '', sets: updatedDati[week] };
            }
            if (!updatedDati[week]) updatedDati[week] = { userNote: '', sets: [] };

            if (field === 'carico' || field === 'reps') {
                const setArray = updatedDati[week].sets;
                while (setArray.length <= serieIndex) setArray.push({ carico: '', reps: '' });
                setArray[serieIndex][field] = value;
            } else if (field === 'userNote') {
                updatedDati[week].userNote = value;
            } else {
                return; // Non-handled field
            }

            const sheetRef = doc(getSheetsRef(currentMesoId), currentSheetId);
            const exerciseRef = doc(getExercisesRef(currentMesoId, currentSheetId), exId);

            const batch = writeBatch(db);
            batch.update(exerciseRef, { datiSettimanali: updatedDati });
            batch.update(sheetRef, { lastModified: new Date().toISOString() });
            await batch.commit();

            exercise.datiSettimanali = updatedDati;
            currentSheetData.lastModified = new Date().toISOString();

            if (week === currentWeek) {
                renderSpecificRecap();
                calculateAndRenderSheetVolume();
            }
        }

        // --- MODIFICA, RIORDINO E PREFERITI (MODAL) ---
        function openEditExerciseModal(exId) {
             const exercise = exercisesCache.find(ex => ex.id === exId);
             if (!exercise) return;
             const container = document.getElementById('edit-exercise-container');
             const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}" ${exercise.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
             container.innerHTML = `
                 <form id="edit-exercise-form" class="space-y-4" data-ex-id="${exId}">
                     <input type="text" name="nomeEsercizio" class="input-field" value="${exercise.nomeEsercizio || ''}" required>
                     <select name="categoria" class="input-field" required>${categoryOptions}</select>
                     <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                         <input type="number" name="serie" class="input-field" value="${exercise.serie || ''}" placeholder="N° Serie" required>
                         <input type="text" name="ripetizioni" class="input-field" value="${exercise.ripetizioni || ''}" placeholder="Reps (es. 8-12)">
                         <input type="text" name="rir" class="input-field" value="${exercise.rir || ''}" placeholder="RIR (es. 1-2)">
                         <input type="text" name="tut" class="input-field" value="${exercise.tut || ''}" placeholder="TUT (es. 2-1-1)">
                         <input type="number" name="recupero" class="input-field" value="${exercise.recupero || ''}" placeholder="Recupero (s)">
                     </div>
                     <div id="edit-ripetizioni-per-serie-container" class="grid grid-cols-3 sm:grid-cols-6 gap-2 mt-2"></div>
                     <input type="text" name="tecnicheIntensita" class="input-field" value="${exercise.tecnicheIntensita || ''}" placeholder="Tecnica di Intensità (es. Dropset)">
                     <textarea name="note" class="textarea-field" placeholder="Nota Coach (Opzionale - persistente ogni settimana)">${exercise.note || ''}</textarea>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                             <label class="text-sm text-secondary">Immagine 1</label>
                             <input type="url" name="imageUrl" class="input-field mb-2" value="${exercise.imageUrl || ''}" placeholder="URL Immagine 1">
                             <input type="file" name="imageFile1" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                         </div>
                         <div>
                             <label class="text-sm text-secondary">Immagine 2</label>
                             <input type="url" name="imageUrl2" class="input-field mb-2" value="${exercise.imageUrl2 || ''}" placeholder="URL Immagine 2">
                             <input type="file" name="imageFile2" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                         </div>
                     </div>
                     <div class="mt-4">
                         <label class="flex items-center space-x-3 cursor-pointer">
                             <input type="checkbox" name="isCircuit" class="h-4 w-4 rounded bg-stone-700 border-stone-600 text-red-600 focus:ring-red-500" ${exercise.isCircuit ? 'checked' : ''}>
                             <span class="text-secondary">È un circuito?</span>
                         </label>
                     </div>
                     <!-- Nuovi campi per Circuito in Edit -->
                     <div id="edit-circuit-fields" class="${exercise.isCircuit ? '' : 'hidden'} space-y-4 pt-4 border-t border-stone-700">
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <input type="number" name="circuitWorkTime" class="input-field" value="${exercise.circuitWorkTime || ''}" placeholder="Tempo Lavoro per round (secondi)">
                             <input type="number" name="circuitRestTime" class="input-field" value="${exercise.circuitRestTime || ''}" placeholder="Recupero tra Round (secondi)">
                         </div>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <label class="text-sm text-secondary">Immagine 3</label>
                                 <input type="url" name="imageUrl3" class="input-field mb-2" value="${exercise.imageUrl3 || ''}" placeholder="URL Immagine 3">
                                 <input type="file" name="imageFile3" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                             </div>
                             <div>
                                 <label class="text-sm text-secondary">Immagine 4</label>
                                 <input type="url" name="imageUrl4" class="input-field mb-2" value="${exercise.imageUrl4 || ''}" placeholder="URL Immagine 4">
                                 <input type="file" name="imageFile4" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-stone-700 file:text-stone-300 hover:file:bg-stone-600">
                             </div>
                         </div>
                     </div>
                     <div class="flex justify-end gap-4 pt-4">
                         <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Annulla</button>
                         <button type="submit" class="btn">Salva Modifiche</button>
                     </div>
                 </form>`;
             const editForm = document.getElementById('edit-exercise-form');
             const seriesInput = editForm.elements.serie;
             const repsContainer = editForm.querySelector('#edit-ripetizioni-per-serie-container');

             generateRepInputs(repsContainer, exercise.serie, exercise.ripetizioniPerSerie);

             seriesInput.addEventListener('input', (e) => {
                 const numSeries = parseInt(e.target.value, 10) || 0;
                 const currentValues = Array.from(repsContainer.querySelectorAll('input')).map(input => input.value);
                 generateRepInputs(repsContainer, numSeries, currentValues);
             });
                          
             editForm.elements.isCircuit.addEventListener('change', (e) => {
                 document.getElementById('edit-circuit-fields').classList.toggle('hidden', !e.target.checked);
             });

             editExerciseModal.classList.remove('hidden');
             setTimeout(() => editExerciseModal.classList.remove('opacity-0'), 10);
             editForm.addEventListener('submit', handleUpdateExercise);
             document.getElementById('cancel-edit-btn').addEventListener('click', closeEditExerciseModal);
         }
        function closeEditExerciseModal() {
             editExerciseModal.classList.add('opacity-0');
             setTimeout(() => editExerciseModal.classList.add('hidden'), 250);
         }
        async function handleUpdateExercise(e) {
             e.preventDefault();
             const form = e.target;
             const exId = form.dataset.exId;
             const submitBtn = form.querySelector('button[type="submit"]');
             submitBtn.disabled = true;
             submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvataggio...';

             const imageFile1 = form.elements.imageFile1.files[0];
             const imageFile2 = form.elements.imageFile2.files[0];
             const imageUrl1 = await uploadImage(imageFile1);
             const imageUrl2 = await uploadImage(imageFile2);
                          
             const isCircuit = form.elements.isCircuit.checked;
             let imageUrl3 = null, imageUrl4 = null;
             let circuitWorkTime = null, circuitRestTime = null;
             
             if (isCircuit) {
                 const imageFile3 = form.elements.imageFile3.files[0];
                 const imageFile4 = form.elements.imageFile4.files[0];
                 imageUrl3 = await uploadImage(imageFile3);
                 imageUrl4 = await uploadImage(imageFile4);
                 
                 circuitWorkTime = parseInt(form.elements.circuitWorkTime.value, 10) || null;
                 circuitRestTime = parseInt(form.elements.circuitRestTime.value, 10) || null;
             }

             const updatedData = {
                 nomeEsercizio: form.elements.nomeEsercizio.value,
                 categoria: form.elements.categoria.value,
                 serie: parseInt(form.elements.serie.value, 10),
                 ripetizioni: form.elements.ripetizioni.value,
                 rir: form.elements.rir.value,
                 tut: form.elements.tut.value,
                 recupero: parseInt(form.elements.recupero.value, 10) || null,
                 tecnicheIntensita: form.elements.tecnicheIntensita.value,
                 note: form.elements.note.value, // Coach/Persistent Note
                 imageUrl: imageUrl1 || form.elements.imageUrl.value,
                 imageUrl2: imageUrl2 || form.elements.imageUrl2.value,
                 ripetizioniPerSerie: Array.from(form.querySelectorAll('input[name="ripetizioniPerSerie"]')).map(input => input.value),
                 isCircuit: isCircuit,
                 circuitWorkTime: circuitWorkTime, // New circuit field
                 circuitRestTime: circuitRestTime, // New circuit field
                 imageUrl3: isCircuit ? (imageUrl3 || form.elements.imageUrl3.value || "") : "",
                 imageUrl4: isCircuit ? (imageUrl4 || form.elements.imageUrl4.value || "") : ""
             };
             await updateDoc(doc(getExercisesRef(currentMesoId, currentSheetId), exId), updatedData);
             closeEditExerciseModal();
             await loadAndRenderExercises();
             showNotification("Esercizio aggiornato!");
         }

        function openExerciseHistoryModal(exId) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise) {
                showNotification("Esercizio non trovato.", "error");
                return;
            }

            const container = document.getElementById('exercise-history-container');
            document.getElementById('history-modal-title').textContent = `Storico: ${exercise.nomeEsercizio}`;
            container.innerHTML = '<div class="loader"></div>';

            const historyData = exercise.datiSettimanali || {};
            const weeks = Object.keys(historyData).map(Number).sort((a, b) => a - b);

            if (weeks.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">Nessun dato registrato per questo esercizio.</p>';
            } else {
                let historyHTML = `<div class="max-h-[60vh] overflow-y-auto pr-2 space-y-4">`;
                let lastBestE1RM = 0;

                weeks.forEach(week => {
                    let weekDataRaw = historyData[week];
                    if (Array.isArray(weekDataRaw)) {
                        // Handle old format
                        weekDataRaw = { userNote: '', sets: weekDataRaw };
                    }
                    const weekData = weekDataRaw.sets;
                    const userNote = weekDataRaw.userNote;

                    if (!weekData || weekData.length === 0) return;

                    let bestSetThisWeek = { e1rm: 0, text: 'N/D' };
                    let setsHTML = '';
                    weekData.forEach((set, index) => {
                        if (set && set.carico && set.reps) {
                            const e1rm = calculateE1RM(set.carico, set.reps);
                            if (e1rm > bestSetThisWeek.e1rm) {
                                bestSetThisWeek = { e1rm, text: `${set.carico}kg x ${set.reps}` };
                            }
                            setsHTML += `<div class="text-sm text-stone-300"><b>Set ${index + 1}:</b> ${set.carico}kg x ${set.reps} reps</div>`;
                        }
                    });

                    let progressIndicator = '';
                    if (bestSetThisWeek.e1rm > 0) {
                        if (lastBestE1RM > 0) {
                            if (bestSetThisWeek.e1rm > lastBestE1RM) {
                                progressIndicator = '<i class="fas fa-arrow-up text-green-400 ml-2" title="Miglioramento"></i>';
                            } else if (bestSetThisWeek.e1rm < lastBestE1RM) {
                                progressIndicator = '<i class="fas fa-arrow-down text-red-400 ml-2" title="Peggioramento"></i>';
                            } else {
                                progressIndicator = '<i class="fas fa-equals text-yellow-400 ml-2" title="Stabile"></i>';
                            }
                        }
                        lastBestE1RM = bestSetThisWeek.e1rm;
                    }

                    historyHTML += `
                        <div class="bg-stone-800/50 p-4 rounded-lg">
                            <h4 class="font-bold text-white text-lg mb-2">Settimana ${week}</h4>
                            <div class="mb-3 p-2 bg-stone-900/50 rounded">
                                <span class="font-semibold text-secondary">Miglior Set: </span>
                                <span class="font-bold text-red-400">${bestSetThisWeek.text}</span>
                                ${progressIndicator}
                            </div>
                            ${userNote ? `<p class="text-sm text-stone-300 mb-3"><i class="fas fa-user-edit mr-1"></i><span class="font-semibold text-secondary"> Tua Nota:</span> ${userNote}</p>` : ''}
                            <div class="space-y-1">${setsHTML || '<p class="text-sm text-stone-400">Nessun dato completo per questa settimana.</p>'}</div>
                        </div>
                    `;
                });

                historyHTML += '</div>';
                container.innerHTML = historyHTML;
            }

            exerciseHistoryModal.classList.remove('hidden');
            setTimeout(() => exerciseHistoryModal.classList.remove('opacity-0'), 10);
        }
        document.getElementById('close-history-modal').addEventListener('click', () => {
            exerciseHistoryModal.classList.add('opacity-0');
            setTimeout(() => exerciseHistoryModal.classList.add('hidden'), 250);
        });
        exerciseHistoryModal.addEventListener('click', (e) => {
            if(e.target === exerciseHistoryModal) {
                exerciseHistoryModal.classList.add('opacity-0');
                setTimeout(() => exerciseHistoryModal.classList.add('hidden'), 250);
            }
        });

        // --- GESTIONE PREFERITI ---
        function openFavoritesModal() {
            favoritesModal.classList.remove('hidden');
            setTimeout(() => favoritesModal.classList.remove('opacity-0'), 10);
            loadAndRenderFavorites();
        }

        async function loadAndRenderFavorites() {
            const container = document.getElementById('favorites-container');
            container.innerHTML = '<div class="loader"></div>';
            const favoritesSnapshot = await getDocs(query(getFavoriteExercisesRef(), orderBy("nomeEsercizio")));
            favoritesCache = favoritesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFilteredFavorites('all');
        }

        function renderFilteredFavorites(category) {
            const listContainer = document.getElementById('favorites-container');
            const filteredFavorites = category === 'all' ? favoritesCache : favoritesCache.filter(fav => fav.categoria === category);

            const categories = [...new Set(favoritesCache.map(fav => fav.categoria))].sort();
            let categoryOptions = '<option value="all">Tutte le Categorie</option>';
            categories.forEach(cat => categoryOptions += `<option value="${cat}" ${category === cat ? 'selected' : ''}>${cat}</option>`);

            let favoritesHTML = filteredFavorites.map(fav => `
                <div class="bg-stone-800/50 p-4 rounded-lg flex flex-col">
                    <div class="flex-grow">
                        <h4 class="font-bold text-white">${fav.nomeEsercizio} ${fav.isCircuit ? '<span class="reward-badge !bg-amber-500 !text-amber-900">CIRCUITO</span>' : ''}</h4>
                        <p class="text-sm text-red-400 mb-2"><i class="fas fa-tag mr-1"></i> ${fav.categoria}</p>
                        <p class="text-xs text-secondary mb-3">Serie: ${fav.serie} | Reps: ${fav.ripetizioniPerSerie ? fav.ripetizioniPerSerie.join(' / ') : (fav.ripetizioni || '')} ${fav.isCircuit ? `| Lav: ${fav.circuitWorkTime || '-'}s | Rec: ${fav.circuitRestTime || '-'}s` : ''} | RIR: ${fav.rir || '-'} | Recupero: ${fav.recupero || '-'}s</p>
                        ${fav.note ? `<p class="text-sm text-stone-300 border-t border-stone-700/50 pt-2 mt-2">Nota Coach: ${fav.note}</p>` : ''}
                    </div>
                    <div class="flex justify-end gap-2 mt-auto pt-2">
                        <button class="btn btn-secondary !p-2 text-xs" data-add-fav-ex-id="${fav.id}" title="Aggiungi alla scheda"><i class="fas fa-plus"></i></button>
                        <button class="btn btn-danger !p-2 text-xs" data-delete-fav-ex-id="${fav.id}" title="Elimina dai preferiti"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`
            ).join('');

            if(filteredFavorites.length === 0) {
                 favoritesHTML = `<div class="text-center py-8"><i class="fas fa-star text-4xl text-stone-600 mb-4"></i><p class="text-secondary">Nessun esercizio preferito in questa categoria.</p></div>`;
            }

            listContainer.innerHTML = `
                <div class="mb-4">
                    <select id="favorite-category-filter" class="input-field">${categoryOptions}</select>
                </div>
                <div id="favorites-list" class="max-h-[60vh] overflow-y-auto pr-2 grid grid-cols-1 md:grid-cols-2 gap-4">${favoritesHTML}</div>
            `;
        }

        favoritesModal.addEventListener('change', (e) => {
            if (e.target.id === 'favorite-category-filter') {
                renderFilteredFavorites(e.target.value);
            }
        });
        favoritesModal.addEventListener('click', async (e) => {
             if (e.target.id === 'close-favorites-modal' || e.target.closest('#close-favorites-modal') || e.target === favoritesModal) {
                 favoritesModal.classList.add('opacity-0');
                 setTimeout(() => favoritesModal.classList.add('hidden'), 250);
                 return;
             }

             const addBtn = e.target.closest('button[data-add-fav-ex-id]');
             const deleteBtn = e.target.closest('button[data-delete-fav-ex-id]');

             if (addBtn && currentSheetId) {
                 const fav = favoritesCache.find(f => f.id === addBtn.dataset.addFavExId);
                 if (fav) {
                     const { id, ...favData } = fav;
                     await addDoc(getExercisesRef(currentMesoId, currentSheetId), { ...favData, ordine: (exercisesCache.length || 0) + 1, datiSettimanali: {} });
                     await loadAndRenderExercises();
                     showNotification("Esercizio aggiunto alla scheda!");
                 }
             } else if (deleteBtn) {
                 if (await showConfirmModal('Eliminare questo esercizio dai preferiti?')) {
                     await deleteDoc(doc(getFavoriteExercisesRef(), deleteBtn.dataset.deleteFavExId));
                     loadAndRenderFavorites();
                     showNotification("Esercizio eliminato dai preferiti!");
                 }
             }
        });

        // --- ESPORTAZIONE ---
        function previewAndExportPDF() {
             if (!currentSheetId) return;
             let content = `<h2>Scheda: ${currentSheetData.nomeScheda} - Settimana ${currentWeek}</h2>`;
             exercisesCache.forEach(ex => {
                 content += `<p><b>${ex.nomeEsercizio}</b>: ${ex.serie}x${ex.ripetizioni || ''}</p>`;
             });
             document.getElementById('pdf-preview-container').innerHTML = content;
             pdfPreviewModal.classList.remove('hidden');
             setTimeout(() => pdfPreviewModal.classList.remove('opacity-0'), 10);
        }
        document.getElementById('download-pdf-btn').addEventListener('click', async () => {
             const { jsPDF } = window.jspdf;
             const pdf = new jsPDF();
             const content = document.getElementById('pdf-preview-container');
             const canvas = await html2canvas(content);
             const imgData = canvas.toDataURL('image/png');
             pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
             pdf.save(`${currentSheetData.nomeScheda}.pdf`);
        });
        document.getElementById('close-pdf-preview-btn').addEventListener('click', () => {
            pdfPreviewModal.classList.add('opacity-0');
            setTimeout(() => pdfPreviewModal.classList.add('hidden'), 250);
        });

        // --- NUOVE FUNZIONALITÀ ---
        function renderWorkoutControls() {
            const container = document.getElementById('workout-controls-container');
            if (!container || !currentSheetData) return;
            container.innerHTML = `
                <div class="bg-gradient-main p-3 rounded-lg border border-stone-700 flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div id="workout-recap-specific" class="text-sm text-secondary flex-grow text-center sm:text-left">
                        </div>
                     <button id="mark-week-complete-btn" class="btn btn-secondary flex-shrink-0"><i class="fas fa-check mr-2"></i> Segna come Completato</button>
                </div>`;

            const markBtn = document.getElementById('mark-week-complete-btn');
            const isWeekCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === currentWeek);

            if (isWeekCompleted) {
                markBtn.disabled = true;
                markBtn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Settimana Completata';
                markBtn.classList.add('!bg-green-600', '!text-white', '!border-green-500', 'opacity-80');
            } else {
                markBtn.addEventListener('click', handleMarkWeekComplete);
            }
        }

        async function handleMarkWeekComplete() {
            if (!currentSheetId) return;
            const isAlreadyCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === currentWeek);
            if (isAlreadyCompleted) {
                showNotification("Questa settimana è già stata completata.", "warning");
                return;
            }

            const confirmed = await showConfirmModal(`Sei sicuro di voler segnare la Settimana ${currentWeek} come completata?`);
            if (confirmed) {
                const oldWeeks = currentSheetData.completedWeeks || [];
                const normalizedWeeks = oldWeeks.map(w => (typeof w === 'number' ? { week: w, completedAt: currentSheetData.dataCreazione || new Date().toISOString() } : w));
                const completionRecord = { week: currentWeek, completedAt: new Date().toISOString() };
                const updatedCompletedWeeks = [...normalizedWeeks, completionRecord];

                try {
                    const sheetRef = doc(getSheetsRef(currentMesoId), currentSheetId);
                    await updateDoc(sheetRef, { completedWeeks: updatedCompletedWeeks });
                    currentSheetData.completedWeeks = updatedCompletedWeeks;
                    showNotification(`Settimana ${currentWeek} completata!`, "success");
                    renderWeekSelector();
                    renderWorkoutControls();
                    renderLastWorkoutRecap();

                } catch (error) {
                    console.error("Errore nel segnare la settimana come completata:", error);
                    showNotification("Errore durante l'aggiornamento.", "error");
                }
            }
        }

        async function renderLastWorkoutRecap() {
            const container = document.getElementById('last-workout-container');
            if (!container) return;
            container.innerHTML = '<div class="text-center text-sm text-secondary p-2">Caricamento ultimo allenamento...</div>';

            try {
                const userId = selectedUserId || currentUser.uid;
                const mesocyclesRef = collection(db, 'users', userId, 'mesocycles');
                const mesocyclesSnapshot = await getDocs(mesocyclesRef);

                let lastWorkout = null;
                for (const mesoDoc of mesocyclesSnapshot.docs) {
                    const sheetsRef = collection(mesoDoc.ref, 'trainingSheets');
                    const sheetsSnapshot = await getDocs(sheetsRef);

                    for (const sheetDoc of sheetsSnapshot.docs) {
                        const sheetData = sheetDoc.data();
                        if (sheetData.completedWeeks && sheetData.completedWeeks.length > 0) {
                            const completedWeeksValid = sheetData.completedWeeks.filter(w => w && w.completedAt);
                            if (completedWeeksValid.length === 0) continue;

                            const latestInSheet = completedWeeksValid.reduce((latest, current) => {
                                return new Date(current.completedAt) > new Date(latest.completedAt) ? current : latest;
                            });

                            if (!lastWorkout || new Date(latestInSheet.completedAt) > new Date(lastWorkout.completedAt)) {
                                lastWorkout = {
                                    ...latestInSheet,
                                    sheetName: sheetData.nomeScheda,
                                    mesoName: mesoDoc.data().nome
                                };
                            }
                        }
                    }
                }

                if (lastWorkout) {
                    const lastDate = new Date(lastWorkout.completedAt).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' });
                    container.innerHTML = `
                        <div class="recap-card p-4 rounded-xl text-center shadow-lg">
                                <h3 class="text-sm font-bold text-purple-300 mb-1 tracking-wider uppercase">ULTIMO ALLENAMENTO COMPLETATO</h3>
                                <p class="text-lg text-white font-semibold">${lastWorkout.sheetName} (Sett. ${lastWorkout.week})</p>
                                <p class="text-sm text-stone-300"><i class="fas fa-calendar-check mr-2"></i>${lastDate}</p>
                        </div>`;
                } else {
                    container.innerHTML = `
                        <div class="recap-card p-4 rounded-xl text-center shadow-lg">
                                <h3 class="text-sm font-bold text-purple-300 mb-1 tracking-wider uppercase">BENVENUTO</h3>
                                <p class="text-lg text-white font-semibold">Nessun allenamento ancora completato. Dai il massimo!</p>
                        </div>`;
                }

            } catch (error) {
                console.error("Errore nel caricare l'ultimo allenamento:", error);
                container.innerHTML = '<p class="text-center text-red-400">Impossibile caricare i dati dell\'ultimo allenamento.</p>';
            }
        }

        function renderSpecificRecap() {
            const container = document.getElementById('workout-recap-specific');
            if (!container) return;
            if (currentSheetData && currentSheetData.lastModified) {
                const lastDate = new Date(currentSheetData.lastModified).toLocaleString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'});
                container.innerHTML = `<i class="fas fa-pencil-alt mr-2 text-yellow-400"></i>Ultima modifica a questa scheda: <b>${lastDate}</b>`;
            } else {
                container.innerHTML = '<i class="fas fa-info-circle mr-2"></i>Nessuna modifica ancora registrata.';
            }
        }
        function calculate1RMEstimate(reps) {
            if (!reps || reps <= 0) return `~% 1RM`;
            const percentage = (1 / (1 + reps / 30)) * 100;
            if (percentage > 100) return `>100%`;
            return `~${Math.round(percentage)}%`;
        }
        const calculateE1RM = (carico, reps) => {
            if (!carico || !reps) return 0;
            return parseFloat(carico) * (1 + parseInt(reps) / 30);
        }
        function handleProcrastinationCheck(exId, serieIndex, repsInput) {
             const exercise = exercisesCache.find(ex => ex.id === exId);
             if (!exercise || !exercise.recupero || exercise.isCircuit || serieIndex >= exercise.serie - 1) return; // Ignore for circuits
             const card = document.getElementById(`ex-card-${exId}`);
             if (!card) return;
             const caricoInput = card.querySelector(`input[data-serie-index="${serieIndex}"][data-field="carico"]`);
             if (repsInput.value && caricoInput && caricoInput.value) {
                 clearProcrastinationTimer(exId);
                 const delay = exercise.recupero * 2.5 * 1000;
                 procrastinationTimers[exId] = setTimeout(() => {
                      procrastinationModal.classList.remove('hidden');
                      setTimeout(() => procrastinationModal.classList.remove('opacity-0'), 10);
                      delete procrastinationTimers[exId];
                 }, delay);
             }
        }
        function clearProcrastinationTimer(exId) {
            if (procrastinationTimers[exId]) {
                clearTimeout(procrastinationTimers[exId]);
                delete procrastinationTimers[exId];
            }
        }
        function closeProcrastinationModal() {
            procrastinationModal.classList.add('opacity-0');
            setTimeout(() => procrastinationModal.classList.add('hidden'), 250);
        }
        document.getElementById('procrastination-ok-btn').addEventListener('click', closeProcrastinationModal);

        async function openVolumeAnalysisModal() {
            if (!currentMesoId) {
                showNotification("Seleziona prima un mesociclo.", "warning");
                return;
            }

            const container = document.getElementById('volume-analysis-container');
            container.innerHTML = '<div class="loader"></div>';
            volumeAnalysisModal.classList.remove('hidden');
            setTimeout(() => volumeAnalysisModal.classList.remove('opacity-0'), 10);
            const sheetsSnapshot = await getDocs(query(getSheetsRef(currentMesoId), orderBy("dataCreazione")));
            const sheets = sheetsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let sheetSelectionHTML = '<p class="text-secondary">Nessuna scheda trovata in questo mesociclo.</p>';
            if (sheets.length > 0) {
                sheetSelectionHTML = sheets.map(sheet => `
                    <label class="flex items-center space-x-3 bg-stone-800/50 p-3 rounded-lg">
                        <input type="checkbox" name="sheet" value="${sheet.id}" class="h-4 w-4 rounded bg-stone-700 border-stone-600 text-red-600 focus:ring-red-500">
                        <span>${sheet.nomeScheda}</span>
                    </label>
                `).join('');
            }
            container.innerHTML = `
                <div class="bg-stone-900/50 p-4 rounded-lg">
                    <h4 class="font-bold text-white mb-3">1. Imposta Frequenza Settimanale</h4>
                    <p class="text-xs text-secondary mb-2">Quante volte a settimana si allena l'utente?</p>
                    <input type="number" id="workouts-per-week" class="input-field w-full sm:w-1/3" placeholder="Es: 4" min="1">
                </div>
                <div class="bg-stone-900/50 p-4 rounded-lg">
                     <h4 class="font-bold text-white mb-3">2. Seleziona le Schede della Rotazione</h4>
                     <p class="text-xs text-secondary mb-2">Quali schede vengono eseguite nella settimana? (Es. Scheda A e Scheda B per una frequenza di 4 volte/sett)</p>
                     <div id="sheet-selection-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">${sheetSelectionHTML}</div>
                </div>
                <div class="text-center">
                    <button id="calculate-volume-btn" class="btn"><i class="fas fa-calculator mr-2"></i> Calcola Volume Mensile</button>
                </div>
                <div id="volume-results-container" class="mt-6"></div>
            `;
            document.getElementById('calculate-volume-btn').addEventListener('click', () => calculateAndDisplayProjectedVolume(sheets));
        }

        async function calculateAndDisplayProjectedVolume(sheets) {
            const workoutsPerWeek = parseInt(document.getElementById('workouts-per-week').value, 10);
            const selectedSheetCheckboxes = document.querySelectorAll('#sheet-selection-container input[type="checkbox"]:checked');
            const selectedSheetIds = Array.from(selectedSheetCheckboxes).map(cb => cb.value);
            const resultsContainer = document.getElementById('volume-results-container');
            resultsContainer.innerHTML = '<div class="loader"></div>';

            if (!workoutsPerWeek || workoutsPerWeek <= 0) {
                resultsContainer.innerHTML = '<p class="text-center text-red-400">Inserisci un numero valido di allenamenti a settimana.</p>';
                return;
            }
            if (selectedSheetIds.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-red-400">Seleziona almeno una scheda da includere nel calcolo.</p>';
                return;
            }

            const multiplier = workoutsPerWeek / selectedSheetIds.length;
            const allExercisesPromises = selectedSheetIds.map(sheetId => getDocs(getExercisesRef(currentMesoId, sheetId)));
            const allExercisesSnapshots = await Promise.all(allExercisesPromises);
            const allExercises = allExercisesSnapshots.flatMap(snapshot => snapshot.docs.map(doc => doc.data()));

            const rotationVolumeData = {};
            for (const group in MACROCYCLE_RULES) {
                rotationVolumeData[group] = { totalSets: 0, composition: {} };
            }

            allExercises.forEach(ex => {
                const { categoria, serie } = ex;
                if (!categoria || !serie) return;

                for (const group in MACROCYCLE_RULES) {
                    const rule = MACROCYCLE_RULES[group];
                    let addedVolume = 0;
                    let contributingCategory = null;
                    let percentage = 100;

                    if (rule.main === categoria) {
                        addedVolume = serie;
                        contributingCategory = categoria;
                    } else {
                        const additionalRule = rule.additional.find(r => r.category === categoria);
                        if (additionalRule) {
                            addedVolume = serie * (additionalRule.percentage / 100);
                            percentage = additionalRule.percentage;
                            contributingCategory = categoria;
                        }
                    }

                    if (addedVolume > 0) {
                        rotationVolumeData[group].totalSets += addedVolume;
                        if (!rotationVolumeData[group].composition[contributingCategory]) {
                            rotationVolumeData[group].composition[contributingCategory] = { sets: 0, percentage: 0 };
                        }
                        rotationVolumeData[group].composition[contributingCategory].sets += serie;
                        rotationVolumeData[group].composition[contributingCategory].percentage = percentage;
                    }
                }
            });

            const weeksInMonth = 4.33;
            let resultsHTML = `
                <h3 class="text-lg font-bold text-white mb-4">Risultati Volume Mensile Stimato</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-stone-800/50">
                            <tr>
                                <th class="p-3">Gruppo Muscolare</th>
                                <th class="p-3">Volume Totale Mensile</th>
                                <th class="p-3">Dettaglio Volume (per rotazione di ${selectedSheetIds.length} schede)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-stone-800">
                `;
            const sortedGroups = Object.keys(rotationVolumeData).sort();
            sortedGroups.forEach(group => {
                const rotationSets = rotationVolumeData[group].totalSets;
                if (rotationSets > 0) {
                    const actualWeeklyVolume = rotationSets * multiplier;
                    const monthlySets = (actualWeeklyVolume * weeksInMonth).toFixed(1);
                    let compositionHTML = Object.entries(rotationVolumeData[group].composition).map(([cat, data]) => {
                        const contribution = (data.sets * (data.percentage / 100)).toFixed(1);
                        return `<div>${cat}: ${data.sets} serie (${data.percentage}%) = <b>${contribution}</b></div>`;
                    }).join('');

                    resultsHTML += `
                        <tr class="hover:bg-stone-800/30">
                            <td class="p-3 font-bold text-red-400">${group}</td>
                            <td class="p-3 font-semibold">${monthlySets} serie</td>
                            <td class="p-3 text-xs text-secondary">Volume rotazione: <b>${rotationSets.toFixed(1)}</b><hr class="my-1 border-stone-700">${compositionHTML}</td>
                        </tr>
                    `;
                }
            });

            resultsHTML += `</tbody></table></div>`;
            resultsContainer.innerHTML = resultsHTML;
        }

        document.getElementById('close-volume-modal').addEventListener('click', () => {
            volumeAnalysisModal.classList.add('opacity-0');
            setTimeout(() => volumeAnalysisModal.classList.add('hidden'), 250);
        });

        // --- INIZIALIZZAZIONE APP ---
        window.addEventListener('load', setupAdminAccount);

    </script>
</body>
</html>