<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Schede Palestra - Versione Migliorata Blue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Variabili di Colore - TEMA SCURO (predominante) */
        :root {
            /* Colori basati sull'ultima immagine fornita (Navy Blue Scuro) */
            --bg-primary: #12121e; /* Quasi nero, base scura */
            --bg-secondary: #1a1a2b; /* Grigio-blu scuro per le card */
            --bg-gradient-from: #1e3a8a; /* Blu Scuro Intenso */
            --bg-gradient-to: #12121e; /* Base scura */
            --text-primary: #f1f5f9; /* Bianco sporco */
            --text-secondary: #94a3b8; /* Slate-400 */
            --text-accent: #3b82f6; /* Blue-500 (Accento brillante) */
            --text-accent-hover: #2563eb; /* Blue-600 */
            --text-accent-dark: #eef2ff; /* Indigo-50 (per testo su accent) */
            --border-color: #334155; /* Slate-700 */
            --btn-secondary-bg: #1e293b; /* Slate-800 */
            --btn-secondary-hover: #334155; /* Slate-700 */
            --ai-color: #f59e0b; /* Amber-500 (Per AI button/Glow) */
            --ai-dark: #431407; /* Stone-900 */
            --cardio-color: #10b981; /* Emerald-500 (New) */
        }
        /* Variabili di Colore - TEMA CHIARO */
        html.light {
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9; /* Slate-100 */
            --bg-gradient-from: #dbeafe; /* Blue-100 */
            --bg-gradient-to: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569; /* Slate-600 */
            --text-accent: #1d4ed8; /* Blue-700 */
            --text-accent-hover: #1e40af; /* Blue-800 */
            --text-accent-dark: #ffffff;
            --border-color: #cbd5e1; /* Slate-300 */
            --btn-secondary-bg: #e2e8f0;
            --btn-secondary-hover: #cbd5e1;
            --ai-color: #d97706; /* Amber-700 */
            --ai-dark: #fff;
            --cardio-color: #059669; /* Emerald-600 (New) */
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .input-field { 
             background-color: var(--bg-secondary); 
             border: 1px solid var(--border-color); 
             border-radius: 0.5rem; 
             padding: 10px 12px; 
             width: 100%; 
             transition: all 0.2s; 
             color: var(--text-primary); 
             box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .input-field:focus { 
             outline: none; 
             border-color: var(--text-accent); 
             box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4), inset 0 1px 3px rgba(0,0,0,0.2); 
         }
        html.dark .input-field:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.6), inset 0 1px 3px rgba(0,0,0,0.4); }
        .textarea-field { 
             background-color: var(--bg-secondary); 
             border: 1px solid var(--border-color); 
             border-radius: 0.5rem; 
             padding: 10px 12px; 
             width: 100%; 
             transition: all 0.2s; 
             color: var(--text-primary); 
             resize: vertical; 
             min-height: 40px; 
              height: auto; 
              box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .textarea-field:focus { outline: none; border-color: var(--text-accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.6), inset 0 1px 3px rgba(0,0,0,0.4); }
        .btn { display: inline-flex; align-items: center; justify-content: center; text-align: center; background-color: var(--text-accent); color: var(--text-accent-dark); font-weight: 700; padding: 10px 16px; border-radius: 0.5rem; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:hover { background-color: var(--text-accent-hover); transform: translateY(-1px); box-shadow: 0 6px 18px -2px rgba(59, 130, 246, 0.4); /* Glow blu intenso */ }
        .btn:disabled { cursor: not-allowed; filter: grayscale(50%); opacity: 0.7; }
        .btn-secondary { background-color: var(--btn-secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
        .btn-danger { background-color: #be123c; color: #fff1f2; }
        .btn-danger:hover { background-color: #9f1239; box-shadow: 0 3px 8px rgba(190, 18, 60, 0.4); }
        .loader { 
             border: 4px solid var(--border-color); 
             border-top: 4px solid var(--ai-color); 
             border-radius: 50%; 
             width: 40px; 
             height: 40px; 
             animation: spin 1s linear infinite; 
             margin: 2rem auto; 
         }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .week-btn { flex-shrink: 0; background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .week-btn.active { background-color: var(--text-accent); color: var(--text-accent-dark); font-weight: 700; border-color: var(--text-accent); box-shadow: 0 2px 5px rgba(59, 130, 246, 0.5); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.open { max-height: 2000px; }
        .notification { position: fixed; bottom: 20px; right: 20px; background-color: var(--text-accent); color: var(--text-accent-dark); padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; animation: slideIn 0.3s ease-out; }
        .notification.warning { background-color: #be123c; color: #fff1f2; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .reward-badge { display: inline-block; background-color: #f59e0b; color: #431407; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .progress-bar { height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--text-accent); }
        .timer-display { font-family: monospace; font-size: 1.5rem; font-weight: bold; }
        .user-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 8px 16px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .exercise-image { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; border: 2px solid var(--border-color); border-radius: 0.5rem; display: block; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .pdf-preview { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; background-color: var(--bg-secondary); }
        .macrocycle-card { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); border: 1px solid #3b82f6; }
        .accordion-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .accordion-header:hover { background-color: rgba(59, 130, 246, 0.2); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-icon.open { transform: rotate(180deg); }
        /* Blue-specific styles for accents */
        .intensity-active { border-color: var(--text-accent); background-color: rgba(59, 130, 246, 0.1); }
        .intensity-glow { border-color: var(--text-accent); box-shadow: 0 0 18px 5px rgba(59, 130, 246, 0.7), inset 0 0 10px 2px rgba(59, 130, 246, 0.5); }
        .recap-card { 
             /* Ripristinato il gradiente specifico per la recap card */ 
             background: linear-gradient(135deg, var(--bg-gradient-from), #3b82f6); 
              border: 1px solid #93c5fd; 
              animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .circuit-card { border-color: var(--ai-color); background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(28, 25, 23, 0.2)); }
        .cardio-card { border-color: var(--cardio-color); background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(28, 25, 23, 0.2)); } /* NEW CARDIO STYLE */
        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-top: 0.5rem; }
        .image-grid .exercise-image { width: 100%; height: auto; aspect-ratio: 1 / 1; object-fit: cover; border: 2px solid var(--border-color); border-radius: 0.5rem; display: block; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        /* NEW: Stile per il pulsante AI più grande */
        .btn-ai-generate {
            background-color: var(--ai-color); /* Amber */
            color: var(--ai-dark); /* Dark Text */
            font-weight: 800;
            padding: 12px 20px;
            font-size: 0.95rem;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.5);
            transition: all 0.2s ease-in-out;
        }
        .btn-ai-generate:hover {
            background-color: #d97706; /* Amber-700 */
            transform: scale(1.05); /* Effetto leggero al passaggio del mouse */
            color: white;
        }
        /* Miglioramento estetica card esercizio */
        .card-bg { 
             background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary) 80%); 
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .intensity-glow {
            border: 2px solid var(--text-accent);
        }
        .circuit-card {
            border: 2px solid var(--ai-color);
        }
            </style>
</head>
<body class="antialiased">
    <div id="app-container" class="container mx-auto p-4 max-w-3xl">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <i class="fas fa-dumbbell text-indigo-500 text-2xl"></i>
                <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Gym App</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle-btn" class="btn btn-secondary !p-2" title="Cambia tema">
                    <i id="theme-icon-light" class="fas fa-sun hidden"></i>
                    <i id="theme-icon-dark" class="fas fa-moon"></i>
                </button>
                <div id="user-controls"></div>
            </div>
        </header>

        <div id="user-indicator" class="user-indicator hidden">
            <div class="flex items-center gap-2">
                <i class="fas fa-user-shield text-indigo-500"></i>
                <span id="selected-user-name" class="text-sm font-medium"></span>
                <button id="back-to-admin-btn" class="btn btn-danger !p-1 text-xs">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div id="main-view"></div>
    </div>
    <div id="auth-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 id="auth-title" class="text-xl font-bold text-white mb-4 text-center">Area Personale</h3>
            <p id="auth-error" class="text-red-400 mb-4 text-center text-sm"></p>
            <form id="auth-form" class="space-y-4">
                <input type="email" name="email" class="input-field" placeholder="Email" required>
                <input type="password" name="password" class="input-field" placeholder="Password (min. 6 caratteri)" required>
                <button type="submit" id="auth-submit-btn" class="btn w-full">Accedi</button>
                <button type="button" id="toggle-auth-mode-btn" class="text-center w-full mt-4 text-sm text-indigo-500 hover:text-indigo-400">Non hai un account? Registrati</button>
            </form>
        </div>
    </div>

    <div id="confirm-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 id="confirm-title" class="text-xl font-bold text-white mb-4">Conferma Azione</h3>
            <p id="confirm-message" class="text-stone-300 mb-6">Sei sicuro?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Annulla</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Conferma</button>
            </div>
        </div>
    </div>
    
    <div id="completion-reminder-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-indigo-500 text-center">
            <h3 class="text-2xl font-bold text-indigo-500 mb-4"><i class="fas fa-clipboard-check mr-2"></i> Hai quasi finito!</h3>
            <p class="text-stone-300 mb-6">Hai compilato i dati di carico e ripetizioni per la maggior parte degli esercizi. Ricordati di segnare la settimana come **Completata** per registrare il tuo allenamento!</p>
            <button id="completion-reminder-ok-btn" class="btn">Ho capito!</button>
        </div>
    </div>

    <div id="weekly-program-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-calendar-week mr-2 text-indigo-500"></i> Programma Settimanale</h3>
                <button id="close-weekly-program-btn" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="weekly-program-container">
                <div class="loader"></div>
            </div>
        </div>
    </div>

    <div id="admin-manual-log-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4"><i class="fas fa-clock mr-2 text-indigo-500"></i> Log Manuale Allenamento</h3>
            <p id="admin-manual-log-info" class="text-sm text-secondary mb-4"></p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="admin-log-mesocycle-selector" class="text-sm text-secondary mb-1 block">Mesociclo</label>
                    <select id="admin-log-mesocycle-selector" class="input-field w-full"></select>
                </div>
                <div>
                    <label for="admin-log-sheet-selector" class="text-sm text-secondary mb-1 block">Scheda</label>
                    <select id="admin-log-sheet-selector" class="input-field w-full"></select>
                </div>
                <div>
                    <label for="admin-log-week-input" class="text-sm text-secondary mb-1 block">Settimana (Riferimento)</label>
                    <input type="number" id="admin-log-week-input" class="input-field" min="1" placeholder="Settimana" required>
                </div>
                <div>
                    <label for="admin-log-date-input" class="text-sm text-secondary mb-1 block">Data e Ora Allenamento</label>
                    <input type="datetime-local" id="admin-log-date-input" class="input-field" required>
                </div>
            </div>

            <div class="flex justify-end gap-4 pt-2">
                <button type="button" id="close-admin-manual-log-btn" class="btn btn-secondary">Annulla</button>
                <button type="button" id="submit-admin-manual-log-btn" class="btn" disabled>Registra Allenamento</button>
            </div>
        </div>
    </div>
    
    <div id="steps-input-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4 text-center"><i class="fas fa-shoe-prints mr-2 text-green-400"></i> Inserisci la tua Media Passi</h3>
            <p class="text-stone-300 mb-4 text-sm text-center">Inserisci la tua media passi settimanale attuale.</p>
            <form id="steps-input-form" class="space-y-4">
                <input type="number" id="user-steps-input" class="input-field text-center" placeholder="Es: 8000" min="0" required>
                <button type="submit" class="btn w-full">Salva Passi</button>
            </form>
            <button id="close-steps-input-modal" class="text-center w-full mt-4 text-xs text-secondary hover:text-white">Annulla</button>
        </div>
    </div>


    <div id="edit-workout-date-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4">Modifica Data Log</h3>
            <form id="edit-workout-date-form" class="space-y-4">
                <p id="edit-workout-date-info" class="text-sm text-secondary"></p>
                <input type="datetime-local" id="new-workout-date" class="input-field" required>
                <div class="flex justify-end gap-4 pt-2">
                    <button type="button" id="cancel-edit-date-btn" class="btn btn-secondary">Annulla</button>
                    <button type="submit" class="btn">Salva Data</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-exercise-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
             <h3 class="text-xl font-bold text-white mb-4">Modifica Esercizio</h3>
             <div id="edit-exercise-container"></div>
        </div>
    </div>

    <div id="favorites-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-3xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Esercizi Preferiti</h3>
                <button id="close-favorites-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="favorites-container"></div>
        </div>
    </div>

    <div id="user-management-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-users-cog mr-2 text-indigo-500"></i> Gestione Utenti</h3>
                <div class="flex gap-2">
                    <button id="refresh-users-btn" class="btn btn-secondary !p-2" title="Aggiorna lista" onclick="renderUserManagementContent()"><i class="fas fa-sync-alt"></i></button>
                    <button id="close-user-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="user-management-container"></div>
        </div>
    </div>

    <div id="edit-user-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4">Modifica Utente</h3>
            <div id="edit-user-container"></div>
        </div>
    </div>

    <div id="user-details-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 id="history-modal-title" class="text-xl font-bold text-white">Dettagli Utente</h3>
                <div class="flex gap-2">
                    <button id="open-admin-manual-log-btn" class="btn btn-secondary"><i class="fas fa-plus-square mr-2"></i> Log Man. </button>
                    <button id="close-user-details-btn" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="user-details-container"></div>
        </div>
    </div>

    <div id="timer-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800" id="timer-modal-content-wrapper">
            <div id="timer-modal-content">
                </div>
        </div>
    </div>
    <div id="pdf-preview-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Anteprima PDF</h3>
                <div class="flex gap-2">
                    <button id="download-pdf-btn" class="btn btn-secondary"><i class="fas fa-download mr-2"></i> Scarica PDF</button>
                    <button id="close-pdf-preview-btn" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="pdf-preview-container" class="pdf-preview"></div>
        </div>
    </div>

    <div id="procrastination-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-indigo-500 text-center">
            <h3 class="text-3xl font-bold text-indigo-500 mb-4 animate-pulse">Ci stai mettendo troppo!</h3>
            <p class="text-stone-300 mb-6">Mantieni alta l'intensità. È ora della prossima serie!</p>
            <button id="procrastination-ok-btn" class="btn">Ho capito!</button>
        </div>
    </div>

    <div id="exercise-history-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-3xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 id="history-modal-title" class="text-xl font-bold text-white">Storico Esercizio</h3>
                <button id="close-history-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="exercise-history-container"></div>
        </div>
    </div>

    <div id="volume-analysis-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-5xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-calculator mr-2 text-indigo-500"></i> Analisi Volume Mesociclo</h3>
                <button id="close-volume-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <div id="volume-analysis-container" class="space-y-6"></div>
        </div>
    </div>

    <div id="admin-alert-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content card-bg p-8 rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95 border border-indigo-500">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-indigo-400"><i class="fas fa-exclamation-triangle mr-2"></i> Memo Alert Settimanale</h3>
                <button id="close-admin-alert-modal" class="btn btn-secondary !p-2"><i class="fas fa-times"></i></button>
            </div>
            <p id="admin-alert-message" class="text-white mb-6 whitespace-pre-wrap"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, query, orderBy, writeBatch, setDoc, where, limit, Timestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpzZN8VmrRKW60rW1WprEzgXyhhATzaPs",
            authDomain: "apppalestrasuper.firebaseapp.com",
            projectId: "apppalestrasuper",
            storageBucket: "apppalestrasuper.appspot.com",
            messagingSenderId: "883984670947",
            appId: "1:883984670947:web:adb9a75775e78ae7a965d6",
            measurementId: "G-CL6QVT906P"
        };

        // --- CHIAVE GEMINI E CONFIGURAZIONE (SENZA LIMITI) ---
        const GEMINI_API_KEY = "AIzaSyCn0J8MrPK_xFv2oGrnivwVdNUfjbMc9IA"; 
        
        // --- INIZIALIZZAZIONE SERVIZI FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // --- COSTANTI E VARIABILI GLOBALI ---
        const CATEGORIES = ["ABDUCTORS", "ABS", "ADDUCTORS", "BICEPS", "CALVES", "CHEST ISO", "DECLINE PUSH", "FRONT DELTS", "GLUTEI ISO", "HAMSTRINGS", "HIP HINGE", "HORIZONTAL HIP EXTENSION", "HORIZONTAL PULL", "HORIZONTAL PUSH", "INCLINE PULL", "INCLINE PUSH", "LEG PRESS VARIATION", "LOWER BACK", "LUNGE", "PULLOVER", "QUADS ISO", "REAR DELTS", "SIDE DELTS", "SQUAT PATTERN", "STRETCHING", "TRAPS", "TRICIPITI", "TRICEPS PUSH", "UPPER BACK", "VERTICAL PULL", "VERTICAL PUSH"];
        const MACROCYCLE_RULES = {
            "ADDOMINALI": { main: "ABS", additional: [] },
            "ADDUTTORI": { main: "ADDUCTORS", additional: [] },
            "BICIPITI": { main: "BICEPS", additional: [ { category: "HORIZONTAL PULL", percentage: 25 }, { category: "UPPER BACK", percentage: 25 }, { category: "INCLINE PULL", percentage: 25 } ] },
            "DELTOIDI FRONTALI": { main: "FRONT DELTS", additional: [ { category: "INCLINE PUSH", percentage: 25 }, { category: "VERTICAL PUSH", percentage: 25 } ] },
            "DELTOIDI LATERALI": { main: "SIDE DELTS", additional: [] },
            "DELTOIDI POSTERIORI": { main: "REAR DELTS", additional: [ { category: "HORIZONTAL PULL", percentage: 25 }, { category: "UPPER BACK", percentage: 25 } ] },
            "DORSALI": { main: "UPPER BACK", additional: [ { category: "HORIZONTAL PULL", percentage: 100 }, { category: "PULLOVER", percentage: 100 }, { category: "INCLINE PULL", percentage: 100 } ] },
            "GLUTEI": { main: "HORIZONTAL HIP EXTENSION", additional: [ { category: "HIP HINGE", percentage: 100 }, { category: "LEG PRESS VARIATION", percentage: 100 }, { category: "LUNGE", percentage: 100 }, { category: "ABDUCTORS", percentage: 100 }, { category: "SQUAT PATTERN", percentage: 100 }, { category: "GLUTEI ISO", percentage: 100 } ] },
            "LOMBARI": { main: "HIP HINGE", additional: [ { category: "LOWER BACK", percentage: 100 } ] },
            "PETTORALI": { main: "HORIZONTAL PUSH", additional: [ { category: "INCLINE PUSH", percentage: 100 }, { category: "CHEST ISO", percentage: 100 }, { category: "DECLINE PUSH", percentage: 100 } ] },
            "POLPACCI": { main: "CALVES", additional: [] },
            "QUADRICIPITI": { main: "SQUAT PATTERN", additional: [ { category: "QUADS ISO", percentage: 100 }, { category: "LUNGE", percentage: 100 }, { category: "LEG PRESS VARIATION", percentage: 100 } ] },
            "STRETCHING": { main: "STRETCHING", additional: [] },
            "TRAPEZI": { main: "HIP HINGE", additional: [ { category: "TRAPS", percentage: 100 }, { category: "HORIZONTAL PULL", percentage: 100 } ] },
            "TRICIPITI": { main: "TRICIPITI", additional: [ { category: "FRONT DELTS", percentage: 100 }, { category: "HORIZONTAL PUSH", percentage: 100 }, { category: "INCLINE PUSH", percentage: 100 }, { category: "DECLINE PUSH", percentage: 100 } ] },
            "UPPER BACK": { main: "VERTICAL PULL", additional: [ { category: "UPPER BACK", percentage: 100 }, { category: "HORIZONTAL PULL", percentage: 100 } ] }
        };
        const WEIGHT_INCREMENT = 2.5;
        const CALENDAR_EXPORT_LIMIT = 3; // Limite eventi esportabili in una sola volta

        // Riferimenti DOM
        const userControls = document.getElementById('user-controls');
        const mainView = document.getElementById('main-view');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const authModal = document.getElementById('auth-modal');
        const editExerciseModal = document.getElementById('edit-exercise-modal');
        const favoritesModal = document.getElementById('favorites-modal');
        const userManagementModal = document.getElementById('user-management-modal');
        const editUserModal = document.getElementById('edit-user-modal');
        const userDetailsModal = document.getElementById('user-details-modal');
        const timerModal = document.getElementById('timer-modal');
        const userIndicator = document.getElementById('user-indicator');
        const selectedUserName = document.getElementById('selected-user-name');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const pdfPreviewModal = document.getElementById('pdf-preview-modal');
        const procrastinationModal = document.getElementById('procrastination-modal');
        const exerciseHistoryModal = document.getElementById('exercise-history-modal');
        const volumeAnalysisModal = document.getElementById('volume-analysis-modal');
        const adminAlertModal = document.getElementById('admin-alert-modal');
        const editWorkoutDateModal = document.getElementById('edit-workout-date-modal');
        const adminManualLogModal = document.getElementById('admin-manual-log-modal');
        const completionReminderModal = document.getElementById('completion-reminder-modal');
        const stepsInputModal = document.getElementById('steps-input-modal');

        let currentUser = null, currentUserRole = 'user', currentMesoId = null, currentSheetId = null, currentSheetData = null, currentWeek = 1, exercisesCache = [], saveTimeouts = {}, isLoginMode = true, selectedUserId = null, favoritesCache = [];
        let activeTimerInterval = null, timerSeconds = 0, timerPaused = false;
        let procrastinationTimers = {};
        let modifiedExercisesThisWeek = new Set();
        let currentSheetName = '';
        let adminUsersCache = []; // Cache for user list in admin modals
        // Stato per il nuovo Interval Timer
        let intervalTimer = {
            interval: null,
            totalSeconds: 0,
            currentPhase: 'WORK',
            workTime: 0,
            restTime: 0,
            currentRound: 0,
            totalRounds: 0,
            exerciseName: ''
        };
        let manualWorkoutDate = null; 
        let weeklyProgramCache = {}; // Cache for weekly program map
        
        // Funzione per ottenere i passi medi dall'utente
        async function getAverageWeeklySteps(userId) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            const userData = userDoc.data();
            
            const steps = userData?.averageWeeklySteps || 0;

            return {
                steps: steps,
                lastUpdate: userData?.stepsLastUpdated 
                    ? (userData.stepsLastUpdated instanceof Timestamp ? userData.stepsLastUpdated.toDate() : new Date(userData.stepsLastUpdated))
                    : null
            };
        }


        // --- GESTIONE TEMA ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('light', theme === 'light');
            document.getElementById('theme-icon-light').classList.toggle('hidden', theme !== 'light');
            document.getElementById('theme-icon-dark').classList.toggle('hidden', theme === 'light');
            localStorage.setItem('theme', theme);
        }
        themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light'));
        applyTheme(localStorage.getItem('theme') || 'dark');

        // --- GESTIONE CHIUSURA MODALI ---
        function setupModalClosing(modalElement) {
            modalElement.addEventListener('click', (e) => {
                if (e.target === modalElement) {
                    closeModal(modalElement);
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modalElement.classList.contains('hidden')) {
                    closeModal(modalElement);
                }
            });
            const closeBtn = modalElement.querySelector('button[id^="close-"], button[id$="-cancel-btn"]');
            if (closeBtn) { 
                 closeBtn.addEventListener('click', () => closeModal(modalElement));
            }
            if (modalElement.id === 'completion-reminder-modal') { 
                 document.getElementById('completion-reminder-ok-btn').addEventListener('click', () => closeModal(completionReminderModal));
            }
        }

        function closeModal(modalElement) {
            modalElement.classList.add('opacity-0');
            setTimeout(() => modalElement.classList.add('hidden'), 250);
            if (modalElement.id === 'timer-modal') {
                stopSimpleTimer();
                stopIntervalTimer();
            }
            if (modalElement.id === 'procrastination-modal') {
                // No cleanup needed here
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            [authModal, confirmModal, editExerciseModal, favoritesModal, userManagementModal, editUserModal, userDetailsModal, timerModal, pdfPreviewModal, procrastinationModal, exerciseHistoryModal, volumeAnalysisModal, adminAlertModal, editWorkoutDateModal, adminManualLogModal, completionReminderModal, stepsInputModal, document.getElementById('weekly-program-modal')].forEach(setupModalClosing);
            document.getElementById('close-weekly-program-btn')?.addEventListener('click', () => closeModal(document.getElementById('weekly-program-modal')));
            document.getElementById('close-steps-input-modal')?.addEventListener('click', () => closeModal(stepsInputModal));
            document.getElementById('steps-input-form')?.addEventListener('submit', handleUserStepsSubmit);
        });

        // --- GESTIONE TIMER RECUPERO SEMPLICE ---
        function renderSimpleTimerModal() {
            document.getElementById('timer-modal-content').innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4 text-center">Timer Recupero</h3>
                <div class="timer-display text-indigo-500 text-center mb-6" id="simple-timer-display">00:00</div>
                <div class="flex justify-center gap-4">
                    <button id="simple-timer-pause-btn" class="btn btn-secondary"><i class="fas fa-pause"></i> Pausa</button>
                    <button id="simple-timer-stop-btn" class="btn btn-danger"><i class="fas fa-stop"></i> Ferma</button>
                </div>
            `;
            document.getElementById('simple-timer-pause-btn').addEventListener('click', toggleSimpleTimerPause);
            document.getElementById('simple-timer-stop-btn').addEventListener('click', () => closeModal(timerModal));
        }

        function startTimerModal(duration) {
            renderSimpleTimerModal();
            const display = document.getElementById('simple-timer-display');
            if (!display) return;

            timerSeconds = duration;
            timerPaused = false;
            display.textContent = `${Math.floor(duration / 60).toString().padStart(2, '0')}:${(duration % 60).toString().padStart(2, '0')}`;

            timerModal.classList.remove('hidden', 'opacity-0');

            if (activeTimerInterval) clearInterval(activeTimerInterval);
            activeTimerInterval = setInterval(() => {
                if (!timerPaused && timerSeconds > 0) {
                    timerSeconds--;
                    const minutes = Math.floor(timerSeconds / 60);
                    const seconds = timerSeconds % 60;
                    display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else if (timerSeconds <= 0) {
                    closeModal(timerModal);
                    showNotification("Timer completato!");
                }
            }, 1000);
        }

        function toggleSimpleTimerPause() {
            timerPaused = !timerPaused;
            document.getElementById('simple-timer-pause-btn').innerHTML = timerPaused ? '<i class="fas fa-play"></i> Riprendi' : '<i class="fas fa-pause"></i> Pausa';
        }

        function stopSimpleTimer() {
            if (activeTimerInterval) clearInterval(activeTimerInterval);
            activeTimerInterval = null;
        }

        // --- GESTIONE TIMER CIRCUITO A INTERVALLI ---
        function startIntervalCircuitTimer(ex) {
            if (!ex.circuitWorkTime || !ex.circuitRestTime || ex.serie === 0) {
                showNotification("Dati circuito non validi. Controlla Tempo Lavoro e Tempo Rec tra Round.", "error");
                return;
            }

            intervalTimer.workTime = ex.circuitWorkTime;
            intervalTimer.restTime = ex.circuitRestTime;
            intervalTimer.totalRounds = ex.serie;
            intervalTimer.currentRound = 1;
            intervalTimer.exerciseName = ex.nomeEsercizio;

            document.getElementById('timer-modal-content').innerHTML = `
                <h3 class="text-xl font-bold text-white mb-4 text-center">Circuito: ${ex.nomeEsercizio}</h3>
                <p class="text-stone-300 text-center mb-2" id="timer-phase-display"></p>
                <div class="timer-display text-indigo-500 text-center mb-6" id="circuit-timer-display">00:00</div>
                <p class="text-sm text-center text-secondary mb-4" id="timer-round-display">Round 1 / ${ex.serie}</p>
                <div class="flex justify-center gap-4">
                    <button id="circuit-timer-pause-btn" class="btn btn-secondary"><i class="fas fa-pause"></i> Pausa</button>
                    <button id="circuit-timer-stop-btn" class="btn btn-danger"><i class="fas fa-stop"></i> Ferma</button>
                </div>
            `;

            document.getElementById('circuit-timer-stop-btn').onclick = () => closeModal(timerModal);
            document.getElementById('circuit-timer-pause-btn').onclick = toggleIntervalPause;

            timerModal.classList.remove('hidden', 'opacity-0');

            if (intervalTimer.interval) clearInterval(intervalTimer.interval);
            startPhase('WORK');
        }

        function stopIntervalTimer() {
            if (intervalTimer.interval) clearInterval(intervalTimer.interval);
            intervalTimer.interval = null;
        }

        function toggleIntervalPause() {
            const btn = document.getElementById('circuit-timer-pause-btn');
            if (intervalTimer.interval) {
                clearInterval(intervalTimer.interval);
                intervalTimer.interval = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Riprendi';
            } else {
                runIntervalTimer();
                btn.innerHTML = '<i class="fas fa-pause"></i> Pausa';
            }
        }

        function startPhase(phase) {
            intervalTimer.currentPhase = phase;
            const duration = phase === 'WORK' ? intervalTimer.workTime : intervalTimer.restTime;
            intervalTimer.totalSeconds = duration;

            const display = document.getElementById('circuit-timer-display');
            const phaseDisplay = document.getElementById('timer-phase-display');

            if (phase === 'WORK') {
                display.classList.remove('text-green-500');
                display.classList.add('text-indigo-500');
                phaseDisplay.textContent = 'FASE DI LAVORO';
            } else {
                display.classList.remove('text-indigo-500');
                display.classList.add('text-green-500');
                phaseDisplay.textContent = 'RECUPERO TRA ROUND';
            }

            if (intervalTimer.interval) clearInterval(intervalTimer.interval);
            runIntervalTimer();
        }

        function runIntervalTimer() {
            function updateDisplay() {
                const minutes = Math.floor(intervalTimer.totalSeconds / 60);
                const seconds = intervalTimer.totalSeconds % 60;
                document.getElementById('circuit-timer-display').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (intervalTimer.totalSeconds <= 0) {
                    handlePhaseEnd();
                } else {
                    intervalTimer.totalSeconds--;
                }
            }

            intervalTimer.interval = setInterval(updateDisplay, 1000);
        }

        function handlePhaseEnd() {
            clearInterval(intervalTimer.interval);
            showNotification(intervalTimer.currentPhase === 'WORK' ? 'Tempo di lavoro scaduto!' : 'Recupero finito!');

            if (intervalTimer.currentPhase === 'WORK') {
                if (intervalTimer.currentRound < intervalTimer.totalRounds) {
                    startPhase('REST');
                } else {
                    showNotification(`Circuito ${intervalTimer.exerciseName} completato!`);
                    closeModal(timerModal);
                }
            } else if (intervalTimer.currentPhase === 'REST') {
                intervalTimer.currentRound++;
                document.getElementById('timer-round-display').textContent = `Round ${intervalTimer.currentRound} / ${intervalTimer.totalRounds}`;
                showNotification(`Inizia Round ${intervalTimer.currentRound}!`);
                startPhase('WORK');
            }
        }
        // --- FINE GESTIONE TIMER CIRCUITO A INTERVALLI ---

        // --- VERIFICA E IMPOSTAZIONE ADMIN ---
        async function setupAdminAccount() { 
             // ... (setupAdminAccount logic remains the same) 
             try { 
                 const adminQuery = query(collection(db, 'users'), where('role', '==', 'admin')); 
                 const adminSnapshot = await getDocs(adminQuery); 
                 if (adminSnapshot.empty) { 
                     const email = 'naccio@live.it'; 
                     try { 
                         await signInWithEmailAndPassword(auth, email, 'admin123'); 
                         const userCredential = auth.currentUser; 
                         await setDoc(doc(db, 'users', userCredential.uid), { email, role: 'admin', createdAt: new Date().toISOString(), createdBy: 'system' }, { merge: true }); 
                         console.log('Account esistente promosso ad admin!'); 
                         await signOut(auth); 
                     } catch (error) { 
                         if (error.code === 'auth/user-not-found') { 
                             try { 
                                 const userCredential = await createUserWithEmailAndPassword(auth, email, 'admin123'); 
                                 await setDoc(doc(db, 'users', userCredential.user.uid), { email, role: 'admin', createdAt: new Date().toISOString(), createdBy: 'system' }); 
                                 console.log('Admin creato con successo!'); 
                                 await signOut(auth); 
                             } catch (createError) { console.error('Errore creazione admin:', createError); } 
                         } else { 
                             console.error('Errore durante il setup dell\'admin:', error); 
                         } 
                     } 
                 } else { 
                     console.log('Admin già presente nel sistema'); 
                 } 
             } catch (error) { 
                 console.error('Errore verifica admin:', error); 
             }
        }

        // --- GESTIONE UTENTE SELEZIONATO (ADMIN) ---
        function selectUser(userId, userEmail) {
            selectedUserId = userId;
            selectedUserName.textContent = userEmail;
            userIndicator.classList.remove('hidden');
            resetState();
            renderAppView();
        }

        function deselectUser() {
            selectedUserId = null;
            userIndicator.classList.add('hidden');
            resetState();
            renderAppView();
        }
        backToAdminBtn.addEventListener('click', deselectUser);

        function resetState() {
            currentMesoId = null;
            currentSheetId = null;
            currentSheetData = null;
            currentSheetName = '';
            currentWeek = 1;
            exercisesCache = [];
            weeklyProgramCache = {}; // Reset weekly program cache
        }

        // --- GESTIONE AUTENTICAZIONE E UI PRINCIPALE ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (user.email === 'naccio@live.it') {
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        await setDoc(doc(db, 'users', user.uid), { email: user.email, role: 'admin' }, { merge: true });
                        currentUserRole = 'admin';
                    } else {
                        currentUserRole = userDoc.data().role || 'user';
                    }
                } else {
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role || 'user';
                    } else {
                        // Nuovo utente registrato, inizializzazione minimale
                        await setDoc(doc(db, 'users', user.uid), { email: user.email, role: 'user', createdAt: new Date().toISOString() });
                        currentUserRole = 'user';
                    }
                }
                await loadWeeklyProgram(); // Load program after auth
                renderAppView();
            } else {
                renderLoginView();
            }
        });

        function renderLoginView() {
            mainView.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-dumbbell text-indigo-500 text-5xl mb-6"></i>
                    <h2 class="text-2xl font-bold mb-4">Benvenuto in Gym App</h2>
                    <p class="text-secondary mb-8">Effettua il login per accedere alla tua area personale.</p>
                </div>`;
            userControls.innerHTML = `<button id="login-btn" class="btn">Accedi / Registrati</button>`;
            document.getElementById('login-btn').addEventListener('click', () => {
                authModal.classList.remove('hidden', 'opacity-0');
            });
        }

        async function renderAppView() {
            const effectiveUserId = selectedUserId || currentUser.uid;
            
            userControls.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-sm text-secondary hidden sm:block">Ciao, ${currentUser.email}</span>
                    <button id="open-steps-input-btn" class="btn btn-secondary !p-2" title="Inserisci Media Passi Settimanale"><i class="fas fa-shoe-prints"></i></button>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            // Bind the handler for the steps input button
            if (!selectedUserId) { // Solo l'utente può inserire i propri passi, l'Admin li visualizza/modifica solo dalla gestione utenti
                document.getElementById('open-steps-input-btn').addEventListener('click', openUserStepsInputModal);
            } else {
                 document.getElementById('open-steps-input-btn').disabled = true; // Disabilita se l'Admin sta impersonando
            }


            const isAdmin = currentUserRole === 'admin';
            mainView.innerHTML = `
                <div class="space-y-6">
                    <div id="last-workout-container" class="mb-6"></div>
                    ${isAdmin && !selectedUserId ? `
                    <div class="card-bg p-4 rounded-xl border border-stone-800 shadow-lg">
                        <h3 class="text-lg font-bold text-white mb-3"><i class="fas fa-users mr-2 text-indigo-500"></i> Seleziona Utente</h3>
                        <div id="user-selector-container"></div>
                    </div>` : ''}
                    <div id="program-view-container" class="mb-6 card-bg p-4 rounded-xl border border-stone-800 shadow-lg"></div>
                    <div id="mesocycle-container" class="card-bg p-4 rounded-xl border border-stone-800 shadow-lg"></div>
                    <div id="sheet-container" class="card-bg p-4 rounded-xl border border-stone-800 shadow-lg hidden"></div>
                    <div id="sheet-content" class="hidden">
                        <div id="week-selector-container" class="mb-4"></div>
                        <div id="workout-controls-container" class="mb-4"></div>
                        <div id="sheet-volume-summary-container" class="mb-4 card-bg p-4 rounded-xl border border-stone-800 shadow-lg"></div>
                        <div id="exercise-list-container" class="space-y-4"></div>
                        ${isAdmin ? `
                        <div class="mt-6 card-bg p-4 rounded-xl border border-stone-800 shadow-lg">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <button id="toggle-add-exercise-btn" class="btn w-full btn-secondary"><i class="fas fa-plus mr-2"></i> Aggiungi Esercizio</button>
                                <button id="add-from-favorites-btn" class="btn w-full btn-secondary"><i class="fas fa-star mr-2"></i> Aggiungi da Preferiti</button>
                            </div>
                            <div id="add-exercise-container" class="collapsible-content"></div>
                        </div>` : ''}
                        <div class="mt-6 text-center flex flex-col sm:flex-row justify-center gap-4">
                            <button id="export-pdf-btn" class="btn btn-secondary"><i class="fas fa-file-pdf mr-2"></i> Esporta PDF</button>
                            <button id="add-to-calendar-btn" class="btn"><i class="fas fa-calendar-plus mr-2"></i> Aggiungi a Calendar (Singola Scheda)</button>
                        </div>
                    </div>
                    <div id="initial-message" class="text-center p-8 text-secondary">
                        <i class="fas fa-clipboard-list text-4xl mb-4 text-slate-600"></i>
                        <p>Seleziona o crea un mesociclo per iniziare.</p>
                    </div>
                    ${isAdmin && !selectedUserId ? `
                    <div class="mt-6 card-bg p-4 rounded-xl border border-stone-800 shadow-lg">
                        <h3 class="text-lg font-bold text-white mb-4"><i class="fas fa-user-shield mr-2 text-indigo-500"></i> Area Amministratore</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="manage-favorites-btn" class="btn btn-secondary"><i class="fas fa-star mr-2"></i> Gestisci Preferiti</button>
                            <button id="manage-users-btn" class="btn btn-secondary"><i class="fas fa-users-cog mr-2"></i> Gestisci Utenti</button>
                            <button id="backup-all-data-btn" class="btn btn-danger"><i class="fas fa-database mr-2"></i> Backup Dati (JSON)</button>
                        </div>
                    </div>` : ''}
                </div>`;
            renderProgramView(); // NEW: Render the weekly program view
            renderLastWorkoutRecap();
            if (isAdmin && !selectedUserId) {
                renderUserSelector();
                document.getElementById('backup-all-data-btn')?.addEventListener('click', handleBackupAllData);
            }
            renderMesocycleSelector();
        }

        // --- RIFERIMENTI DB DINAMICI ---
        const getMesocyclesRef = () => collection(db, 'users', selectedUserId || currentUser.uid, 'mesocycles');
        const getSheetsRef = (mesoId) => collection(db, 'users', selectedUserId || currentUser.uid, 'mesocycles', mesoId, 'trainingSheets');
        const getExercisesRef = (mesoId, sheetId) => collection(db, 'users', selectedUserId || currentUser.uid, 'mesocycles', mesoId, 'trainingSheets', sheetId, 'exercises');
        const getFavoriteExercisesRef = () => collection(db, 'favoriteExercises');
        const getUsersRef = () => collection(db, 'users');
        const getWorkoutHistoryRef = (userId) => collection(db, 'users', userId || currentUser.uid, 'workoutHistory');
        const getWeeklyProgramRef = (userId) => doc(db, 'users', userId || currentUser.uid, 'weeklyProgram', 'schedule'); // NEW: Program document reference

        // --- FUNZIONI MODAL E UTILITY ---
        function showNotification(message, type = "success") {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'warning' : ''}`;
            notification.innerHTML = `<div class="flex items-center"><i class="fas ${type === "error" ? "fa-exclamation-circle" : "fa-check-circle"} mr-2"></i><span>${message}</span></div>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showConfirmModal(message) {
            return new Promise(resolve => {
                confirmModal.classList.remove('hidden', 'opacity-0');
                document.getElementById('confirm-message').textContent = message;
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');

                const cleanup = (result) => {
                    closeModal(confirmModal);
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };

                okBtn.onclick = () => cleanup(true);
                cancelBtn.onclick = () => cleanup(false);
            });
        }

        document.getElementById('toggle-auth-mode-btn').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-submit-btn').textContent = isLoginMode ? 'Accedi' : 'Registrati';
            document.getElementById('toggle-auth-mode-btn').textContent = isLoginMode ? 'Non hai un account? Registrati' : 'Hai già un account? Accedi';
            document.getElementById('auth-error').textContent = '';
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements.email.value;
            const password = e.target.elements.password.value;
            const authError = document.getElementById('auth-error');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            authError.textContent = '';
            authSubmitBtn.disabled = true;
            authSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Elaborazione...';

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, 'users', userCredential.user.uid), { email, role: 'user', createdAt: new Date().toISOString() });
                }
                closeModal(authModal);
            } catch (error) {
                console.error("Authentication error:", error.code, error.message);
                authError.textContent = "Credenziali non valide o utente già esistente.";
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerHTML = isLoginMode ? 'Accedi' : 'Registrati';
            }
        });

        // --- GESTIONE STEPS ATLETA ---
        async function openUserStepsInputModal() {
            const userId = currentUser.uid;
            const userDoc = await getDoc(doc(getUsersRef(), userId));
            const currentSteps = userDoc.data()?.averageWeeklySteps || '';
            document.getElementById('user-steps-input').value = currentSteps;
            stepsInputModal.classList.remove('hidden', 'opacity-0');
        }
        
        async function handleUserStepsSubmit(e) {
            e.preventDefault();
            const userId = currentUser.uid;
            const inputElement = document.getElementById('user-steps-input');
            const newSteps = parseInt(inputElement.value, 10);

            if (isNaN(newSteps) || newSteps < 0) {
                 showNotification("Inserisci un numero di passi valido.", "error");
                 return;
            }

            try {
                await updateDoc(doc(getUsersRef(), userId), { 
                     averageWeeklySteps: newSteps,
                     stepsLastUpdated: new Date()
                });
                showNotification(`Passi settimanali aggiornati a ${newSteps}!`, "success");
                closeModal(stepsInputModal);
                renderLastWorkoutRecap();
            } catch(error) {
                console.error("Errore salvataggio passi:", error);
                showNotification("Errore nel salvataggio dei passi.", "error");
            }
        }


        // --- FUNZIONI DI LOGICA PRINCIPALE ---
        async function renderUserSelector() {
            const container = document.getElementById('user-selector-container');
            if (!container) return;
            container.innerHTML = '<div class="loader"></div>';
            try {
                const usersQuery = query(getUsersRef(), orderBy('email'));
                const usersSnapshot = await getDocs(usersQuery);
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                adminUsersCache = users; // Cache users

                let options = '<option value="">-- Seleziona un utente --</option>';
                users.forEach(user => {
                    options += `<option value="${user.id}">${user.email}${user.role === 'admin' ? ' (Admin)' : ''}</option>`;
                });

                container.innerHTML = `<select id="user-selector" class="input-field w-full">${options}</select>`;
                document.getElementById('user-selector').addEventListener('change', (e) => {
                    const userId = e.target.value;
                    if (userId) {
                        const selectedUser = users.find(u => u.id === userId);
                        if (selectedUser) selectUser(userId, selectedUser.email);
                    }
                });
            } catch (error) {
                console.error("Errore caricamento utenti:", error);
                container.innerHTML = '<p class="text-red-400 text-center">Errore durante il caricamento degli utenti.</p>';
            }
        }

        async function renderMesocycleSelector() {
            const mesocycleContainer = document.getElementById('mesocycle-container');
            if (!mesocycleContainer) return;

            const mesocyclesSnapshot = await getDocs(query(getMesocyclesRef(), orderBy("dataCreazione", "desc")));
            let options = '<option value="">-- Seleziona un mesociclo --</option>';
            mesocyclesSnapshot.forEach(doc => {
                options += `<option value="${doc.id}">${doc.data().nome}</option>`;
            });

            mesocycleContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-calendar-alt mr-2 text-indigo-500"></i> Mesociclo</h3>
                     <div class="flex items-center gap-2">
                        ${currentUserRole === 'admin' ? `<button id="analyze-volume-btn" class="btn btn-secondary !p-2 text-xs" title="Analisi Volume Mesociclo"><i class="fas fa-calculator"></i></button>` : ''}
                        ${currentUserRole === 'admin' ? `<button id="toggle-create-meso-btn" class="btn btn-secondary !p-2 text-xs" title="Crea Nuovo Mesociclo"><i class="fas fa-plus"></i></button>` : ''}
                    </div>
                </div>
                <select id="mesocycle-selector" class="input-field w-full">${options}</select>
                ${currentUserRole === 'admin' ? `
                <div id="create-meso-container" class="collapsible-content mt-3">
                    <form id="create-meso-form" class="space-y-3">
                        <input type="text" name="name" class="input-field" placeholder="Nome mesociclo..." required>
                        <button type="submit" class="btn w-full"><i class="fas fa-plus mr-2"></i> Crea</button>
                    </form>
                </div>` : ''}`;

            const mesoSelector = document.getElementById('mesocycle-selector');
            mesoSelector.addEventListener('change', (e) => selectMesocycle(e.target.value));

            if (currentUserRole === 'admin') {
                document.getElementById('create-meso-form')?.addEventListener('submit', handleCreateMeso);
                document.getElementById('toggle-create-meso-btn')?.addEventListener('click', () => document.getElementById('create-meso-container')?.classList.toggle('open'));
                document.getElementById('analyze-volume-btn')?.addEventListener('click', openVolumeAnalysisModal);
            }

            const effectiveUserId = selectedUserId || currentUser.uid;
            const lastMesoId = localStorage.getItem(`lastMesoId_${effectiveUserId}`);
            if (lastMesoId && mesoSelector.querySelector(`option[value="${lastMesoId}"]`)) {
                mesoSelector.value = lastMesoId;
                selectMesocycle(lastMesoId);
            }
        }

        async function selectMesocycle(mesoId) {
            currentMesoId = mesoId;
            const effectiveUserId = selectedUserId || currentUser.uid;
            localStorage.setItem(`lastMesoId_${effectiveUserId}`, mesoId || '');
            const sheetContent = document.getElementById('sheet-content');
            const initialMessage = document.getElementById('initial-message');
            const sheetContainer = document.getElementById('sheet-container');

            sheetContent.classList.add('hidden');
            initialMessage.classList.remove('hidden');

            if (!mesoId) {
                sheetContainer.classList.add('hidden');
                return;
            }
            sheetContainer.classList.remove('hidden');
            await renderSheetSelector();
        }

        async function renderSheetSelector() {
            const sheetContainer = document.getElementById('sheet-container');
            const sheetsSnapshot = await getDocs(query(getSheetsRef(currentMesoId), orderBy("dataCreazione", "desc")));

            let options = '<option value="">-- Seleziona una scheda --</option>';
            sheetsSnapshot.forEach(doc => {
                const sheet = doc.data();
                options += `<option value="${doc.id}">${sheet.nomeScheda}${sheet.isCompleta ? ' (Completata)' : ''}</option>`;
            });

            sheetContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-clipboard-list mr-2 text-indigo-500"></i> Scheda di Allenamento</h3>
                    ${currentUserRole === 'admin' ? `<button id="toggle-create-sheet-btn" class="btn btn-secondary !p-2 text-xs"><i class="fas fa-plus"></i></button>` : ''}
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <select id="sheet-selector" class="input-field flex-grow">${options}</select>
                    <div class="flex items-center gap-3">
                        ${currentUserRole === 'admin' ? `
                        <button id="add-weeks-btn" class="btn btn-secondary" title="Aggiungi Settimane"><i class="fas fa-calendar-plus"></i></button>
                       <button id="duplicate-sheet-btn" class="btn btn-secondary" title="Duplica Scheda"><i class="fas fa-copy"></i></button>
                        <button id="delete-sheet-btn" class="btn btn-danger" title="Elimina Scheda"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                </div>
                ${currentUserRole === 'admin' ? `
                <div id="create-sheet-container" class="collapsible-content mt-3">
                    <form id="create-sheet-form" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                        <input type="text" id="new-sheet-name" class="input-field flex-grow" placeholder="Nome nuova scheda..." required>
                        <input type="number" id="new-sheet-weeks" class="input-field sm:w-28" placeholder="Sett." min="1" required>
                        <button type="submit" class="btn !w-full sm:!w-auto"><i class="fas fa-plus mr-2"></i> Aggiungi</button>
                    </form>
                </div>` : ''}`;
            document.getElementById('sheet-selector').addEventListener('change', (e) => selectSheet(e.target.value));

            if (currentUserRole === 'admin') {
                document.getElementById('toggle-create-sheet-btn')?.addEventListener('click', () => document.getElementById('create-sheet-container')?.classList.toggle('open'));
                document.getElementById('create-sheet-form')?.addEventListener('submit', handleCreateSheet);
                document.getElementById('add-weeks-btn')?.addEventListener('click', handleAddWeeks);
                document.getElementById('duplicate-sheet-btn')?.addEventListener('click', handleDuplicateSheet);
                document.getElementById('delete-sheet-btn')?.addEventListener('click', handleDeleteSheet);
            }
        }

        async function selectSheet(sheetId) {
            Object.values(procrastinationTimers).forEach(clearTimeout);
            procrastinationTimers = {};

            const sheetContent = document.getElementById('sheet-content');
            const initialMessage = document.getElementById('initial-message');

            if (!sheetId) {
                sheetContent.classList.add('hidden');
                initialMessage.classList.remove('hidden');
                currentSheetId = null;
                currentSheetName = '';
                return;
            }

            initialMessage.classList.add('hidden');
            sheetContent.classList.remove('hidden');
            currentSheetId = sheetId;
            currentWeek = 1;
            modifiedExercisesThisWeek = new Set();
            localStorage.removeItem(`completion_reminder_${currentSheetId}_${currentWeek}`); // Reset reminder flag

            const sheetDocRef = doc(getSheetsRef(currentMesoId), sheetId);
            const sheetDocSnap = await getDoc(sheetDocRef);
            if (!sheetDocSnap.exists()) {
                showNotification("Scheda non trovata!", "error");
                return;
            }
            currentSheetData = sheetDocSnap.data();
            currentSheetName = currentSheetData.nomeScheda;

            renderWeekSelector();
            renderWorkoutControls();
            renderSpecificRecap();
            if (currentUserRole === 'admin') {
                renderAddExerciseForm();
            }
            await loadAndRenderExercises();
        }

        async function loadAndRenderExercises() {
            const exerciseContainer = document.getElementById('exercise-list-container');
            exerciseContainer.innerHTML = '<div class="loader"></div>';
            const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
            const q = query(exercisesRef, orderBy("ordine"));
            const exercisesSnapshot = await getDocs(q);
            exercisesCache = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderExercises();
        }

        // --- RENDERING UI SPECIFICA ---
        function renderWeekSelector() {
            const weekSelectorContainer = document.getElementById('week-selector-container');
            const numWeeks = currentSheetData.numeroSettimane || 1;
            weekSelectorContainer.innerHTML = `<div class="flex items-center space-x-2 overflow-x-auto pb-1 no-scrollbar"></div>`;
            const container = weekSelectorContainer.firstElementChild;

            for (let i = 1; i <= numWeeks; i++) {
                const isCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === i);
                const btn = document.createElement('button');
                btn.innerHTML = `Sett. ${i} ${isCompleted ? '<i class="fas fa-check-circle ml-1 text-green-400"></i>' : ''}`;
                let classes = 'week-btn px-4 py-2 rounded-md font-semibold text-sm';
                if (i === currentWeek) classes += ' active';
                if (isCompleted) {
                    btn.classList.add('opacity-70', 'border-green-500/50');
                }
                btn.className = classes;

                btn.onclick = () => {
                    currentWeek = i;
                    modifiedExercisesThisWeek = new Set();
                    localStorage.removeItem(`completion_reminder_${currentSheetId}_${currentWeek}`); // Reset reminder flag
                    renderWeekSelector();
                    renderExercises();
                    renderWorkoutControls();
                    renderSpecificRecap();
                };
                container.appendChild(btn);
            }
        }

        function calculateAndRenderSheetVolume() {
            const sheetVolumeSummaryContainer = document.getElementById('sheet-volume-summary-container');

            // --- Aggiunto il wrapper collapsible ---
            let collapseIcon = document.getElementById('volume-collapse-icon') || document.createElement('i');
            collapseIcon.id = 'volume-collapse-icon';
            collapseIcon.className = 'fas fa-chevron-down ml-2 transition-transform duration-300 accordion-icon';
                        
            // Logica per inizializzare CHIUSO a meno che non sia stato aperto precedentemente
            let isVolumeOpen = localStorage.getItem('volume_is_open');
            if (isVolumeOpen === null) {
                isVolumeOpen = true; // Default: aperto la prima volta
                localStorage.setItem('volume_is_open', 'true');
            } else {
                isVolumeOpen = isVolumeOpen === 'true';
            }
                        
            if (!isVolumeOpen) {
                collapseIcon.classList.add('rotate-180');
            }

            const header = `
                <div id="volume-header" class="flex justify-between items-center cursor-pointer p-1 accordion-header" onclick="toggleVolumeCollapse()">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-chart-pie mr-2 text-indigo-500"></i> Volume Muscolare Totale</h3>
                    ${collapseIcon.outerHTML}
                </div>
                <div id="volume-content" class="collapsible-content ${isVolumeOpen ? 'open' : ''} pt-2">
                    <div id="volume-details" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                        <div class="loader !my-2"></div>
                    </div>
                </div>
            `;
            sheetVolumeSummaryContainer.innerHTML = header;

            if (exercisesCache.length === 0) { 
                 document.getElementById('volume-details').innerHTML = `<p class="text-secondary col-span-full">Nessun esercizio per calcolare il volume.</p>`; 
                 return;
            }
                        
            // --- Calcolo del Volume ---
            const volumeByMuscleGroup = {};
            for (const group in MACROCYCLE_RULES) {
                volumeByMuscleGroup[group] = 0;
            }

            exercisesCache.forEach(ex => {
                const { categoria, serie } = ex;
                // Escludi il cardio dal calcolo del volume ipertrofico
                if (!categoria || !serie || ex.isCardio) return;

                for (const group in MACROCYCLE_RULES) {
                    const rule = MACROCYCLE_RULES[group];
                    if (rule.main === categoria) {
                        volumeByMuscleGroup[group] += serie;
                    } else {
                        const additionalRule = rule.additional.find(r => r.category === categoria);
                        if (additionalRule) {
                            volumeByMuscleGroup[group] += serie * (additionalRule.percentage / 100);
                        }
                    }
                }
            });
            // --- Fine Calcolo del Volume ---

            let summaryHTML = '';
            const sortedGroups = Object.keys(volumeByMuscleGroup).sort();
            let hasVolume = false;

            sortedGroups.forEach(group => {
                const volume = Math.round(volumeByMuscleGroup[group] * 10) / 10;
                if (volume > 0) {
                    hasVolume = true;
                    summaryHTML += `<div class="bg-slate-800/50 p-2 rounded"><span class="font-semibold text-secondary">${group}:</span> <span class="text-indigo-400 font-bold">${volume} serie</span></div>`;
                }
            });

            document.getElementById('volume-details').innerHTML = hasVolume ? summaryHTML : `<p class="text-secondary col-span-full">Nessun volume effettivo calcolato.</p>`;
        }
                        
        // NEW GLOBAL FUNCTION for collapse
        window.toggleVolumeCollapse = function() {
            const content = document.getElementById('volume-content');
            const icon = document.getElementById('volume-header').querySelector('.accordion-icon');
                        
            // Trova l'elemento che gestisce il collapse e l'icona
            if (icon) { 
                 const isOpen = !content.classList.contains('open'); 
                 content.classList.toggle('open'); 
                 icon.classList.toggle('rotate-180', !isOpen); 
                 localStorage.setItem('volume_is_open', isOpen);
            }
        }

        function renderExercises() {
            const exerciseContainer = document.getElementById('exercise-list-container');
            exerciseContainer.innerHTML = '';
            if (exercisesCache.length === 0) {
                exerciseContainer.innerHTML = `<div class="text-center py-8"><i class="fas fa-dumbbell text-4xl text-slate-600 mb-4"></i><p class="text-secondary">Nessun esercizio. Aggiungine uno.</p></div>`;
            } else {
                exercisesCache.forEach(ex => exerciseContainer.appendChild(createExerciseCard(ex)));
            }
            calculateAndRenderSheetVolume();
        }

        function createExerciseCard(ex) {
            const card = document.createElement('div');
            card.id = `ex-card-${ex.id}`;

            let cardClasses = 'card-bg p-3 rounded-lg border shadow-md transition-all duration-300';
            if (ex.isCardio) { // NEW: Cardio Style
                cardClasses += ' cardio-card';
            } else if (ex.isCircuit) {
                cardClasses += ' circuit-card';
            } else if (ex.tecnicheIntensita && ex.tecnicheIntensita.trim() !== '') {
                cardClasses += ' intensity-glow';
            } else {
                cardClasses += ' border-stone-800';
            }
            card.className = cardClasses;

            let seriesHTML = '';
            // 1. Dati Settimanali (Nuovo formato con userNote e adminMemo)
            let weeklyData = ex.datiSettimanali?.[currentWeek] || {};
            if (Array.isArray(weeklyData)) {
                // Migrazione formato vecchio (in-memory per questa settimana)
                weeklyData = { userNote: '', sets: weeklyData, adminMemo: '' };
            }
            const setDataArray = weeklyData.sets || [];
            const weeklyUserNoteContent = weeklyData.userNote || ''; // Nota Atleta (Settimanale)
            const weeklyAdminMemo = weeklyData.adminMemo || ''; // Memo Alert (Settimanale)

            const prevWeeklyDataRaw = ex.datiSettimanali?.[currentWeek - 1] || {};
            const prevSetDataArray = (Array.isArray(prevWeeklyDataRaw) ? prevWeeklyDataRaw : prevWeeklyDataRaw.sets) || []; // Handle previous week format
            const targetReps = ex.ripetizioniPerSerie || [];

            if (ex.isCardio) { // NEW: Cardio specific display
                const cardioIcon = `<i class="fas fa-heartbeat mr-1 text-[var(--cardio-color)]"></i>`;
                seriesHTML = `
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold text-secondary text-sm">${cardioIcon} Tempo/Distanza Obiettivo:</span>
                            <span class="text-white font-bold">${ex.ripetizioni || 'N/D'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold text-secondary text-sm">${cardioIcon} FC Target:</span>
                            <span class="text-white font-bold">${ex.fcMinTarget || '-'} - ${ex.fcMaxTarget || '-'} bpm</span>
                        </div>
                        <div class="grid grid-cols-5 items-center gap-2 pt-3 border-t border-stone-700">
                            <span class="font-semibold text-secondary text-sm col-span-2">Risultato Effettivo:</span>
                            <input type="text" placeholder="Tempo/Dist. Fatti" class="input-field !p-2 text-center col-span-3" value="${setDataArray[0]?.carico || ''}" data-ex-id="${ex.id}" data-serie-index="0" data-field="carico">
                             </div>
                    </div>
                `;
            } else { // Standard lifting display
                seriesHTML = '<div class="space-y-2 mt-2">';
                for (let i = 0; i < ex.serie; i++) {
                    let setData = setDataArray[i] || { carico: '', reps: '' };
                    const prevSetData = prevSetDataArray[i] || null;
                    const targetRep = targetReps[i] || ex.ripetizioni || '';

                    // Logic for progressive overload suggestion (only for non-circuit)
                    if (currentWeek > 1 && !setData.carico && prevSetData?.carico && prevSetData?.reps) {
                        const repRange = (targetRep.toString() || "").split('-').map(Number);
                        const maxReps = repRange.length > 1 ? repRange[1] : repRange[0];
                        if (parseInt(prevSetData.reps, 10) >= maxReps) {
                            setData.carico = (parseFloat(prevSetData.carico) + WEIGHT_INCREMENT).toString();
                        } else {
                            setData.carico = prevSetData.carico;
                        }
                        // IMPORTANT: The auto-fill value here is ONLY in the DOM (setData). It is NOT saved to Firestore
                        // and should NOT trigger automatic log if it is the first set. Log triggers only on manual input save.
                    }

                    let prevWeekHint = prevSetData ? `<p class="text-xs text-slate-500 text-right col-span-5 mb-1"><i class="fas fa-history mr-1"></i> Sett. prec: ${prevSetData.carico || '-'}kg x ${prevSetData.reps || '-'}</p>` : '';

                    // Determine timer button action
                    let timerButton;
                    if (ex.isCircuit) {
                        timerButton = `<button class="btn btn-secondary !p-2 text-xs" data-circuit-ex-id="${ex.id}" title="Avvia Timer Circuito"><i class="fas fa-stopwatch-20"></i></button>`;
                    } else {
                        timerButton = `<button class="btn btn-secondary !p-2 text-xs" data-timer="${ex.recupero}" title="Avvia timer recupero"><i class="fas fa-stopwatch"></i></button>`;
                    }

                    seriesHTML += `
                        ${prevWeekHint}
                        <div class="grid grid-cols-5 items-center gap-2">
                            <span class="font-semibold text-secondary text-sm">S ${i + 1} (${targetRep})</span>
                            <input type="number" step="0.5" placeholder="kg" class="input-field !p-2 text-center" value="${setData.carico}" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="carico">
                            <input type="number" placeholder="reps" class="input-field !p-2 text-center" value="${setData.reps}" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="reps">
                            <span class="text-xs text-indigo-400 font-mono" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="1rm">~% 1RM</span>
                            ${timerButton}
                        </div>`;
                }
                seriesHTML += '</div>';
            }


            let imagesHTML = '';
            const imageUrls = [ex.imageUrl, ex.imageUrl2, ex.imageUrl3, ex.imageUrl4].filter(url => url);

            // FIX: Correzione bug duplicazione immagini (rimosso loop interno errato)
            if (imageUrls.length > 0) {
                if (imageUrls.length > 2) { // Use grid for 3 or 4 images
                    imagesHTML += `<div class="image-grid">`;
                    imageUrls.forEach(url => {
                        imagesHTML += `<div><img src="${url}" alt="${ex.nomeEsercizio}" class="exercise-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/374151/E5E7EB?text=NO_IMG';"></div>`;
                    });
                    imagesHTML += `</div>`;
                } else { // Use flex for 1 or 2 images
                    imagesHTML += `<div class="flex gap-2 mt-2 justify-center">`;
                    imageUrls.forEach(url => {
                        // FIX: Utilizzo corretto dell'HTML per le immagini senza duplicazione
                        imagesHTML += `<div class="${imageUrls.length === 1 ? 'w-1/2 max-w-[200px]' : 'w-1/2'}"><img src="${url}" alt="${ex.nomeEsercizio}" class="exercise-image" onerror="this.onerror=null;this.src='https://placehold.co/100x100/374151/E5E7EB?text=NO_IMG';"></div>`;
                    });
                    imagesHTML += '</div>';
                }
            }

            const repsDisplay = ex.ripetizioniPerSerie && ex.ripetizioniPerSerie.length > 0 ? ex.ripetizioniPerSerie.join(' / ') : (ex.ripetizioni || '');

            // Weekly Admin Alert (Visible if the user has written a memo OR if the Admin is viewing)
            const adminAlertIndicator = (currentUserRole === 'admin' && weeklyAdminMemo) ? 
                                             `<button class="btn btn-danger !p-1 text-xs ml-2" data-admin-alert-memo="${weeklyAdminMemo}" title="Memo Alert Settimanale!"><i class="fas fa-exclamation-triangle"></i></button>` : 
                                            (weeklyAdminMemo ? `<span class="text-red-400 text-xs ml-2" title="Memo in attesa di revisione"><i class="fas fa-exclamation-triangle"></i></span>` : '');

            // --- NEW: AI Recommendation Block ---
            let recBlock = '';
            const isUserImpersonatingOrSelf = selectedUserId || currentUser.uid;
            if (isUserImpersonatingOrSelf && !ex.isCardio) { // Mostra il blocco per tutti gli utenti autenticati, solo per esercizi non-cardio
                recBlock = `
                    <div id="ai-rec-block-${ex.id}" class="mt-2 pt-2 border-t border-stone-700 space-y-2">
                        <h5 class="text-sm font-bold text-indigo-400 flex items-center mb-2"><i class="fas fa-brain mr-2"></i> Suggerimento AI Progressione (Sett. ${currentWeek})</h5>
                                                <div id="ai-rec-content-${ex.id}">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-2">
                                <span id="ai-rec-text-${ex.id}" class="text-xs text-secondary italic flex-grow pr-2">Clicca "Chiedi all'AI" per un consiglio...</span>
                                <div class="flex gap-2 mt-2 sm:mt-0">
                                    <button class="btn btn-secondary !py-2 !px-3 text-xs flex-shrink-0" id="apply-ai-rec-btn-${ex.id}" data-apply-rec-ex-id="${ex.id}" title="Applica carico/reps suggeriti" disabled><i class="fas fa-check-double mr-1"></i> Applica Carico AI</button>
                                    <button class="btn btn-ai-generate !py-2 !px-4 text-xs flex-shrink-0" data-generate-rec-ex-id="${ex.id}" title="Genera Consiglio AI"><i class="fas fa-magic mr-1"></i> Chiedi all'AI</button>
                                </div>
                            </div>
                            <div id="ai-tips-container-${ex.id}" class="text-xs text-stone-300 space-y-1">
                                </div>
                        </div>
                    </div>
                `;
            }
            // --- END NEW: AI Recommendation Block ---

            const cardioBadge = ex.isCardio ? '<span class="reward-badge !bg-[var(--cardio-color)] !text-white">CARDIO</span>' : '';
            const fcTargetDisplay = ex.isCardio ? `<i class="fas fa-heart-rate mr-1 ml-2 text-red-400"></i> FC: ${ex.fcMinTarget || '-'} - ${ex.fcMaxTarget || '-'} bpm |` : '';


            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow pr-4">
                        <h4 class="text-lg font-bold text-white">${ex.nomeEsercizio} ${ex.isCircuit ? '<span class="reward-badge !bg-amber-500 !text-amber-900">CIRCUITO</span>' : ''} ${cardioBadge}</h4>
                        <p class="text-sm text-indigo-500"><i class="fas fa-tag mr-1"></i> ${ex.categoria}</p>
                        ${!ex.isCardio ? 
                           `<p class="text-xs text-secondary mt-1">
                                <i class="fas fa-list-ol mr-1"></i> S: ${ex.serie} | 
                                <i class="fas fa-redo mr-1 ml-2"></i> R: ${repsDisplay} |
                                ${ex.isCircuit ? `<i class="fas fa-clock mr-1 ml-2"></i> Lavoro: ${ex.circuitWorkTime || '-'}s | Rec Round: ${ex.circuitRestTime || '-'}s |` : ''}
                                <i class="fas fa-fire mr-1 ml-2"></i> RIR: ${ex.rir || '-'} | 
                                <i class="fas fa-hourglass-half mr-1 ml-2"></i> Rec: ${ex.recupero || '-'}s | 
                                <i class="fas fa-stopwatch-20 mr-1 ml-2"></i> TUT: ${ex.tut || '-'}
                            </p>` 
                          : 
                          `<p class="text-xs text-secondary mt-1">
                                <i class="fas fa-bullseye mr-1"></i> Obiettivo: ${repsDisplay} |
                                ${fcTargetDisplay}
                                <i class="fas fa-hourglass-half mr-1 ml-2"></i> Rec: ${ex.recupero || '-'}s
                            </p>`
                        }
                        
                        ${ex.tecnicheIntensita ? `<p class="text-sm text-indigo-400 mt-2 font-semibold"><i class="fas fa-bolt mr-2"></i> ${ex.tecnicheIntensita}</p>` : ''}

                        ${ex.note ? `<p class="text-sm text-stone-300 mt-2 border-t border-stone-700/50 pt-2"><i class="fas fa-comment-dots mr-1 text-indigo-400"></i><span class="font-semibold text-indigo-400">Nota Coach (Persistente):</span> ${ex.note}</p>` : ''}
                    </div>
                    <div class="flex items-start gap-2">
                        <div class="flex flex-col gap-1">
                            <button class="btn btn-secondary !p-1 reorder-btn" data-reorder-ex-id="${ex.id}" data-direction="up" title="Sposta su"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn btn-secondary !p-1 reorder-btn" data-reorder-ex-id="${ex.id}" data-direction="down" title="Sposta giù"><i class="fas fa-arrow-down"></i></button>
                        </div>
                        <div class="flex flex-col gap-1">
                            <button class="btn btn-secondary !p-2" data-save-fav-ex-id="${ex.id}" title="Salva nei preferiti"><i class="fas fa-star"></i></button>
                            <button class="btn btn-secondary !p-2" data-edit-ex-id="${ex.id}" title="Modifica"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary !p-2" data-history-ex-id="${ex.id}" title="Storico"><i class="fas fa-chart-line"></i></button>
                            <button class="btn btn-danger !p-2" data-delete-ex-id="${ex.id}" title="Elimina"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
                ${imagesHTML}
                ${recBlock} ${seriesHTML}

                <div class="mt-4 pt-3 border-t border-stone-800 space-y-3">
                    <div>
                        <label for="persistent-user-note-${ex.id}" class="text-xs text-secondary mb-1 block font-semibold">Tua Nota (Persistente, per te stesso):</label>
                        <textarea id="persistent-user-note-${ex.id}" class="textarea-field !p-2 text-sm" data-ex-id="${ex.id}" data-field="persistentUserNote" placeholder="Es. Ricorda di usare il bilanciere EZ, non il dritto">${ex.persistentUserNote || ''}</textarea>
                    </div>

                    <div>
                        <label for="weekly-user-note-${ex.id}" class="text-xs text-secondary mb-1 block font-semibold">Tua Nota (Settimana ${currentWeek}, privata):</label>
                        <textarea id="weekly-user-note-${ex.id}" class="textarea-field !p-2 text-sm" data-ex-id="${ex.id}" data-field="userNote" placeholder="Es. Sentito bene, aumento il carico prossima settimana">${weeklyUserNoteContent}</textarea>
                    </div>

                    <div>
                        <label for="weekly-admin-memo-${ex.id}" class="text-xs text-secondary mb-1 block font-semibold flex items-center">
                            Memo Alert (Problema Sett. ${currentWeek} per Coach)
                            ${adminAlertIndicator}
                        </label>
                        <textarea id="weekly-admin-memo-${ex.id}" class="textarea-field !p-2 text-sm ${weeklyAdminMemo ? '!border-red-500' : ''}" data-ex-id="${ex.id}" data-field="adminMemo" placeholder="Es. Ho avuto dolore al gomito nella terza serie, carichi ridotti.">${weeklyAdminMemo}</textarea>
                    </div>
                </div>
                `;

            if (!ex.isCardio) {
                const repsInputs = card.querySelectorAll('input[data-field="reps"]');
                repsInputs.forEach(input => {
                    const reps = parseInt(input.value, 10);
                    const serieIndex = input.dataset.serieIndex;
                    const oneRmSpan = card.querySelector(`span[data-field="1rm"][data-serie-index="${serieIndex}"]`);
                    if (oneRmSpan) {
                        oneRmSpan.textContent = calculate1RMEstimate(reps);
                    }
                });
            }
            return card;
        }

        function generateRepInputs(container, numSeries, values = []) {
            container.innerHTML = '';
            if (numSeries > 0) {
                const label = document.createElement('label');
                label.className = 'text-sm text-secondary col-span-full';
                label.textContent = 'Ripetizioni per Serie';
                container.appendChild(label);
            }
            for (let i = 0; i < numSeries; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'ripetizioniPerSerie';
                input.className = 'input-field !p-2 text-center';
                input.placeholder = `S ${i + 1}`;
                input.value = values[i] || '';
                container.appendChild(input);
            }
        }

        function renderAddExerciseForm() {
            const addExerciseContainer = document.getElementById('add-exercise-container');
            const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            addExerciseContainer.innerHTML = `
                <form id="add-exercise-form" class="space-y-4">
                    <input type="text" name="nomeEsercizio" class="input-field" placeholder="Nome Esercizio" required>
                    <select name="categoria" class="input-field" required>${categoryOptions}</select>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4">
                        <input type="number" name="serie" class="input-field" placeholder="N° Serie" required>
                        <input type="text" name="ripetizioni" class="input-field" placeholder="Reps (es. 8-12) / Tempo (es. 30min)">
                        <input type="text" name="rir" class="input-field" placeholder="RIR (es. 1-2)">
                        <input type="text" name="tut" class="input-field" placeholder="TUT (es. 2-1-1)">
                        <input type="number" name="recupero" class="input-field" placeholder="Recupero (s)">
                    </div>
                    <div id="add-ripetizioni-per-serie-container" class="grid grid-cols-3 sm:grid-cols-6 gap-2 mt-2"></div>
                    <input type="text" name="tecnicheIntensita" class="input-field" placeholder="Tecnica di Intensità (es. Dropset)">
                     <textarea name="note" class="textarea-field" placeholder="Nota Coach (Opzionale - persistente ogni settimana)"></textarea>
                     <textarea name="persistentUserNote" class="textarea-field" placeholder="Nota Atleta (Persistente - per l'atleta)"></textarea>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-secondary">Immagine 1</label>
                            <input type="url" name="imageUrl" class="input-field mb-2" placeholder="URL Immagine 1">
                            <input type="file" name="imageFile1" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600">
                        </div>
                        <div>
                            <label class="text-sm text-secondary">Immagine 2</label>
                            <input type="url" name="imageUrl2" class="input-field mb-2" placeholder="URL Immagine 2">
                            <input type="file" name="imageFile2" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600">
                        </div>
                    </div>

                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="isCircuit" name="isCircuit" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-secondary">È un circuito?</span>
                        </label>
                         <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="isCardio" name="isCardio" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-[var(--cardio-color)] focus:ring-[var(--cardio-color)]">
                            <span class="text-secondary">È un esercizio Cardio?</span>
                        </label>
                    </div>

                    <div id="add-circuit-fields" class="hidden space-y-4 pt-4 border-t border-slate-700">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="number" name="circuitWorkTime" class="input-field" placeholder="Tempo Lavoro per round (secondi)">
                            <input type="number" name="circuitRestTime" class="input-field" placeholder="Recupero tra Round (secondi)">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-secondary">Immagine 3</label>
                                <input type="url" name="imageUrl3" class="input-field mb-2" placeholder="URL Immagine 3">
                                <input type="file" name="imageFile3" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600">
                            </div>
                            <div>
                                <label class="text-sm text-secondary">Immagine 4</label>
                                <input type="url" name="imageUrl4" class="input-field mb-2" placeholder="URL Immagine 4">
                                <input type="file" name="imageFile4" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600">
                            </div>
                        </div>
                    </div>

                     <div id="add-cardio-fields" class="hidden space-y-4 pt-4 border-t border-slate-700">
                        <h5 class="text-base font-bold text-[var(--cardio-color)]">Target Frequenza Cardiaca (FC)</h5>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="number" name="fcMinTarget" class="input-field" placeholder="FC Minima Target (bpm)">
                            <input type="number" name="fcMaxTarget" class="input-field" placeholder="FC Massima Target (bpm)">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn w-full !mt-6">Aggiungi Esercizio</button>
                </form>`;
            const addForm = document.getElementById('add-exercise-form');
            const isCardioCheckbox = addForm.elements.isCardio;
            const isCircuitCheckbox = addForm.elements.isCircuit;

            addForm.elements.serie.addEventListener('input', (e) => {
                const numSeries = parseInt(e.target.value, 10) || 0;
                const container = addForm.querySelector('#add-ripetizioni-per-serie-container');
                generateRepInputs(container, numSeries);
            });
            isCircuitCheckbox.addEventListener('change', (e) => {
                document.getElementById('add-circuit-fields').classList.toggle('hidden', !e.target.checked);
                if (e.target.checked) isCardioCheckbox.checked = false; // Cannot be both
                document.getElementById('add-cardio-fields').classList.add('hidden');
            });
            isCardioCheckbox.addEventListener('change', (e) => {
                document.getElementById('add-cardio-fields').classList.toggle('hidden', !e.target.checked);
                if (e.target.checked) isCircuitCheckbox.checked = false; // Cannot be both
                document.getElementById('add-circuit-fields').classList.add('hidden');
            });

            addForm.addEventListener('submit', handleAddExercise);
        }

        // --- GESTIONE EVENTI E AZIONI ---
        async function handleCreateMeso(e) {
            e.preventDefault();
            const form = e.target;
            const mesoName = form.elements['name'].value.trim();
            if (!mesoName) return;

            await addDoc(getMesocyclesRef(), { nome: mesoName, dataCreazione: new Date().toISOString() });
            await renderMesocycleSelector();
            showNotification("Mesociclo creato con successo!");
        }

        async function handleCreateSheet(e) {
            e.preventDefault();
            const form = e.target;
            const sheetName = form.elements['new-sheet-name'].value.trim();
            const numWeeks = parseInt(form.elements['new-sheet-weeks'].value, 10);
            if (!sheetName || !numWeeks) return;

            await addDoc(getSheetsRef(currentMesoId), { nomeScheda: sheetName, numeroSettimane: numWeeks, dataCreazione: new Date().toISOString(), isCompleta: false, completedWeeks: [] });
            await renderSheetSelector();
            showNotification("Scheda creata con successo!");
        }

        async function handleDuplicateSheet() {
            if (!currentSheetId) { showNotification("Seleziona una scheda da duplicare.", "warning"); return; }

            const newName = prompt("Nuovo nome per la scheda:", `${currentSheetData.nomeScheda} (Copia)`);
            if (!newName) return;

            const newSheetRef = await addDoc(getSheetsRef(currentMesoId), { ...currentSheetData, nomeScheda: newName, dataCreazione: new Date().toISOString(), isCompleta: false });
            const exercisesSnapshot = await getDocs(getExercisesRef(currentMesoId, currentSheetId));
            const batch = writeBatch(db);
            exercisesSnapshot.forEach(exDoc => {
                const newExerciseRef = doc(getExercisesRef(currentMesoId, newSheetRef.id));
                batch.set(newExerciseRef, exDoc.data());
            });
            await batch.commit();

            showNotification(`Scheda "${newName}" creata!`);
            await renderSheetSelector();
        }

        async function handleDeleteSheet() {
            if (!currentSheetId) { showNotification("Seleziona una scheda da eliminare.", "warning"); return; }
            if (await showConfirmModal(`Sei sicuro di voler eliminare la scheda "${currentSheetData.nomeScheda}"?`)) {
                const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
                const exercisesSnapshot = await getDocs(exercisesRef);
                const batch = writeBatch(db);
                exercisesSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                await deleteDoc(doc(getSheetsRef(currentMesoId), currentSheetId));
                showNotification("Scheda eliminata.");
                currentSheetId = null;
                document.getElementById('sheet-content').classList.add('hidden');
                document.getElementById('initial-message').classList.remove('hidden');
                await renderSheetSelector();
            }
        }

        async function handleAddWeeks() {
            if (!currentSheetId || !currentSheetData) {
                showNotification("Seleziona una scheda per aggiungere settimane.", "warning");
                return;
            }

            const weeksToAddStr = prompt("Quante settimane vuoi aggiungere?");
            if (!weeksToAddStr) return;
            const weeksToAdd = parseInt(weeksToAddStr, 10);
            if (isNaN(weeksToAdd) || weeksToAdd <= 0) {
                showNotification("Inserisci un numero di settimane valido e positivo.", "error");
                return;
            }

            const currentWeeks = currentSheetData.numeroSettimane || 0;
            const newTotalWeeks = currentWeeks + weeksToAdd;

            try {
                const sheetRef = doc(getSheetsRef(currentMesoId), currentSheetId);
                await updateDoc(sheetRef, { numeroSettimane: newTotalWeeks });
                currentSheetData.numeroSettimane = newTotalWeeks;
                renderWeekSelector();
                showNotification(`${weeksToAdd} settimana(e) aggiunta(e) con successo! Totale: ${newTotalWeeks}.`, "success");
            } catch (error) {
                console.error("Errore durante l'aggiunta di settimane:", error);
                showNotification("Errore durante l'aggiornamento.", "error");
            }
        }

        async function uploadImage(file) {
            if (!file) return null;
            const storageRef = ref(storage, `exercise_images/${Date.now()}_${file.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (error) {
                console.error("Errore durante l'upload dell'immagine:", error);
                showNotification("Errore upload immagine.", "error");
                return null;
            }
        }

        async function handleAddExercise(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Aggiungo...';

            const imageFile1 = form.elements.imageFile1.files[0];
            const imageFile2 = form.elements.imageFile2.files[0];
            const imageUrl1 = await uploadImage(imageFile1);
            const imageUrl2 = await uploadImage(imageFile2);

            const isCircuit = form.elements.isCircuit.checked;
            const isCardio = form.elements.isCardio.checked; // NEW
            let imageUrl3 = null, imageUrl4 = null;
            let circuitWorkTime = null, circuitRestTime = null;
            let fcMinTarget = null, fcMaxTarget = null; // NEW

            if (isCircuit) {
                const imageFile3 = form.elements.imageFile3.files[0];
                const imageFile4 = form.elements.imageFile4.files[0];
                imageUrl3 = await uploadImage(imageFile3);
                imageUrl4 = await uploadImage(imageFile4);

                circuitWorkTime = parseInt(form.elements.circuitWorkTime.value, 10) || null;
                circuitRestTime = parseInt(form.elements.circuitRestTime.value, 10) || null;
            }
            
            if (isCardio) { // NEW
                fcMinTarget = parseInt(form.elements.fcMinTarget.value, 10) || null;
                fcMaxTarget = parseInt(form.elements.fcMaxTarget.value, 10) || null;
            }

            const newExercise = {
                nomeEsercizio: form.elements.nomeEsercizio.value,
                categoria: form.elements.categoria.value,
                ordine: (exercisesCache.length || 0) + 1,
                serie: parseInt(form.elements.serie.value, 10),
                ripetizioni: form.elements.ripetizioni.value, // Used for Time/Distance in Cardio
                rir: form.elements.rir.value || "",
                tut: form.elements.tut.value || "",
                recupero: parseInt(form.elements.recupero.value, 10) || null,
                // RIGA MODIFICATA PER ENFATIZZARE INTENSITÀ
                tecnicheIntensita: form.elements.tecnicheIntensita.value || "",
                note: form.elements.note.value || "", // Coach/Persistent Note
                persistentUserNote: form.elements.persistentUserNote.value || "", // NEW Persistent Athlete Note
                imageUrl: imageUrl1 || form.elements.imageUrl.value || "",
                imageUrl2: imageUrl2 || form.elements.imageUrl2.value || "",
                ripetizioniPerSerie: Array.from(form.querySelectorAll('input[name="ripetizioniPerSerie"]')).map(input => input.value),
                datiSettimanali: {},
                // Circuit Fields
                isCircuit: isCircuit,
                circuitWorkTime: circuitWorkTime, 
                circuitRestTime: circuitRestTime, 
                imageUrl3: isCircuit ? (imageUrl3 || form.elements.imageUrl3.value || "") : "",
                imageUrl4: isCircuit ? (imageUrl4 || form.elements.imageUrl4.value || "") : "",
                // Cardio Fields
                isCardio: isCardio, // NEW
                fcMinTarget: fcMinTarget, // NEW
                fcMaxTarget: fcMaxTarget, // NEW
            };

            await addDoc(getExercisesRef(currentMesoId, currentSheetId), newExercise);
            form.reset();
            document.getElementById('add-ripetizioni-per-serie-container').innerHTML = ''; // Clear reps per series
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Aggiungi Esercizio';
            document.getElementById('add-circuit-fields').classList.add('hidden');
            document.getElementById('add-cardio-fields').classList.add('hidden'); // NEW
            document.getElementById('add-exercise-container').classList.remove('open');
            await loadAndRenderExercises();
            showNotification("Esercizio aggiunto!");
        }

        async function handleReorderExercise(exId, direction) {
            const currentIndex = exercisesCache.findIndex(ex => ex.id === exId);
            if (currentIndex === -1) return;
            const otherIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (otherIndex < 0 || otherIndex >= exercisesCache.length) return;

            const [currentExercise, otherExercise] = [exercisesCache[currentIndex], exercisesCache[otherIndex]];
            const [currentOrder, otherOrder] = [currentExercise.ordine, otherExercise.ordine];

            const batch = writeBatch(db);
            batch.update(doc(getExercisesRef(currentMesoId, currentSheetId), currentExercise.id), { ordine: otherOrder });
            batch.update(doc(getExercisesRef(currentMesoId, currentSheetId), otherExercise.id), { ordine: currentOrder });

            await batch.commit();
            await loadAndRenderExercises();
        }

        async function handleSaveToFavorites(exercise) {
            const { datiSettimanali, id, ...favData } = exercise; 
             await addDoc(getFavoriteExercisesRef(), favData);
            showNotification(`"${favData.nomeEsercizio}" salvato nei preferiti!`);
        }

        // Funzione helper per verificare lo stato di completamento dei log
        function isWorkoutAlmostCompleted() {
            if (exercisesCache.length === 0) return false;

            let totalExercises = exercisesCache.length;
            let completedExercises = 0;
                        
            exercisesCache.forEach(ex => {
                const weeklyData = ex.datiSettimanali?.[currentWeek] || {};
                const setDataArray = Array.isArray(weeklyData) ? weeklyData : (weeklyData.sets || []);
                                
                // Un esercizio è considerato 'completato' se la maggior parte dei set ha sia carico che reps (o il campo carico è compilato per il cardio)
                const totalSets = ex.serie;
                let filledSets = 0;
                
                if (ex.isCardio) {
                    filledSets = setDataArray[0]?.carico ? 1 : 0; // Check only the cardio log field
                    if (filledSets > 0) completedExercises++;
                } else {
                    filledSets = setDataArray.filter(set => set.carico && set.reps).length;
                    if (totalSets > 0 && filledSets >= totalSets) { // Compilati tutti i set
                        completedExercises++;
                    }
                }
            });

            // Considera "quasi completato" se il penultimo esercizio è stato compilato
            return completedExercises >= totalExercises - 1; 
        }

        mainView.addEventListener('input', (e) => {
            if (e.target.matches('input[data-ex-id]')) {
                const { exId, serieIndex, field } = e.target.dataset;
                const value = e.target.value;
                const weekForSave = currentWeek;

                // Clear set-specific timeout
                const key = `${exId}-${weekForSave}-${serieIndex}-${field}`;
                clearTimeout(saveTimeouts[key]);
                saveTimeouts[key] = setTimeout(async () => { 
                     await saveWeeklyData(exId, parseInt(serieIndex, 10), field, value, weekForSave);

                     // Logica Avviso di Completamento dopo il salvataggio 
                     const isWeekCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === currentWeek); 
                     const isReminderShown = localStorage.getItem(`completion_reminder_${currentSheetId}_${currentWeek}`) === 'true';

                     if (!isWeekCompleted && !isReminderShown) { 
                         if (isWorkoutAlmostCompleted()) {
                            completionReminderModal.classList.remove('hidden', 'opacity-0');
                            localStorage.setItem(`completion_reminder_${currentSheetId}_${currentWeek}`, 'true'); 
                         } 
                     }
                }, 800);

                if (field === 'reps') {
                    const card = e.target.closest('.card-bg');
                    if (card) {
                        const oneRmSpan = card.querySelector(`span[data-field="1rm"][data-serie-index="${serieIndex}"]`);
                        if (oneRmSpan) oneRmSpan.textContent = calculate1RMEstimate(parseInt(value, 10));
                    }
                    handleProcrastinationCheck(exId, parseInt(serieIndex, 10), e.target);
                } else if (field === 'carico') {
                    clearProcrastinationTimer(exId);
                }
            } else if (e.target.matches('textarea[data-ex-id]')) { 
                 const { exId, field } = e.target.dataset; 
                 const value = e.target.value; 
                 const weekForSave = currentWeek;

                 if (field === 'persistentUserNote') { 
                      // Persistent Note save logic
                      const key = `${exId}-persistentUserNote`;
                      clearTimeout(saveTimeouts[key]);
                      saveTimeouts[key] = setTimeout(() => savePersistentUserData(exId, value), 800);
                 } else if (field === 'userNote' || field === 'adminMemo') { 
                      // Weekly Note/Memo save logic
                      const key = `${exId}-${weekForSave}-${field}`;
                      clearTimeout(saveTimeouts[key]);
                      saveTimeouts[key] = setTimeout(() => saveWeeklyData(exId, null, field, value, weekForSave), 800);

                      // Visual feedback for adminMemo
                      if (field === 'adminMemo') { 
                           const textarea = e.target;
                           const label = textarea.previousElementSibling;
                           const indicator = label.querySelector('.fa-exclamation-triangle');
                           textarea.classList.toggle('!border-red-500', value.trim() !== '');
                      } 
                 }
            }
        });

        mainView.addEventListener('click', async (e) => {
            const reorderBtn = e.target.closest('button[data-reorder-ex-id]');
            const editBtn = e.target.closest('button[data-edit-ex-id]');
            const deleteBtn = e.target.closest('button[data-delete-ex-id]');
            const timerBtn = e.target.closest('button[data-timer]');
            const circuitTimerBtn = e.target.closest('button[data-circuit-ex-id]');
            const saveFavBtn = e.target.closest('button[data-save-fav-ex-id]');
            const historyBtn = e.target.closest('button[data-history-ex-id]');
            const adminAlertBtn = e.target.closest('button[data-admin-alert-memo]');
            const resetMemoBtn = e.target.closest('#reset-memo-btn');
            const generateRecBtn = e.target.closest('button[data-generate-rec-ex-id]'); // NEW AI Rec button
            const applyRecBtn = e.target.closest('button[data-apply-rec-ex-id]'); // NEW Apply AI Rec button
            const addToCalendarBtn = e.target.closest('#add-to-calendar-btn'); // NEW Calendar button
            const openProgramBtn = e.target.closest('#open-program-btn'); // NEW Program button

            if (reorderBtn) {
                await handleReorderExercise(reorderBtn.dataset.reorderExId, reorderBtn.dataset.direction);
            } else if (editBtn) {
                openEditExerciseModal(editBtn.dataset.editExId);
            } else if (historyBtn) {
                openExerciseHistoryModal(historyBtn.dataset.historyExId);
            } else if (deleteBtn) {
                if (await showConfirmModal('Eliminare questo esercizio?')) {
                    await deleteDoc(doc(getExercisesRef(currentMesoId, currentSheetId), deleteBtn.dataset.deleteExId));
                    await loadAndRenderExercises();
                    showNotification("Esercizio eliminato!");
                }
            } else if (timerBtn) {
                const time = parseInt(timerBtn.dataset.timer, 10);
                if (time) startTimerModal(time);
            } else if (circuitTimerBtn) {
                const exercise = exercisesCache.find(ex => ex.id === circuitTimerBtn.dataset.circuitExId);
                if (exercise) startIntervalCircuitTimer(exercise);
            } else if (saveFavBtn) {
                const exerciseToSave = exercisesCache.find(ex => ex.id === saveFavBtn.dataset.saveFavExId);
                if (exerciseToSave) await handleSaveToFavorites(exerciseToSave);
            } else if (adminAlertBtn) {
                openAdminAlertModal(adminAlertBtn.dataset.adminAlertMemo);
            } else if (resetMemoBtn) {
                handleResetAllAdminMemosForWeek();
            } else if (e.target.id === 'toggle-add-exercise-btn') {
                document.getElementById('add-exercise-container').classList.toggle('open');
            } else if (e.target.id === 'add-from-favorites-btn') {
                openFavoritesModal();
            } else if (e.target.id === 'export-pdf-btn') {
                previewAndExportPDF();
            } else if (e.target.id === 'manage-favorites-btn') {
                openFavoritesModal();
            } else if (e.target.id === 'manage-users-btn') {
                openUserManagementModal();
            } else if (generateRecBtn) { // NEW AI Rec button
                fetchAIRecommendation(generateRecBtn.dataset.generateRecExId);
            } else if (applyRecBtn) { // NEW Apply AI Rec button
                applyAIRecommendation(applyRecBtn.dataset.applyRecExId);
            } else if (addToCalendarBtn) { // NEW Calendar button
                generateGoogleCalendarUrl();
            } else if (openProgramBtn) { // NEW Program button handler
                openWeeklyProgramModal();
            }
        });

        // NEW EVENT HANDLER: Open Admin Manual Log from User Details Modal
        userDetailsModal.addEventListener('click', (e) => {
            if (e.target.id === 'open-admin-manual-log-btn' && selectedUserId && currentUserRole === 'admin') {
                openAdminManualLogModal(selectedUserId);
            }
        });

        // NEW FUNCTION: Log Workout Session (automatic or manual override)
        async function logWorkoutSession(sheetId, week, sheetName, isManualOverride = false, workoutDateOverride = null) {
            const userId = selectedUserId || currentUser.uid;

            // Use override date if provided, otherwise default to current time
            const workoutDate = workoutDateOverride || new Date().toISOString();

           // Formattiamo la data per il controllo "una volta al giorno"
            const logDateOnly = new Date(workoutDate).toISOString().split('T')[0];
            const startOfDay = new Date(logDateOnly).toISOString();
            const endOfDay = new Date(logDateOnly);
            endOfDay.setDate(endOfDay.getDate() + 1);
            const endOfDayISO = endOfDay.toISOString();

            const checkLogQuery = query(getWorkoutHistoryRef(userId),
                where('sheetId', '==', sheetId),
                where('week', '==', week),
                where('completedAt', '>=', startOfDay),
                where('completedAt', '<', endOfDayISO), // Check if a log exists for this sheet/week/day
                limit(1)
            );

            const checkLogSnapshot = await getDocs(checkLogQuery);

            if (!checkLogSnapshot.empty) {
                // Log for this sheet/week/day already exists. 
                if (isManualOverride) {
                    showNotification(`Attenzione: Allenamento Sett. ${week} per il ${logDateOnly} già loggato.`, "warning");
                }
                return;
            }

            try {
                // Se non c'è un log per questa scheda/settimana in questo giorno specifico, lo creiamo
                await addDoc(getWorkoutHistoryRef(userId), {
                    sheetId: sheetId,
                    sheetName: sheetName,
                    week: week,
                    completedAt: workoutDate, // Use the determined date/time (manual or current)
                    workoutStartTime: new Date(workoutDate).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' }), // NEW: Log current time
                    userId: userId, 
                    mesoId: currentMesoId
                });
                showNotification(`Allenamento loggato: ${sheetName}, Sett. ${week} (${logDateOnly})`, "success");

                if (selectedUserId) {
                    renderWorkoutHistory(selectedUserId);
                }

            } catch (error) {
                console.error("Errore nel log dell'allenamento:", error);
            }
        }

        // NEW FUNCTION: Save Persistent User Data
        async function savePersistentUserData(exId, value) {
            try {
                const exerciseRef = doc(getExercisesRef(currentMesoId, currentSheetId), exId);
                await updateDoc(exerciseRef, { persistentUserNote: value });

                // Aggiorna la cache
                const exercise = exercisesCache.find(ex => ex.id === exId);
                if (exercise) exercise.persistentUserNote = value;

            } catch(error) {
                console.error("Errore nel salvataggio della nota persistente:", error);
                showNotification("Errore di salvataggio nota persistente.", "error");
            }
        }
        // CORREZIONE CRITICA: Uso di updateDoc con datiSettimanali correttamente formattato
        async function saveWeeklyData(exId, serieIndex, field, value, week) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise) return;

            const updatedDati = JSON.parse(JSON.stringify(exercise.datiSettimanali || {}));

            let weeklyData = updatedDati[week] || { userNote: '', sets: [], adminMemo: '' };
            if (Array.isArray(weeklyData)) {
                weeklyData = { userNote: '', sets: weeklyData, adminMemo: '' };
            }
            if (!weeklyData.sets) weeklyData.sets = [];

            let isLogTriggered = false;

            if (field === 'carico' || field === 'reps') {
                const setArray = weeklyData.sets;
                const numSets = exercise.serie || 1; // Default to 1 for cardio/safety

                while (setArray.length < numSets) {
                    setArray.push({ carico: '', reps: '' });
                }

                const actualSerieIndex = Math.min(serieIndex, numSets - 1);
                if (actualSerieIndex >= 0) {

                    const isFirstExercise = exercisesCache.indexOf(exercise) === 0;
                    const isFirstSet = actualSerieIndex === 0;

                    // Trigger log ONLY if it's the first set/exercise AND we are saving a non-empty value for the first time this week.
                    // This handles the user typing over an auto-filled value. The auto-filled value is NOT saved in Firestore yet,
                    // so the DB value (weeklyData.sets[actualSerieIndex][field] in the next line) will be empty.
                    if (isFirstExercise && isFirstSet && (field === 'carico' || field === 'reps') && (setArray[actualSerieIndex][field] || '').trim() === '' && value.trim() !== '') {
                        isLogTriggered = true;
                    }

                    setArray[actualSerieIndex][field] = value;
                }
            } else if (field === 'userNote') {
                weeklyData.userNote = value;
            } else if (field === 'adminMemo') {
                weeklyData.adminMemo = value;
            } else {
                return;
            }

            updatedDati[week] = weeklyData;

            try {
                const sheetRef = doc(getSheetsRef(currentMesoId), currentSheetId);
                const exerciseRef = doc(getExercisesRef(currentMesoId, currentSheetId), exId);

                const batch = writeBatch(db);
                batch.update(exerciseRef, { datiSettimanali: updatedDati });
                batch.update(sheetRef, { lastModified: new Date().toISOString() });
                await batch.commit();

                // Log workout session if triggered (FIX: logWorkoutSession checks for duplicates, so it's safe to call here)
                if (isLogTriggered && currentSheetName) {
                    // Log with current time as default
                    logWorkoutSession(currentSheetId, week, currentSheetName);
                }

                // Aggiorna la cache solo dopo il successo del commit
                exercise.datiSettimanali = updatedDati;
                currentSheetData.lastModified = new Date().toISOString();

                if (week === currentWeek) {
                    renderSpecificRecap();
                    if (field === 'adminMemo') {
                        renderExercises();
                    }
                }
            } catch(error) {
                console.error("Errore nel salvataggio dei dati settimanali:", error);
                showNotification("Errore di salvataggio dati. Controlla la console.", "error");
            }
        }

        // --- MODIFICA, RIORDINO E PREFERITI (MODAL) ---
        function openEditExerciseModal(exId) { 
             const exercise = exercisesCache.find(ex => ex.id === exId); 
             if (!exercise) return;

             const container = document.getElementById('edit-exercise-container'); 
             const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}" ${exercise.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');

             container.innerHTML = ` 
                 <form id="edit-exercise-form" class="space-y-4" data-ex-id="${exId}"> 
                     <input type="text" name="nomeEsercizio" class="input-field" value="${exercise.nomeEsercizio || ''}" required> 
                     <select name="categoria" class="input-field" required>${categoryOptions}</select> 
                     <div class="grid grid-cols-2 sm:grid-cols-5 gap-4"> 
                         <input type="number" name="serie" class="input-field" value="${exercise.serie || ''}" placeholder="N° Serie" required> 
                         <input type="text" name="ripetizioni" class="input-field" value="${exercise.ripetizioni || ''}" placeholder="Reps (es. 8-12) / Tempo (es. 30min)"> 
                         <input type="text" name="rir" class="input-field" value="${exercise.rir || ''}" placeholder="RIR (es. 1-2)"> 
                         <input type="text" name="tut" class="input-field" value="${exercise.tut || ''}" placeholder="TUT (es. 2-1-1)"> 
                         <input type="number" name="recupero" class="input-field" value="${exercise.recupero || ''}" placeholder="Recupero (s)"> 
                     </div> 
                     <div id="edit-ripetizioni-per-serie-container" class="grid grid-cols-3 sm:grid-cols-6 gap-2 mt-2"></div> 
                     <input type="text" name="tecnicheIntensita" class="input-field" value="${exercise.tecnicheIntensita || ''}" placeholder="Tecnica di Intensità (es. Dropset)"> 
                                          <textarea name="note" class="textarea-field" placeholder="Nota Coach (Opzionale - persistente ogni settimana)">${exercise.note || ''}</textarea> 
                                          <textarea name="persistentUserNote" class="textarea-field" placeholder="Nota Atleta (Persistente)">${exercise.persistentUserNote || ''}</textarea> 

                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> 
                         <div> 
                             <label class="text-sm text-secondary">Immagine 1</label> 
                             <div class="flex items-center gap-2"> 
                                 <input type="url" name="imageUrl" class="input-field mb-2 flex-grow" value="${exercise.imageUrl || ''}" placeholder="URL Immagine 1"> 
                                 ${exercise.imageUrl ? `<button type="button" class="btn btn-danger !p-2 !w-8 !h-8 flex-shrink-0" data-clear-image="imageUrl" title="Rimuovi URL"><i class="fas fa-trash"></i></button>` : ''} 
                             </div> 
                             <input type="file" name="imageFile1" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600"> 
                         </div> 
                         <div> 
                             <label class="text-sm text-secondary">Immagine 2</label> 
                             <div class="flex items-center gap-2"> 
                                 <input type="url" name="imageUrl2" class="input-field mb-2 flex-grow" value="${exercise.imageUrl2 || ''}" placeholder="URL Immagine 2"> 
                                 ${exercise.imageUrl2 ? `<button type="button" class="btn btn-danger !p-2 !w-8 !h-8 flex-shrink-0" data-clear-image="imageUrl2" title="Rimuovi URL"><i class="fas fa-trash"></i></button>` : ''} 
                             </div> 
                             <input type="file" name="imageFile2" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600"> 
                         </div> 
                     </div> 
                     
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="edit-isCircuit" name="isCircuit" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500" ${exercise.isCircuit ? 'checked' : ''}>
                            <span class="text-secondary">È un circuito?</span>
                        </label>
                         <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="edit-isCardio" name="isCardio" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-[var(--cardio-color)] focus:ring-[var(--cardio-color)]" ${exercise.isCardio ? 'checked' : ''}>
                            <span class="text-secondary">È un esercizio Cardio?</span>
                        </label>
                    </div>

                     <div id="edit-circuit-fields" class="${exercise.isCircuit ? '' : 'hidden'} space-y-4 pt-4 border-t border-slate-700"> 
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> 
                             <input type="number" name="circuitWorkTime" class="input-field" value="${exercise.circuitWorkTime || ''}" placeholder="Tempo Lavoro per round (secondi)"> 
                             <input type="number" name="circuitRestTime" class="input-field" value="${exercise.circuitRestTime || ''}" placeholder="Recupero tra Round (secondi)"> 
                         </div> 
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4"> 
                             <div> 
                                 <label class="text-sm text-secondary">Immagine 3</label> 
                                 <div class="flex items-center gap-2"> 
                                     <input type="url" name="imageUrl3" class="input-field mb-2 flex-grow" value="${exercise.imageUrl3 || ''}" placeholder="URL Immagine 3"> 
                                     ${exercise.imageUrl3 ? `<button type="button" class="btn btn-danger !p-2 !w-8 !h-8 flex-shrink-0" data-clear-image="imageUrl3" title="Rimuovi URL"><i class="fas fa-trash"></i></button>` : ''} 
                                 </div> 
                                 <input type="file" name="imageFile3" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600"> 
                             </div> 
                             <div> 
                                 <label class="text-sm text-secondary">Immagine 4</label> 
                                 <div class="flex items-center gap-2"> 
                                     <input type="url" name="imageUrl4" class="input-field mb-2 flex-grow" value="${exercise.imageUrl4 || ''}" placeholder="URL Immagine 4"> 
                                     ${exercise.imageUrl4 ? `<button type="button" class="btn btn-danger !p-2 !w-8 !h-8 flex-shrink-0" data-clear-image="imageUrl4" title="Rimuovi URL"><i class="fas fa-trash"></i></button>` : ''} 
                                 </div> 
                                 <input type="file" name="imageFile4" class="text-sm w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-slate-700 file:text-slate-300 hover:file:bg-slate-600"> 
                             </div> 
                         </div> 
                     </div> 
                     
                    <div id="edit-cardio-fields" class="${exercise.isCardio ? '' : 'hidden'} space-y-4 pt-4 border-t border-slate-700">
                        <h5 class="text-base font-bold text-[var(--cardio-color)]">Target Frequenza Cardiaca (FC)</h5>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="number" name="fcMinTarget" class="input-field" value="${exercise.fcMinTarget || ''}" placeholder="FC Minima Target (bpm)">
                            <input type="number" name="fcMaxTarget" class="input-field" value="${exercise.fcMaxTarget || ''}" placeholder="FC Massima Target (bpm)">
                        </div>
                    </div>
                     
                     <div class="flex justify-end gap-4 pt-4"> 
                         <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Annulla</button> 
                         <button type="submit" class="btn">Salva Modifiche</button> 
                     </div> 
                 </form>`;

             const editForm = document.getElementById('edit-exercise-form');
             const isCardioCheckbox = editForm.elements['edit-isCardio'];
             const isCircuitCheckbox = editForm.elements['edit-isCircuit'];
             const seriesInput = editForm.elements.serie; 
             const repsContainer = editForm.querySelector('#edit-ripetizioni-per-serie-container');

             // Aggiungi listener per la rimozione dell'immagine 
             editForm.querySelectorAll('button[data-clear-image]').forEach(btn => { 
                 btn.addEventListener('click', (e) => { 
                     const fieldName = e.currentTarget.dataset.clearImage; 
                     const urlInput = editForm.querySelector(`input[name="${fieldName}"]`); 
                     if (urlInput) { 
                         urlInput.value = ''; 
                         // Rimuovi il pulsante stesso e il file input associato se si tratta di un URL 
                         e.currentTarget.remove(); 
                         const fileInput = editForm.querySelector(`input[name="imageFile${fieldName.slice(-1)}"]`); 
                         if (fileInput) fileInput.value = ''; 
                         showNotification(`URL immagine per ${fieldName} rimosso. Salva le modifiche per confermare.`, "info"); 
                     } 
                 }); 
             });

             generateRepInputs(repsContainer, exercise.serie, exercise.ripetizioniPerSerie);

             seriesInput.addEventListener('input', (e) => { 
                 const numSeries = parseInt(e.target.value, 10) || 0; 
                 const currentValues = Array.from(repsContainer.querySelectorAll('input')).map(input => input.value); 
                 generateRepInputs(repsContainer, numSeries, currentValues); 
             });

             isCircuitCheckbox.addEventListener('change', (e) => {
                 document.getElementById('edit-circuit-fields').classList.toggle('hidden', !e.target.checked);
                 if (e.target.checked) isCardioCheckbox.checked = false;
                 document.getElementById('edit-cardio-fields').classList.add('hidden');
             });
             isCardioCheckbox.addEventListener('change', (e) => {
                 document.getElementById('edit-cardio-fields').classList.toggle('hidden', !e.target.checked);
                 if (e.target.checked) isCircuitCheckbox.checked = false;
                 document.getElementById('edit-circuit-fields').classList.add('hidden');
             });

             editExerciseModal.classList.remove('hidden', 'opacity-0'); 
             editForm.addEventListener('submit', handleUpdateExercise); 
             document.getElementById('cancel-edit-btn').addEventListener('click', () => closeModal(editExerciseModal));
        }

        async function handleUpdateExercise(e) { 
             e.preventDefault(); 
             const form = e.target; 
             const exId = form.dataset.exId; 
             const submitBtn = form.querySelector('button[type="submit"]'); 
             submitBtn.disabled = true; 
             submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvataggio...';

             const exerciseInCache = exercisesCache.find(ex => ex.id === exId);

              // Reuse existing URLs or use the URL input value, overriding with new file upload 
             const getFinalUrl = async (urlInputName, fileInputName) => { 
                  const urlInput = form.elements[urlInputName]; 
                  const fileInput = form.elements[fileInputName]; 
                  if (fileInput && fileInput.files.length > 0) { 
                      return await uploadImage(fileInput.files[0]); 
                  } 
                  // Se non c'è un file nuovo, usa il valore dell'input URL (che può essere vuoto se l'utente ha cancellato l'URL con il tasto) 
                  return urlInput ? urlInput.value || '' : ''; 
             };

             const imageUrl1 = await getFinalUrl('imageUrl', 'imageFile1'); 
             const imageUrl2 = await getFinalUrl('imageUrl2', 'imageFile2');

             const isCircuit = form.elements.isCircuit.checked; 
             const isCardio = form.elements.isCardio.checked; // NEW
             let imageUrl3 = ''; 
             let imageUrl4 = ''; 
             let circuitWorkTime = null; 
             let circuitRestTime = null;
             let fcMinTarget = null; // NEW
             let fcMaxTarget = null; // NEW

             if (isCircuit) { 
                  imageUrl3 = await getFinalUrl('imageUrl3', 'imageFile3'); 
                  imageUrl4 = await getFinalUrl('imageUrl4', 'imageFile4');

                  circuitWorkTime = parseInt(form.elements.circuitWorkTime.value, 10) || null; 
                  circuitRestTime = parseInt(form.elements.circuitRestTime.value, 10) || null; 
             }
             
             if (isCardio) { // NEW
                 fcMinTarget = parseInt(form.elements.fcMinTarget.value, 10) || null;
                 fcMaxTarget = parseInt(form.elements.fcMaxTarget.value, 10) || null;
             }

             const updatedData = { 
                  nomeEsercizio: form.elements.nomeEsercizio.value, 
                  categoria: form.elements.categoria.value, 
                  serie: parseInt(form.elements.serie.value, 10), 
                  ripetizioni: form.elements.ripetizioni.value, 
                  rir: form.elements.rir.value, 
                  tut: form.elements.tut.value, 
                  recupero: parseInt(form.elements.recupero.value, 10) || null, 
                  tecnicheIntensita: form.elements.tecnicheIntensita.value, 
                  note: form.elements.note.value, 
                  persistentUserNote: form.elements.persistentUserNote.value, 
                  imageUrl: imageUrl1, 
                  imageUrl2: imageUrl2, 
                  ripetizioniPerSerie: Array.from(form.querySelectorAll('input[name="ripetizioniPerSerie"]')).map(input => input.value), 
                  // Circuit Fields (reset if not circuit)
                  isCircuit: isCircuit, 
                  circuitWorkTime: isCircuit ? circuitWorkTime : null, 
                  circuitRestTime: isCircuit ? circuitRestTime : null, 
                  imageUrl3: isCircuit ? imageUrl3 : '', 
                  imageUrl4: isCircuit ? imageUrl4 : '',
                  // Cardio Fields (reset if not cardio)
                  isCardio: isCardio, // NEW
                  fcMinTarget: isCardio ? fcMinTarget : null, // NEW
                  fcMaxTarget: isCardio ? fcMaxTarget : null, // NEW
             };

             await updateDoc(doc(getExercisesRef(currentMesoId, currentSheetId), exId), updatedData); 
             closeModal(editExerciseModal); 
             await loadAndRenderExercises(); 
             showNotification("Esercizio aggiornato!");
        }

        function openExerciseHistoryModal(exId) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise) {
                showNotification("Esercizio non trovato.", "error");
                return;
            }

            const container = document.getElementById('exercise-history-container');
            document.getElementById('history-modal-title').textContent = `Storico: ${exercise.nomeEsercizio}`;
            container.innerHTML = '<div class="loader"></div>';

            const historyData = exercise.datiSettimanali || {};
            const weeks = Object.keys(historyData).map(Number).sort((a, b) => a - b);

            if (weeks.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">Nessun dato registrato per questo esercizio.</p>';
            } else {
                let historyHTML = `<div class="max-h-[60vh] overflow-y-auto pr-2 space-y-4">`;
                let lastBestE1RM = 0;

                weeks.forEach(week => {
                    let weekDataRaw = historyData[week];
                    if (Array.isArray(weekDataRaw)) {
                        weekDataRaw = { userNote: '', sets: weekDataRaw, adminMemo: '' };
                    }
                    const weekData = weekDataRaw.sets;
                    const userNote = weekDataRaw.userNote;
                    const adminMemo = weekDataRaw.adminMemo;

                    if (!weekData || weekData.length === 0) return;

                    let bestSetThisWeek = { e1rm: 0, text: 'N/D' };
                    let setsHTML = '';

                    if (exercise.isCardio) { // Cardio specific display in history
                        const result = weekData[0]?.carico || 'N/D';
                        setsHTML = `<div class="text-sm text-stone-300"><b>Risultato:</b> ${result}</div>`;
                        bestSetThisWeek.text = result;
                    } else { // Lifting display in history
                        weekData.forEach((set, index) => {
                            if (set && set.carico && set.reps) {
                                const e1rm = calculateE1RM(set.carico, set.reps);
                                if (e1rm > bestSetThisWeek.e1rm) {
                                    bestSetThisWeek = { e1rm, text: `${set.carico}kg x ${set.reps}` };
                                }
                                setsHTML += `<div class="text-sm text-stone-300"><b>Set ${index + 1}:</b> ${set.carico}kg x ${set.reps} reps</div>`;
                            }
                        });
                    }

                    let progressIndicator = '';
                    if (!exercise.isCardio && bestSetThisWeek.e1rm > 0) {
                        if (lastBestE1RM > 0) {
                            if (bestSetThisWeek.e1rm > lastBestE1RM) {
                                progressIndicator = '<i class="fas fa-arrow-up text-green-400 ml-2" title="Miglioramento"></i>';
                            } else if (bestSetThisWeek.e1rm < lastBestE1RM) {
                                progressIndicator = '<i class="fas fa-arrow-down text-red-400 ml-2" title="Peggioramento"></i>';
                            } else {
                                progressIndicator = '<i class="fas fa-equals text-yellow-400 ml-2" title="Stabile"></i>';
                            }
                        }
                        lastBestE1RM = bestSetThisWeek.e1rm;
                    }

                    historyHTML += `
                        <div class="bg-stone-800/50 p-4 rounded-lg">
                            <h4 class="font-bold text-white text-lg mb-2">Settimana ${week}</h4>
                            ${!exercise.isCardio && bestSetThisWeek.e1rm > 0 ? 
                                `<div class="mb-3 p-2 bg-stone-900/50 rounded">
                                    <span class="font-semibold text-secondary">Miglior Set: </span>
                                    <span class="font-bold text-indigo-400">${bestSetThisWeek.text}</span>
                                    ${progressIndicator}
                                </div>` : ''}
                            ${userNote ? `<p class="text-sm text-stone-300 mb-3"><i class="fas fa-user-edit mr-1"></i><span class="font-semibold text-secondary"> Tua Nota (Settimanale):</span> ${userNote}</p>` : ''}
                            ${adminMemo ? `<p class="text-sm text-red-400 mb-3"><i class="fas fa-exclamation-triangle mr-1"></i><span class="font-semibold text-red-400"> Memo Alert:</span> ${adminMemo}</p>` : ''}
                            <div class="space-y-1">${setsHTML || '<p class="text-sm text-stone-400">Nessun dato completo per questa settimana.</p>'}</div>
                        </div>
                    `;
                });

                historyHTML += '</div>';
                container.innerHTML = historyHTML;
            }

            exerciseHistoryModal.classList.remove('hidden', 'opacity-0');
        }

        // --- GESTIONE PREFERITI ---
        function openFavoritesModal() {
            favoritesModal.classList.remove('hidden', 'opacity-0');
            loadAndRenderFavorites();
        }

        async function loadAndRenderFavorites() {
            const container = document.getElementById('favorites-container');
            container.innerHTML = '<div class="loader"></div>';
            const favoritesSnapshot = await getDocs(query(getFavoriteExercisesRef(), orderBy("nomeEsercizio")));
            favoritesCache = favoritesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFilteredFavorites('all');
        }

        function renderFilteredFavorites(category) {
            const listContainer = document.getElementById('favorites-container');
            const filteredFavorites = category === 'all' ? favoritesCache : favoritesCache.filter(fav => fav.categoria === category);

            const categories = [...new Set(favoritesCache.map(fav => fav.categoria))].sort();
            let categoryOptions = '<option value="all">Tutte le Categorie</option>';
            categories.forEach(cat => categoryOptions += `<option value="${cat}" ${category === cat ? 'selected' : ''}>${cat}</option>`);

            let favoritesHTML = filteredFavorites.map(fav => {
                const isCardio = fav.isCardio;
                const cardioBadge = isCardio ? '<span class="reward-badge !bg-[var(--cardio-color)] !text-white">CARDIO</span>' : '';
                const detailText = isCardio 
                    ? `Obiettivo: ${fav.ripetizioni || '-'} | FC: ${fav.fcMinTarget || '-'} - ${fav.fcMaxTarget || '-'} bpm | Recupero: ${fav.recupero || '-'}s` 
                    : `Serie: ${fav.serie} | Reps: ${fav.ripetizioniPerSerie ? fav.ripetizioniPerSerie.join(' / ') : (fav.ripetizioni || '')} ${fav.isCircuit ? `| Lav: ${fav.circuitWorkTime || '-'}s | Rec: ${fav.circuitRestTime || '-'}s` : ''} | RIR: ${fav.rir || '-'} | Recupero: ${fav.recupero || '-'}s`;

                return `
                <div class="bg-stone-800/50 p-4 rounded-lg flex flex-col">
                    <div class="flex-grow">
                        <h4 class="font-bold text-white">${fav.nomeEsercizio} ${fav.isCircuit ? '<span class="reward-badge !bg-amber-500 !text-amber-900">CIRCUITO</span>' : ''} ${cardioBadge}</h4>
                        <p class="text-sm text-indigo-400 mb-2"><i class="fas fa-tag mr-1"></i> ${fav.categoria}</p>
                        <p class="text-xs text-secondary mb-3">${detailText}</p>
                        ${fav.note ? `<p class="text-sm text-stone-300 border-t border-stone-700/50 pt-2 mt-2">Nota Coach: ${fav.note}</p>` : ''}
                        ${fav.persistentUserNote ? `<p class="text-sm text-stone-300 border-t border-stone-700/50 pt-2 mt-2">Nota Atleta (Pers.): ${fav.persistentUserNote}</p>` : ''}
                    </div>
                    <div class="flex justify-end gap-2 mt-auto pt-2">
                        <button class="btn btn-secondary !p-2 text-xs" data-add-fav-ex-id="${fav.id}" title="Aggiungi alla scheda"><i class="fas fa-plus"></i></button>
                        <button class="btn btn-danger !p-2 text-xs" data-delete-fav-ex-id="${fav.id}" title="Elimina dai preferiti"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`
            }).join('');

            if(filteredFavorites.length === 0) { 
                 favoritesHTML = `<div class="text-center py-8"><i class="fas fa-star text-4xl text-slate-600 mb-4"></i><p class="text-secondary">Nessun esercizio preferito in questa categoria.</p></div>`;
            }

            listContainer.innerHTML = `
                <div class="mb-4">
                    <select id="favorite-category-filter" class="input-field">${categoryOptions}</select>
                </div>
                <div id="favorites-list" class="max-h-[60vh] overflow-y-auto pr-2 grid grid-cols-1 md:grid-cols-2 gap-4">${favoritesHTML}</div>
            `;
        }

        favoritesModal.addEventListener('change', (e) => {
            if (e.target.id === 'favorite-category-filter') {
                renderFilteredFavorites(e.target.value);
            }
        });

        favoritesModal.addEventListener('click', async (e) => { 
             const addBtn = e.target.closest('button[data-add-fav-ex-id]'); 
             const deleteBtn = e.target.closest('button[data-delete-fav-ex-id]');

             if (addBtn && currentSheetId) { 
                  const fav = favoritesCache.find(f => f.id === addBtn.dataset.addFavExId); 
                  if (fav) {
                      const { id, ...favData } = fav;
                      // Ensure all new/updated fields are copied for an accurate exercise creation
                      const newExerciseData = { 
                          ...favData, 
                          ordine: (exercisesCache.length || 0) + 1, 
                          datiSettimanali: {},
                          isCardio: fav.isCardio || false,
                          fcMinTarget: fav.fcMinTarget || null,
                          fcMaxTarget: fav.fcMaxTarget || null
                      };
                      await addDoc(getExercisesRef(currentMesoId, currentSheetId), newExerciseData); 
                      await loadAndRenderExercises(); 
                      showNotification("Esercizio aggiunto alla scheda!"); 
                  } 
             } else if (deleteBtn) { 
                  if (await showConfirmModal('Eliminare questo esercizio dai preferiti?')) { 
                      await deleteDoc(doc(getFavoriteExercisesRef(), deleteBtn.dataset.deleteFavExId)); 
                      loadAndRenderFavorites(); 
                      showNotification("Esercizio eliminato dai preferiti!"); 
                  } 
             }
        });

        // --- ESPORTAZIONE ---
        function previewAndExportPDF() { 
             if (!currentSheetId) return; 
             let content = `<h2>Scheda: ${currentSheetData.nomeScheda} - Settimana ${currentWeek}</h2>`; 
             exercisesCache.forEach(ex => {
                 const details = ex.isCardio 
                    ? `Cardio: ${ex.ripetizioni || 'N/D'} | FC: ${ex.fcMinTarget || '-'} - ${ex.fcMaxTarget || '-'} bpm` 
                    : `${ex.serie}x${ex.ripetizioni || ''} ${ex.ripetizioniPerSerie?.length ? `(${ex.ripetizioniPerSerie.join('/')})` : ''} | RIR: ${ex.rir || '-'}`;

                 content += `<p><b>${ex.nomeEsercizio}</b>: ${details}</p>`; 
             });
             document.getElementById('pdf-preview-container').innerHTML = content;

             pdfPreviewModal.classList.remove('hidden', 'opacity-0');
        }

        document.getElementById('download-pdf-btn').addEventListener('click', async () => { 
             const { jsPDF } = window.jspdf; 
             const pdf = new jsPDF(); 
             const content = document.getElementById('pdf-preview-container');

             // Use a specific CSS class for PDF content styling if needed 
             content.style.backgroundColor = 'white'; 
             content.style.color = 'black';

             const canvas = await html2canvas(content); 
             const imgData = canvas.toDataURL('image/png'); 
             pdf.addImage(imgData, 'PNG', 10, 10, 190, 0); 
             pdf.save(`${currentSheetData.nomeScheda}.pdf`);

             // Restore original styles 
             content.style.backgroundColor = ''; 
             content.style.color = '';
        });

        // NEW FUNCTION: Backup All Data to JSON
        async function handleBackupAllData() {
            if (currentUserRole !== 'admin') {
                showNotification("Solo gli amministratori possono eseguire il backup.", "error");
                return;
            }

            const confirmBackup = await showConfirmModal("Sei sicuro di voler scaricare un backup JSON di TUTTI i dati degli utenti (esclusi i preferiti globali)?");
            if (!confirmBackup) return;

            showNotification("Avvio backup dati...", "info");

            try {
                const usersSnapshot = await getDocs(getUsersRef());
                const backupData = {};

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const userData = { ...userDoc.data(), mesocycles: [], workoutHistory: [] };

                    // 1. Fetch Workout History
                    const historySnapshot = await getDocs(getWorkoutHistoryRef(userId));
                    userData.workoutHistory = historySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // 2. Fetch Mesocycles
                    const mesocyclesRef = collection(db, 'users', userId, 'mesocycles');
                    const mesocyclesSnapshot = await getDocs(mesocyclesRef);

                    for (const mesoDoc of mesocyclesSnapshot.docs) {
                        const mesoData = { id: mesoDoc.id, ...mesoDoc.data(), trainingSheets: [] };

                        // 3. Fetch Training Sheets
                        const sheetsRef = collection(mesoDoc.ref, 'trainingSheets');
                        const sheetsSnapshot = await getDocs(sheetsRef);

                        for (const sheetDoc of sheetsSnapshot.docs) {
                            const sheetData = { id: sheetDoc.id, ...sheetDoc.data(), exercises: [] };

                            // 4. Fetch Exercises
                            const exercisesRef = collection(sheetDoc.ref, 'exercises');
                            const exercisesSnapshot = await getDocs(exercisesRef);
                            sheetData.exercises = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                            mesoData.trainingSheets.push(sheetData);
                        }
                        userData.mesocycles.push(mesoData);
                    }
                    backupData[userId] = userData;
                }

                // Create and download the JSON file
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gym_app_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification("Backup completato con successo!", "success");

            } catch (error) {
                console.error("Errore durante il backup dei dati:", error);
                showNotification("Errore critico durante il backup. Controlla la console.", "error");
            }
        }

        // --- NUOVE FUNZIONI AI/CALENDAR/PROGRAMMA ---

        // Helper Function to summarize performance for the AI prompt
        function summarizeWeeklyPerformance(ex, targetWeek) {
            let allSetsData = [];
                        
            // Raccogli tutti i dati precedenti fino alla settimana corrente inclusa
            for (const week in ex.datiSettimanali) {
                const weekNum = parseInt(week);
                if (weekNum <= targetWeek) {
                    let weeklyDataRaw = ex.datiSettimanali[week];
                    if (Array.isArray(weeklyDataRaw)) {
                        weeklyDataRaw = { sets: weeklyDataRaw };
                    }
                    const sets = weeklyDataRaw.sets || [];
                                        
                    sets.forEach((set, i) => {
                        if (set.carico && set.reps) {
                            allSetsData.push({
                                week: weekNum,
                                set: i + 1,
                                load: parseFloat(set.carico),
                                reps: parseInt(set.reps),
                                e1rm: calculateE1RM(set.carico, set.reps)
                            });
                        }
                    });
                }
            }
                        
            // Ordina per settimana per avere una cronologia chiara
            allSetsData.sort((a, b) => a.week - b.week);

            const lastWeek = allSetsData.reduce((max, set) => Math.max(max, set.week), 0);
            const performanceForPrompt = allSetsData
                .filter(set => set.week > 0) // Esclude la settimana 0 se esiste
                .map(set => `Sett. ${set.week}: ${set.load}kg x ${set.reps} reps (E1RM: ${set.e1rm.toFixed(2)})`)
                .join(', ');

            let summary = {
                name: ex.nomeEsercizio,
                targetReps: ex.ripetizioniPerSerie?.join('/') || ex.ripetizioni,
                targetSets: ex.serie,
                rir: ex.rir,
                recupero: ex.recupero,
                targetWeek: targetWeek,
                history: performanceForPrompt,
                lastWeekLogged: lastWeek
            };

            return summary;
        }

        // Function to apply AI recommendation to inputs
        function applyAIRecommendation(exId) { 
             const recTextElement = document.getElementById(`ai-rec-text-${exId}`); 
             const applyButton = document.getElementById(`apply-ai-rec-btn-${exId}`);
                          
             if (applyButton.dataset.aiRecommendation) { 
                 try { 
                     const rec = JSON.parse(applyButton.dataset.aiRecommendation); 
                     const loadRec = rec.progression?.load || "";
                                          
                     if (loadRec.includes('kg')) { 
                         const loadMatch = loadRec.match(/(\d+\.?\d*)\s*kg/i); 
                         const initialLoad = loadMatch ? parseFloat(loadMatch[1]) : null;
                                                  
                         if (initialLoad !== null) { 
                             const exercise = exercisesCache.find(ex => ex.id === exId); 
                             const numSets = exercise.serie;

                             // Applica il carico suggerito a tutti i campi "carico" 
                             for (let i = 0; i < numSets; i++) { 
                                 const caricoInput = document.querySelector(`input[data-ex-id="${exId}"][data-serie-index="${i}"][data-field="carico"]`); 
                                 if (caricoInput) { 
                                     caricoInput.value = initialLoad.toString(); 
                                     caricoInput.dispatchEvent(new Event('input')); // Trigger save/log logic 
                                 } 
                             } 
                             showNotification(`Carico AI (${initialLoad}kg) applicato ai campi.`, "success"); 
                         } else {
                            showNotification("L'AI non ha fornito un carico valido da applicare.", "warning"); 
                         } 
                     } else { 
                         showNotification("L'AI non ha fornito un carico valido da applicare.", "warning"); 
                     } 
                 } catch (e) { 
                     console.error("Errore nel parsing della raccomandazione AI:", e); 
                     showNotification("Errore nell'applicare il consiglio. Riprova a generare.", "error"); 
                 } 
             }
        }

        // Function to call Gemini API for recommendation (SENZA LIMITI)
        async function fetchAIRecommendation(exId) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise || exercise.isCardio) return; // Skip cardio

            const recTextElement = document.getElementById(`ai-rec-text-${exId}`);
            const recButton = document.querySelector(`button[data-generate-rec-ex-id="${exId}"]`);
            const applyButton = document.getElementById(`apply-ai-rec-btn-${exId}`);
            const tipsContainer = document.getElementById(`ai-tips-container-${exId}`);

            const summary = summarizeWeeklyPerformance(exercise, currentWeek);
                        
            // 2. Check for sufficient data
            if (!summary.history || summary.history.trim().length === 0) { 
                 recTextElement.innerHTML = `<span class="text-red-400">Nessun dato registrato fino alla Settimana ${currentWeek}. Registra almeno un set per ricevere un consiglio.</span>`;
                return;
            }

            recTextElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generazione in corso...';
            recButton.disabled = true;
            applyButton.disabled = true;
            tipsContainer.innerHTML = '';
            applyButton.removeAttribute('data-ai-recommendation');

            const systemPrompt = "Sei un coach di forza e ipertrofia esperto (Powerbuilding). Analizza lo storico delle performance (carico e reps) fornito. Fornisci un piano di progressione conciso (Load/Reps obiettivo per la settimana corrente) e 3 consigli di esecuzione/focus specifici, uno per ogni serie. Il consiglio di progressione DEVE contenere il valore numerico del carico e l'unità di misura (es. 'Aumenta a 72.5kg' o 'Mantieni 60kg') se applicabile, altrimenti solo Reps. Restituisci la risposta SOLO in formato JSON, rigorosamente aderente allo schema fornito, in lingua italiana.";

            const userQuery = `Analizza la progressione per l'esercizio "${summary.name}" (Obiettivo teorico: ${summary.targetSets} set x ${summary.targetReps} reps, RIR target: ${summary.rir}).Storico Completo (Settimana ${summary.lastWeekLogged} e precedenti): ${summary.history}Forniscimi il tuo consiglio per la SETTIMANA CORRENTE (${currentWeek}).`;
                        
            const responseSchema = {
                type: "OBJECT",
                properties: {
                    progression: {
                        type: "OBJECT",
                        description: "Consiglio di progressione complessivo per carico e ripetizioni.",
                        properties: {
                            load: { type: "STRING", description: "Consiglio conciso sul carico da usare (es. 'Aumenta a 70kg' o 'Mantieni 60kg')." },
                            reps: { type: "STRING", description: "Consiglio conciso sulle ripetizioni obiettivo (es. 'Mantieni 8-10 reps' o 'Prova 12 reps')." }
                        },
                        propertyOrdering: ["load", "reps"]
                    },
                    seriesTips: {
                        type: "ARRAY",
                        description: "Tre consigli specifici per l'esecuzione, uno per ciascuna delle prime 3 serie.",
                        items: { type: "STRING" }
                    }
                }
            };

            const apiKey = GEMINI_API_KEY; 
                         
            if (apiKey.length < 39) { 
                 recTextElement.innerHTML = `<span class="text-red-400">Servizio AI non attivo: La chiave API Gemini non è valida.</span>`; 
                 recButton.disabled = true; 
                 return;
            }

            try {
                let parsedRec = null;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        config: { // Modificato "generationConfig" in "config" per compatibilità futura e sintassi pulita
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed with status: ${response.status}. ${errorText}`);
                }

                const result = await response.json();
                const rawJson = result.candidates?.[0]?.content?.parts?.[0]?.text;
                                        
                if (!rawJson) throw new Error("Risposta AI vuota o non valida.");

                // Pulizia e parsing JSON
                parsedRec = JSON.parse(rawJson);
                
                                
                // 3. Visualizzazione e salvataggio metadati
                if (parsedRec) {
                    const progText = `${parsedRec.progression.load}. ${parsedRec.progression.reps}.`;
                    recTextElement.textContent = progText;
                    recTextElement.classList.remove('text-red-400', 'text-secondary', 'italic');
                    recTextElement.classList.add('text-green-400', 'font-semibold');

                    let tipsHtml = parsedRec.seriesTips.map((tip, i) => 
                        `<li class="flex items-start"><i class="fas fa-dot-circle text-xs text-indigo-400 mr-2 mt-1"></i><span>${tip}</span></li>`
                    ).join('');
                    tipsContainer.innerHTML = `<ul class="list-none space-y-1 mt-2">${tipsHtml}</ul>`;

                    applyButton.disabled = false;
                    applyButton.dataset.aiRecommendation = JSON.stringify(parsedRec);
                } else { 
                     throw new Error("Parsed recommendation is empty.");
                }

            } catch (error) {
                console.error("Errore Gemini API (finale):", error);
                                
                recTextElement.innerHTML = `Errore di generazione: Controlla la chiave API e la connessione.`;
                recTextElement.classList.add('text-red-400', 'italic');
                tipsContainer.innerHTML = '';
                applyButton.disabled = true;
                applyButton.removeAttribute('data-ai-recommendation');
            } finally {
                recButton.disabled = false;
                recButton.innerHTML = '<i class="fas fa-magic mr-1"></i> Chiedi all\'AI';
            }
        }

        // Function to generate the Google Calendar URL for the current sheet (SINGOLA SCHEDA)
        function generateGoogleCalendarUrl() {
            if (!currentSheetName) {
                showNotification("Seleziona una scheda prima di aggiungere al calendario.", "warning");
                return;
            }
            // Use current time and an estimate session time (e.g., 90 minutes from now)
            const startTime = new Date();
            const endTime = new Date(startTime.getTime() + 90 * 60000); // +90 minutes

            const formatDateTime = (date) => {
                // YYYYMMDDTHHMMSS (Local time format for Google Calendar)
                const Y = date.getFullYear();
                const M = String(date.getMonth() + 1).padStart(2, '0');
                const D = String(date.getDate()).padStart(2, '0');
                const h = String(date.getHours()).padStart(2, '0');
                const m = String(date.getMinutes()).padStart(2, '0');
                const s = String(date.getSeconds()).padStart(2, '0');
                return `${Y}${M}${D}T${h}${m}${s}`;
            }

            const title = encodeURIComponent(`Allenamento: ${currentSheetName} (Sett. ${currentWeek})`);
            const details = encodeURIComponent("Allenamento di Forza e Ipertrofia generato con Gym App. Logga i tuoi set e carichi direttamente nell'app.");
            const start = formatDateTime(startTime);
            const end = formatDateTime(endTime);

            // Google Calendar link template
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&details=${details}&dates=${start}/${end}&sf=true&output=xml`;

            window.open(calendarUrl, '_blank');
        }

        // Function to generate Google Calendar URL for the entire weekly program (SETTIMANALE)
        function generateWeeklyProgramCalendarUrl(schedule, sheets) {
            
            let events = [];                        
            const sheetNames = sheets.reduce((map, s) => ({ ...map, [s.id]: s.name }), {});
            const daysMap = { 'Lunedì': 1, 'Martedì': 2, 'Mercoledì': 3, 'Giovedì': 4, 'Venerdì': 5, 'Sabato': 6, 'Domenica': 0 };

            // Trova la data di Lunedì della settimana in corso o della prossima
            const today = new Date();
            const todayDayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday
            let startOfWeek = new Date(today);
            let diff = today.getDate() - todayDayOfWeek + (todayDayOfWeek === 0 ? -6 : 1); // Ottiene Lunedì
            startOfWeek.setDate(diff);
            startOfWeek.setHours(18, 0, 0, 0); // Orario di default se non impostato nell'UI

            const now = new Date();
            
            // Calcola la data specifica per i 7 giorni a partire da Lunedì
            for (let i = 0; i < 7; i++) {
                const dayIndex = (1 + i) % 7; // 1=Lunedì, ..., 0=Domenica
                const dayName = Object.keys(daysMap).find(key => daysMap[key] === dayIndex);
                
                if (schedule[dayName] && schedule[dayName].sheetId) {
                    const sheetId = schedule[dayName].sheetId;
                    const sheetName = sheetNames[sheetId] || 'Scheda Sconosciuta';
                    const time = schedule[dayName].time || '18:00'; // Orario predefinito o quello impostato

                    const [hours, minutes] = time.split(':').map(Number);
                                        
                    const eventDate = new Date(startOfWeek);
                    eventDate.setDate(startOfWeek.getDate() + i); 
                    
                    // Assicurati che l'evento sia per il futuro
                    const eventDateCheck = new Date(eventDate);
                    eventDateCheck.setHours(hours, minutes, 0, 0);
                    if (eventDateCheck < now) continue;
                    
                    const startTime = new Date(eventDate);
                    startTime.setHours(hours, minutes, 0, 0); 
                    const endTime = new Date(startTime.getTime() + 90 * 60000); // + 90 min (durata stimata)

                    const formatDateTime = (d) => { 
                         // Formato YYYYMMDDTHHMMSS per l'orario locale
                        const Y = d.getFullYear();
                        const M = String(d.getMonth() + 1).padStart(2, '0');
                        const D = String(d.getDate()).padStart(2, '0');
                        const h = String(d.getHours()).padStart(2, '0');
                        const m = String(d.getMinutes()).padStart(2, '0');
                        const s = String(d.getSeconds()).padStart(2, '0');
                        return `${Y}${M}${D}T${h}${m}${s}`; 
                    }

                    const startLocal = formatDateTime(startTime);
                    const endLocal = formatDateTime(endTime);
                    
                    const title = encodeURIComponent(`Allenamento: ${sheetName} (${dayName} ${time})`);
                    // NOTA IMPORTANTE: Aggiunto promemoria per la ricorrenza
                    const details = encodeURIComponent(`Scheda: ${sheetName} (Settimana ${currentWeek} del mesociclo). \n\n[RICORDA: Imposta la ricorrenza Settimanale in Google Calendar per tutti gli allenamenti del tuo Programma!] \n\nLogga i tuoi set e carichi direttamente in Gym App.`);
                    
                    // Aggiungi un evento per ogni giorno
                    events.push({ title: title, dates: `${startLocal}/${endLocal}`, details: details, location: 'Palestra' });
                }
            }
                        
            if (events.length === 0) { 
                 showNotification("Nessun allenamento futuro programmato per l'esportazione.", "warning"); 
                 return;
            }
            
            // Apriamo fino a CALENDAR_EXPORT_LIMIT schede (3) per l'utente.
            const eventsToExport = events.slice(0, CALENDAR_EXPORT_LIMIT);
            let openedCount = 0;

            eventsToExport.forEach((event, index) => {
                // Creiamo l'URL di esportazione per il singolo evento
                const calendarLink = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${event.title}&dates=${event.dates}&details=${event.details}&location=${event.location}&sf=true&output=xml`;
                
                // Apri in una nuova scheda
                window.open(calendarLink, `_blank_event_${index}`);
                openedCount++;
            });
            
            if (openedCount > 0) {
                 showNotification(`Aperte ${openedCount} schede per l'esportazione su Google Calendar. Segui i passaggi in ogni scheda per salvare gli eventi.`, "success");
            } else {
                 showNotification("Nessun allenamento futuro trovato per l'esportazione.", "warning");
            }
        }

        // --- WEEKLY PROGRAM LOGIC ---
        async function loadWeeklyProgram() {
            const userId = selectedUserId || currentUser.uid;
            if (!userId) return;
            try {
                const docSnap = await getDoc(getWeeklyProgramRef(userId));
                // Struttura: { "Lunedì": { sheetId: '...', time: 'HH:mm' }, ... }
                weeklyProgramCache = docSnap.exists() ? docSnap.data().schedule || {} : {};
            } catch (error) {
                console.error("Errore nel caricamento del programma settimanale:", error);
                weeklyProgramCache = {};
            }
        }
                
        async function saveWeeklyProgram(schedule) {
            const userId = selectedUserId || currentUser.uid;
            if (!userId) return;
            try {
                await setDoc(getWeeklyProgramRef(userId), { schedule: schedule });
                weeklyProgramCache = schedule;
                showNotification("Programma settimanale salvato!", "success");
                renderProgramView();
            } catch (error) {
                console.error("Errore nel salvataggio del programma settimanale:", error);
                showNotification("Errore nel salvataggio del programma.", "error");
            }
        }

        function openWeeklyProgramModal() {
            const modal = document.getElementById('weekly-program-modal');
            const container = document.getElementById('weekly-program-container');
            container.innerHTML = '<div class="loader"></div>';

            const days = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];                        

            // Fetch current sheets (must use currentMesoId if selected)
            let sheets = [];
            if (currentMesoId) {
                getDocs(query(getSheetsRef(currentMesoId), orderBy("nomeScheda")))
                    .then(snapshot => {
                        sheets = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().nomeScheda }));
                        renderProgramForm(container, days, sheets);
                    })
                    .catch(error => {
                        console.error("Errore fetch schede per programma:", error);
                        container.innerHTML = '<p class="text-red-400">Impossibile caricare le schede. Assicurati che un mesociclo sia selezionato e che contenga schede.</p>';
                    });
            } else {
                container.innerHTML = '<p class="text-secondary text-center">Seleziona un mesociclo per gestire le schede.</p>';
            }

            modal.classList.remove('hidden', 'opacity-0');
        }

        function renderProgramForm(container, days, sheets) {
            const currentSchedule = weeklyProgramCache;                        

            // Genera il form
            let formHtml = `<form id="weekly-program-form" class="space-y-4">`;
            const sheetOptions = sheets.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            days.forEach(day => {
                const daySchedule = currentSchedule[day] || {};
                const currentSheetId = daySchedule.sheetId || '';
                const currentTime = daySchedule.time || '18:00'; // Default time
                                
                formHtml += `
                    <div class="flex items-center space-x-2">
                        <label class="w-20 font-semibold text-white">${day}</label>
                        <select name="${day}-sheet" class="input-field flex-grow">
                            <option value="">-- Riposo --</option>
                            ${sheets.map(s => `<option value="${s.id}" ${s.id === currentSheetId ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                        <input type="time" name="${day}-time" class="input-field w-24 text-center" value="${currentTime}" ${!currentSheetId ? 'disabled' : ''}>
                    </div>
                `;
            });

            formHtml += `
                <div class="flex justify-between pt-4 border-t border-slate-700 mt-6 flex-wrap gap-2">
                    <button type="button" id="calendar-export-program-btn" class="btn btn-secondary flex-shrink-0"><i class="fas fa-calendar-plus mr-2"></i> Esporta Programma Calendar</button>
                    <button type="submit" class="btn flex-shrink-0"><i class="fas fa-save mr-2"></i> Salva Programma</button>
                </div>
            </form>`;

            container.innerHTML = formHtml;
            const form = document.getElementById('weekly-program-form');
            form.addEventListener('submit', handleSaveWeeklyProgramForm);

            // Listener per abilitare/disabilitare l'input 'time' in base alla selezione della scheda
            days.forEach(day => {
                const sheetSelector = form.elements[`${day}-sheet`];
                const timeInput = form.elements[`${day}-time`];

                sheetSelector.addEventListener('change', () => {
                    timeInput.disabled = !sheetSelector.value;
                });
            });
                        

            // NEW: Listener per l'esportazione
            document.getElementById('calendar-export-program-btn').addEventListener('click', () => {
                const sheetsInMeso = Array.from(document.getElementById('sheet-selector').options)
                    .filter(opt => opt.value)
                    .map(opt => ({ id: opt.value, name: opt.textContent.split(' (')[0] }));
                                
                // Raccoglie i dati correnti del form
                const currentFormSchedule = {}; 
                days.forEach(day => {
                    const sheetId = form.elements[`${day}-sheet`].value;
                    const time = form.elements[`${day}-time`].value;
                    if (sheetId) {
                        currentFormSchedule[day] = { sheetId: sheetId, time: time };
                    }
                });

                // Chiamata alla nuova funzione di esportazione multipla
                generateWeeklyProgramCalendarUrl(currentFormSchedule, sheetsInMeso);
            });
        }

        async function handleSaveWeeklyProgramForm(e) {
            e.preventDefault();
            const form = e.target;
            const newSchedule = {};
            const days = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
                        
            days.forEach(day => {
                const sheetId = form.elements[`${day}-sheet`].value;
                const time = form.elements[`${day}-time`].value;
                if (sheetId) {
                    newSchedule[day] = { sheetId: sheetId, time: time };
                }
            });
            await saveWeeklyProgram(newSchedule);
        }

        async function renderProgramView() {
            const container = document.getElementById('program-view-container');
            if (!container) return;
                        
            const days = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
            const currentProgram = weeklyProgramCache;
                        
            const currentSheetNames = {};
            // Popola i nomi delle schede per la visualizzazione rapida
            const sheetSelector = document.getElementById('sheet-selector');
            const currentSheets = sheetSelector ? Array.from(sheetSelector.options).map(opt => ({ id: opt.value, name: opt.textContent.split(' (')[0] })) : [];
            currentSheets.forEach(s => { currentSheetNames[s.id] = s.name; });

            let programHtml = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-white"><i class="fas fa-calendar-week mr-2 text-indigo-500"></i> Piano Settimanale</h3>
                    <button id="open-program-btn" class="btn btn-secondary !p-2 text-xs"><i class="fas fa-edit"></i> Gestisci</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
            `;

            days.forEach(day => {
                const daySchedule = currentProgram[day];
                const sheetId = daySchedule?.sheetId;
                const time = daySchedule?.time || 'N/D';
                const sheetName = currentSheetNames[sheetId] || 'Riposo';
                const isToday = new Date().toLocaleDateString('it-IT', { weekday: 'long' }).toLowerCase() === day.toLowerCase();

                let style = isToday ? 'bg-indigo-700/50 border-indigo-400' : 'bg-slate-800/50 border-stone-800';
                if (sheetName === 'Riposo') style += ' opacity-60';

                programHtml += `
                    <div class="${style} p-3 rounded-lg border flex flex-col cursor-pointer ${sheetId ? 'hover:bg-indigo-700/70' : ''}"
                          data-sheet-id="${sheetId || ''}" data-day="${day}" id="program-day-${day}">
                        <span class="font-semibold text-white">${day.slice(0, 3)}.</span>
                        <span class="text-xs ${sheetId ? 'text-indigo-300 font-bold' : 'text-secondary'}">${sheetName}</span>
                        ${sheetId ? `<span class="text-xs text-secondary mt-1"><i class="fas fa-clock mr-1"></i> ${time}</span>` : ''}
                    </div>
                `;
            });
            programHtml += `</div>`;
            container.innerHTML = programHtml;
                        
            // Add listeners for dynamic sheet selection on click
            container.querySelectorAll('[data-sheet-id]').forEach(element => {
                element.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.sheetId;
                    if (targetId && currentMesoId) {
                        const selector = document.getElementById('sheet-selector');
                        if (selector) {
                            selector.value = targetId;
                            selectSheet(targetId);
                            showNotification(`Scheda ${currentSheetNames[targetId]} caricata!`);
                            // Scroll to sheet content
                            document.getElementById('sheet-content').scrollIntoView({ behavior: 'smooth' });
                        }
                    } else if (targetId === '') {
                        showNotification('Giorno di riposo, nessun allenamento da caricare.');
                    }
                });
            });
        }
                
        // --- FINE WEEKLY PROGRAM LOGIC ---

        // --- NUOVE FUNZIONI ADMIN (MEMO & HISTORY) ---

        // Utility: Check if a single user has any non-empty adminMemo in ANY week/sheet/mesocycle
        async function checkForPendingMemos(userId) {
            try {
                const mesocyclesRef = collection(db, 'users', userId, 'mesocycles');
                const mesocyclesSnapshot = await getDocs(mesocyclesRef);

                for (const mesoDoc of mesocyclesSnapshot.docs) {
                    const sheetsRef = collection(mesoDoc.ref, 'trainingSheets');
                    const sheetsSnapshot = await getDocs(sheetsRef);

                    for (const sheetDoc of sheetsSnapshot.docs) {
                        const exercisesRef = collection(sheetDoc.ref, 'exercises');
                        const exercisesSnapshot = await getDocs(exercisesRef);

                        for (const exDoc of exercisesSnapshot.docs) {
                            const datiSettimanali = exDoc.data().datiSettimanali || {};
                            for (const week in datiSettimanali) {
                                const weeklyData = datiSettimanali[week];
                                const adminMemo = (Array.isArray(weeklyData) ? '' : (weeklyData.adminMemo || '')).trim();

                                if (adminMemo.length > 0) {
                                    return true;
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`Errore durante il check memo per utente ${userId}:`, error);
            }
            return false;
        }

        async function renderUserManagementContent() {
            const container = document.getElementById('user-management-container');
            if (!container) return;
            container.innerHTML = '<div class="loader"></div>';

            try {
                const usersQuery = query(getUsersRef(), orderBy('email'));
                const usersSnapshot = await getDocs(usersQuery);
                const allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                adminUsersCache = allUsers; // Cache users for edit modal

                let tableHTML = `
                    <div class="max-h-[70vh] overflow-y-auto pr-2">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-800 sticky top-0">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider text-secondary">Email</th>
                                <th class="p-3 text-left text-xs font-semibold uppercase tracking-wider text-secondary">Ruolo</th>
                                <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider text-secondary">Memo</th>
                                <th class="p-3 text-center text-xs font-semibold uppercase tracking-wider text-secondary">Coach</th>
                                <th class="p-3 text-right text-xs font-semibold uppercase tracking-wider text-secondary">Azioni</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                `;
                for (const user of allUsers) {
                    const userHasMemo = await checkForPendingMemos(user.id);
                    const memoBadge = userHasMemo ? '<span class="reward-badge !bg-red-600 !text-white" title="Memo Alert in Attesa"><i class="fas fa-exclamation-triangle"></i></span>' : '';
                    const isCoachedBadge = user.isCoached ? 
                        '<span class="reward-badge !bg-indigo-600 !text-white" title="Allenamento con Coach"><i class="fas fa-hand-holding-heart"></i></span>' : '';


                    tableHTML += `
                        <tr class="hover:bg-slate-800/30">
                            <td class="p-3 text-sm font-medium text-white">${user.email}</td>
                            <td class="p-3 text-sm text-secondary">${user.role}</td>
                            <td class="p-3 text-center">${memoBadge}</td>
                            <td class="p-3 text-center">${isCoachedBadge}</td>
                            <td class="p-3 text-right space-x-2">
                                <button class="btn btn-secondary !p-2 text-xs" data-view-user-id="${user.id}" data-user-email="${user.email}" title="Vedi Dettagli/Storico"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-secondary !p-2 text-xs" data-edit-user-id="${user.id}" title="Modifica Ruolo/Note"><i class="fas fa-user-edit"></i></button>
                            </td>
                        </tr>
                    `;
                }

                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;

                // Rebind click listeners for view buttons
                container.querySelectorAll('[data-view-user-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.viewUserId;
                        const userEmail = e.currentTarget.dataset.userEmail;
                        openUserDetailsModal(userId, userEmail);
                    });
                });
                container.querySelectorAll('[data-edit-user-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        openEditUserModal(e.currentTarget.dataset.editUserId);
                    });
                });

            } catch (error) {
                console.error("Errore gestione utenti:", error);
                container.innerHTML = '<p class="text-red-400 text-center">Errore durante il caricamento degli utenti.</p>';
            }
        }

        function openUserManagementModal() {
            userManagementModal.classList.remove('hidden', 'opacity-0');
            renderUserManagementContent();
        }

        // NEW FUNCTION: Placeholder for Edit User Modal (only role + coachNote + isCoached)
        async function openEditUserModal(userId) {
            const user = adminUsersCache.find(u => u.id === userId);
            if (!user) { showNotification("Utente non trovato.", "error"); return; }
                        
            // Re-fetch user data
            const userDocSnap = await getDoc(doc(getUsersRef(), userId));
            const userData = userDocSnap.data() || {};
            const coachNote = userData.coachNote || '';
            const isCoached = userData.isCoached || false;

            const container = document.getElementById('edit-user-container');
            container.innerHTML = `
                <form id="edit-user-form" data-user-id="${userId}" class="space-y-4">
                    <p class="text-lg font-bold text-indigo-400">Modifica Utente: ${user.email}</p>
                    <div>
                        <label for="user-role" class="text-sm text-secondary mb-1 block">Ruolo</label>
                        <select id="user-role" name="role" class="input-field" required>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </div>
                    
                    ${user.role === 'user' ? `
                    <p class="text-sm text-yellow-400">Nota: L'obiettivo passi è impostato dall'Atleta.</p>
                    <div class="bg-slate-800/50 p-3 rounded-lg">
                        <label class="block text-sm font-semibold text-white">Passi Attuali (Visualizzazione)</label>
                        <span class="text-secondary text-sm">${userData.averageWeeklySteps ? userData.averageWeeklySteps.toLocaleString('it-IT') + ' passi' : 'Non impostato'}</span>
                    </div>` : ''}

                    <div>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="is-coached" name="isCoached" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500" ${isCoached ? 'checked' : ''}>
                            <span class="text-secondary">Allenamento con Coach (Notifica l'Admin)</span>
                        </label>
                    </div>

                    <div>
                        <label for="coach-note" class="text-sm text-secondary mb-1 block">Nota Allenamenti Coach (Privata)</label>
                        <textarea id="coach-note" name="coachNote" class="textarea-field" placeholder="Note private sull'utente (visibile solo all'Admin)">${coachNote}</textarea>
                    </div>
                    <div class="flex justify-end gap-4 pt-2">
                        <button type="button" class="btn btn-secondary" onclick="closeModal(editUserModal)">Annulla</button>
                        <button type="submit" class="btn">Salva Modifiche Utente</button>
                    </div>
                </form>
            `;
            document.getElementById('edit-user-form').addEventListener('submit', handleUpdateUser);
            editUserModal.classList.remove('hidden', 'opacity-0');
        }

        async function handleUpdateUser(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const newRole = form.elements.role.value;
            const newCoachNote = form.elements.coachNote.value;
            const newIsCoached = form.elements.isCoached.checked;

            try {
                const updateData = { 
                     role: newRole,
                    coachNote: newCoachNote,
                    isCoached: newIsCoached
                };

                await updateDoc(doc(getUsersRef(), userId), updateData);
                showNotification(`Dati utente aggiornati!`, "success");
                closeModal(editUserModal);
                // Aggiorna la cache per la visualizzazione rapida nel Modulo Gestione Utenti
                const index = adminUsersCache.findIndex(u => u.id === userId);
                if (index !== -1) {
                    adminUsersCache[index].role = newRole;
                    adminUsersCache[index].isCoached = newIsCoached;
                }
                renderUserManagementContent(); // Refresh user list
            } catch (error) {
                console.error("Errore aggiornamento utente:", error);
                showNotification("Errore nell'aggiornamento dell'utente.", "error");
            }
        }

        async function openUserDetailsModal(userId, userEmail) {
            const userDetailsContainer = document.getElementById('user-details-container');
            userDetailsContainer.innerHTML = '<div class="loader"></div>';

            document.getElementById('user-details-modal').classList.remove('hidden', 'opacity-0');

            // Fetch user data
            const userDocSnap = await getDoc(doc(getUsersRef(), userId));
            const userData = userDocSnap.data() || {};
            const coachNote = userData.coachNote || 'Nessuna nota coach. (Visibile solo all\'Admin)';

            userDetailsContainer.innerHTML = `
                <div class="bg-slate-800/50 p-4 rounded-lg mb-4">
                    <p class="text-lg font-bold text-indigo-400 mb-1">${userEmail}</p>
                    <p class="text-sm text-secondary">ID Utente: <span class="text-xs font-mono text-white">${userId}</span></p>
                                        
                    <div class="mt-3 pt-3 border-t border-slate-700">
                        <h4 class="text-sm font-bold text-red-400 mb-1"><i class="fas fa-user-tie mr-1"></i> Nota Allenamenti Coach (Privata)</h4>
                        <p class="text-xs text-red-300 whitespace-pre-wrap">${coachNote}</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button id="select-user-from-details-btn" class="btn w-full"><i class="fas fa-arrow-right mr-2"></i> Passa a questa Scheda</button>
                </div>

                <div class="mt-4">
                    <h4 class="font-bold text-white mb-3 flex items-center"><i class="fas fa-history mr-2 text-indigo-400"></i> Storico Allenamenti Loggati (Ultimi 30)</h4>
                    <div id="user-details-history-container"></div>
                </div>
            `;
            document.getElementById('select-user-from-details-btn').addEventListener('click', () => {
                selectUser(userId, userEmail);
                closeModal(userDetailsModal);
                closeModal(userManagementModal);
            });

            renderWorkoutHistory(userId); 
            document.getElementById('close-user-details-btn').addEventListener('click', () => closeModal(userDetailsModal));

        } // End of openUserDetailsModal

        // NEW FUNCTION: Admin Manual Log Modal Handler
        async function openAdminManualLogModal(userId) {
            const user = adminUsersCache.find(u => u.id === userId);
            if (!user) { showNotification("Utente non trovato.", "error"); return; }

            document.getElementById('admin-manual-log-info').textContent = `Log manuale per l'utente: ${user.email}`;

            const mesoSelector = document.getElementById('admin-log-mesocycle-selector');
            const sheetSelector = document.getElementById('admin-log-sheet-selector');
            const submitBtn = document.getElementById('submit-admin-manual-log-btn');

            submitBtn.disabled = true;

            // Load Mesocycles for the selected user
            const mesocyclesSnapshot = await getDocs(query(collection(db, 'users', userId, 'mesocycles'), orderBy("dataCreazione", "desc")));
            let mesoOptions = '<option value="">Seleziona Mesociclo</option>';
            mesocyclesSnapshot.forEach(doc => {
                mesoOptions += `<option value="${doc.id}">${doc.data().nome}</option>`;
            });
            mesoSelector.innerHTML = mesoOptions;
            sheetSelector.innerHTML = '<option value="">Seleziona Scheda</option>';
            document.getElementById('admin-log-week-input').value = 1;

            // Default Date/Time (Current Time)
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('admin-log-date-input').value = `${year}-${month}-${day}T${hours}:${minutes}`;

            // Event Listeners for selectors
            const updateSheetOptions = async () => {
                const mesoId = mesoSelector.value;
                if (mesoId) {
                    const sheetsSnapshot = await getDocs(query(collection(db, 'users', userId, 'mesocycles', mesoId, 'trainingSheets'), orderBy("dataCreazione", "desc")));
                    let sheetOptions = '<option value="">Seleziona Scheda</option>';
                    sheetsSnapshot.forEach(doc => {
                        sheetOptions += `<option value="${doc.id}" data-sheet-name="${doc.data().nomeScheda}" data-weeks="${doc.data().numeroSettimane || 1}">${doc.data().nomeScheda}</option>`;
                    });
                    sheetSelector.innerHTML = sheetOptions;
                } else {
                    sheetSelector.innerHTML = '<option value="">Seleziona Scheda</option>';
                }
                updateSubmitButtonState();
            };

            const updateSubmitButtonState = () => {
                const mesoId = mesoSelector.value;
                const sheetId = sheetSelector.value;
                const date = document.getElementById('admin-log-date-input').value;
                const week = parseInt(document.getElementById('admin-log-week-input').value, 10);

                const selectedSheet = sheetSelector.options[sheetSelector.selectedIndex];
                const totalWeeks = parseInt(selectedSheet?.dataset?.weeks, 10) || 1;

                submitBtn.disabled = !(mesoId && sheetId && date && week >= 1 && week <= totalWeeks);
            };

            mesoSelector.onchange = updateSheetOptions;
            sheetSelector.onchange = updateSubmitButtonState;
            document.getElementById('admin-log-week-input').oninput = updateSubmitButtonState;
            document.getElementById('admin-log-date-input').onchange = updateSubmitButtonState;

            // Submit handler
            submitBtn.onclick = async () => {
                const mesoId = mesoSelector.value;
                const sheetId = sheetSelector.value;
                const sheetName = sheetSelector.options[sheetSelector.selectedIndex]?.dataset?.sheetName;
                const week = parseInt(document.getElementById('admin-log-week-input').value, 10);
                const date = document.getElementById('admin-log-date-input').value; // Contains datetime-local value

                if (mesoId && sheetId && sheetName && week && date) {
                    const confirmed = await showConfirmModal(`Confermi di registrare l'allenamento: ${sheetName}, Sett. ${week} per il ${new Date(date).toLocaleString('it-IT')} per l'utente ${user.email}?`);

                    if (confirmed) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Registrazione...';
                        // Pass the datetime-local value as ISO string for logging
                        await logWorkoutSession(sheetId, week, sheetName, true, new Date(date).toISOString()); 
                        closeModal(adminManualLogModal);
                    }
                }
            };

            adminManualLogModal.classList.remove('hidden', 'opacity-0');
        }

        // NEW FUNCTION: Handle Edit Workout Date for old logs
        async function openEditWorkoutDateModal(logId, currentSheetName, currentDate) {
            if (currentUserRole !== 'admin') return;

            // Ensure to format the date correctly for datetime-local input
            const inputDate = new Date(currentDate).toISOString().slice(0, 16);

            document.getElementById('edit-workout-date-info').textContent = `Modifica la data per il log: ${currentSheetName}`;
            document.getElementById('new-workout-date').value = inputDate;

            const form = document.getElementById('edit-workout-date-form');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const newDate = document.getElementById('new-workout-date').value;
                if (!newDate) {
                    showNotification("Seleziona una data valida.", "error");
                    return;
                }

                const logRef = doc(getWorkoutHistoryRef(selectedUserId), logId);
                // Convert the datetime-local value back to ISO string for storage
                await updateDoc(logRef, { 
                     completedAt: new Date(newDate).toISOString(),
                     // Re-calculate workoutStartTime to reflect the new time part
                     workoutStartTime: new Date(newDate).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) 
                }); 

                showNotification("Data log aggiornata!", "success");

                closeModal(editWorkoutDateModal);
                renderWorkoutHistory(selectedUserId); // Refresh history list
            };

            editWorkoutDateModal.classList.remove('hidden', 'opacity-0');
        }

        // CORREZIONE: Ordinamento dello storico basato sul campo 'completedAt' (già esistente)
        async function renderWorkoutHistory(userId) {
            const historyContainer = document.getElementById('user-details-history-container');
            if (!historyContainer) return;
            historyContainer.innerHTML = '<div class="loader"></div>';

            try {
                // Ordina per completedAt (data di completamento/log) in ordine decrescente
                const historyQuery = query(getWorkoutHistoryRef(userId), orderBy('completedAt', 'desc'), limit(30));
                const historySnapshot = await getDocs(historyQuery);
                const history = historySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (history.length === 0) {
                    historyContainer.innerHTML = '<p class="text-secondary text-center">Nessun allenamento registrato in automatico.</p>';
                    return;
                }

                let historyHTML = `<div class="space-y-3 max-h-80 overflow-y-auto pr-2">`;
                history.forEach(log => {
                    const date = new Date(log.completedAt).toLocaleDateString('it-IT', { year: 'numeric', month: 'short', day: 'numeric' });
                    const time = new Date(log.completedAt).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    const displayTime = log.workoutStartTime || time; // Use logged start time if available

                    historyHTML += `
                        <div class="bg-slate-800/50 p-3 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center">
                            <span class="font-semibold text-white">${log.sheetName} (Sett. ${log.week})</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-secondary mt-1 sm:mt-0"><i class="fas fa-calendar-alt mr-1"></i> ${date} - ${displayTime}</span>
                                ${currentUserRole === 'admin' ?
                                   `<button class="btn btn-secondary !p-1 text-xs edit-date-btn"
                                          data-log-id="${log.id}"
                                          data-sheet-name="${log.sheetName}"
                                          data-date="${log.completedAt}"
                                          title="Modifica Data">
                                         <i class="fas fa-edit"></i>
                                    </button>`
                                    : ''}
                            </div>
                        </div>
                    `;
                });
                historyHTML += '</div>';
                historyContainer.innerHTML = historyHTML;

                if (currentUserRole === 'admin') {
                    historyContainer.querySelectorAll('.edit-date-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const { logId, sheetName, date } = e.currentTarget.dataset;
                            openEditWorkoutDateModal(logId, sheetName, date);
                        });
                    });
                }

            } catch (error) {
                console.error("Errore nel caricamento storico allenamenti:", error);
                historyContainer.innerHTML = '<p class="text-red-400 text-center">Errore nel caricamento dello storico.</p>';
            }
        }

        async function handleResetAllAdminMemosForWeek() {
            if (currentUserRole !== 'admin') {
                showNotification("Solo gli amministratori possono resettare i memo.", "error");
                return;
            }
            if (!currentMesoId || !currentSheetId) return;

            const confirmed = await showConfirmModal(`Sei sicuro di voler resettare tutti i Memo Alert per la Scheda corrente, Settimana ${currentWeek}?`);
            if (confirmed) {
                const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
                const exercisesSnapshot = await getDocs(query(exercisesRef));
                const batch = writeBatch(db);
                const weekKey = currentWeek.toString();

                let memosCleared = 0;
                exercisesSnapshot.forEach(exDoc => {
                    const exData = exDoc.data();
                    const datiSettimanali = exData.datiSettimanali || {};

                    if (datiSettimanali[weekKey] && datiSettimanali[weekKey].adminMemo) {
                        // Crea una copia profonda per l'aggiornamento
                        const updatedDati = JSON.parse(JSON.stringify(datiSettimanali));
                        updatedDati[weekKey].adminMemo = "";

                        const exRef = doc(exercisesRef, exDoc.id);
                        batch.update(exRef, { datiSettimanali: updatedDati });
                        memosCleared++;
                    }
                });

                if (memosCleared > 0) {
                    await batch.commit();
                    // Forza il ricaricamento della cache e del rendering per rimuovere gli indicatori
                    await loadAndRenderExercises(); 
                     // E anche l'aggiornamento della UI dei controlli per rimuovere il pulsante Reset Memo Alert
                    renderWorkoutControls();
                    showNotification(`Resettati ${memosCleared} Memo Alert per la Settimana ${currentWeek}!`, "success");
                } else {
                    showNotification("Nessun Memo Alert trovato per questa settimana.", "warning");
                }
            }
        }

        function renderWorkoutControls() {
            const container = document.getElementById('workout-controls-container');
            if (!container || !currentSheetData) return;

            // Check if any memo is pending for this week to show the reset button
            const hasPendingMemo = exercisesCache.some(ex => {
                const weeklyData = ex.datiSettimanali?.[currentWeek] || {};
                const memoContent = (Array.isArray(weeklyData) ? '' : (weeklyData.adminMemo || '')).trim();
                return memoContent.length > 0;
            });

            const memoResetButton = currentUserRole === 'admin' && hasPendingMemo ? 
                 `<button id="reset-memo-btn" class="btn btn-danger flex-shrink-0 !py-2 !px-4"><i class="fas fa-trash-alt mr-2"></i> Reset Memo Alert</button>` : '';

            // Rimosso il blocco del log manuale
            container.innerHTML = `
                <div class="card-bg p-3 rounded-lg border border-stone-700 space-y-4">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <div id="workout-recap-specific" class="text-sm text-secondary flex-grow text-center sm:text-left">
                        </div>
                       <button id="mark-week-complete-btn" class="btn btn-secondary flex-shrink-0"><i class="fas fa-check mr-2"></i> Segna come Completato</button>
                    </div>
                     ${memoResetButton ? `
                    <div class="border-t border-stone-800 pt-3 flex justify-end">
                        ${memoResetButton}
                    </div>` : ''}
                </div>`;

            const markBtn = document.getElementById('mark-week-complete-btn');
            const isWeekCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === currentWeek);

            if (isWeekCompleted) {
                markBtn.disabled = true;
                markBtn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Settimana Completata';
                markBtn.classList.add('!bg-green-600', '!text-white', '!border-green-500', 'opacity-80');
            } else {
                markBtn.addEventListener('click', handleMarkWeekComplete);
            }
        }

        async function handleMarkWeekComplete() {
            if (!currentSheetId) return;
            const isAlreadyCompleted = currentSheetData.completedWeeks?.some(w => (w.week || w) === currentWeek);
            if (isAlreadyCompleted) {
                showNotification("Questa settimana è già stata completata.", "warning");
                return;
            }

            const confirmed = await showConfirmModal(`Sei sicuro di voler segnare la Settimana ${currentWeek} come completata?`);
            if (confirmed) {
                const oldWeeks = currentSheetData.completedWeeks || [];
                const normalizedWeeks = oldWeeks.map(w => (typeof w === 'number' ? { week: w, completedAt: currentSheetData.dataCreazione || new Date().toISOString() } : w));
                const completionRecord = { week: currentWeek, completedAt: new Date().toISOString() };
                const updatedCompletedWeeks = [...normalizedWeeks, completionRecord];

                try {
                    const sheetRef = doc(getSheetsRef(currentMesoId), currentSheetId);
                    await updateDoc(sheetRef, { completedWeeks: updatedCompletedWeeks });
                    currentSheetData.completedWeeks = updatedCompletedWeeks;
                    showNotification(`Settimana ${currentWeek} completata!`, "success");
                    renderWeekSelector();
                    renderWorkoutControls();
                    renderLastWorkoutRecap();

                } catch (error) {
                    console.error("Errore nel segnare la settimana come completata:", error);
                    showNotification("Errore durante l'aggiornamento.", "error");
                }
            }
        }

        async function renderLastWorkoutRecap() {
            const container = document.getElementById('last-workout-container');
            if (!container) return;
            container.innerHTML = '<div class="text-center text-sm text-secondary p-2">Caricamento ultimo allenamento...</div>';

            try {
                const userId = selectedUserId || currentUser.uid;
                const mesocyclesRef = collection(db, 'users', userId, 'mesocycles');
                const mesocyclesSnapshot = await getDocs(mesocyclesRef);

                let lastWorkout = null;
                for (const mesoDoc of mesocyclesSnapshot.docs) {
                    const sheetsRef = collection(mesoDoc.ref, 'trainingSheets');
                    const sheetsSnapshot = await getDocs(sheetsRef);

                    for (const sheetDoc of sheetsSnapshot.docs) {
                        const sheetData = sheetDoc.data();
                        if (sheetData.completedWeeks && sheetData.completedWeeks.length > 0) {
                            const completedWeeksValid = sheetData.completedWeeks.filter(w => w && w.completedAt);
                            if (completedWeeksValid.length === 0) continue;

                            const latestInSheet = completedWeeksValid.reduce((latest, current) => {
                                return new Date(current.completedAt) > new Date(latest.completedAt) ? current : latest;
                            });

                            if (!lastWorkout || new Date(latestInSheet.completedAt) > new Date(lastWorkout.completedAt)) {
                                lastWorkout = {
                                    ...latestInSheet,
                                    sheetName: sheetData.nomeScheda,
                                    mesoName: mesoDoc.data().nome
                                };
                            }
                        }
                    }
                }

                // Secondary check: Find the most recent log in workoutHistory (for automatic logs)
                const historyQuery = query(getWorkoutHistoryRef(userId), orderBy('completedAt', 'desc'), limit(1));
                const historySnapshot = await getDocs(historyQuery);
                const lastLog = historySnapshot.docs.length > 0 ? historySnapshot.docs[0].data() : null;

                if (lastLog) {
                    // Normalize lastWorkout to compare with lastLog (logs auto-capture when first set is done, weeks are manual marks)
                    if (!lastWorkout || new Date(lastLog.completedAt) > new Date(lastWorkout.completedAt)) {
                       // Prefer the actual log entry if it's newer than the last manually marked week.
                       lastWorkout = {
                            week: lastLog.week,
                            completedAt: lastLog.completedAt,
                            sheetName: lastLog.sheetName,
                            mesoName: lastLog.mesoId, // Use MesoID here
                            isAutoLog: true,
                            workoutStartTime: lastLog.workoutStartTime // Use the new field
                       };
                    }
                }
                
                // Fetch average steps (manual from user profile)
                const stepsData = await getAverageWeeklySteps(userId);
                const avgSteps = stepsData.steps || 0;
                const stepsUpdateDate = stepsData.lastUpdate 
                                        ? stepsData.lastUpdate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }) 
                                        : 'N/D';

                const stepsRecap = avgSteps > 0 
                    ? `<div class="bg-slate-800/50 p-2 rounded-lg mt-2 text-sm">
                        <p class="text-white font-semibold flex items-center justify-center">
                            <i class="fas fa-shoe-prints mr-2 text-green-400"></i> Obiettivo Passi: <span class="text-green-400 ml-2">${avgSteps.toLocaleString('it-IT')}</span>
                        </p>
                        <p class="text-xs text-secondary mt-1">Aggiornato il: ${stepsUpdateDate}</p>
                    </div>`
                    : `<p class="text-sm text-secondary italic mt-2">Obiettivo passi settimanali non impostato. Clicca sull'icona passi in alto per inserirlo!</p>`;


                if (lastWorkout) {
                    const logType = lastWorkout.isAutoLog ? 'Ultimo Allenamento Loggato' : 'Ultima Settimana Completata';
                    const lastDate = new Date(lastWorkout.completedAt).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'});
                    
                    container.innerHTML = `
                        <div class="recap-card p-4 rounded-xl text-center shadow-lg">
                            <h3 class="text-sm font-bold text-cyan-300 mb-1 tracking-wider uppercase">${logType}</h3>
                            <p class="text-lg text-white font-semibold">${lastWorkout.sheetName} (Sett. ${lastWorkout.week})</p>
                            <p class="text-sm text-slate-300 mb-3"><i class="fas fa-calendar-check mr-2"></i>${lastDate}</p>
                            ${stepsRecap}
                        </div>`;
                } else {
                    container.innerHTML = `
                        <div class="recap-card p-4 rounded-xl text-center shadow-lg">
                            <h3 class="text-sm font-bold text-cyan-300 mb-1 tracking-wider uppercase">BENVENUTO</h3>
                            <p class="text-lg text-white font-semibold">Nessun allenamento ancora loggato. Dai il massimo!</p>
                            <div class="mt-3">
                                ${stepsRecap}
                            </div>
                        </div>`;
                }

            } catch (error) {
                console.error("Errore nel caricare l'ultimo allenamento:", error);
                container.innerHTML = '<p class="text-center text-red-400">Impossibile caricare i dati dell\'ultimo allenamento.</p>';
            }
        }

        function renderSpecificRecap() {
            const container = document.getElementById('workout-recap-specific');
            if (!container) return;

            if (currentSheetData && currentSheetData.lastModified) {
                const lastDate = new Date(currentSheetData.lastModified).toLocaleString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'});
                container.innerHTML = `<i class="fas fa-pencil-alt mr-2 text-yellow-400"></i>Ultima modifica a questa scheda: <b>${lastDate}</b>`;
            } else {
                container.innerHTML = '<i class="fas fa-info-circle mr-2"></i>Nessuna modifica ancora registrata.';
            }
        }

        function calculate1RMEstimate(reps) {
            if (!reps || reps <= 0) return `~% 1RM`;
            const percentage = (1 / (1 + reps / 30)) * 100;
            if (percentage > 100) return `>100%`;
            return `~${Math.round(percentage)}%`;
        }

        const calculateE1RM = (carico, reps) => {
            if (!carico || !reps) return 0;
            return parseFloat(carico) * (1 + parseInt(reps) / 30);
        }

        function handleProcrastinationCheck(exId, serieIndex, repsInput) { 
             const exercise = exercisesCache.find(ex => ex.id === exId); 
             if (!exercise || !exercise.recupero || exercise.isCircuit || serieIndex >= exercise.serie - 1) return;

             const card = document.getElementById(`ex-card-${exId}`); 
             if (!card) return;

             const caricoInput = card.querySelector(`input[data-serie-index="${serieIndex}"][data-field="carico"]`);

             if (repsInput.value && caricoInput && caricoInput.value) { 
                 clearProcrastinationTimer(exId); 
                 const delay = exercise.recupero * 2.5 * 1000; 
                 procrastinationTimers[exId] = setTimeout(() => { 
                     procrastinationModal.classList.remove('hidden', 'opacity-0'); 
                     delete procrastinationTimers[exId]; 
                 }, delay); 
             }
        }

        function clearProcrastinationTimer(exId) {
            if (procrastinationTimers[exId]) {
                clearTimeout(procrastinationTimers[exId]);
                delete procrastinationTimers[exId];
            }
        }        
        document.getElementById('procrastination-ok-btn').addEventListener('click', () => closeModal(procrastinationModal));

        // VOLUME ANALYSIS REFACTOR
        async function calculateEffectiveVolume(selectedSheetIds, mesoId, userId) {
            const historySnapshot = await getDocs(query(getWorkoutHistoryRef(userId), orderBy('completedAt', 'desc')));
            const history = historySnapshot.docs.map(doc => doc.data()).filter(log => log.mesoId === mesoId);

           const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentHistory = history.filter(log => new Date(log.completedAt) >= thirtyDaysAgo);

            const sheetExercisesMap = {};
            for (const sheetId of selectedSheetIds) {
                if (!sheetExercisesMap[sheetId]) {
                    const exercisesSnapshot = await getDocs(getExercisesRef(mesoId, sheetId));
                    sheetExercisesMap[sheetId] = exercisesSnapshot.docs.map(doc => doc.data());
                }
            }

            const effectiveVolumeMonthly = {};
            for (const group in MACROCYCLE_RULES) {
                effectiveVolumeMonthly[group] = 0;
            }

            recentHistory.forEach(log => {
                const exercises = sheetExercisesMap[log.sheetId] || [];

                exercises.forEach(ex => {
                    const { categoria, serie } = ex;
                    // Escludi il cardio dal calcolo del volume ipertrofico
                    if (!categoria || !serie || ex.isCardio) return;

                    for (const group in MACROCYCLE_RULES) {
                        const rule = MACROCYCLE_RULES[group];
                        let addedVolume = 0;

                        if (rule.main === categoria) {
                            addedVolume = serie;
                        } else {
                            const additionalRule = rule.additional.find(r => r.category === categoria);
                            if (additionalRule) {
                                addedVolume = serie * (additionalRule.percentage / 100);
                            }
                        }

                        if (addedVolume > 0) {
                            effectiveVolumeMonthly[group] += addedVolume;
                        }
                    }
                });
            });

            const weeksInMonth = 4.33;
            const effectiveVolumeWeekly = {};
            for (const group in effectiveVolumeMonthly) {
                effectiveVolumeWeekly[group] = (effectiveVolumeMonthly[group] / weeksInMonth);
            }

            return { monthly: effectiveVolumeMonthly, weekly: effectiveVolumeWeekly, numWorkouts: recentHistory.length };
        }

        async function calculateVolumeAnalysis(sheets) {
            const workoutsPerWeekInput = document.getElementById('workouts-per-week');
            if (!workoutsPerWeekInput) return;

            const workoutsPerWeek = parseInt(workoutsPerWeekInput.value, 10) || 0;
            const selectedSheetCheckboxes = document.querySelectorAll('#sheet-selection-container input[type="checkbox"]:checked');
            const selectedSheetIds = Array.from(selectedSheetCheckboxes).map(cb => cb.value);
            const resultsContainer = document.getElementById('volume-results-container');
            resultsContainer.innerHTML = '<div class="loader"></div>';

            if (selectedSheetIds.length === 0) { 
                 resultsContainer.innerHTML = '<p class="text-center text-red-400">Seleziona almeno una scheda da includere nel calcolo.</p>'; 
                 return;
            }

            const multiplier = workoutsPerWeek / selectedSheetIds.length;
            const allExercisesPromises = selectedSheetIds.map(sheetId => getDocs(getExercisesRef(currentMesoId, sheetId)));
            const allExercisesSnapshots = await Promise.all(allExercisesPromises);
            const allExercises = allExercisesSnapshots.flatMap(snapshot => snapshot.docs.map(doc => doc.data())).filter(ex => !ex.isCardio); // Filter out cardio

            const rotationVolumeData = {};
            for (const group in MACROCYCLE_RULES) { 
                 rotationVolumeData[group] = { totalSets: 0, composition: {} };
            }

            allExercises.forEach(ex => { 
                 const { categoria, serie } = ex; 
                 if (!categoria || !serie) return;

                 for (const group in MACROCYCLE_RULES) { 
                      const rule = MACROCYCLE_RULES[group]; 
                      let addedVolume = 0;
                      let contributingCategory = null;
                      let percentage = 100;

                      if (rule.main === categoria) { 
                           addedVolume = serie; 
                           contributingCategory = categoria;
                      } else { 
                           const additionalRule = rule.additional.find(r => r.category === categoria); 
                           if (additionalRule) {
                                addedVolume = serie * (additionalRule.percentage / 100); 
                                percentage = additionalRule.percentage;
                                contributingCategory = categoria;
                           }
                      }

                      if (addedVolume > 0) { 
                           rotationVolumeData[group].totalSets += addedVolume; 
                           if (!rotationVolumeData[group].composition[contributingCategory]) {
                                rotationVolumeData[group].composition[contributingCategory] = { sets: 0, percentage: 0 };
                           }
                           rotationVolumeData[group].composition[contributingCategory].sets += serie;
                           rotationVolumeData[group].composition[contributingCategory].percentage = percentage;
                      } 
                 }
            });

            const weeksInMonth = 4.33;
            const effectiveUserId = selectedUserId || currentUser.uid;

            // Phase 2: Effective Volume (using history)
            let effectiveVolumeData = { monthly: {}, weekly: {}, numWorkouts: 0 };
            if (effectiveUserId) {
                effectiveVolumeData = await calculateEffectiveVolume(selectedSheetIds, currentMesoId, effectiveUserId);
            }

            // Phase 3: Display Results
            let projectedMonthlyHTML = '';
            let projectedWeeklyHTML = '';

            if (workoutsPerWeek > 0) {
                projectedMonthlyHTML = `
                    <h4 class="font-bold text-white mb-3 flex items-center"><i class="fas fa-chart-line mr-2"></i> Proiezione Volume Teorico (Base ${workoutsPerWeek}x/sett)</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-800/50">
                                <tr>
                                    <th class="p-3">Gruppo Muscolare</th>
                                    <th class="p-3">Volume Rotazione</th>
                                    <th class="p-3">Volume Settimanale (Teorico)</th>
                                    <th class="p-3">Volume Mensile (Teorico)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                `;
                const sortedGroups = Object.keys(rotationVolumeData).sort();
                sortedGroups.forEach(group => {
                    const rotationSets = rotationVolumeData[group].totalSets;
                    if (rotationSets > 0) {
                        const actualWeeklyVolume = rotationSets * multiplier;
                        const monthlySets = (actualWeeklyVolume * weeksInMonth).toFixed(1);

                        projectedMonthlyHTML += `
                            <tr class="hover:bg-slate-800/30">
                                <td class="p-3 font-bold text-indigo-400">${group}</td>
                                <td class="p-3 font-semibold">${rotationSets.toFixed(1)} serie</td>
                                <td class="p-3 font-semibold">${actualWeeklyVolume.toFixed(1)} serie</td>
                                <td class="p-3 font-semibold">${monthlySets} serie</td>
                            </tr>
                        `;
                    }
                });

                projectedMonthlyHTML += `</tbody></table></div>`;
            } else {
                projectedMonthlyHTML = `<p class="text-center text-secondary">Inserisci la Frequenza Settimanale per visualizzare la Proiezione Teorica.</p>`;
            }

            // Effective Volume HTML
            let effectiveVolumeHTML = `
                <h4 class="font-bold text-white mb-3 flex items-center"><i class="fas fa-history mr-2"></i> Volume Effettivo (Ultimi 30 giorni)</h4>
                <p class="text-sm text-secondary mb-3">Basato su ${effectiveVolumeData.numWorkouts} allenamenti loggati in questo mesociclo.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            let effectiveMonthlyList = `<div class="bg-slate-900/50 p-3 rounded-lg"><h5 class="font-semibold text-indigo-400 mb-2">Volume Mensile Effettivo</h5><ul class="space-y-1">`;
            let effectiveWeeklyList = `<div class="bg-slate-900/50 p-3 rounded-lg"><h5 class="font-semibold text-indigo-400 mb-2">Volume Settimanale Effettivo (Media)</h5><ul class="space-y-1">`;

            let hasEffectiveVolume = false;
            Object.keys(effectiveVolumeData.monthly).sort().forEach(group => {
                const monthlySets = effectiveVolumeData.monthly[group].toFixed(1);
                const weeklySets = effectiveVolumeData.weekly[group].toFixed(1);
                if (parseFloat(monthlySets) > 0) {
                    hasEffectiveVolume = true;
                    effectiveMonthlyList += `<li class="flex justify-between"><span class="text-white">${group}:</span> <span class="font-bold">${monthlySets} serie</span></li>`;
                    effectiveWeeklyList += `<li class="flex justify-between"><span class="text-white">${group}:</span> <span class="font-bold">${weeklySets} serie</span></li>`;
                }
            });

            effectiveMonthlyList += `</ul></div>`;
            effectiveWeeklyList += `</ul></div>`;

            if (hasEffectiveVolume) {
                effectiveVolumeHTML += effectiveMonthlyList + effectiveWeeklyList;
            } else {
                effectiveVolumeHTML += `<p class="text-center text-secondary col-span-full">Nessun dato di volume effettivo negli ultimi 30 giorni.</p>`;
            }
            effectiveVolumeHTML += `</div>`;

            resultsContainer.innerHTML = `
                <div class="bg-slate-900/50 p-4 rounded-lg mb-6">${projectedMonthlyHTML}</div>
                <div class="bg-slate-900/50 p-4 rounded-lg">${effectiveVolumeHTML}</div>
            `;
        }

        async function openVolumeAnalysisModal() {
            if (!currentMesoId) {
                showNotification("Seleziona prima un mesociclo.", "warning");
                return;
            }

            const container = document.getElementById('volume-analysis-container');
            container.innerHTML = '<div class="loader"></div>';
            volumeAnalysisModal.classList.remove('hidden', 'opacity-0');

            const sheetsSnapshot = await getDocs(query(getSheetsRef(currentMesoId), orderBy("dataCreazione")));
            const sheets = sheetsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let sheetSelectionHTML = '<p class="text-secondary">Nessuna scheda trovata in questo mesociclo.</p>';
            if (sheets.length > 0) {
                sheetSelectionHTML = sheets.map(sheet => `
                    <label class="flex items-center space-x-3 bg-slate-800/50 p-3 rounded-lg cursor-pointer">
                        <input type="checkbox" name="sheet" value="${sheet.id}" class="h-4 w-4 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500">
                        <span>${sheet.nomeScheda}</span>
                    </label>
                `).join('');
            }

            container.innerHTML = `
                <div class="bg-slate-900/50 p-4 rounded-lg">
                    <h4 class="font-bold text-white mb-3">1. Imposta Frequenza Settimanale (Per Proiezione Teorica)</h4>
                    <p class="text-xs text-secondary mb-2">Quante volte a settimana si allena l'utente?</p>
                    <input type="number" id="workouts-per-week" class="input-field w-full sm:w-1/3" placeholder="Es: 4" min="0">
                </div>
                <div class="bg-slate-900/50 p-4 rounded-lg">
                    <h4 class="font-bold text-white mb-3">2. Seleziona le Schede della Rotazione</h4>
                    <p class="text-xs text-secondary mb-2">Quali schede vengono eseguite nella rotazione? (Necessario per entrambi i calcoli)</p>
                    <div id="sheet-selection-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">${sheetSelectionHTML}</div>
                </div>
                <div class="text-center">
                    <button id="calculate-volume-btn" class="btn"><i class="fas fa-calculator mr-2"></i> Calcola Volumi</button>
                </div>
                <div id="volume-results-container" class="mt-6"></div>
            `;
            document.getElementById('calculate-volume-btn').addEventListener('click', () => calculateVolumeAnalysis(sheets));

            if (sheets.length > 0) {
                document.querySelector('#sheet-selection-container input[type="checkbox"]').checked = true;
            }
        }

        // --- INIZIALIZZAZIONE APP ---
        window.addEventListener('load', setupAdminAccount);
    </script>
</body>
</html>