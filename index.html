<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Schede Palestra v28</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .editable-input { -moz-appearance: textfield; background-color: #374151; border: 1px solid #4b5563; color: #d1d5db; border-radius: 0.5rem; padding: 8px 12px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .editable-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .week-btn { transition: all 0.2s ease-in-out; flex-shrink: 0; }
        .week-btn.active { background-color: #2563eb; color: white; }
        .loader { border: 5px solid #374151; border-top: 5px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view-mode { display: block; }
        .edit-mode { display: none; }
        .card-editing .view-mode { display: none; }
        .card-editing .edit-mode { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes flash-green { 0% { background-color: #374151; } 50% { background-color: #10B981; } 100% { background-color: #374151; } }
        .flash-saved { animation: flash-green 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-white">Scheda Allenamento</h1>
        </header>

        <!-- Sezione Controlli -->
        <div id="controls-panel" class="controls bg-gray-800 p-4 rounded-xl shadow-lg mb-6 flex flex-col gap-4 sticky top-4 z-20">
            <div class="flex items-center gap-4">
                <label for="athlete-selector" class="font-semibold text-gray-300">Atleta:</label>
                <select id="athlete-selector" class="w-full bg-gray-700 text-white p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div class="flex items-center justify-between">
                <select id="sheet-selector" class="w-full bg-gray-700 text-white p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></select>
                <button id="new-sheet-btn" class="ml-4 flex-shrink-0 bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
            </div>
            <div id="week-selector" class="flex items-center space-x-2 overflow-x-auto pb-2 no-scrollbar"></div>
        </div>

        <!-- Area Messaggi e Loader -->
        <div id="status-message" class="text-center mb-4 h-6"></div>
        <div id="loader" class="loader hidden"></div>

        <!-- VISTA LISTA ESERCIZI -->
        <div id="exercise-list-view">
            <div id="exercise-list-container" class="space-y-3"></div>
            <div id="action-buttons" class="mt-8 flex flex-wrap justify-center gap-4 hidden">
                <button id="add-row-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition shadow-lg">+ Aggiungi Esercizio</button>
                <button id="add-week-btn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition shadow-lg">+ Aggiungi Settimana</button>
                 <button id="summary-btn" class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-600 transition shadow-lg">Riepilogo Storico</button>
                <button id="category-summary-btn" class="bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition shadow-lg">Riepilogo Categorie</button>
            </div>
        </div>

        <!-- VISTA DETTAGLIO ESERCIZIO -->
        <div id="exercise-detail-view" class="hidden">
            <div class="flex items-center gap-4 mb-4 sticky top-4 z-20 bg-gray-900 py-2">
                <button id="back-to-list-btn" class="p-3 bg-gray-700 rounded-lg text-blue-400 hover:bg-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                </button>
                <select id="exercise-jumper" class="w-full bg-gray-700 text-white p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div id="exercise-detail-container"></div>
        </div>
    </div>

    <!-- Modali -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm m-4">
            <h3 class="text-xl font-bold text-white mb-4" id="password-modal-title">Inserisci Password</h3>
            <p class="text-sm text-gray-400 mb-4" id="password-modal-text">Questa scheda Ã¨ protetta.</p>
            <input type="password" id="password-input" class="editable-input w-full mb-4" placeholder="Password...">
            <button id="password-submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Accedi</button>
        </div>
    </div>
    <div id="summary-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg m-4 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold text-white" id="summary-modal-title">Riepilogo</h3>
                 <button id="close-summary-btn" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div id="summary-content" class="overflow-y-auto space-y-4"></div>
        </div>
    </div>
    <div id="timer-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl text-center">
            <h3 class="text-2xl font-bold text-white mb-4">Timer Recupero</h3>
            <p id="timer-display" class="text-6xl font-mono text-blue-400 mb-6">00:00</p>
            <button id="close-timer-btn" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition">Chiudi</button>
        </div>
    </div>
    <div id="chart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-3xl m-4 max-h-[80vh] flex flex-col">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold text-white">Grafico Progressione Carico</h3>
                 <button id="close-chart-btn" class="text-gray-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <canvas id="load-chart"></canvas>
        </div>
    </div>

    <script>
        // ========================================================================
        // --- CONFIGURAZIONE ATLETI ---
        // Per aggiungere un nuovo atleta, copia una delle righe qui sotto,
        // incollala e cambia il nome (es. "Marco") e l'URL dello script.
        // ========================================================================
        const athletes = {
            "Erika": {
                scriptURL: 'https://script.google.com/macros/s/AKfycbxxtdWlvsIo3dviUYy54CHo5xV1x7_IHeOva-EzXw50S1YnQ-McD6zidFwuBP3i6yVr2g/exec'
            },
            "Alice": {
                scriptURL: 'https://script.google.com/macros/s/AKfycbz2HNrfgHESlyL3tG8NKYiVZ6sqxqw5UdHcu7bhaAuSBpXdDnflAleDt-EweIhz-7YM/exec'
            },
            "Orazio": {
                scriptURL: 'https://script.google.com/macros/s/AKfycbxZGuWdQdFcfMMR87563SKdaW0RzsrZwDywFdDfnRbNlQIKvpJUF2BuKtUtBse_afsF/exec'
            }
        };
        // ========================================================================

        // --- RIFERIMENTI DOM ---
        const athleteSelector = document.getElementById('athlete-selector');
        const sheetSelector = document.getElementById('sheet-selector');
        const weekSelector = document.getElementById('week-selector');
        const newSheetBtn = document.getElementById('new-sheet-btn');
        const loader = document.getElementById('loader');
        const statusMessage = document.getElementById('status-message');
        const addRowBtn = document.getElementById('add-row-btn');
        const addWeekBtn = document.getElementById('add-week-btn');
        const summaryBtn = document.getElementById('summary-btn');
        const categorySummaryBtn = document.getElementById('category-summary-btn');
        const actionButtons = document.getElementById('action-buttons');
        const controlsPanel = document.getElementById('controls-panel');
        // Viste
        const listView = document.getElementById('exercise-list-view');
        const detailView = document.getElementById('exercise-detail-view');
        const listContainer = document.getElementById('exercise-list-container');
        const detailContainer = document.getElementById('exercise-detail-container');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const exerciseJumper = document.getElementById('exercise-jumper');
        // Modali
        const summaryModal = document.getElementById('summary-modal');
        const summaryModalTitle = document.getElementById('summary-modal-title');
        const closeSummaryBtn = document.getElementById('close-summary-btn');
        const summaryContent = document.getElementById('summary-content');
        const timerModal = document.getElementById('timer-modal');
        const timerDisplay = document.getElementById('timer-display');
        const closeTimerBtn = document.getElementById('close-timer-btn');
        const chartModal = document.getElementById('chart-modal');
        const closeChartBtn = document.getElementById('close-chart-btn');

        // --- STATO APPLICAZIONE ---
        let currentAthlete = "Erika";
        let currentScriptURL = athletes[currentAthlete].scriptURL;
        let currentSheetData = [];
        let currentWeek = 1;
        let saveTimeout;
        let sheetPasswords = {};
        let weekColRanges = {};
        let weekHeaderRowIndex = -1;
        let exerciseStartRowIndex = -1;
        let timerInterval;
        let loadChartInstance;
        let audioCtx;

        // --- LOGICA PRINCIPALE ---
        async function init() {
            setupAthleteSelector();
            await loadSheets();
            const selectedSheet = sheetSelector.value;
            if (selectedSheet) {
                await loadSheetData(selectedSheet);
            }
        }
        
        function setupAthleteSelector() {
            Object.keys(athletes).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                athleteSelector.appendChild(option);
            });
        }

        async function loadSheets() {
            showLoader(true);
            sheetSelector.innerHTML = '';
            try {
                const response = await fetch(`${currentScriptURL}?action=getSheets`);
                const result = await response.json();
                if (result.status === 'success') {
                    result.data.forEach(sheetName => {
                        const option = document.createElement('option');
                        option.value = sheetName;
                        option.textContent = sheetName;
                        sheetSelector.appendChild(option);
                    });
                } else { throw new Error(result.message); }
            } catch (error) {
                showStatus(`Errore caricamento schede: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        function promptForPassword(sheetName, text) {
            return new Promise((resolve, reject) => {
                const modal = document.getElementById('password-modal');
                const title = document.getElementById('password-modal-title');
                const modalText = document.getElementById('password-modal-text');
                const input = document.getElementById('password-input');
                const submitBtn = document.getElementById('password-submit-btn');

                title.textContent = `Password per "${sheetName}"`;
                modalText.textContent = text;
                input.value = '';
                modal.classList.remove('hidden');
                input.focus();

                const handleSubmit = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(input.value);
                };

                const handleCancel = (event) => {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                        cleanup();
                        reject(new Error("Accesso annullato."));
                    }
                };
                
                const handleKeyUp = (event) => { if (event.key === 'Enter') handleSubmit(); };
                const cleanup = () => {
                    submitBtn.onclick = null;
                    input.onkeyup = null;
                    modal.onclick = null;
                };

                submitBtn.onclick = handleSubmit;
                input.onkeyup = handleKeyUp;
                modal.onclick = handleCancel;
            });
        }

        async function loadSheetData(sheetName) {
            showLoader(true);
            listContainer.innerHTML = '';
            actionButtons.classList.add('hidden');
            showListView();

            try {
                const passCheckResponse = await fetch(`${currentScriptURL}?action=isPasswordRequired&sheetName=${encodeURIComponent(sheetName)}`);
                const passCheckResult = await passCheckResponse.json();

                let password = '';
                if (passCheckResult.status === 'success' && passCheckResult.data.required) {
                    const passwordKey = `${currentAthlete}-${sheetName}`;
                    password = sheetPasswords[passwordKey] || await promptForPassword(sheetName, 'Questa scheda Ã¨ protetta. Inserisci la password.');
                }

                const response = await fetch(`${currentScriptURL}?action=getSheetData&sheetName=${encodeURIComponent(sheetName)}&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    if (passCheckResult.data.required) {
                        sheetPasswords[`${currentAthlete}-${sheetName}`] = password;
                    }
                    currentSheetData = result.data;
                    analyzeSheetStructure(currentSheetData);
                    renderExerciseList(currentSheetData);
                    actionButtons.classList.remove('hidden');
                } else { 
                    delete sheetPasswords[`${currentAthlete}-${sheetName}`];
                    throw new Error(result.message); 
                }
            } catch (error) {
                showStatus(error.message, 'error');
                currentSheetData = [];
            } finally {
                showLoader(false);
            }
        }
        
        function analyzeSheetStructure(data) {
            weekSelector.innerHTML = '';
            weekColRanges = {};
            weekHeaderRowIndex = -1;
            exerciseStartRowIndex = -1;

            for (let i = 0; i < Math.min(data.length, 10); i++) {
                const row = data[i] || [];
                if (weekHeaderRowIndex === -1 && row.some(cell => typeof cell === 'string' && cell.toLowerCase().includes('settimana'))) {
                    weekHeaderRowIndex = i;
                }
                if (exerciseStartRowIndex === -1 && typeof row[1] === 'string' && row[1].toUpperCase() === 'CATEGORIA') {
                    exerciseStartRowIndex = i + 1;
                }
            }

            if (weekHeaderRowIndex === -1) return;

            const headerRow = data[weekHeaderRowIndex];
            headerRow.forEach((cell, index) => {
                if (typeof cell === 'string' && cell.toLowerCase().startsWith('settimana')) {
                    const weekNumMatch = cell.match(/\d+/);
                    if (weekNumMatch) {
                        const weekNum = parseInt(weekNumMatch[0], 10);
                        weekColRanges[weekNum] = { start: index, end: index + 8 };
                        
                        const btn = document.createElement('button');
                        btn.textContent = `Sett. ${weekNum}`;
                        btn.dataset.week = weekNum;
                        btn.className = `week-btn px-4 py-2 rounded-md font-semibold text-sm ${weekNum === currentWeek ? 'active' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`;
                        btn.onclick = () => {
                            currentWeek = weekNum;
                            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            if (!detailView.classList.contains('hidden')) {
                                const exerciseIndex = parseInt(detailContainer.dataset.exerciseIndex, 10);
                                renderExerciseDetail(exerciseIndex);
                            }
                        };
                        weekSelector.appendChild(btn);
                    }
                }
            });
        }

        function renderExerciseList(data) {
            listContainer.innerHTML = '';
            if (exerciseStartRowIndex === -1) {
                listContainer.innerHTML = `<p class="p-4 text-center text-red-400">Struttura foglio non riconosciuta.</p>`;
                return;
            }
            
            const exercises = data.slice(exerciseStartRowIndex);
            exercises.forEach((row, rowIndex) => {
                const esercizio = row[2] || '';
                const categoria = row[1] || '';

                if (row.every(cell => cell === '')) return;

                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-700 transition flex justify-between items-center';
                item.onclick = () => showExerciseDetail(rowIndex);
                
                item.innerHTML = `
                    <div>
                        <h3 class="text-lg font-bold text-white">${esercizio || 'Nuovo Esercizio'}</h3>
                        <p class="text-sm text-gray-400">${categoria}</p>
                    </div>
                    <svg class="text-gray-500" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                `;
                listContainer.appendChild(item);
            });
        }

        function populateExerciseJumper(currentExerciseIndex) {
            exerciseJumper.innerHTML = '';
            const exercises = currentSheetData.slice(exerciseStartRowIndex);
            exercises.forEach((row, rowIndex) => {
                const esercizio = row[2] || 'Nuovo Esercizio';
                if (row.every(cell => cell === '')) return;
                
                const option = document.createElement('option');
                option.value = rowIndex;
                option.textContent = esercizio;
                if (rowIndex === currentExerciseIndex) {
                    option.selected = true;
                }
                exerciseJumper.appendChild(option);
            });
        }
        
        function getMaxRepsFromRange(rangeStr) {
            if (!rangeStr || typeof rangeStr !== 'string') return null;
            const parts = rangeStr.split('-').map(p => parseInt(p.trim(), 10));
            return Math.max(...parts.filter(p => !isNaN(p)));
        }

        function renderExerciseDetail(exerciseIndex) {
            detailContainer.innerHTML = '';
            detailContainer.dataset.exerciseIndex = exerciseIndex;
            
            populateExerciseJumper(exerciseIndex);
            
            const originalRowIndex = exerciseIndex + exerciseStartRowIndex;
            const row = currentSheetData[originalRowIndex];
            const weekToShow = currentWeek;
            
            const weekCols = weekColRanges[weekToShow];
            if (!weekCols) {
                detailContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Dati per la settimana ${weekToShow} non trovati.</p>`;
                return;
            }

            const categoria = row[1] || '';   // B
            const esercizio = row[2] || '';   // C
            const tecnica = row[3] || '';     // D
            const note = row[4] || '';        // E
            const link = row[5] || '';        // F
            const rir = row[6] || '';         // G
            const recupero = row[7] || '';    // H
            const serie = row[8] || '';       // I
            const ripetizioni = row[9] || ''; // J
            const maxReps = getMaxRepsFromRange(ripetizioni);

            const card = document.createElement('div');
            card.className = 'exercise-card bg-gray-800 p-5 rounded-lg shadow-md';
            
            const seriesData = row.slice(weekCols.start, weekCols.end);
            let weeklySeriesHTML = '';
            for (let i = 0; i < 4; i++) {
                const caricoCol = weekCols.start + (i * 2);
                const repCol = caricoCol + 1;
                
                let prevWeekHint = '';
                let progressionHint = '';
                let prefilledLoad = seriesData[i*2] || '';

                if (weekToShow > 1 && weekColRanges[weekToShow - 1]) {
                    const prevWeekCols = weekColRanges[weekToShow - 1];
                    const prevSeriesData = row.slice(prevWeekCols.start, prevWeekCols.end);
                    const prevLoad = prevSeriesData[i*2] || '-';
                    const prevReps = prevSeriesData[i*2+1] || '-';

                    if (prevLoad !== '-' || prevReps !== '-') {
                        prevWeekHint = `<p class="text-xs text-gray-500 text-right col-span-3 mb-1">Sett. prec: ${prevLoad} x ${prevReps}</p>`;
                        
                        const lastReps = parseInt(prevReps, 10);
                        if (!isNaN(lastReps) && maxReps && prefilledLoad === '') {
                             if (lastReps < maxReps) {
                                prefilledLoad = prevLoad;
                                progressionHint = `<p class="text-xs text-amber-400 text-right col-span-3 -mt-2 mb-1">Consiglio: Stesso carico, aumenta le reps</p>`;
                             } else {
                                progressionHint = `<p class="text-xs text-green-400 text-right col-span-3 -mt-2 mb-1">Consiglio: Aumenta il carico!</p>`;
                             }
                        }
                    }
                }

                weeklySeriesHTML += `
                    <div class="grid grid-cols-3 items-center gap-3 mb-2">
                        ${prevWeekHint}
                        ${progressionHint}
                        <span class="font-bold text-gray-400">Serie ${i + 1}</span>
                        <input type="text" placeholder="kg" class="editable-input" value="${prefilledLoad}" data-row="${originalRowIndex}" data-col="${caricoCol}" oninput="handleCellUpdate(event)">
                        <input type="text" placeholder="reps" class="editable-input" value="${seriesData[i*2+1] || ''}" data-row="${originalRowIndex}" data-col="${repCol}" oninput="handleCellUpdate(event)">
                    </div>
                `;
            }

            const createDetailField = (label, value, colIndex) => `
                <div class="grid grid-cols-3 gap-x-4 items-center">
                    <label class="text-gray-400 font-semibold col-span-1">${label}</label>
                    <div class="col-span-2">
                        <p class="view-mode text-gray-200 py-2">${value || '...'}</p>
                        <input type="text" class="edit-mode editable-input" value="${value}" data-row="${originalRowIndex}" data-col="${colIndex}" oninput="handleCellUpdate(event)">
                    </div>
                </div>`;
            
            const linkIcon = link.startsWith('http') ? `<a href="${link}" target="_blank" class="text-blue-400 hover:text-blue-300 absolute right-0 top-0 p-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>` : '';
            const linkFieldHTML = `<div class="grid grid-cols-3 gap-x-4 items-center"><label class="text-gray-400 font-semibold col-span-1">Link</label><div class="col-span-2 relative"><p class="view-mode text-gray-200 py-2 truncate">${link || '...'}</p><input type="text" class="edit-mode editable-input" value="${link}" data-row="${originalRowIndex}" data-col="5" oninput="handleCellUpdate(event)">${linkIcon}</div></div>`;

            card.innerHTML = `
                <div class="relative">
                    <div class="view-mode"><h3 class="text-xl font-bold text-white mb-3">${esercizio || 'Nuovo Esercizio'}</h3></div>
                    <div class="edit-mode mb-3">${createDetailField('Esercizio', esercizio, 2)}</div>
                    <div class="absolute top-0 right-0 flex gap-2">
                        <button class="p-1 text-gray-400 hover:text-white" onclick="handleManualSave(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                        <button class="p-1 text-gray-400 hover:text-white" onclick="toggleEditMode(this)">
                            <svg class="edit-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="text-sm space-y-2">
                    ${createDetailField('Categoria', categoria, 1)}
                    ${createDetailField('Tecnica', tecnica, 3)}
                    ${createDetailField('Note', note, 4)}
                    ${linkFieldHTML}
                    <div class="space-y-2 pt-2 mt-2 border-t border-gray-700">
                        ${createDetailField('Serie', serie, 8)}
                        ${createDetailField('Ripetizioni', ripetizioni, 9)}
                        ${createDetailField('RIR', rir, 6)}
                        <div class="grid grid-cols-3 gap-x-4 items-center">
                            <label class="text-gray-400 font-semibold col-span-1">Recupero</label>
                            <div class="col-span-2 flex items-center gap-2">
                                <div class="flex-grow"><p class="view-mode text-gray-200 py-2">${recupero || '...'}</p><input type="text" class="edit-mode editable-input" value="${recupero}" data-row="${originalRowIndex}" data-col="7" oninput="handleCellUpdate(event)"></div>
                                <button class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600" onclick="startTimer('${recupero}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="border-gray-700 my-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-semibold text-gray-200">Carichi Settimana ${weekToShow}</h4>
                    <button class="text-sm text-blue-400 hover:underline" onclick="showLoadChart(${exerciseIndex})">Mostra Grafico</button>
                </div>
                <div class="space-y-3">${weeklySeriesHTML}</div>
            `;
            detailContainer.appendChild(card);
        }

        function showListView() {
            listView.classList.remove('hidden');
            detailView.classList.add('hidden');
            controlsPanel.classList.remove('hidden');
        }

        function showExerciseDetail(exerciseIndex) {
            listView.classList.add('hidden');
            detailView.classList.remove('hidden');
            controlsPanel.classList.add('hidden');
            renderExerciseDetail(exerciseIndex);
        }
        
        function toggleEditMode(button) {
            const card = button.closest('.exercise-card');
            card.classList.toggle('card-editing');
        }

        function handleCellUpdate(event) {
            clearTimeout(saveTimeout);
            const input = event.target;
            const newValue = input.value;
            const { row, col } = input.dataset;
            const sheetName = sheetSelector.value;
            
            showStatus('Digitando...', 'info');
            currentSheetData[row][col] = newValue;

            saveTimeout = setTimeout(() => {
                showStatus('Salvataggio...', 'info');
                const payload = { action: 'updateCell', sheetName, row, col, value: newValue };
                
                fetch(currentScriptURL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        showStatus('Salvato!', 'success');
                        input.classList.add('flash-saved');
                        input.addEventListener('animationend', () => {
                            input.classList.remove('flash-saved');
                        }, { once: true });
                    } else { throw new Error(result.message); }
                })
                .catch(error => {
                    showStatus(`Errore: ${error.message}`, 'error');
                });
            }, 1000);
        }

        async function handleManualSave(button) {
            const card = button.closest('.exercise-card');
            const inputs = card.querySelectorAll('input[data-row]');
            const updates = [];
            
            inputs.forEach(input => {
                updates.push({
                    row: input.dataset.row,
                    col: input.dataset.col,
                    value: input.value
                });
            });

            if (updates.length === 0) {
                showStatus('Nessun dato da salvare.', 'info');
                return;
            }

            showLoader(true);
            const sheetName = sheetSelector.value;
            const payload = { action: 'bulkUpdateCells', sheetName, updates };

            try {
                const response = await fetch(currentScriptURL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showStatus('Dati salvati con successo!', 'success');
                    inputs.forEach(input => {
                        input.classList.add('flash-saved');
                        input.addEventListener('animationend', () => {
                            input.classList.remove('flash-saved');
                        }, { once: true });
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus(`Errore salvataggio: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        function showSummary() {
            summaryModalTitle.textContent = 'Riepilogo Storico';
            summaryContent.innerHTML = '';
            let summaryHTML = '';

            const exercises = currentSheetData.slice(exerciseStartRowIndex);
            exercises.forEach(row => {
                const exerciseName = row[2];
                if (!exerciseName) return;

                let exerciseLogHTML = `<div class="bg-gray-700 p-4 rounded-md">
                                        <h4 class="font-bold text-lg text-white mb-2">${exerciseName}</h4>
                                        <div class="space-y-2">`;
                
                let hasData = false;
                Object.keys(weekColRanges).sort((a, b) => a - b).forEach(weekNumStr => {
                    const weekNum = parseInt(weekNumStr, 10);
                    const weekCols = weekColRanges[weekNum];
                    if (!weekCols) return;

                    let weeklyData = [];
                    for (let i = 0; i < 4; i++) {
                        const load = row[weekCols.start + (i * 2)] || '';
                        const reps = row[weekCols.start + (i * 2) + 1] || '';
                        if (load || reps) {
                            weeklyData.push(`${load} x ${reps}`);
                        }
                    }

                    if (weeklyData.length > 0) {
                        hasData = true;
                        exerciseLogHTML += `<div class="text-sm">
                                              <p class="font-semibold text-gray-300">Settimana ${weekNum}:</p>
                                              <p class="text-gray-400 pl-2">${weeklyData.join(' | ')}</p>
                                           </div>`;
                    }
                });

                exerciseLogHTML += `</div></div>`;
                
                if (hasData) {
                    summaryHTML += exerciseLogHTML;
                }
            });

            if (summaryHTML === '') {
                summaryContent.innerHTML = '<p class="text-gray-400">Nessun dato registrato da mostrare nel riepilogo.</p>';
            } else {
                summaryContent.innerHTML = summaryHTML;
            }
            
            summaryModal.classList.remove('hidden');
        }

        async function showCategorySummary() {
            showLoader(true);
            try {
                const passwordKey = `${currentAthlete}-GLOBAL`;
                let password = sheetPasswords[passwordKey] || '';
                if (!password) {
                    password = await promptForPassword(currentAthlete, `Inserisci la password di ${currentAthlete} per il riepilogo globale.`);
                }
                
                const response = await fetch(`${currentScriptURL}?action=getAllSheetsData&password=${encodeURIComponent(password)}`);
                const result = await response.json();

                if (result.status === 'success') {
                    sheetPasswords[passwordKey] = password;
                    const allSheetsData = result.data;
                    const categoryCounts = {};

                    for (const sheetName in allSheetsData) {
                        const sheetData = allSheetsData[sheetName];
                        let startRow = -1;
                        for (let i = 0; i < sheetData.length; i++) {
                            if (sheetData[i][1] && sheetData[i][1].toUpperCase() === 'CATEGORIA') {
                                startRow = i + 1;
                                break;
                            }
                        }

                        if (startRow !== -1) {
                            const exercises = sheetData.slice(startRow);
                            exercises.forEach(row => {
                                const category = row[1];
                                const sets = parseInt(row[8], 10);
                                if (category && !isNaN(sets)) {
                                    categoryCounts[category] = (categoryCounts[category] || 0) + sets;
                                }
                            });
                        }
                    }
                    
                    summaryModalTitle.textContent = 'Riepilogo Volume Categorie';
                    let summaryHTML = '';
                    const sortedCategories = Object.keys(categoryCounts).sort();

                    if (sortedCategories.length === 0) {
                        summaryHTML = '<p class="text-gray-400">Nessuna categoria trovata. Controlla la colonna "CATEGORIA" nei tuoi fogli.</p>';
                    } else {
                         summaryHTML = sortedCategories.map(category => `
                            <div class="flex justify-between items-center bg-gray-700 p-3 rounded-md">
                                <span class="font-semibold text-white">${category}</span>
                                <span class="font-bold text-blue-400">${categoryCounts[category]} serie</span>
                            </div>
                        `).join('');
                    }
                    summaryContent.innerHTML = summaryHTML;
                    summaryModal.classList.remove('hidden');

                } else {
                    delete sheetPasswords[passwordKey];
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus(`Errore riepilogo: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function handleAddNewRow() {
            showLoader(true);
            const sheetName = sheetSelector.value;
            const payload = { action: 'addRow', sheetName };
            try {
                const response = await fetch(currentScriptURL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showStatus('Nuova riga aggiunta!', 'success');
                    await loadSheetData(sheetName);
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                } else { throw new Error(result.message); }
            } catch (error) {
                 showStatus(`Errore: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }
        
        async function handleAddWeek() {
            showLoader(true);
            const sheetName = sheetSelector.value;
            const payload = { action: 'addWeek', sheetName };
            try {
                const response = await fetch(currentScriptURL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showStatus('Nuova settimana aggiunta!', 'success');
                    await loadSheetData(sheetName);
                } else { throw new Error(result.message); }
            } catch (error) {
                 showStatus(`Errore: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function handleNewSheet() {
            const newSheetName = prompt("Inserisci il nome per la nuova scheda:");
            if (!newSheetName || newSheetName.trim() === '') return;

            showLoader(true);
            const payload = { action: 'createSheet', sheetName: newSheetName.trim() };

            try {
                const response = await fetch(currentScriptURL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                    await loadSheets();
                    sheetSelector.value = newSheetName.trim();
                    await loadSheetData(newSheetName.trim());
                } else { throw new Error(result.message); }
            } catch (error) {
                showStatus(`Errore creazione: ${error.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        function showLoader(show) {
            loader.classList.toggle('hidden', !show);
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'text-center mb-4 h-6 font-semibold transition-opacity duration-300';
            const colors = { success: 'text-green-400', error: 'text-red-400', info: 'text-blue-400' };
            statusMessage.classList.add(colors[type] || 'text-gray-400');
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    if (statusMessage.textContent === message) {
                       statusMessage.textContent = '';
                    }
                }, 3000);
            }
        }
        
        function startTimer(durationStr) {
            clearInterval(timerInterval);
            let duration = parseInt(durationStr, 10);
            if (isNaN(duration)) {
                showStatus('Tempo di recupero non valido.', 'error');
                return;
            }
            
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            timerModal.classList.remove('hidden');
            let timer = duration;
            timerInterval = setInterval(() => {
                const minutes = Math.floor(timer / 60);
                const seconds = timer % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (--timer < 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "Fine!";
                    playTimerSound();
                }
            }, 1000);
        }

        function playTimerSound() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1);

            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 1);
        }

        function showLoadChart(exerciseIndex) {
            const originalRowIndex = exerciseIndex + exerciseStartRowIndex;
            const row = currentSheetData[originalRowIndex];
            
            const labels = [];
            const data = [];

            Object.keys(weekColRanges).sort((a,b) => a-b).forEach(weekNumStr => {
                const weekNum = parseInt(weekNumStr, 10);
                const weekCols = weekColRanges[weekNum];
                if (!weekCols) return;
                
                let maxLoad = 0;
                for (let i = 0; i < 4; i++) {
                    const load = parseFloat(row[weekCols.start + (i * 2)]);
                    if (!isNaN(load) && load > maxLoad) {
                        maxLoad = load;
                    }
                }
                if (maxLoad > 0) {
                    labels.push(`Sett. ${weekNum}`);
                    data.push(maxLoad);
                }
            });

            if (loadChartInstance) {
                loadChartInstance.destroy();
            }

            const ctx = document.getElementById('load-chart').getContext('2d');
            loadChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Carico Massimo Sollevato (kg)',
                        data: data,
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            chartModal.classList.remove('hidden');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', init);
        athleteSelector.addEventListener('change', async (e) => {
            currentAthlete = e.target.value;
            currentScriptURL = athletes[currentAthlete].scriptURL;
            sheetPasswords = {};
            await loadSheets();
            const selectedSheet = sheetSelector.value;
            if(selectedSheet) await loadSheetData(selectedSheet);
        });
        sheetSelector.addEventListener('change', (e) => loadSheetData(e.target.value));
        newSheetBtn.addEventListener('click', handleNewSheet);
        addRowBtn.addEventListener('click', handleAddNewRow);
        addWeekBtn.addEventListener('click', handleAddWeek);
        summaryBtn.addEventListener('click', showSummary);
        categorySummaryBtn.addEventListener('click', showCategorySummary);
        closeSummaryBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        closeTimerBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerModal.classList.add('hidden');
        });
        closeChartBtn.addEventListener('click', () => chartModal.classList.add('hidden'));
        backToListBtn.addEventListener('click', showListView);
        exerciseJumper.addEventListener('change', (e) => {
            const newIndex = parseInt(e.target.value, 10);
            renderExerciseDetail(newIndex);
        });
    </script>
</body>
</html>
