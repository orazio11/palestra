<!DOCTYPE html>
<html lang="it" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Schede Palestra - Versione Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0c0a09; --bg-secondary: #1c1917; --bg-gradient-from: #1f2937; --bg-gradient-to: #0c0a09;
            --text-primary: #e2e8f0; --text-secondary: #a8a29e; --text-accent: #f59e0b; --text-accent-dark: #431407;
            --border-color: #44403c; --btn-secondary-bg: #262626; --btn-secondary-hover: #404040;
        }
        html.light {
            --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --bg-gradient-from: #e5e7eb; --bg-gradient-to: #f3f4f6;
            --text-primary: #111827; --text-secondary: #4b5563; --text-accent: #d97706; --text-accent-dark: #ffffff;
            --border-color: #d1d5db; --btn-secondary-bg: #e5e7eb; --btn-secondary-hover: #d1d5db;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        .bg-gradient-main { background-image: linear-gradient(to bottom right, var(--bg-gradient-from), var(--bg-gradient-to)); }
        .input-field { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 10px 12px; width: 100%; transition: all 0.2s; color: var(--text-primary); }
        .input-field:focus { outline: none; border-color: var(--text-accent); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.4); }
        .textarea-field { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 10px 12px; width: 100%; transition: all 0.2s; color: var(--text-primary); resize: vertical; min-height: 80px; }
        .textarea-field:focus { outline: none; border-color: var(--text-accent); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.4); }
        .btn { display: inline-flex; align-items: center; justify-content: center; text-align: center; background-color: var(--text-accent); color: var(--text-accent-dark); font-weight: 700; padding: 10px 16px; border-radius: 0.5rem; transition: all 0.2s; cursor: pointer; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1); }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); }
        .btn:disabled { cursor: not-allowed; filter: grayscale(50%); opacity: 0.7; }
        .btn-secondary { background-color: var(--btn-secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: var(--btn-secondary-hover); }
        .btn-danger { background-color: #be123c; color: #fff1f2; }
        .btn-danger:hover { background-color: #9f1239; }
        .loader { border: 4px solid var(--border-color); border-top: 4px solid var(--text-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .week-btn { flex-shrink: 0; background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .week-btn.active { background-color: var(--text-accent); color: var(--text-accent-dark); font-weight: 700; border-color: var(--text-accent); }
        .week-btn.completed { background-color: #047857; color: #d1fae5; border-color: #065f46; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.open { max-height: 2000px; }
        .notification { position: fixed; bottom: 20px; right: 20px; background-color: var(--text-accent); color: var(--text-accent-dark); padding: 16px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .reward-badge { display: inline-block; background-color: #f59e0b; color: #431407; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .stats-card { background-color: var(--bg-secondary); border-radius: 0.5rem; padding: 1rem; border: 1px solid var(--border-color); }
        .progress-bar { height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background-color: var(--text-accent); }
        .timer-display { font-family: monospace; font-size: 1.5rem; font-weight: bold; }
        .user-card { transition: all 0.2s; }
        .user-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .action-btn { transition: all 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .admin-setup-card { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border: 1px solid #374151; }
        .admin-request-card { background: linear-gradient(135deg, #7c2d12 0%, #431407 100%); border: 1px solid #9a3412; }
        .user-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 8px 16px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .exercise-image { width: 200px; height: 200px; object-fit: cover; border: 2px solid var(--border-color); border-radius: 0.5rem; margin: 1rem auto; display: block; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .image-upload-container { position: relative; }
        .image-preview { position: relative; display: inline-block; }
        .remove-image-btn { position: absolute; top: -8px; right: -8px; background-color: #be123c; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        .pdf-preview { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 1rem; margin-top: 1rem; background-color: var(--bg-secondary); }
        .pdf-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .pdf-preview-title { font-size: 1.5rem; font-weight: bold; color: var(--text-primary); }
        .pdf-preview-info { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .pdf-preview-exercise { border-bottom: 1px solid var(--border-color); padding: 0.5rem 0; }
        .pdf-preview-exercise:last-child { border-bottom: none; }
        .pdf-preview-exercise-name { font-weight: bold; color: var(--text-primary); }
        .pdf-preview-exercise-details { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .macrocycle-card { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); border: 1px solid #3b82f6; }
        .macrocycle-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .macrocycle-table th, .macrocycle-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid rgba(59, 130, 246, 0.3); }
        .macrocycle-table th { background-color: rgba(59, 130, 246, 0.2); color: white; font-weight: 600; }
        .macrocycle-table tr:nth-child(even) { background-color: rgba(59, 130, 246, 0.05); }
        .macrocycle-table tr:hover { background-color: rgba(59, 130, 246, 0.1); }
        .volume-bar { height: 8px; background-color: rgba(59, 130, 246, 0.2); border-radius: 4px; overflow: hidden; margin-top: 0.25rem; }
        .volume-fill { height: 100%; background-color: #3b82f6; border-radius: 4px; }
        .category-tag { display: inline-block; background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; margin-right: 0.25rem; }
        .accordion-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .accordion-header:hover { background-color: rgba(59, 130, 246, 0.2); }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-icon.open { transform: rotate(180deg); }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="container mx-auto p-4 max-w-3xl">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <i class="fas fa-dumbbell text-amber-400 text-2xl"></i>
                <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">Gym App</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="theme-toggle-btn" class="btn btn-secondary !p-2" title="Cambia tema">
                    <i id="theme-icon-light" class="fas fa-sun hidden"></i>
                    <i id="theme-icon-dark" class="fas fa-moon"></i>
                </button>
                <div id="user-controls"></div>
            </div>
        </header>
        
        <!-- Indicatore utente selezionato (solo per admin) -->
        <div id="user-indicator" class="user-indicator hidden">
            <div class="flex items-center gap-2">
                <i class="fas fa-user text-amber-400"></i>
                <span id="selected-user-name" class="text-sm font-medium"></span>
                <button id="back-to-admin-btn" class="btn btn-secondary !p-1 text-xs">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div id="main-view"></div>
    </div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 id="auth-title" class="text-xl font-bold text-white mb-4 text-center">Area Personale</h3>
            <p id="auth-error" class="text-red-400 mb-4 text-center text-sm"></p>
            <form id="auth-form" class="space-y-4">
                <input type="email" name="email" class="input-field" placeholder="Email" required>
                <input type="password" name="password" class="input-field" placeholder="Password (min. 6 caratteri)" required>
                <button type="submit" id="auth-submit-btn" class="btn w-full">Accedi</button>
                <button type="button" id="toggle-auth-mode-btn" class="text-center w-full mt-4 text-sm text-amber-400 hover:text-amber-300">Non hai un account? Registrati</button>
            </form>
            <div class="mt-6 text-center text-sm text-stone-500">
                <p>Se sei l'amministratore, usa le tue credenziali esistenti.</p>
                <p class="mt-2">Se hai bisogno di impostare un account admin, contatta lo sviluppatore.</p>
            </div>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 id="confirm-title" class="text-xl font-bold text-white mb-4">Conferma Azione</h3>
            <p id="confirm-message" class="text-stone-300 mb-6">Sei sicuro?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Annulla</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Conferma</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Exercise Modal -->
    <div id="edit-exercise-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95 border border-stone-800">
             <h3 class="text-xl font-bold text-white mb-4">Modifica Esercizio</h3>
             <div id="edit-exercise-container"></div>
        </div>
    </div>
    
    <!-- Favorites Modal -->
    <div id="favorites-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Esercizi Preferiti</h3>
                <button id="close-favorites-modal" class="btn btn-secondary !p-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="favorites-container"></div>
        </div>
    </div>
    
    <!-- User Management Modal -->
    <div id="user-management-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-4xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">
                    <i class="fas fa-users-cog mr-2 text-amber-400"></i> Gestione Utenti
                </h3>
                <div class="flex gap-2">
                    <button id="refresh-users-btn" class="btn btn-secondary !p-2" title="Aggiorna lista">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button id="close-user-modal" class="btn btn-secondary !p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="user-management-container"></div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-md m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4">Modifica Utente</h3>
            <div id="edit-user-container"></div>
        </div>
    </div>
    
    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Dettagli Utente</h3>
                <button id="close-user-details-btn" class="btn btn-secondary !p-2">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="user-details-container"></div>
        </div>
    </div>
    
    <!-- Timer Modal -->
    <div id="timer-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-sm m-4 transform scale-95 border border-stone-800">
            <h3 class="text-xl font-bold text-white mb-4 text-center">Timer Recupero</h3>
            <div class="timer-display text-amber-400 text-center mb-6" id="timer-display">00:00</div>
            <div class="flex justify-center gap-4">
                <button id="timer-pause-btn" class="btn btn-secondary">
                    <i class="fas fa-pause"></i> Pausa
                </button>
                <button id="timer-stop-btn" class="btn btn-danger">
                    <i class="fas fa-stop"></i> Ferma
                </button>
            </div>
        </div>
    </div>
    
    <!-- PDF Preview Modal -->
    <div id="pdf-preview-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden opacity-0 overflow-y-auto p-4">
        <div class="modal-content bg-stone-900 p-8 rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 border border-stone-800">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Anteprima PDF</h3>
                <div class="flex gap-2">
                    <button id="download-pdf-btn" class="btn btn-secondary">
                        <i class="fas fa-download mr-2"></i> Scarica PDF
                    </button>
                    <button id="create-gdoc-btn" class="btn btn-secondary">
                        <i class="fab fa-google-drive mr-2"></i> Crea Google Doc
                    </button>
                    <button id="close-pdf-preview-btn" class="btn btn-secondary !p-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="pdf-preview-container" class="pdf-preview">
                <!-- PDF preview content will be inserted here -->
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, query, orderBy, writeBatch, setDoc, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBpzZN8VmrRKW60rW1WprEzgXyhhATzaPs",
            authDomain: "apppalestrasuper.firebaseapp.com",
            projectId: "apppalestrasuper",
            storageBucket: "apppalestrasuper.appspot.com",
            messagingSenderId: "883984670947",
            appId: "1:883984670947:web:adb9a75775e78ae7a965d6",
            measurementId: "G-CL6QVT906P"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // NUOVE CATEGORIE DI ESERCIZI
        const CATEGORIES = [
            "ABDUCTORS", "ABS", "ADDUCTORS", "BICEPS", "CALVES", "CHEST ISO", 
            "DECLINE PUSH", "FRONT DELTS", "GLUTEI ISO", "HAMSTRINGS", "HIP HINGE", 
            "HORIZONTAL HIP EXTENSION", "HORIZONTAL PULL", "HORIZONTAL PUSH", 
            "INCLINE PULL", "INCLINE PUSH", "LEG PRESS VARIATION", "LOWER BACK", 
            "LUNGE", "PULLOVER", "QUADS ISO", "REAR DELTS", "SIDE DELTS", 
            "SQUAT PATTERN", "TRAPS", "TRICIPITI", "TRICEPS PUSH", "UPPER BACK", 
            "VERTICAL PULL", "VERTICAL PUSH"
        ];
        
        // REGOLE DEL MACROCICLO
        const MACROCYCLE_RULES = {
            "ADDOMINALI": { main: "ABS", additional: [] },
            "ADDUTTORI": { main: "ADDUCTORS", additional: [] },
            "BICIPITI": { main: "BICEPS", additional: [
                    { category: "HORIZONTAL PULL", percentage: 25 },
                    { category: "UPPER BACK", percentage: 25 },
                    { category: "INCLINE PULL", percentage: 25 }
                ] 
            },
 
            "DELTOIDI FRONTALI": { 
                main: "FRONT DELTS", 
                additional: [
                    { category: "INCLINE PUSH", percentage: 25 },
                    { category: "VERTICAL PUSH", percentage: 25 }
                ] 
            },
            "DELTOIDI LATERALI": { main: "SIDE DELTS", additional: [] },
            "DELTOIDI POSTERIORI": { 
                main: "REAR DELTS", 
                additional: [
                    { category: "HORIZONTAL PULL", percentage: 25 },
                    { category: "UPPER BACK", percentage: 25 }
                ] 
            },
            "DELTOIDI POSTERIORI": { 
                main: "REAR DELTS", 
                additional: [
                    { category: "HORIZONTAL PULL", percentage: 25 },
                    { category: "UPPER BACK", percentage: 25 }
                ] 
            },
            "DORSALI": { 
                main: "UPPER BACK", 
                additional: [
                    { category: "HORIZONTAL PULL", percentage: 100 },
                    { category: "PULLOVER", percentage: 100 },
                    { category: "INCLINE PULL", percentage: 100 }
                ] 
            },
            "GLUTEI": { 
                main: "HORIZONTAL HIP EXTENSION", 
                additional: [
                    { category: "HIP HINGE", percentage: 100 },
                    { category: "LEG PRESS VARIATION", percentage: 100 },
                    { category: "LUNGE", percentage: 100 },
                    { category: "ABDUCTORS", percentage: 100 },
                    { category: "SQUAT PATTERN", percentage: 100 },
                    { category: "GLUTEI ISO", percentage: 100 }
                ] 
            },
            "LOMBARI": { 
                main: "HIP HINGE", 
                additional: [
                    { category: "LOWER BACK", percentage: 100 }
                ] 
            },
            "PETTORALI": { 
                main: "HORIZONTAL PUSH", 
                additional: [
                    { category: "INCLINE PUSH", percentage: 100 },
                    { category: "CHEST ISO", percentage: 100 },
                    { category: "DECLINE PUSH", percentage: 100 }
                ] 
            },
            "POLPACCI": { main: "CALVES", additional: [] },
            "QUADRICIPITI": { 
                main: "SQUAT PATTERN", 
                additional: [
                    { category: "QUADS ISO", percentage: 100 },
                    { category: "LUNGE", percentage: 100 },
                    { category: "LEG PRESS VARIATION", percentage: 100 }
                ] 
            },
            "TRAPEZI": { 
                main: "HIP HINGE", 
                additional: [
                    { category: "TRAPS", percentage: 100 },
                    { category: "HORIZONTAL PULL", percentage: 100 }
                ] 
            },
            "TRICIPITI": { 
                main: "TRICIPITI", 
                additional: [
                    { category: "FRONT DELTS", percentage: 100 },
                    { category: "HORIZONTAL PUSH", percentage: 100 },
                    { category: "INCLINE PUSH", percentage: 100 },
                    { category: "DECLINE PUSH", percentage: 100 }
                ] 
            },
            "UPPER BACK": { 
                main: "VERTICAL PULL", 
                additional: [
                    { category: "UPPER BACK", percentage: 100 },
                    { category: "HORIZONTAL PULL", percentage: 100 }
                ] 
            }
        };
        
        const WEIGHT_INCREMENT = 2.5;
        
        // Riferimenti DOM
        const userControls = document.getElementById('user-controls');
        const mainView = document.getElementById('main-view');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const authModal = document.getElementById('auth-modal');
        const editExerciseModal = document.getElementById('edit-exercise-modal');
        const favoritesModal = document.getElementById('favorites-modal');
        const userManagementModal = document.getElementById('user-management-modal');
        const editUserModal = document.getElementById('edit-user-modal');
        const userDetailsModal = document.getElementById('user-details-modal');
        const timerModal = document.getElementById('timer-modal');
        const userIndicator = document.getElementById('user-indicator');
        const selectedUserName = document.getElementById('selected-user-name');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const pdfPreviewModal = document.getElementById('pdf-preview-modal');
        const pdfPreviewContainer = document.getElementById('pdf-preview-container');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const createGdocBtn = document.getElementById('create-gdoc-btn');
        const closePdfPreviewBtn = document.getElementById('close-pdf-preview-btn');
        
        let currentUser = null, currentUserRole = 'user', currentMesoId = null, currentSheetId = null, currentSheetData = null, currentWeek = 1, exercisesCache = [], saveTimeouts = {}, workoutStartTime = null, activeTimerInterval = null, isLoginMode = true, timerSeconds = 0, timerPaused = false, selectedUserId = null, pdfContent = null;
        
        // --- GESTIONE TEMA ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('light', theme === 'light');
            document.getElementById('theme-icon-light').classList.toggle('hidden', theme !== 'light');
            document.getElementById('theme-icon-dark').classList.toggle('hidden', theme === 'light');
            localStorage.setItem('theme', theme);
        }
        themeToggleBtn.addEventListener('click', () => applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light'));
        applyTheme(localStorage.getItem('theme') || 'dark');
        
        // --- GESTIONE TIMER ---
        function startTimerModal(duration) {
            timerSeconds = duration;
            timerPaused = false;
            updateTimerDisplay();
            timerModal.classList.remove('hidden');
            setTimeout(() => timerModal.classList.remove('opacity-0'), 10);
            
            if (activeTimerInterval) clearInterval(activeTimerInterval);
            activeTimerInterval = setInterval(() => {
                if (!timerPaused && timerSeconds > 0) {
                    timerSeconds--;
                    updateTimerDisplay();
                } else if (timerSeconds <= 0) {
                    clearInterval(activeTimerInterval);
                    showNotification("Timer completato!");
                    timerModal.classList.add('opacity-0');
                    setTimeout(() => timerModal.classList.add('hidden'), 250);
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        document.getElementById('timer-pause-btn').addEventListener('click', () => {
            timerPaused = !timerPaused;
            document.getElementById('timer-pause-btn').innerHTML = timerPaused ? 
                '<i class="fas fa-play"></i> Riprendi' : 
                '<i class="fas fa-pause"></i> Pausa';
        });
        
        document.getElementById('timer-stop-btn').addEventListener('click', () => {
            clearInterval(activeTimerInterval);
            timerModal.classList.add('opacity-0');
            setTimeout(() => timerModal.classList.add('hidden'), 250);
        });
        
        // --- VERIFICA E IMPOSTAZIONE ADMIN ---
        async function setupAdminAccount() {
            try {
                // Verifica se esiste già un admin nel sistema
                const adminQuery = query(collection(db, 'users'), where('role', '==', 'admin'));
                const adminSnapshot = await getDocs(adminQuery);
                
                if (adminSnapshot.empty) {
                    // Non ci sono admin nel sistema, proviamo a creare l'account admin predefinito
                    const email = 'naccio@live.it';
                    
                    try {
                        // Prova ad accedere con l'account esistente
                        const userCredential = await signInWithEmailAndPassword(auth, email, 'admin123');
                        const user = userCredential.user;
                        
                        // Se l'accesso riesce, imposta il ruolo admin
                        await setDoc(doc(db, 'users', user.uid), {
                            email,
                            role: 'admin',
                            createdAt: new Date().toISOString(),
                            createdBy: 'system'
                        });
                        
                        console.log('Account esistente promosso ad admin!');
                        showNotification('Il tuo account è stato impostato come amministratore!');
                        
                        // Esegui il logout per permettere il nuovo login
                        await signOut(auth);
                    } catch (error) {
                        if (error.code === 'auth/user-not-found') {
                            // L'utente non esiste, creiamolo
                            try {
                                const userCredential = await createUserWithEmailAndPassword(auth, email, 'admin123');
                                const user = userCredential.user;
                                
                                // Imposta il ruolo admin
                                await setDoc(doc(db, 'users', user.uid), {
                                    email,
                                    role: 'admin',
                                    createdAt: new Date().toISOString(),
                                    createdBy: 'system'
                                });
                                
                                console.log('Admin creato con successo!');
                                showNotification('Account admin creato. Accedi con naccio@live.it e password admin123');
                                
                                // Esegui il logout per permettere il nuovo login
                                await signOut(auth);
                            } catch (createError) {
                                console.error('Errore durante la creazione dell\'admin:', createError);
                            }
                        } else if (error.code === 'auth/wrong-password') {
                            // L'utente esiste ma la password è sbagliata
                            showNotification('L\'account admin esiste ma la password è errata. Contatta lo sviluppatore per reimpostare la password.');
                        } else {
                            console.error('Errore durante l\'accesso:', error);
                        }
                    }
                } else {
                    console.log('Admin già presente nel sistema');
                }
            } catch (error) {
                console.error('Errore durante la verifica dell\'admin:', error);
            }
        }
        
        // --- GESTIONE UTENTE SELEZIONATO ---
        function selectUser(userId, userEmail) {
            selectedUserId = userId;
            selectedUserName.textContent = userEmail;
            userIndicator.classList.remove('hidden');
            
            // Resetta le selezioni correnti
            currentMesoId = null;
            currentSheetId = null;
            currentSheetData = null;
            currentWeek = 1;
            exercisesCache = [];
            
            // Ricarica la vista
            renderAppView();
        }
        
        function deselectUser() {
            selectedUserId = null;
            userIndicator.classList.add('hidden');
            
            // Resetta le selezioni correnti
            currentMesoId = null;
            currentSheetId = null;
            currentSheetData = null;
            currentWeek = 1;
            exercisesCache = [];
            
            // Ricarica la vista
            renderAppView();
        }
        
        backToAdminBtn.addEventListener('click', deselectUser);
        
        // --- GESTIONE AUTENTICAZIONE E UI ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // Controlla il ruolo dell'utente
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                // Se l'utente è l'admin predefinito, assicurati che abbia i privilegi di admin
                if (user.email === 'naccio@live.it') {
                    if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                        // Imposta il ruolo admin per questo utente
                        await setDoc(doc(db, 'users', user.uid), {
                            email: user.email,
                            role: 'admin',
                            createdAt: userDoc.exists() ? userDoc.data().createdAt : new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }, { merge: true });
                        currentUserRole = 'admin';
                    } else {
                        currentUserRole = userDoc.data().role || 'user';
                    }
                } else {
                    if (userDoc.exists()) {
                        currentUserRole = userDoc.data().role || 'user';
                    } else {
                        // Se l'utente non ha un documento nel database, creane uno con ruolo 'user'
                        await setDoc(doc(db, 'users', user.uid), {
                            email: user.email,
                            role: 'user',
                            createdAt: new Date().toISOString()
                        });
                        currentUserRole = 'user';
                    }
                }
                
                renderAppView();
            } else {
                renderLoginView();
            }
        });
        
        function renderLoginView() {
            mainView.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-dumbbell text-amber-400 text-5xl mb-6"></i>
                    <h2 class="text-2xl font-bold text-white mb-4">Benvenuto in Gym App</h2>
                    <p class="text-stone-400 mb-8">Effettua il login per accedere alla tua area personale.</p>
                    <div class="admin-setup-card max-w-md mx-auto p-6 rounded-xl mb-8">
                        <h3 class="text-lg font-semibold text-white mb-3">
                            <i class="fas fa-user-shield mr-2 text-amber-400"></i> Informazioni Admin
                        </h3>
                        <p class="text-stone-300 mb-4">
                            Se sei l'amministratore del sistema, utilizza le tue credenziali esistenti. 
                            Se non hai ancora un account admin, verrà creato automaticamente al primo accesso.
                        </p>
                        <div class="bg-stone-800 p-4 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-stone-400">Email admin:</span>
                                <span class="font-mono text-amber-400">naccio@live.it</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-stone-400">Password:</span>
                                <span class="font-mono text-amber-400">admin123</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            userControls.innerHTML = `<button id="login-btn" class="btn">Accedi / Registrati</button>`;
            document.getElementById('login-btn').addEventListener('click', openAuthModal);
        }
        
        function renderAppView() {
            // Se l'utente è loggato ma non è admin, mostra la richiesta di admin
            if (currentUser && currentUser.email === 'naccio@live.it' && currentUserRole !== 'admin') {
                mainView.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-user-shield text-amber-400 text-5xl mb-6"></i>
                        <h2 class="text-2xl font-bold text-white mb-4">Accesso Amministratore Richiesto</h2>
                        <p class="text-stone-400 mb-8">
                            Il tuo account è registrato come amministratore ma non ha i privilegi di admin nel sistema.
                            Clicca sul pulsante qui sotto per impostare i privilegi di amministratore.
                        </p>
                        <div class="admin-request-card max-w-md mx-auto p-6 rounded-xl mb-8">
                            <h3 class="text-lg font-semibold text-white mb-3">
                                <i class="fas fa-exclamation-triangle mr-2 text-amber-400"></i> Richiesta Admin
                            </h3>
                            <p class="text-stone-300 mb-4">
                                Per accedere alle funzionalità di amministratore, devi impostare manualmente i privilegi di admin per questo account.
                            </p>
                            <button id="request-admin-btn" class="btn w-full">
                                <i class="fas fa-user-shield mr-2"></i> Imposta Privilegi Admin
                            </button>
                        </div>
                    </div>`;
                
                document.getElementById('request-admin-btn').addEventListener('click', async () => {
                    if (await showConfirmModal('Impostare questo account come amministratore?')) {
                        try {
                            await updateDoc(doc(db, 'users', currentUser.uid), {
                                role: 'admin',
                                promotedBy: 'self',
                                promotedAt: new Date().toISOString()
                            });
                            currentUserRole = 'admin';
                            showNotification("Privilegi di amministratore impostati con successo!");
                            renderAppView();
                        } catch (error) {
                            console.error("Errore durante l'impostazione dei privilegi admin:", error);
                            showNotification("Errore durante l'impostazione dei privilegi admin.", "error");
                        }
                    }
                });
                
                userControls.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-stone-400 hidden sm:block">Ciao, ${currentUser.email}</span>
                        <button id="logout-btn" class="btn btn-secondary">Logout</button>
                    </div>`;
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
                
                return;
            }
            
            // Rendering normale dell'app per utenti e admin
            userControls.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-sm text-stone-400 hidden sm:block">Ciao, ${currentUser.email}</span>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>`;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            
            const isAdmin = currentUserRole === 'admin';
            const effectiveUserId = selectedUserId || currentUser.uid;
            
            mainView.innerHTML = `
                <div class="space-y-6">
                    ${isAdmin && !selectedUserId ? `
                    <div class="bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg">
                        <h3 class="text-lg font-bold text-white mb-3">
                            <i class="fas fa-users mr-2 text-amber-400"></i> Seleziona Utente
                        </h3>
                        <div id="user-selector-container"></div>
                    </div>
                    ` : ''}
                    <div id="mesocycle-container" class="bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg"></div>
                    <div id="macrocycle-volume-container" class="hidden macrocycle-card p-4 rounded-xl border border-blue-600 shadow-lg"></div>
                    <div id="sheet-container" class="bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg hidden"></div>
                    <div id="sheet-content" class="hidden">
                        <div id="week-selector-container" class="mb-4"></div>
                        <div id="week-actions-container" class="mb-4 text-center"></div>
                        <div id="sheet-volume-summary-container" class="mb-4"></div>
                        <div id="exercise-list-container" class="space-y-4"></div>
                        ${isAdmin ? `
                        <div class="mt-6 bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg">
                            <button id="toggle-add-exercise-btn" class="btn w-full btn-secondary">
                                <i class="fas fa-plus mr-2"></i> Aggiungi Esercizio
                            </button>
                            <div id="add-exercise-container" class="collapsible-content mt-4"></div>
                        </div>
                        ` : ''}
                        <div class="mt-6 text-center">
                            <button id="export-csv-btn" class="btn btn-secondary mr-2">
                                <i class="fas fa-file-csv mr-2"></i> Esporta CSV
                            </button>
                            <button id="export-pdf-btn" class="btn btn-secondary">
                                <i class="fas fa-file-pdf mr-2"></i> Esporta PDF
                            </button>
                        </div>
                    </div>
                    <div id="initial-message" class="text-center p-8 text-stone-400">
                        <i class="fas fa-clipboard-list text-4xl mb-4 text-stone-600"></i>
                        <p>Seleziona o crea un mesociclo per iniziare.</p>
                    </div>
                    ${isAdmin && !selectedUserId ? `
                    <div class="mt-6 bg-gradient-main p-4 rounded-xl border border-stone-800 shadow-lg">
                        <h3 class="text-lg font-bold text-white mb-4">
                            <i class="fas fa-user-shield mr-2 text-amber-400"></i> Area Amministratore
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="manage-favorites-btn" class="btn btn-secondary">
                                <i class="fas fa-star mr-2"></i> Esercizi Preferiti
                            </button>
                            <button id="manage-users-btn" class="btn btn-secondary">
                                <i class="fas fa-users-cog mr-2"></i> Gestisci Utenti
                            </button>
                        </div>
                    </div>
                    ` : ''}
                </div>`;
            
            // Se l'admin non ha selezionato un utente, carica il selettore di utenti
            if (isAdmin && !selectedUserId) {
                renderUserSelector();
            }
            
            renderMesocycleSelector();
        }
        
        // --- FUNZIONE PER IL SELETTORE DI UTENTI ---
        async function renderUserSelector() {
            const container = document.getElementById('user-selector-container');
            if (!container) return;
            
            container.innerHTML = '<div class="loader"></div>';
            
            try {
                const usersSnapshot = await getDocs(getUsersRef());
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (users.length === 0) {
                    container.innerHTML = '<p class="text-stone-400 text-center">Nessun utente trovato.</p>';
                    return;
                }
                
                let options = '<option value="">-- Seleziona un utente --</option>';
                users.forEach(user => {
                    options += `<option value="${user.id}">${user.email} ${user.role === 'admin' ? '(Admin)' : ''}</option>`;
                });
                
                container.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-3">
                        <select id="user-selector" class="input-field flex-grow">${options}</select>
                        <button id="view-user-details-btn" class="btn btn-secondary" disabled>
                            <i class="fas fa-user-circle mr-2"></i> Dettagli
                        </button>
                    </div>`;
                
                const userSelector = document.getElementById('user-selector');
                const viewUserDetailsBtn = document.getElementById('view-user-details-btn');
                
                userSelector.addEventListener('change', (e) => {
                    const userId = e.target.value;
                    viewUserDetailsBtn.disabled = !userId;
                    
                    if (userId) {
                        const selectedUser = users.find(u => u.id === userId);
                        if (selectedUser) {
                            selectUser(userId, selectedUser.email);
                        }
                    }
                });
                
                viewUserDetailsBtn.addEventListener('click', () => {
                    const userId = userSelector.value;
                    if (userId) {
                        const selectedUser = users.find(u => u.id === userId);
                        if (selectedUser) {
                            openUserDetailsModal(selectedUser);
                        }
                    }
                });
            } catch (error) {
                console.error("Errore durante il caricamento degli utenti:", error);
                container.innerHTML = '<p class="text-red-400 text-center">Errore durante il caricamento degli utenti.</p>';
            }
        }
        
        // --- FUNZIONI DI LOGICA PRINCIPALE ---
        const getMesocyclesRef = () => {
            const effectiveUserId = selectedUserId || currentUser.uid;
            return collection(db, 'users', effectiveUserId, 'mesocycles');
        };
        
        const getSheetsRef = (mesoId) => {
            const effectiveUserId = selectedUserId || currentUser.uid;
            return collection(db, 'users', effectiveUserId, 'mesocycles', mesoId, 'trainingSheets');
        };
        
        const getExercisesRef = (mesoId, sheetId) => {
            const effectiveUserId = selectedUserId || currentUser.uid;
            return collection(db, 'users', effectiveUserId, 'mesocycles', mesoId, 'trainingSheets', sheetId, 'exercises');
        };
        
        const getRewardsRef = () => {
            const effectiveUserId = selectedUserId || currentUser.uid;
            return collection(db, 'users', effectiveUserId, 'rewards');
        };
        
        const getFavoriteExercisesRef = () => collection(db, 'favoriteExercises');
        const getUsersRef = () => collection(db, 'users');
        
        async function renderMesocycleSelector() {
            const mesocycleContainer = document.getElementById('mesocycle-container');
            if (!mesocycleContainer) return;
            const mesocyclesSnapshot = await getDocs(query(getMesocyclesRef(), orderBy("dataCreazione", "desc")));
            let options = '<option value="">-- Seleziona un mesociclo --</option>';
            mesocyclesSnapshot.forEach(doc => {
                options += `<option value="${doc.id}">${doc.data().nome}</option>`;
            });
            
            mesocycleContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white">
                        <i class="fas fa-calendar-alt mr-2 text-amber-400"></i> Mesociclo
                    </h3>
                    <div class="flex items-center gap-2">
                        <button id="export-meso-btn" class="btn btn-secondary !p-2 text-xs" title="Esporta Mesociclo (JSON)">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button id="import-meso-btn" class="btn btn-secondary !p-2 text-xs" title="Importa Mesociclo (JSON)">
                            <i class="fas fa-file-import"></i>
                        </button>
                        ${currentUserRole === 'admin' ? `
                        <button id="toggle-create-meso-btn" class="btn btn-secondary !p-2 text-xs">
                            <i class="fas fa-plus"></i>
                        </button>
                        ` : ''}
                    </div>
                </div>
                <select id="mesocycle-selector" class="input-field w-full">${options}</select>
                ${currentUserRole === 'admin' ? `
                <div id="create-meso-container" class="collapsible-content mt-3">
                    <form id="create-meso-form" class="space-y-3">
                        <input type="text" name="name" class="input-field" placeholder="Nome mesociclo..." required>
                        <button type="submit" class="btn w-full">
                            <i class="fas fa-plus mr-2"></i> Crea
                        </button>
                    </form>
                </div>
                ` : ''}
                <input type="file" id="import-file-input" class="hidden" accept=".json">`;
            
            const mesoSelector = document.getElementById('mesocycle-selector');
            mesoSelector.addEventListener('change', (e) => selectMesocycle(e.target.value));
            
            if (currentUserRole === 'admin') {
                document.getElementById('create-meso-form').addEventListener('submit', handleCreateMeso);
                document.getElementById('toggle-create-meso-btn').addEventListener('click', () => document.getElementById('create-meso-container').classList.toggle('open'));
            }
            
            document.getElementById('export-meso-btn').addEventListener('click', handleExportMeso);
            document.getElementById('import-meso-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
            document.getElementById('import-file-input').addEventListener('change', handleImportMeso);
            
            const effectiveUserId = selectedUserId || currentUser.uid;
            const lastMesoId = localStorage.getItem(`lastMesoId_${effectiveUserId}`);
            if (lastMesoId && mesoSelector.querySelector(`option[value="${lastMesoId}"]`)) {
                mesoSelector.value = lastMesoId;
                selectMesocycle(lastMesoId);
            }
        }
        
        async function selectMesocycle(mesoId) {
            currentMesoId = mesoId;
            const effectiveUserId = selectedUserId || currentUser.uid;
            localStorage.setItem(`lastMesoId_${effectiveUserId}`, mesoId || '');
            const sheetContent = document.getElementById('sheet-content');
            const initialMessage = document.getElementById('initial-message');
            const sheetContainer = document.getElementById('sheet-container');
            const macrocycleVolumeContainer = document.getElementById('macrocycle-volume-container');
            
            sheetContent.classList.add('hidden');
            initialMessage.classList.remove('hidden');
            if (!mesoId) {
                sheetContainer.classList.add('hidden');
                macrocycleVolumeContainer.classList.add('hidden');
                return;
            }
            sheetContainer.classList.remove('hidden');
            await renderSheetSelector();
            await calculateAndRenderMacrocycleVolume();
        }
        
        async function renderSheetSelector() {
            const sheetContainer = document.getElementById('sheet-container');
            const sheetsSnapshot = await getDocs(query(getSheetsRef(currentMesoId), orderBy("dataCreazione", "desc")));
            let options = '<option value="">-- Seleziona una scheda --</option>';
            sheetsSnapshot.forEach(doc => {
                const sheet = doc.data();
                options += `<option value="${doc.id}">${sheet.nomeScheda}${sheet.isCompleta ? ' (Completata)' : ''}</option>`;
            });
            sheetContainer.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white">
                        <i class="fas fa-clipboard-list mr-2 text-amber-400"></i> Scheda di Allenamento
                    </h3>
                    ${currentUserRole === 'admin' ? `
                    <button id="toggle-create-sheet-btn" class="btn btn-secondary !p-2 text-xs">
                        <i class="fas fa-plus"></i>
                    </button>
                    ` : ''}
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <select id="sheet-selector" class="input-field flex-grow">${options}</select>
                    <div class="flex items-center gap-3">
                        ${currentUserRole === 'admin' ? `
                        <button id="duplicate-sheet-btn" class="btn btn-secondary w-full" title="Duplica Scheda">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button id="delete-sheet-btn" class="btn btn-danger w-full" title="Elimina Scheda">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                        <button id="complete-sheet-btn" class="btn btn-secondary w-full" title="Termina Scheda">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                ${currentUserRole === 'admin' ? `
                <div id="create-sheet-container" class="collapsible-content mt-3">
                    <form id="create-sheet-form" class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                        <input type="text" id="new-sheet-name" class="input-field flex-grow" placeholder="Nome nuova scheda..." required>
                        <input type="number" id="new-sheet-weeks" class="input-field sm:w-28" placeholder="Sett." min="1" required>
                        <button type="submit" class="btn !w-full sm:!w-auto">
                            <i class="fas fa-plus mr-2"></i> Aggiungi
                        </button>
                    </form>
                </div>
                ` : ''}`;
            
            document.getElementById('sheet-selector').addEventListener('change', (e) => selectSheet(e.target.value));
            
            if (currentUserRole === 'admin') {
                document.getElementById('toggle-create-sheet-btn').addEventListener('click', () => document.getElementById('create-sheet-container').classList.toggle('open'));
                document.getElementById('create-sheet-form').addEventListener('submit', handleCreateSheet);
                document.getElementById('duplicate-sheet-btn').addEventListener('click', handleDuplicateSheet);
                document.getElementById('delete-sheet-btn').addEventListener('click', handleDeleteSheet);
            }
            
            document.getElementById('complete-sheet-btn').addEventListener('click', handleCompleteSheet);
        }
        
        async function selectSheet(sheetId) {
            const sheetContent = document.getElementById('sheet-content');
            const initialMessage = document.getElementById('initial-message');
            const macrocycleVolumeContainer = document.getElementById('macrocycle-volume-container');
            if (!sheetId) {
                sheetContent.classList.add('hidden');
                macrocycleVolumeContainer.classList.remove('hidden');
                currentSheetId = null;
                return;
            }
            macrocycleVolumeContainer.classList.add('hidden');
            initialMessage.classList.add('hidden');
            sheetContent.classList.remove('hidden');
            currentSheetId = sheetId;
            currentWeek = 1;
            workoutStartTime = null;
            const sheetDocRef = doc(getSheetsRef(currentMesoId), sheetId);
            const sheetDocSnap = await getDoc(sheetDocRef);
            if (!sheetDocSnap.exists()) { 
                showNotification("Scheda non trovata!", "error");
                return; 
            }
            currentSheetData = sheetDocSnap.data();
            
            renderWeekSelector();
            renderWeekActions();
            if (currentUserRole === 'admin') {
                renderAddExerciseForm();
            }
            await loadAndRenderExercises();
        }
        
        async function loadAndRenderExercises() {
            const exerciseContainer = document.getElementById('exercise-list-container');
            exerciseContainer.innerHTML = '<div class="loader"></div>';
            const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
            const q = query(exercisesRef, orderBy("ordine"));
            const exercisesSnapshot = await getDocs(q);
            exercisesCache = exercisesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderExercises();
        }
        
        // --- RENDERING UI SPECIFICA ---
        function renderWeekSelector() {
            const weekSelectorContainer = document.getElementById('week-selector-container');
            const numWeeks = currentSheetData.numeroSettimane || 1;
            const completedWeeks = currentSheetData.completedWeeks || [];
            weekSelectorContainer.innerHTML = `<div class="flex items-center space-x-2 overflow-x-auto pb-1 no-scrollbar"></div>`;
            const container = weekSelectorContainer.firstElementChild;
            for (let i = 1; i <= numWeeks; i++) {
                const btn = document.createElement('button');
                btn.textContent = `Sett. ${i}`;
                let classes = 'week-btn px-4 py-2 rounded-md font-semibold text-sm';
                if (i === currentWeek) classes += ' active';
                if (completedWeeks.includes(i)) classes += ' completed';
                btn.className = classes;
                btn.onclick = () => { currentWeek = i; renderWeekSelector(); renderExercises(); renderWeekActions(); };
                container.appendChild(btn);
            }
        }
        
        function renderWeekActions() {
            const weekActionsContainer = document.getElementById('week-actions-container');
            const duration = currentSheetData.workoutDurations?.[currentWeek];
            let durationHTML = duration ? 
                `<p class="text-sm text-stone-400">
                    <i class="fas fa-clock mr-1"></i> Durata Allenamento: 
                    <span class="font-bold text-amber-400">${duration}</span>
                </p>` : '';
            weekActionsContainer.innerHTML = `
                <button id="complete-week-btn" class="btn btn-secondary">
                    <i class="fas fa-check-circle mr-2"></i> Completa Settimana ${currentWeek}
                </button>
                ${durationHTML}`;
            document.getElementById('complete-week-btn').addEventListener('click', handleCompleteWeek);
        }
        
        // --- NUOVA FUNZIONE PER IL VOLUME MACROCICLO ---
        async function calculateAndRenderMacrocycleVolume() {
            const macrocycleVolumeContainer = document.getElementById('macrocycle-volume-container');
            if (!macrocycleVolumeContainer) return;
            
            macrocycleVolumeContainer.classList.remove('hidden');
            macrocycleVolumeContainer.innerHTML = '<div class="loader"></div>';
            
            try {
                // Calcola il volume per ogni categoria di esercizio nel mesociclo
                const volumeByCategory = {};
                const sheetsSnapshot = await getDocs(getSheetsRef(currentMesoId));
                
                for (const sheetDoc of sheetsSnapshot.docs) {
                    const exercisesSnapshot = await getDocs(getExercisesRef(currentMesoId, sheetDoc.id));
                    exercisesSnapshot.forEach(exDoc => {
                        const ex = exDoc.data();
                        const category = ex.categoria || 'Senza Categoria';
                        if (!volumeByCategory[category]) volumeByCategory[category] = 0;
                        volumeByCategory[category] += ex.serie;
                    });
                }
                
                // Calcola il volume per ogni gruppo del macrociclo
                const macrocycleVolume = {};
                const macrocycleDetails = {};
                
                for (const [groupName, rule] of Object.entries(MACROCYCLE_RULES)) {
                    const mainVolume = volumeByCategory[rule.main] || 0;
                    let totalVolume = mainVolume;
                    
                    // Aggiungi il volume delle categorie aggiuntive con le rispettive percentuali
                    const additionalContributions = [];
                    for (const additional of rule.additional) {
                        const additionalVolume = volumeByCategory[additional.category] || 0;
                        const contribution = Math.round(additionalVolume * additional.percentage / 100);
                        totalVolume += contribution;
                        
                        additionalContributions.push({
                            category: additional.category,
                            percentage: additional.percentage,
                            volume: additionalVolume,
                            contribution
                        });
                    }
                    
                    macrocycleVolume[groupName] = totalVolume;
                    macrocycleDetails[groupName] = {
                        mainCategory: rule.main,
                        mainVolume,
                        additionalContributions
                    };
                }
                
                // Renderizza il volume del macrociclo in una tabella chiara
                let summaryHTML = `
                    <div class="accordion-header flex justify-between items-center p-3 rounded-lg cursor-pointer" id="macrocycle-accordion-header">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-chart-line mr-2 text-blue-400"></i> Volume Macrociclo
                        </h3>
                        <i class="fas fa-chevron-down accordion-icon text-blue-400"></i>
                    </div>
                    <div id="macrocycle-accordion-content" class="collapsible-content">
                        <div class="overflow-x-auto mt-3">
                            <table class="macrocycle-table">
                                <thead>
                                    <tr>
                                        <th>Gruppo Muscolare</th>
                                        <th>Volume Totale</th>
                                        <th>Composizione</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                
                for (const [groupName, volume] of Object.entries(macrocycleVolume)) {
                    const details = macrocycleDetails[groupName];
                    let compositionHtml = `<span class="category-tag">${details.mainCategory}: ${details.mainVolume} serie</span>`;
                    
                    details.additionalContributions.forEach(add => {
                        compositionHtml += `<span class="category-tag">${add.category}: ${add.volume} serie (${add.percentage}%)</span>`;
                    });
                    
                    summaryHTML += `
                        <tr>
                            <td class="font-medium text-white">${groupName}</td>
                            <td class="text-blue-400 font-bold">${volume} serie</td>
                            <td>${compositionHtml}</td>
                        </tr>`;
                }
                
                summaryHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                
                macrocycleVolumeContainer.innerHTML = summaryHTML;
                
                // Aggiungi event listener per la tendina
                document.getElementById('macrocycle-accordion-header').addEventListener('click', () => {
                    const content = document.getElementById('macrocycle-accordion-content');
                    const icon = document.querySelector('#macrocycle-accordion-header .accordion-icon');
                    
                    content.classList.toggle('open');
                    icon.classList.toggle('open');
                });
                
            } catch (error) {
                console.error("Errore durante il calcolo del volume macrociclo:", error);
                macrocycleVolumeContainer.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle text-2xl text-red-500 mb-2"></i>
                        <p class="text-stone-400">Errore durante il calcolo del volume macrociclo.</p>
                    </div>`;
            }
        }
        
        function calculateAndRenderSheetVolume() {
            const sheetVolumeSummaryContainer = document.getElementById('sheet-volume-summary-container');
            const volumeByCategory = {};
            exercisesCache.forEach(ex => {
                const category = ex.categoria || 'Senza Categoria';
                if (!volumeByCategory[category]) volumeByCategory[category] = 0;
                volumeByCategory[category] += ex.serie;
            });
            let summaryHTML = `
                <h3 class="text-lg font-bold mb-2 text-white">
                    <i class="fas fa-chart-pie mr-2 text-amber-400"></i> Volume Scheda
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">`;
            const sortedCategories = Object.keys(volumeByCategory).sort();
            if (sortedCategories.length === 0) summaryHTML = '';
            else sortedCategories.forEach(cat => { 
                summaryHTML += `
                    <div class="bg-stone-800/50 p-2 rounded">
                        <span class="font-semibold text-stone-300">${cat}:</span> 
                        <span class="text-amber-400 font-bold">${volumeByCategory[cat]} serie</span>
                    </div>`; 
            });
            summaryHTML += `</div>`;
            sheetVolumeSummaryContainer.innerHTML = summaryHTML;
        }
        
        function renderExercises() {
            const exerciseContainer = document.getElementById('exercise-list-container');
            exerciseContainer.innerHTML = '';
            if (exercisesCache.length === 0) {
                exerciseContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-dumbbell text-4xl text-stone-600 mb-4"></i>
                        <p class="text-stone-400">Nessun esercizio. Aggiungine uno qui sotto.</p>
                    </div>`;
            } else {
                exercisesCache.forEach(ex => exerciseContainer.appendChild(createExerciseCard(ex)));
                const reorderBtns = exerciseContainer.querySelectorAll('.reorder-btn');
                if (reorderBtns.length > 0) {
                    exerciseContainer.querySelector('.reorder-btn[data-direction="up"]').disabled = true;
                    const allDownButtons = exerciseContainer.querySelectorAll('.reorder-btn[data-direction="down"]');
                    allDownButtons[allDownButtons.length - 1].disabled = true;
                }
            }
            calculateAndRenderSheetVolume();
        }
        
        function createExerciseCard(ex) {
            const card = document.createElement('div');
            card.className = 'bg-gradient-main p-4 rounded-lg border border-stone-800 shadow-md';
            
            let seriesHTML = '<div class="space-y-3 mt-4">';
            const weeklyData = ex.datiSettimanali?.[currentWeek] || [];
            const prevWeeklyData = ex.datiSettimanali?.[currentWeek - 1] || [];
            
            for (let i = 0; i < ex.serie; i++) {
                let setData = weeklyData[i] || { carico: '', reps: '' };
                const prevSetData = prevWeeklyData[i] || null;
                
                if (currentWeek > 1 && !setData.carico && prevSetData?.carico && prevSetData?.reps) {
                    const repRange = (ex.ripetizioni || "").split('-').map(Number);
                    const maxReps = repRange.length > 1 ? repRange[1] : repRange[0];
                    if (parseInt(prevSetData.reps) >= maxReps) {
                        setData.carico = parseFloat(prevSetData.carico) + WEIGHT_INCREMENT;
                    } else {
                        setData.carico = prevSetData.carico;
                    }
                }
                
                let prevWeekHint = prevSetData ? 
                    `<p class="text-xs text-stone-500 text-right col-span-4 mb-1">
                        <i class="fas fa-history mr-1"></i> Sett. prec: ${prevSetData.carico || '-'}kg x ${prevSetData.reps || '-'}
                    </p>` : '';
                seriesHTML += `
                    ${prevWeekHint}
                    <div class="grid grid-cols-4 items-center gap-3">
                        <span class="font-semibold text-stone-400 text-sm">Serie ${i + 1}</span>
                        <input type="number" step="0.5" placeholder="kg" class="input-field text-center" value="${setData.carico}" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="carico">
                        <input type="number" placeholder="reps" class="input-field text-center" value="${setData.reps}" data-ex-id="${ex.id}" data-serie-index="${i}" data-field="reps">
                        <button class="btn btn-secondary !p-2 text-xs" data-timer="${ex.recupero}" title="Avvia timer">
                            <i class="fas fa-stopwatch"></i>
                        </button>
                    </div>`;
            }
            seriesHTML += '</div>';
            const imageUrlHTML = ex.imageUrl ? 
                `<img src="${ex.imageUrl}" alt="${ex.nomeEsercizio}" class="exercise-image">` : '';
            
            // Check for progress reward
            let progressReward = '';
            if (currentWeek > 1) {
                const prevWeekData = ex.datiSettimanali?.[currentWeek - 1] || [];
                const currentWeekData = ex.datiSettimanali?.[currentWeek] || [];
                
                for (let i = 0; i < Math.min(prevWeekData.length, currentWeekData.length); i++) {
                    const prevLoad = parseFloat(prevWeekData[i]?.carico || 0);
                    const currentLoad = parseFloat(currentWeekData[i]?.carico || 0);
                    
                    if (currentLoad > prevLoad) {
                        progressReward = '<span class="reward-badge"><i class="fas fa-trophy mr-1"></i> Progresso!</span>';
                        break;
                    }
                }
            }
            
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow pr-4">
                        <h4 class="text-lg font-bold text-white">${ex.nomeEsercizio} ${progressReward}</h4>
                        <p class="text-sm text-amber-400">
                            <i class="fas fa-tag mr-1"></i> ${ex.categoria}
                        </p>
                        <p class="text-xs text-stone-400 mt-1">
                            <i class="fas fa-list-ol mr-1"></i> Serie: ${ex.serie} | 
                            <i class="fas fa-redo mr-1 ml-2"></i> Reps: ${ex.ripetizioni} | 
                            <i class="fas fa-fire mr-1 ml-2"></i> RIR: ${ex.rir || '-'} | 
                            <i class="fas fa-hourglass-half mr-1 ml-2"></i> Recupero: ${ex.recupero || '-'}s
                        </p>
                        ${ex.note ? `<p class="text-sm text-stone-300 mt-2 border-t border-stone-700/50 pt-2">${ex.note}</p>` : ''}
                    </div>
                    <div class="flex items-start gap-2">
                        ${currentUserRole === 'admin' ? `
                        <div class="flex flex-col gap-1">
                            <button class="btn btn-secondary !p-1 reorder-btn" data-reorder-ex-id="${ex.id}" data-direction="up" title="Sposta su">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="btn btn-secondary !p-1 reorder-btn" data-reorder-ex-id="${ex.id}" data-direction="down" title="Sposta giù">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                        <div class="flex flex-col gap-1">
                             <button class="btn btn-secondary !p-2" data-edit-ex-id="${ex.id}" title="Modifica">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger !p-2" data-delete-ex-id="${ex.id}" title="Elimina">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                        ${ex.videoUrl ? 
                            `<a href="${ex.videoUrl}" target="_blank" class="text-amber-400 hover:text-amber-300 self-center" title="Guarda il video">
                                <i class="fab fa-youtube text-xl"></i>
                            </a>` : ''}
                    </div>
                </div>
                ${imageUrlHTML}
                ${seriesHTML}`;
            return card;
        }
        
        function renderAddExerciseForm() {
            const addExerciseContainer = document.getElementById('add-exercise-container');
            const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            addExerciseContainer.innerHTML = `
                <form id="add-exercise-form" class="space-y-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <input type="text" name="nomeEsercizio" class="input-field" placeholder="Nome Esercizio" required>
                        <select name="categoria" class="input-field" required>${categoryOptions}</select>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <input type="number" name="ordine" class="input-field" placeholder="Ordine" value="${(exercisesCache.length || 0) + 1}" required>
                        <input type="number" name="serie" class="input-field" placeholder="N° Serie" required>
                        <input type="text" name="ripetizioni" class="input-field" placeholder="Reps (es. 8-10)" required>
                        <input type="text" name="rir" class="input-field" placeholder="RIR (es. 1-2)">
                    </div>
                    <input type="number" name="recupero" class="input-field" placeholder="Recupero (secondi)">
                    <textarea name="note" class="textarea-field" placeholder="Note (opzionale)" rows="3"></textarea>
                    <input type="url" name="videoUrl" class="input-field" placeholder="Link Video (opzionale)">
                    <input type="url" name="imageUrl" class="input-field" placeholder="URL Immagine (opzionale)">
                    <div class="image-upload-container">
                        <label class="text-sm text-stone-400 mb-1 block">Oppure carica un'immagine dal PC</label>
                        <input type="file" name="imageFile" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200">
                    </div>
                    <button type="submit" class="btn w-full">
                        <i class="fas fa-plus mr-2"></i> Aggiungi
                    </button>
                </form>`;
            document.getElementById('add-exercise-form').addEventListener('submit', handleAddExercise);
        }
        
        // --- GESTIONE EVENTI ---
        async function handleCreateMeso(e) {
            e.preventDefault();
            const form = e.target;
            const mesoName = form.elements['name'].value.trim();
            if (!mesoName) return;
            await addDoc(getMesocyclesRef(), { 
                nome: mesoName, 
                dataCreazione: new Date().toISOString() 
            });
            await renderMesocycleSelector();
            showNotification("Mesociclo creato con successo!");
        }
        
        async function handleCreateSheet(e) {
            e.preventDefault();
            const form = e.target;
            const sheetName = form.elements['new-sheet-name'].value.trim();
            const numWeeks = parseInt(form.elements['new-sheet-weeks'].value, 10);
            if (!sheetName || !numWeeks) return;
            await addDoc(getSheetsRef(currentMesoId), { 
                nomeScheda: sheetName, 
                numeroSettimane: numWeeks, 
                dataCreazione: new Date().toISOString(), 
                isCompleta: false, 
                completedWeeks: [] 
            });
            await renderSheetSelector();
            showNotification("Scheda creata con successo!");
        }
        
        async function handleDuplicateSheet() {
            if (!currentSheetId) { 
                showNotification("Seleziona una scheda da duplicare.", "error");
                return; 
            }
            const newName = prompt("Nuovo nome per la scheda:", `${currentSheetData.nomeScheda} (Copia)`);
            if (!newName) return;
            const newSheetRef = await addDoc(getSheetsRef(currentMesoId), { 
                ...currentSheetData, 
                nomeScheda: newName, 
                dataCreazione: new Date().toISOString(), 
                isCompleta: false, 
                completedWeeks: [] 
            });
            const exercisesSnapshot = await getDocs(getExercisesRef(currentMesoId, currentSheetId));
            const batch = writeBatch(db);
            exercisesSnapshot.forEach(exDoc => {
                const newExerciseRef = doc(getExercisesRef(currentMesoId, newSheetRef.id));
                batch.set(newExerciseRef, exDoc.data());
            });
            await batch.commit();
            showNotification(`Scheda "${newName}" creata!`);
            await renderSheetSelector();
        }
        
        async function handleDeleteSheet() {
            if (!currentSheetId) { 
                showNotification("Seleziona una scheda da eliminare.", "error");
                return; 
            }
            const confirmed = await showConfirmModal(`Sei sicuro di voler eliminare la scheda "${currentSheetData.nomeScheda}"? Questa azione è irreversibile.`);
            if (confirmed) {
                const exercisesRef = getExercisesRef(currentMesoId, currentSheetId);
                const exercisesSnapshot = await getDocs(exercisesRef);
                const batch = writeBatch(db);
                exercisesSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await deleteDoc(doc(getSheetsRef(currentMesoId), currentSheetId));
                showNotification("Scheda eliminata con successo.");
                currentSheetId = null;
                document.getElementById('sheet-content').classList.add('hidden');
                document.getElementById('initial-message').classList.remove('hidden');
                await renderSheetSelector();
            }
        }
        
        async function handleCompleteSheet() {
            if (!currentSheetId) { 
                showNotification("Seleziona una scheda da terminare.", "error");
                return; 
            }
            const confirmed = await showConfirmModal(`Contrassegnare la scheda "${currentSheetData.nomeScheda}" come completata?`);
            if (confirmed) {
                await updateDoc(doc(getSheetsRef(currentMesoId), currentSheetId), { isCompleta: true });
                await renderSheetSelector();
                showNotification("Scheda completata!");
            }
        }
        
        async function handleCompleteWeek() {
            const completedWeeks = currentSheetData.completedWeeks || [];
            if (!completedWeeks.includes(currentWeek)) {
                completedWeeks.push(currentWeek);
                const updateData = { completedWeeks };
                if (workoutStartTime) {
                    const endTime = new Date();
                    const durationMs = endTime - workoutStartTime;
                    const hours = Math.floor(durationMs / 3600000).toString().padStart(2, '0');
                    const minutes = Math.floor((durationMs % 3600000) / 60000).toString().padStart(2, '0');
                    const seconds = Math.floor((durationMs % 60000) / 1000).toString().padStart(2, '0');
                    const durationString = `${hours}:${minutes}:${seconds}`;
                    
                    const durations = currentSheetData.workoutDurations || {};
                    durations[currentWeek] = durationString;
                    updateData.workoutDurations = durations;
                    workoutStartTime = null;
                }
                await updateDoc(doc(getSheetsRef(currentMesoId), currentSheetId), updateData);
                currentSheetData = { ...currentSheetData, ...updateData };
                
                // Check if all weeks are completed
                if (completedWeeks.length === currentSheetData.numeroSettimane) {
                    await awardReward('completion', `Hai completato la scheda ${currentSheetData.nomeScheda}!`);
                }
                
                renderWeekSelector();
                renderWeekActions();
                showNotification(`Settimana ${currentWeek} completata!`);
            }
        }
        
        async function handleAddExercise(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Caricamento...';
            let imageUrl = form.elements.imageUrl.value || "";
            const imageFile = form.elements.imageFile.files[0];
            if (imageFile) {
                const storageRef = ref(storage, `exercise_images/${currentUser.uid}/${currentMesoId}/${Date.now()}_${imageFile.name}`);
                const snapshot = await uploadBytes(storageRef, imageFile);
                imageUrl = await getDownloadURL(snapshot.ref);
            }
            const newExercise = {
                nomeEsercizio: form.elements.nomeEsercizio.value,
                categoria: form.elements.categoria.value,
                ordine: parseInt(form.elements.ordine.value, 10),
                serie: parseInt(form.elements.serie.value, 10),
                ripetizioni: form.elements.ripetizioni.value,
                rir: form.elements.rir.value || "",
                recupero: parseInt(form.elements.recupero.value, 10) || null,
                note: form.elements.note.value || "",
                videoUrl: form.elements.videoUrl.value || "",
                imageUrl: imageUrl,
                datiSettimanali: {}
            };
            await addDoc(getExercisesRef(currentMesoId, currentSheetId), newExercise);
            form.reset();
            document.getElementById('add-exercise-container').classList.remove('open');
            await loadAndRenderExercises();
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus mr-2"></i> Aggiungi';
            showNotification("Esercizio aggiunto con successo!");
        }
        
        mainView.addEventListener('input', (e) => {
            if (e.target.matches('input[data-ex-id]')) {
                if (!workoutStartTime) workoutStartTime = new Date();
                const { exId, serieIndex, field } = e.target.dataset;
                const value = e.target.value;
                const key = `${exId}-${currentWeek}-${serieIndex}-${field}`;
                clearTimeout(saveTimeouts[key]);
                saveTimeouts[key] = setTimeout(() => saveWeeklyData(exId, serieIndex, field, value), 800);
            }
        });
        
        mainView.addEventListener('click', async (e) => {
            const target = e.target;
            const reorderBtn = target.closest('button[data-reorder-ex-id]');
            const editBtn = target.closest('button[data-edit-ex-id]');
            const deleteBtn = target.closest('button[data-delete-ex-id]');
            const timerBtn = target.closest('button[data-timer]');
            
            if (reorderBtn) {
                reorderBtn.disabled = true;
                await handleReorderExercise(reorderBtn.dataset.reorderExId, reorderBtn.dataset.direction);
            } else if (editBtn) {
                openEditExerciseModal(editBtn.dataset.editExId);
            } else if (deleteBtn) {
                if (await showConfirmModal('Sei sicuro di voler eliminare questo esercizio?')) {
                    await deleteDoc(doc(getExercisesRef(currentMesoId, currentSheetId), deleteBtn.dataset.deleteExId));
                    await loadAndRenderExercises();
                    showNotification("Esercizio eliminato!");
                }
            } else if (timerBtn) {
                const time = parseInt(timerBtn.dataset.timer, 10);
                if (time && !timerBtn.disabled) {
                    startTimerModal(time);
                }
            } else if (e.target.id === 'toggle-add-exercise-btn') {
                document.getElementById('add-exercise-container').classList.toggle('open');
            } else if (e.target.id === 'export-csv-btn') {
                exportSheetToCSV();
            } else if (e.target.id === 'export-pdf-btn') {
                previewAndExportPDF();
            } else if (e.target.id === 'manage-favorites-btn') {
                openFavoritesModal();
            } else if (e.target.id === 'manage-users-btn') {
                openUserManagementModal();
            }
        });
        
        async function saveWeeklyData(exId, serieIndex, field, value) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise) return;
            const updatedDati = JSON.parse(JSON.stringify(exercise.datiSettimanali || {}));
            if (!updatedDati[currentWeek]) updatedDati[currentWeek] = [];
            while (updatedDati[currentWeek].length <= serieIndex) updatedDati[currentWeek].push({ carico: '', reps: '' });
            updatedDati[currentWeek][serieIndex][field] = value;
            await updateDoc(doc(getExercisesRef(currentMesoId, currentSheetId), exId), { datiSettimanali: updatedDati });
            exercise.datiSettimanali = updatedDati;
            
            // Check for progress reward
            if (field === 'carico' && currentWeek > 1) {
                const prevWeekData = exercise.datiSettimanali?.[currentWeek - 1]?.[serieIndex];
                if (prevWeekData && prevWeekData.carico) {
                    const prevLoad = parseFloat(prevWeekData.carico);
                    const currentLoad = parseFloat(value);
                    if (currentLoad > prevLoad) {
                        await awardReward('progress', `Hai superato il carico in ${exercise.nomeEsercizio}!`);
                    }
                }
            }
            
            calculateAndRenderSheetVolume();
        }
        
        // --- FUNZIONI MODAL E UTILITY ---
        function showConfirmModal(message) {
            return new Promise(resolve => {
                confirmModal.classList.remove('hidden');
                document.getElementById('confirm-message').textContent = message;
                setTimeout(() => confirmModal.classList.remove('opacity-0'), 10);
                
                const okBtn = document.getElementById('confirm-ok-btn');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const cleanup = (result) => {
                    confirmModal.classList.add('opacity-0');
                    setTimeout(() => confirmModal.classList.add('hidden'), 250);
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    resolve(result);
                };
                
                okBtn.onclick = () => cleanup(true);
                cancelBtn.onclick = () => cleanup(false);
            });
        }
        
        function openAuthModal() {
            authModal.classList.remove('hidden');
            setTimeout(() => authModal.classList.remove('opacity-0'), 10);
        }
        
        function closeAuthModal() {
            authModal.classList.add('opacity-0');
            setTimeout(() => authModal.classList.add('hidden'), 250);
        }
        
        authModal.addEventListener('click', (e) => { if (e.target === authModal) closeAuthModal(); });
        
        document.getElementById('toggle-auth-mode-btn').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-submit-btn').textContent = isLoginMode ? 'Accedi' : 'Registrati';
            document.getElementById('toggle-auth-mode-btn').textContent = isLoginMode ? 'Non hai un account? Registrati' : 'Hai già un account? Accedi';
            document.getElementById('auth-error').textContent = '';
        });
        
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.elements.email.value, password = e.target.elements.password.value;
            const authError = document.getElementById('auth-error');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            authError.textContent = '';
            authSubmitBtn.disabled = true;
            authSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Elaborazione...';
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Create user document with default role
                    await setDoc(doc(db, 'users', userCredential.user.uid), {
                        email,
                        role: 'user',
                        createdAt: new Date().toISOString()
                    });
                }
                closeAuthModal();
            } catch (error) {
                authError.textContent = "Credenziali non valide o utente già esistente.";
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.innerHTML = isLoginMode ? 'Accedi' : 'Registrati';
            }
        });
        
        // --- NUOVE FUNZIONI PER MODIFICA E RIORDINO ---
        function openEditExerciseModal(exId) {
            const exercise = exercisesCache.find(ex => ex.id === exId);
            if (!exercise) return;
            const container = document.getElementById('edit-exercise-container');
            const categoryOptions = CATEGORIES.map(cat => `<option value="${cat}" ${exercise.categoria === cat ? 'selected' : ''}>${cat}</option>`).join('');
            container.innerHTML = `
                <form id="edit-exercise-form" class="space-y-3" data-ex-id="${exId}">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <input type="text" name="nomeEsercizio" class="input-field" placeholder="Nome Esercizio" value="${exercise.nomeEsercizio}" required>
                        <select name="categoria" class="input-field" required>${categoryOptions}</select>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <input type="number" name="ordine" class="input-field" placeholder="Ordine" value="${exercise.ordine}" required>
                        <input type="number" name="serie" class="input-field" placeholder="N° Serie" value="${exercise.serie}" required>
                        <input type="text" name="ripetizioni" class="input-field" placeholder="Reps (es. 8-10)" value="${exercise.ripetizioni}" required>
                        <input type="text" name="rir" class="input-field" placeholder="RIR (es. 1-2)" value="${exercise.rir || ''}">
                    </div>
                    <input type="number" name="recupero" class="input-field" placeholder="Recupero (secondi)" value="${exercise.recupero || ''}">
                    <textarea name="note" class="textarea-field" placeholder="Note (opzionale)" rows="3">${exercise.note || ''}</textarea>
                    <input type="url" name="videoUrl" class="input-field" placeholder="Link Video (opzionale)" value="${exercise.videoUrl || ''}">
                    <input type="url" name="imageUrl" class="input-field" placeholder="URL Immagine (opzionale)" value="${exercise.imageUrl || ''}">
                    <div class="image-upload-container">
                        <label class="text-sm text-stone-400 mb-1 block">Oppure carica un'immagine dal PC</label>
                        <input type="file" name="imageFile" class="input-field file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200">
                        ${exercise.imageUrl ? `
                        <div class="image-preview mt-3">
                            <img src="${exercise.imageUrl}" class="exercise-image">
                            <button type="button" class="remove-image-btn" data-remove-image="true" title="Rimuovi immagine">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Annulla</button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save mr-2"></i> Salva Modifiche
                        </button>
                    </div>
                </form>`;
            editExerciseModal.classList.remove('hidden');
            setTimeout(() => editExerciseModal.classList.remove('opacity-0'), 10);
            document.getElementById('edit-exercise-form').addEventListener('submit', handleUpdateExercise);
            document.getElementById('cancel-edit-btn').addEventListener('click', closeEditExerciseModal);
            
            // Aggiungi event listener per il pulsante di rimozione immagine
            const removeImageBtn = container.querySelector('[data-remove-image]');
            if (removeImageBtn) {
                removeImageBtn.addEventListener('click', () => {
                    container.querySelector('input[name="imageUrl"]').value = '';
                    container.querySelector('.image-preview').remove();
                });
            }
        }
        
        function closeEditExerciseModal() {
            editExerciseModal.classList.add('opacity-0');
            setTimeout(() => {
                editExerciseModal.classList.add('hidden');
                document.getElementById('edit-exercise-container').innerHTML = '';
            }, 250);
        }
        
        editExerciseModal.addEventListener('click', (e) => { if (e.target === editExerciseModal) closeEditExerciseModal(); });
        
        async function handleUpdateExercise(e) {
            e.preventDefault();
            const form = e.target;
            const exId = form.dataset.exId;
            const originalExercise = exercisesCache.find(ex => ex.id === exId);
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Salvataggio...';
            let imageUrl = originalExercise.imageUrl;
            const imageFile = form.elements.imageFile.files[0];
            if (imageFile) {
                const storageRef = ref(storage, `exercise_images/${currentUser.uid}/${currentMesoId}/${Date.now()}_${imageFile.name}`);
                const snapshot = await uploadBytes(storageRef, imageFile);
                imageUrl = await getDownloadURL(snapshot.ref);
            } else {
                const newImageUrl = form.elements.imageUrl.value;
                if (newImageUrl) {
                    imageUrl = newImageUrl;
                }
            }
            const updatedData = {
                nomeEsercizio: form.elements.nomeEsercizio.value,
                categoria: form.elements.categoria.value,
                ordine: parseInt(form.elements.ordine.value, 10),
                serie: parseInt(form.elements.serie.value, 10),
                ripetizioni: form.elements.ripetizioni.value,
                rir: form.elements.rir.value || "",
                recupero: parseInt(form.elements.recupero.value, 10) || null,
                note: form.elements.note.value || "",
                videoUrl: form.elements.videoUrl.value || "",
                imageUrl: imageUrl
            };
            await updateDoc(doc(getExercisesRef(currentMesoId, currentSheetId), exId), updatedData);
            
            closeEditExerciseModal();
            await loadAndRenderExercises();
            showNotification("Esercizio aggiornato con successo!");
        }
        
        async function handleReorderExercise(exId, direction) {
            const currentIndex = exercisesCache.findIndex(ex => ex.id === exId);
            if (currentIndex === -1) return;
            const otherIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (otherIndex < 0 || otherIndex >= exercisesCache.length) return;
            const currentExercise = exercisesCache[currentIndex];
            const otherExercise = exercisesCache[otherIndex];
            const currentOrder = currentExercise.ordine;
            const otherOrder = otherExercise.ordine;
            const batch = writeBatch(db);
            const currentExRef = doc(getExercisesRef(currentMesoId, currentSheetId), currentExercise.id);
            const otherExRef = doc(getExercisesRef(currentMesoId, currentSheetId), otherExercise.id);
            batch.update(currentExRef, { ordine: otherOrder });
            batch.update(otherExRef, { ordine: currentOrder });
            try {
                await batch.commit();
                await loadAndRenderExercises();
            } catch (error) {
                console.error("Errore durante il riordino degli esercizi:", error);
                showNotification("Si è verificato un errore durante il riordino.", "error");
            }
        }
        
        // --- FUNZIONI DI PREMI ---
        async function awardReward(type, description) {
            await addDoc(getRewardsRef(), {
                type,
                description,
                date: new Date().toISOString(),
                claimed: false
            });
            
            showNotification(`🏆 ${description}`);
        }
        
        function showNotification(message, type = "success") {
            const notification = document.createElement('div');
            notification.className = `notification ${type === "error" ? "bg-red-500" : "bg-amber-500"}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === "error" ? "fa-exclamation-circle" : "fa-trophy"} mr-2"></i>
                    <span>${message}</span>
                </div>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // --- FUNZIONI DI ESPORTAZIONE ---
        async function exportSheetToCSV() {
            if (!currentSheetId) return;
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Ordine", "Esercizio", "Categoria", "Serie Target", "Reps Target", "Note"];
            const maxSets = Math.max(0, ...exercisesCache.map(ex => ex.serie));
            for (let i = 1; i <= currentSheetData.numeroSettimane; i++) {
                for (let j = 1; j <= maxSets; j++) {
                    headers.push(`Sett ${i} - Carico ${j}`, `Sett ${i} - Reps ${j}`);
                }
            }
            csvContent += headers.join(",") + "\r\n";
            exercisesCache.forEach(ex => {
                const row = [ex.ordine, `"${ex.nomeEsercizio}"`, ex.categoria, ex.serie, ex.ripetizioni, `"${(ex.note || "").replace(/"/g, '""')}"`];
                for (let i = 1; i <= currentSheetData.numeroSettimane; i++) {
                    const weeklyData = ex.datiSettimanali?.[i] || [];
                    for (let j = 0; j < maxSets; j++) {
                        const set = weeklyData[j] || { carico: '', reps: '' };
                        row.push(set.carico, set.reps);
                    }
                }
                csvContent += row.join(",") + "\r\n";
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentSheetData.nomeScheda.replace(/ /g, "_")}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification("Scheda esportata in CSV!");
        }
        
        async function previewAndExportPDF() {
            if (!currentSheetId) return;
            
            // Generate PDF content
            pdfContent = generatePDFContent();
            
            // Show preview modal
            pdfPreviewContainer.innerHTML = pdfContent;
            pdfPreviewModal.classList.remove('hidden');
            setTimeout(() => pdfPreviewModal.classList.remove('opacity-0'), 10);
        }
        
        function generatePDFContent() {
            const creationDate = new Date().toLocaleDateString('it-IT');
            
            let html = `
                <div class="pdf-preview-header">
                    <h2 class="pdf-preview-title">RISCALDAMENTO</h2>
                    <div class="pdf-preview-info">
                        <p><strong>Settimane:</strong> ${currentWeek}</p>
                        <p><strong>Creato:</strong> ${creationDate}</p>
                    </div>
                </div>
                <div class="space-y-4">`;
            
            exercisesCache.forEach((ex, index) => {
                html += `
                    <div class="pdf-preview-exercise">
                        <div class="pdf-preview-exercise-name">${index + 1}. ${ex.nomeEsercizio}</div>
                        <div class="pdf-preview-exercise-details">
                            <p><strong>Categoria:</strong> ${ex.categoria} | <strong>Serie:</strong> ${ex.serie} | <strong>Reps:</strong> ${ex.ripetizioni} | <strong>RIR:</strong> ${ex.rir || '-'} | <strong>Recupero:</strong> ${ex.recupero || '-'}s</p>
                            ${ex.note ? `<p><strong>Note:</strong> ${ex.note}</p>` : ''}
                        </div>
                    </div>`;
            });
            
            html += `</div>`;
            
            return html;
        }
        
        async function exportSheetToPDF() {
            if (!currentSheetId) return;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Aggiungi titolo
            pdf.setFontSize(20);
            pdf.text("RISCALDAMENTO", 105, 20, { align: 'center' });
            
            // Aggiungi informazioni scheda
            pdf.setFontSize(12);
            pdf.text(`Settimane: ${currentWeek}`, 20, 35);
            pdf.text(`Creato: ${new Date().toLocaleDateString()}`, 20, 45);
            
            // Aggiungi elenco esercizi
            let yPosition = 60;
            pdf.setFontSize(14);
            pdf.text('Esercizi:', 20, yPosition);
            yPosition += 10;
            
            pdf.setFontSize(10);
            exercisesCache.forEach((ex, index) => {
                // Controlla se c'è spazio per una nuova pagina
                if (yPosition > 270) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                // Nome esercizio
                pdf.setFont(undefined, 'bold');
                pdf.text(`${index + 1}. ${ex.nomeEsercizio}`, 20, yPosition);
                yPosition += 5;
                
                // Dettagli esercizio
                pdf.setFont(undefined, 'normal');
                pdf.text(`Categoria: ${ex.categoria} | Serie: ${ex.serie} | Reps: ${ex.ripetizioni} | RIR: ${ex.rir || '-'} | Recupero: ${ex.recupero || '-'}s`, 25, yPosition);
                yPosition += 5;
                
                if (ex.note) {
                    // Gestione note su più righe
                    const noteLines = pdf.splitTextToSize(ex.note, 170);
                    pdf.text(`Note: ${noteLines[0]}`, 25, yPosition);
                    yPosition += 5;
                    
                    for (let i = 1; i < noteLines.length; i++) {
                        if (yPosition > 270) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        pdf.text(noteLines[i], 25, yPosition);
                        yPosition += 5;
                    }
                }
                
                // Dati settimanali
                for (let week = 1; week <= currentSheetData.numeroSettimane; week++) {
                    const weeklyData = ex.datiSettimanali?.[week] || [];
                    if (weeklyData.length > 0) {
                        pdf.text(`Settimana ${week}:`, 25, yPosition);
                        yPosition += 5;
                        
                        weeklyData.forEach((set, index) => {
                            pdf.text(`  Serie ${index + 1}: ${set.carico || '-'}kg x ${set.reps || '-'}reps`, 30, yPosition);
                            yPosition += 5;
                        });
                    }
                }
                
                yPosition += 5; // Spazio tra esercizi
            });
            
            pdf.save(`${currentSheetData.nomeScheda.replace(/ /g, "_")}.pdf`);
            showNotification("Scheda esportata in PDF!");
        }
        
        // --- FUNZIONI DI IMPORT/EXPORT MESOCICLO ---
        async function handleExportMeso() {
            if (!currentMesoId) {
                showNotification("Seleziona un mesociclo da esportare.", "error");
                return;
            }
            
            try {
                const mesoDoc = await getDoc(doc(getMesocyclesRef(), currentMesoId));
                if (!mesoDoc.exists()) {
                    showNotification("Mesociclo non trovato.", "error");
                    return;
                }
                
                const mesoData = mesoDoc.data();
                const sheetsSnapshot = await getDocs(getSheetsRef(currentMesoId));
                const sheetsData = [];
                
                for (const sheetDoc of sheetsSnapshot.docs) {
                    const sheetData = sheetDoc.data();
                    const exercisesSnapshot = await getDocs(getExercisesRef(currentMesoId, sheetDoc.id));
                    const exercisesData = exercisesSnapshot.docs.map(exDoc => exDoc.data());
                    
                    sheetsData.push({
                        ...sheetData,
                        exercises: exercisesData
                    });
                }
                
                const exportData = {
                    mesocycle: mesoData,
                    sheets: sheetsData,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `${mesoData.nome.replace(/ /g, "_")}_export.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification("Mesociclo esportato con successo!");
            } catch (error) {
                console.error("Errore durante l'esportazione del mesociclo:", error);
                showNotification("Errore durante l'esportazione del mesociclo.", "error");
            }
        }
        
        async function handleImportMeso(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const fileContent = await file.text();
                const importData = JSON.parse(fileContent);
                
                if (!importData.mesocycle || !importData.sheets) {
                    showNotification("Formato file non valido.", "error");
                    return;
                }
                
                // Crea il mesociclo
                const newMesoRef = await addDoc(getMesocyclesRef(), {
                    nome: importData.mesocycle.nome + " (Importato)",
                    dataCreazione: new Date().toISOString()
                });
                
                // Importa le schede e gli esercizi
                for (const sheet of importData.sheets) {
                    const { exercises, ...sheetData } = sheet;
                    const newSheetRef = await addDoc(getSheetsRef(newMesoRef.id), {
                        ...sheetData,
                        dataCreazione: new Date().toISOString()
                    });
                    
                    // Importa gli esercizi
                    for (const exercise of exercises) {
                        await addDoc(getExercisesRef(newMesoRef.id, newSheetRef.id), {
                            ...exercise,
                            datiSettimanali: exercise.datiSettimanali || {}
                        });
                    }
                }
                
                await renderMesocycleSelector();
                showNotification("Mesociclo importato con successo!");
            } catch (error) {
                console.error("Errore durante l'importazione del mesociclo:", error);
                showNotification("Errore durante l'importazione del mesociclo.", "error");
            }
            
            // Resetta l'input file per permettere di importare di nuovo lo stesso file
            e.target.value = '';
        }
        
        // --- FUNZIONI PER LA GESTIONE DEI PREFERITI ---
        function openFavoritesModal() {
            favoritesModal.classList.remove('hidden');
            setTimeout(() => favoritesModal.classList.remove('opacity-0'), 10);
            loadAndRenderFavorites();
        }
        
        async function loadAndRenderFavorites() {
            const container = document.getElementById('favorites-container');
            container.innerHTML = '<div class="loader"></div>';
            
            try {
                const favoritesSnapshot = await getDocs(getFavoriteExercisesRef());
                const favorites = favoritesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (favorites.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-star text-4xl text-stone-600 mb-4"></i>
                            <p class="text-stone-400">Nessun esercizio preferito trovato.</p>
                        </div>`;
                    return;
                }
                
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${favorites.map(fav => `
                            <div class="bg-stone-800/50 p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-white">${fav.nomeEsercizio}</h4>
                                    <span class="text-sm text-amber-400">${fav.categoria}</span>
                                </div>
                                <p class="text-sm text-stone-400 mb-3">
                                    Serie: ${fav.serie} | Reps: ${fav.ripetizioni} | RIR: ${fav.rir || '-'} | Recupero: ${fav.recupero || '-'}s
                                </p>
                                ${fav.note ? `<p class="text-sm text-stone-300 mb-3">${fav.note}</p>` : ''}
                                <div class="flex justify-end gap-2">
                                    <button class="btn btn-secondary !p-2 text-xs" data-add-fav-ex-id="${fav.id}" title="Aggiungi alla scheda">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-danger !p-2 text-xs" data-delete-fav-ex-id="${fav.id}" title="Elimina dai preferiti">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6">
                        <form id="add-favorite-form" class="space-y-3">
                            <h3 class="text-lg font-bold text-white mb-2">Aggiungi Esercizio Preferito</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <input type="text" name="nomeEsercizio" class="input-field" placeholder="Nome Esercizio" required>
                                <select name="categoria" class="input-field" required>
                                    ${CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                </select>
                            </div>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                <input type="number" name="serie" class="input-field" placeholder="N° Serie" required>
                                <input type="text" name="ripetizioni" class="input-field" placeholder="Reps (es. 8-10)" required>
                                <input type="text" name="rir" class="input-field" placeholder="RIR (es. 1-2)">
                                <input type="number" name="recupero" class="input-field" placeholder="Recupero (secondi)">
                            </div>
                            <textarea name="note" class="textarea-field" placeholder="Note (opzionale)" rows="2"></textarea>
                            <button type="submit" class="btn w-full">
                                <i class="fas fa-plus mr-2"></i> Aggiungi ai Preferiti
                            </button>
                        </form>
                    </div>`;
                
                // Aggiungi event listeners
                container.addEventListener('click', async (e) => {
                    const addBtn = e.target.closest('button[data-add-fav-ex-id]');
                    const deleteBtn = e.target.closest('button[data-delete-fav-ex-id]');
                    
                    if (addBtn && currentSheetId) {
                        const favId = addBtn.dataset.addFavExId;
                        const fav = favorites.find(f => f.id === favId);
                        if (fav) {
                            const newExercise = {
                                nomeEsercizio: fav.nomeEsercizio,
                                categoria: fav.categoria,
                                ordine: (exercisesCache.length || 0) + 1,
                                serie: fav.serie,
                                ripetizioni: fav.ripetizioni,
                                rir: fav.rir || "",
                                recupero: fav.recupero || null,
                                note: fav.note || "",
                                videoUrl: "",
                                imageUrl: "",
                                datiSettimanali: {}
                            };
                            await addDoc(getExercisesRef(currentMesoId, currentSheetId), newExercise);
                            await loadAndRenderExercises();
                            showNotification("Esercizio aggiunto alla scheda!");
                        }
                    } else if (deleteBtn) {
                        const favId = deleteBtn.dataset.deleteFavExId;
                        if (await showConfirmModal('Sei sicuro di voler eliminare questo esercizio dai preferiti?')) {
                            await deleteDoc(doc(getFavoriteExercisesRef(), favId));
                            loadAndRenderFavorites();
                            showNotification("Esercizio eliminato dai preferiti!");
                        }
                    }
                });
                
                document.getElementById('add-favorite-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const newFavorite = {
                        nomeEsercizio: form.elements.nomeEsercizio.value,
                        categoria: form.elements.categoria.value,
                        serie: parseInt(form.elements.serie.value, 10),
                        ripetizioni: form.elements.ripetizioni.value,
                        rir: form.elements.rir.value || "",
                        recupero: parseInt(form.elements.recupero.value, 10) || null,
                        note: form.elements.note.value || ""
                    };
                    await addDoc(getFavoriteExercisesRef(), newFavorite);
                    form.reset();
                    loadAndRenderFavorites();
                    showNotification("Esercizio aggiunto ai preferiti!");
                });
            } catch (error) {
                console.error("Errore durante il caricamento dei preferiti:", error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                        <p class="text-stone-400">Errore durante il caricamento dei preferiti.</p>
                    </div>`;
            }
        }
        
        document.getElementById('close-favorites-modal').addEventListener('click', () => {
            favoritesModal.classList.add('opacity-0');
            setTimeout(() => favoritesModal.classList.add('hidden'), 250);
        });
        
        favoritesModal.addEventListener('click', (e) => { if (e.target === favoritesModal) {
            favoritesModal.classList.add('opacity-0');
            setTimeout(() => favoritesModal.classList.add('hidden'), 250);
        }});
        
        // --- FUNZIONI PER LA GESTIONE DEGLI UTENTI ---
        function openUserManagementModal() {
            userManagementModal.classList.remove('hidden');
            setTimeout(() => userManagementModal.classList.remove('opacity-0'), 10);
            loadAndRenderUsers();
        }
        
        async function loadAndRenderUsers() {
            const container = document.getElementById('user-management-container');
            container.innerHTML = '<div class="loader"></div>';
            
            try {
                const usersSnapshot = await getDocs(getUsersRef());
                const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                container.innerHTML = `
                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Elenco Utenti</h3>
                        <span class="text-sm text-stone-400">Totale: ${users.length} utenti</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-stone-700">
                                    <th class="text-left py-2 px-3 text-stone-300">Email</th>
                                    <th class="text-left py-2 px-3 text-stone-300">Ruolo</th>
                                    <th class="text-left py-2 px-3 text-stone-300">Data Creazione</th>
                                    <th class="text-left py-2 px-3 text-stone-300">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr class="border-b border-stone-800 hover:bg-stone-800/30">
                                        <td class="py-3 px-3 text-white">${user.email}</td>
                                        <td class="py-3 px-3">
                                            <span class="px-2 py-1 rounded text-xs ${user.role === 'admin' ? 'bg-red-500/20 text-red-400' : 'bg-amber-500/20 text-amber-400'}">
                                                ${user.role === 'admin' ? 'Amministratore' : 'Utente'}
                                            </span>
                                        </td>
                                        <td class="py-3 px-3 text-stone-400">${new Date(user.createdAt).toLocaleDateString()}</td>
                                        <td class="py-3 px-3">
                                            <div class="flex gap-2">
                                                <button class="btn btn-secondary !p-2 text-xs" data-view-user-id="${user.id}" title="Visualizza dettagli">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-secondary !p-2 text-xs" data-edit-user-id="${user.id}" title="Modifica utente">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-secondary !p-2 text-xs" data-access-user-id="${user.id}" title="Accedi come utente">
                                                    <i class="fas fa-sign-in-alt"></i>
                                                </button>
                                                ${currentUserRole === 'admin' && user.id !== currentUser.uid ? `
                                                <button class="btn btn-danger !p-2 text-xs" data-delete-user-id="${user.id}" title="Elimina utente">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
                
                // Aggiungi event listeners
                container.addEventListener('click', async (e) => {
                    const viewBtn = e.target.closest('button[data-view-user-id]');
                    const editBtn = e.target.closest('button[data-edit-user-id]');
                    const accessBtn = e.target.closest('button[data-access-user-id]');
                    const deleteBtn = e.target.closest('button[data-delete-user-id]');
                    
                    if (viewBtn) {
                        const userId = viewBtn.dataset.viewUserId;
                        const user = users.find(u => u.id === userId);
                        if (user) {
                            openUserDetailsModal(user);
                        }
                    } else if (editBtn) {
                        const userId = editBtn.dataset.editUserId;
                        const user = users.find(u => u.id === userId);
                        if (user) {
                            openEditUserModal(user);
                        }
                    } else if (accessBtn) {
                        const userId = accessBtn.dataset.accessUserId;
                        const user = users.find(u => u.id === userId);
                        if (user) {
                            selectUser(userId, user.email);
                            userManagementModal.classList.add('opacity-0');
                            setTimeout(() => userManagementModal.classList.add('hidden'), 250);
                        }
                    } else if (deleteBtn) {
                        const userId = deleteBtn.dataset.deleteUserId;
                        const user = users.find(u => u.id === userId);
                        if (user && await showConfirmModal(`Sei sicuro di voler eliminare l'utente ${user.email}?`)) {
                            await deleteDoc(doc(getUsersRef(), userId));
                            loadAndRenderUsers();
                            showNotification("Utente eliminato con successo!");
                        }
                    }
                });
            } catch (error) {
                console.error("Errore durante il caricamento degli utenti:", error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
                        <p class="text-stone-400">Errore durante il caricamento degli utenti.</p>
                    </div>`;
            }
        }
        
        document.getElementById('refresh-users-btn').addEventListener('click', () => {
            loadAndRenderUsers();
        });
        
        document.getElementById('close-user-modal').addEventListener('click', () => {
            userManagementModal.classList.add('opacity-0');
            setTimeout(() => userManagementModal.classList.add('hidden'), 250);
        });
        
        userManagementModal.addEventListener('click', (e) => { if (e.target === userManagementModal) {
            userManagementModal.classList.add('opacity-0');
            setTimeout(() => userManagementModal.classList.add('hidden'), 250);
        }});
        
        // --- FUNZIONI PER LA MODIFICA DEGLI UTENTI ---
        function openEditUserModal(user) {
            const container = document.getElementById('edit-user-container');
            container.innerHTML = `
                <form id="edit-user-form" class="space-y-4" data-user-id="${user.id}">
                    <div>
                        <label class="block text-sm font-medium text-stone-300 mb-1">Email</label>
                        <input type="email" name="email" class="input-field" value="${user.email}" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-300 mb-1">Ruolo</label>
                        <select name="role" class="input-field" ${user.id === currentUser.uid ? 'disabled' : ''}>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>Utente</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Amministratore</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" id="cancel-edit-user-btn" class="btn btn-secondary">Annulla</button>
                        <button type="submit" class="btn">
                            <i class="fas fa-save mr-2"></i> Salva Modifiche
                        </button>
                    </div>
                </form>`;
            
            editUserModal.classList.remove('hidden');
            setTimeout(() => editUserModal.classList.remove('opacity-0'), 10);
            
            document.getElementById('edit-user-form').addEventListener('submit', handleUpdateUser);
            document.getElementById('cancel-edit-user-btn').addEventListener('click', closeEditUserModal);
        }
        
        function closeEditUserModal() {
            editUserModal.classList.add('opacity-0');
            setTimeout(() => {
                editUserModal.classList.add('hidden');
                document.getElementById('edit-user-container').innerHTML = '';
            }, 250);
        }
        
        async function handleUpdateUser(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const role = form.elements.role.value;
            
            try {
                await updateDoc(doc(getUsersRef(), userId), { role });
                closeEditUserModal();
                loadAndRenderUsers();
                showNotification("Utente aggiornato con successo!");
                
                // Se l'utente ha modificato se stesso, aggiorna il ruolo corrente
                if (userId === currentUser.uid) {
                    currentUserRole = role;
                    renderAppView();
                }
            } catch (error) {
                console.error("Errore durante l'aggiornamento dell'utente:", error);
                showNotification("Errore durante l'aggiornamento dell'utente.", "error");
            }
        }
        
        editUserModal.addEventListener('click', (e) => { if (e.target === editUserModal) closeEditUserModal(); });
        
        // --- FUNZIONI PER I DETTAGLI UTENTE ---
        function openUserDetailsModal(user) {
            const container = document.getElementById('user-details-container');
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-stone-800/50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-2">Informazioni Account</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-stone-400">Email:</span>
                                <p class="text-white">${user.email}</p>
                            </div>
                            <div>
                                <span class="text-stone-400">Ruolo:</span>
                                <p class="text-white">${user.role === 'admin' ? 'Amministratore' : 'Utente'}</p>
                            </div>
                            <div>
                                <span class="text-stone-400">ID Utente:</span>
                                <p class="text-white font-mono text-xs">${user.id}</p>
                            </div>
                            <div>
                                <span class="text-stone-400">Data Creazione:</span>
                                <p class="text-white">${new Date(user.createdAt).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-stone-800/50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-2">Statistiche</h3>
                        <div id="user-stats-container">
                            <div class="loader"></div>
                        </div>
                    </div>
                    
                    <div class="bg-stone-800/50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-2">Premi</h3>
                        <div id="user-rewards-container">
                            <div class="loader"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-2">
                        <button id="access-user-btn" class="btn btn-secondary">
                            <i class="fas fa-sign-in-alt mr-2"></i> Accedi come utente
                        </button>
                        <button id="close-user-details-btn" class="btn btn-secondary">Chiudi</button>
                    </div>
                </div>`;
            
            userDetailsModal.classList.remove('hidden');
            setTimeout(() => userDetailsModal.classList.remove('opacity-0'), 10);
            
            // Carica statistiche e premi
            loadUserStats(user.id);
            loadUserRewards(user.id);
            
            // Aggiungi event listener per il pulsante di accesso
            document.getElementById('access-user-btn').addEventListener('click', () => {
                selectUser(user.id, user.email);
                userDetailsModal.classList.add('opacity-0');
                setTimeout(() => userDetailsModal.classList.add('hidden'), 250);
            });
        }
        
        async function loadUserStats(userId) {
            const container = document.getElementById('user-stats-container');
            
            try {
                // Conta mesocicli
                const mesocyclesSnapshot = await getDocs(collection(db, 'users', userId, 'mesocycles'));
                const mesocyclesCount = mesocyclesSnapshot.size;
                
                // Conta schede
                let sheetsCount = 0;
                let completedSheetsCount = 0;
                
                for (const mesoDoc of mesocyclesSnapshot.docs) {
                    const sheetsSnapshot = await getDocs(collection(db, 'users', userId, 'mesocycles', mesoDoc.id, 'trainingSheets'));
                    sheetsCount += sheetsSnapshot.size;
                    
                    sheetsSnapshot.forEach(sheetDoc => {
                        if (sheetDoc.data().isCompleta) {
                            completedSheetsCount++;
                        }
                    });
                }
                
                // Conta esercizi
                let exercisesCount = 0;
                for (const mesoDoc of mesocyclesSnapshot.docs) {
                    const sheetsSnapshot = await getDocs(collection(db, 'users', userId, 'mesocycles', mesoDoc.id, 'trainingSheets'));
                    
                    for (const sheetDoc of sheetsSnapshot.docs) {
                        const exercisesSnapshot = await getDocs(collection(db, 'users', userId, 'mesocycles', mesoDoc.id, 'trainingSheets', sheetDoc.id, 'exercises'));
                        exercisesCount += exercisesSnapshot.size;
                    }
                }
                
                container.innerHTML = `
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
                        <div class="bg-stone-700/50 p-3 rounded-lg">
                            <p class="text-2xl font-bold text-amber-400">${mesocyclesCount}</p>
                            <p class="text-xs text-stone-400">Mesocicli</p>
                        </div>
                        <div class="bg-stone-700/50 p-3 rounded-lg">
                            <p class="text-2xl font-bold text-amber-400">${sheetsCount}</p>
                            <p class="text-xs text-stone-400">Schede</p>
                        </div>
                        <div class="bg-stone-700/50 p-3 rounded-lg">
                            <p class="text-2xl font-bold text-amber-400">${completedSheetsCount}</p>
                            <p class="text-xs text-stone-400">Schede Completate</p>
                        </div>
                        <div class="bg-stone-700/50 p-3 rounded-lg">
                            <p class="text-2xl font-bold text-amber-400">${exercisesCount}</p>
                            <p class="text-xs text-stone-400">Esercizi</p>
                        </div>
                    </div>`;
            } catch (error) {
                console.error("Errore durante il caricamento delle statistiche utente:", error);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle text-2xl text-red-500 mb-2"></i>
                        <p class="text-stone-400">Errore durante il caricamento delle statistiche.</p>
                    </div>`;
            }
        }
        
        async function loadUserRewards(userId) {
            const container = document.getElementById('user-rewards-container');
            
            try {
                const rewardsSnapshot = await getDocs(collection(db, 'users', userId, 'rewards'));
                const rewards = rewardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (rewards.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-trophy text-2xl text-stone-600 mb-2"></i>
                            <p class="text-stone-400">Nessun premio ottenuto.</p>
                        </div>`;
                    return;
                }
                
                container.innerHTML = `
                    <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        ${rewards.map(reward => `
                            <div class="flex items-center gap-3 p-3 bg-stone-700/50 rounded-lg">
                                <div class="flex-shrink-0 w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center">
                                    <i class="fas fa-trophy text-amber-400"></i>
                                </div>
                                <div class="flex-grow">
                                    <p class="text-white font-medium">${reward.description}</p>
                                    <p class="text-xs text-stone-400">${new Date(reward.date).toLocaleString()}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <span class="px-2 py-1 rounded text-xs ${reward.type === 'completion' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}">
                                        ${reward.type === 'completion' ? 'Completamento' : 'Progresso'}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            } catch (error) {
                console.error("Errore durante il caricamento dei premi utente:", error);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle text-2xl text-red-500 mb-2"></i>
                        <p class="text-stone-400">Errore durante il caricamento dei premi.</p>
                    </div>`;
            }
        }
        
        document.getElementById('close-user-details-btn').addEventListener('click', () => {
            userDetailsModal.classList.add('opacity-0');
            setTimeout(() => userDetailsModal.classList.add('hidden'), 250);
        });
        
        userDetailsModal.addEventListener('click', (e) => { if (e.target === userDetailsModal) {
            userDetailsModal.classList.add('opacity-0');
            setTimeout(() => userDetailsModal.classList.add('hidden'), 250);
        }});
        
        // --- FUNZIONI PER LA PREVIEW E CREAZIONE GOOGLE DOC ---
        downloadPdfBtn.addEventListener('click', () => {
            exportSheetToPDF();
            pdfPreviewModal.classList.add('opacity-0');
            setTimeout(() => pdfPreviewModal.classList.add('hidden'), 250);
        });
        
        createGdocBtn.addEventListener('click', () => {
            createGoogleDoc();
        });
        
        closePdfPreviewBtn.addEventListener('click', () => {
            pdfPreviewModal.classList.add('opacity-0');
            setTimeout(() => pdfPreviewModal.classList.add('hidden'), 250);
        });
        
        pdfPreviewModal.addEventListener('click', (e) => { if (e.target === pdfPreviewModal) {
            pdfPreviewModal.classList.add('opacity-0');
            setTimeout(() => pdfPreviewModal.classList.add('hidden'), 250);
        }});
        
        function createGoogleDoc() {
            // Crea il contenuto per Google Doc
            const title = `RISCALDAMENTO - Settimana ${currentWeek}`;
            let content = `<html><head><title>${title}</title></head><body>`;
            content += `<h1>RISCALDAMENTO</h1>`;
            content += `<p><strong>Settimane:</strong> ${currentWeek}</p>`;
            content += `<p><strong>Creato:</strong> ${new Date().toLocaleDateString('it-IT')}</p>`;
            content += `<h2>Esercizi</h2>`;
            content += `<ul>`;
            
            exercisesCache.forEach((ex, index) => {
                content += `<li><strong>${index + 1}. ${ex.nomeEsercizio}</strong>`;
                content += `<br><em>Categoria:</em> ${ex.categoria} | <em>Serie:</em> ${ex.serie} | <em>Reps:</em> ${ex.ripetizioni} | <em>RIR:</em> ${ex.rir || '-'} | <em>Recupero:</em> ${ex.recupero || '-'}s`;
                if (ex.note) {
                    content += `<br><em>Note:</em> ${ex.note.replace(/\n/g, '<br>')}`;
                }
                content += `</li>`;
            });
            
            content += `</ul></body></html>`;
            
            // Crea un Blob con il contenuto HTML
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            // Crea un link per il download
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title.replace(/ /g, '_')}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("File HTML creato! Puoi caricarlo su Google Docs.");
        }
        
        // --- INIZIALIZZAZIONE ---
        // Chiamata a setupAdminAccount dopo il caricamento della pagina
        window.addEventListener('load', () => {
            setupAdminAccount();
        });
    </script>
</body>
</html>